<!DOCTYPE html>
<!-- saved from url=(0127)https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml -->
<html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml" data-csrf-cookie="csrfsafari" data-highlight-privacy="private" data-user-id="4423847" data-user-uuid="6d9ee17b-34b1-4bf4-bdae-19676bd84ca1" data-username="fwang3" data-account-type="B2B" data-activated-trial-date="" data-archive="9781484245019" data-publishers="Apress" data-htmlfile-name="477630_1_En_14_Chapter.xhtml" data-epub-title="Practical Microservices Architectural Patterns: Event-Based Java Microservices with Spring Boot and Spring Cloud" data-debug="0" data-testing="0" style=""><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="O&#39;Reilly Media"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781484245019"><link rel="shortcut icon" href="https://www.oreilly.com/favicon.ico"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="shortcut icon" href="https://learning.oreilly.com/favicon.ico" type="image/x-icon"><link href="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/css" rel="stylesheet" type="text/css"><title>14.&nbsp;Transactions and Microservices - Practical Microservices Architectural Patterns: Event-Based Java Microservices with Spring Boot and Spring Cloud</title><link rel="stylesheet" href="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/output.731.css" type="text/css"><link rel="stylesheet" type="text/css" href="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/annotator..css"><link rel="stylesheet" href="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/font-aweso.css"><style type="text/css" title="ibis-book">
    #sbo-rt-content a{text-decoration:none}#sbo-rt-content a:link,#sbo-rt-content a:active{color:#0176C3}#sbo-rt-content a:visited{color:#5f5f5f}#sbo-rt-content div{font-family:"Cambria","Minion Pro","Times New Roman","Times",serif;}#sbo-rt-content img{border:0;vertical-align:middle}#sbo-rt-content video{display:block;margin-top:1em;max-width:100%;text-indent:0;width:100%}#sbo-rt-content p{margin:0}#sbo-rt-content .Heading,#sbo-rt-content .SubHeading,#sbo-rt-content .ContextInformation,#sbo-rt-content .MainTitleSection,#sbo-rt-content .PartTitle,#sbo-rt-content .SeriesTitle,#sbo-rt-content .SeriesSubTitle,#sbo-rt-content .SubSeriesTitle,#sbo-rt-content .SubSeriesSubTitle,#sbo-rt-content .BookTitle,#sbo-rt-content .BookSubTitle,#sbo-rt-content .ForewordTitle,#sbo-rt-content .PrefaceTitle,#sbo-rt-content .BookAcknowledgmentsTitle,#sbo-rt-content .BookNotesTitle{text-align:left !important}#sbo-rt-content .Heading,#sbo-rt-content .SubHeading{display:block;font-weight:bold}#sbo-rt-content .ArticleContextInformation{border-bottom:1px solid;margin-bottom:.8em;padding-bottom:.3em}#sbo-rt-content .ArticleContextInformation .ContextInformation{display:block;font-size:80%}#sbo-rt-content .ArticleContextInformation .JournalTitle:after,#sbo-rt-content .ArticleContextInformation .JournalSubTitle:after{content:", "}#sbo-rt-content .ArticleCopyright{display:inline}#sbo-rt-content .ArticleCopyright .CopyrightComment,#sbo-rt-content .ArticleContextInformation .ArticleDOI{display:block}#sbo-rt-content .ChapterContextInformation{border-bottom:1px solid;margin-bottom:.8em;padding-bottom:.3em}#sbo-rt-content .ChapterContextInformation .ContextInformation{display:block;font-size:80%}#sbo-rt-content .ChapterCopyright .CopyrightComment{display:block}#sbo-rt-content .ChapterContextInformation .BookEdition:before{content:", "}#sbo-rt-content .ChapterContextInformation .ContextInformationAuthorEditorNames:after{content:", "}#sbo-rt-content .ChapterContextInformation .BookTitle{font-style:italic}#sbo-rt-content .ChapterContextInformation .SeriesTitle:before{content:", "}#sbo-rt-content .ChapterContextInformation .SeriesSubTitle:before{content:": "}#sbo-rt-content .ChapterContextInformation .ContextInformationVolumeNumber:before{content:" "}#sbo-rt-content .ChapterContextInformation .ChapterDOI{display:block}#sbo-rt-content .Categories{color:#666;margin-bottom:1em;margin-top:1em}#sbo-rt-content .ArticleCategory,#sbo-rt-content .ChapterCategory{font-size:1.2rem}#sbo-rt-content .ArticleSubCategory,#sbo-rt-content .ChapterSubCategory{font-size:1rem}#sbo-rt-content .MainTitleSection{font-weight:bold;margin-bottom:1.2em;margin-top:1.2em}#sbo-rt-content .ArticleSuperTitle{font-size:1.2rem}#sbo-rt-content .MainTitleSection .ArticleTitle,#sbo-rt-content .ForeignLanguageHeader .ArticleTitle,#sbo-rt-content .MainTitleSection .ChapterTitle,#sbo-rt-content .ForeignLanguageHeader .ChapterTitle{font-size:1.73rem;margin:0}#sbo-rt-content .ArticleSubTitle,#sbo-rt-content .ChapterSubTitle{font-size:1.2rem;padding-top:.2em}#sbo-rt-content div>.AuthorGroup .AuthorNames,#sbo-rt-content .BookBackmatter>.AuthorGroup .AuthorNames{font-size:100%;margin-bottom:1em;margin-top:1em;text-align:left !important}#sbo-rt-content .BookBackmatter>.AuthorGroup .AuthorNames{font-weight:bold}#sbo-rt-content .AuthorNames sup{font-size:70%}#sbo-rt-content .Prefix:after{content:" "}#sbo-rt-content .Suffix:before{content:" "}#sbo-rt-content .Degrees:before{content:", "}#sbo-rt-content .NativeName:before,#sbo-rt-content .Role:before{content:" ("}#sbo-rt-content .NativeName:after,#sbo-rt-content .Role:after{content:")"}#sbo-rt-content .AffiliationNumber{float:left;padding-right:.5em}#sbo-rt-content .AffiliationText{margin-left:2em}#sbo-rt-content .AffiliationHint{font-style:italic}#sbo-rt-content .AuthorNames .DeceasedSymbol:before{content:"†";padding-left:3px}#sbo-rt-content .AuthorNames .EqualContributionSymbol:before{content:"*";padding-left:3px}#sbo-rt-content .InstitutionMembers:before{content:" ("}#sbo-rt-content .InstitutionMembers:after{content:")"}#sbo-rt-content .AffiliationLegend .DeceasedSymbol:before{content:"†";display:inline-block;width:14px}#sbo-rt-content .AffiliationLegend .EqualContributionSymbol:before{content:"*";display:inline-block;width:14px}#sbo-rt-content .ClearBoth{clear:both;font-size:0;line-height:0 !important}#sbo-rt-content .Contact,#sbo-rt-content .AffiliationLegend{margin-bottom:1em;margin-top:1em}#sbo-rt-content .ContactIcon{background-image:url(envelope.png);background-repeat:no-repeat;background-size:contain;width:.8rem}#sbo-rt-content .AuthorNames .ContactIcon{display:inline-block}#sbo-rt-content .Contact .ContactIcon{float:left;margin-top:4px;margin-right:4px}#sbo-rt-content .ContactAuthorLine{padding-left:20px;font-weight:bold}#sbo-rt-content .ContactAdditionalLine{padding-left:20px}#sbo-rt-content .ContactType{font-weight:bold}#sbo-rt-content .ArticleHistory{margin-bottom:1em;margin-top:1em}#sbo-rt-content .HistoryLabel{font-weight:bold}#sbo-rt-content .History+.History{padding-left:.5em}#sbo-rt-content .ArticleOrChapterToc{border-top:1px solid #bbb;margin-top:1em;padding-top:1em}#sbo-rt-content .ArticleOrChapterToc .HeadingNumber{font-weight:bold;padding-right:.3em}#sbo-rt-content .Abstract{margin-top:1em}#sbo-rt-content .Abstract>.Heading{font-size:1em;margin:0}#sbo-rt-content .AbstractSection{margin-top:.3em}#sbo-rt-content .Heading+.AbstractSection{margin-top:0}#sbo-rt-content .AbstractSection>.Heading{font-size:1em;font-style:italic;font-weight:normal;margin:0}#sbo-rt-content .KeywordGroup{margin-top:1em}#sbo-rt-content .KeywordGroup .Heading{display:inline;font-size:1em;margin:0;padding-right:.5em}#sbo-rt-content .Keyword+.Keyword:before{content:" – "}#sbo-rt-content .ArticleExternalID{margin-top:1em}#sbo-rt-content .ArticleExternalIDLabel{font-weight:bold}#sbo-rt-content .ForeignLanguageHeader{border-top:1px solid #bbb;margin-top:1em}#sbo-rt-content .ForeignLanguageTitleSection{font-weight:bold;margin-bottom:1.2em;margin-top:1rem}#sbo-rt-content .AbbreviationGroup{margin-top:1em}#sbo-rt-content .ForeignLanguageHeader+.AbbreviationGroup{border-top:1px solid #bbb;margin-top:1em;padding-top:1em}#sbo-rt-content .AbbreviationGroup>.Heading{font-size:1em;margin:0}#sbo-rt-content .AbbreviationGroup .DefinitionList{margin-top:0;margin-bottom:0;padding-right:.1em;padding-top:.1em;padding-bottom:.1em}#sbo-rt-content .AbbreviationGroupSection>.Heading{font-size:1em;margin:0;padding-top:.2em}#sbo-rt-content .ArticleNote{margin-top:1em}#sbo-rt-content .ArticleNote>.Heading{font-size:1em;margin:0}#sbo-rt-content .ArticleNoteMotto{font-style:italic;margin-left:1.5em;margin-right:1.5em;text-align:right}#sbo-rt-content .Biography{display:block;margin-top:.8em;padding-bottom:0;width:100%}#sbo-rt-content .Loc .AuthorGroup .Biography{margin-top:0}#sbo-rt-content .Biography .FormalPara,#sbo-rt-content .Biography .BiographyFigure{display:block;margin-top:0;margin-bottom:0}#sbo-rt-content .Biography .BiographyFigure{float:right;margin-left:6px}#sbo-rt-content .Biography .Figure{border-bottom:none;margin-top:.5em;margin-bottom:0}#sbo-rt-content .Fulltext>.Para:first-of-type>.BlockQuote:first-child{margin-top:0}#sbo-rt-content .BlockQuote{margin:1em 1.5em}#sbo-rt-content .BlockQuote>.Heading{font-size:1em;margin-top:1em;margin-bottom:0;text-indent:0}#sbo-rt-content .BlockQuote>.Para{text-indent:0}#sbo-rt-content .Heading+.Para>.BlockQuote:first-child{margin-top:0}#sbo-rt-content .Caption,#sbo-rt-content .TableFooter{display:block;text-align:left}#sbo-rt-content .TableFooter .SimplePara+.SimplePara{text-indent:0}#sbo-rt-content .Caption{margin-top:.5em}#sbo-rt-content .CaptionContent{font-size:90%}#sbo-rt-content .TableFooter{margin-top:1em}#sbo-rt-content .Table .Caption{margin-top:.5em}#sbo-rt-content .Figure .Caption,#sbo-rt-content video+.Caption{margin-bottom:1em}#sbo-rt-content .Table .Caption{margin-bottom:.5em}#sbo-rt-content .CaptionNumber{font-style:italic;font-weight:bold;padding-right:.6em}#sbo-rt-content .CaptionContent>span.Heading{display:inline}#sbo-rt-content .CaptionContent>span.SimplePara{display:block}#sbo-rt-content .CaptionContent>.SimplePara:first-child,#sbo-rt-content .CaptionContent>.CaptionNumber+.SimplePara,#sbo-rt-content .CaptionContent>a+.SimplePara{display:inline;margin-top:0}#sbo-rt-content .Credit>.SimplePara{text-indent:1.5em}#sbo-rt-content .DefinitionList{margin-top:1em;margin-bottom:1em;padding:.1em}#sbo-rt-content .DefinitionList>.Heading{font-size:1rem;margin:0;text-indent:0}#sbo-rt-content dl{margin:0}#sbo-rt-content .DefinitionList:after{content:"";clear:both;display:table}#sbo-rt-content .Term{clear:both;float:left;font-style:italic;padding-right:1em;text-indent:0;vertical-align:top}#sbo-rt-content .Description{padding-bottom:.3em;margin-left:0}#sbo-rt-content .Description .Para:first-child{text-indent:0}#sbo-rt-content .Heading+.Para>div.DefinitionList:first-child{margin-top:0}#sbo-rt-content .EmphasisTypeBold{font-weight:bold}#sbo-rt-content .EmphasisTypeItalic{font-style:italic}#sbo-rt-content .EmphasisTypeUnderline{text-decoration:underline}#sbo-rt-content .EmphasisTypeDoubleUnderline{border-bottom-style:double}#sbo-rt-content .EmphasisTypeSmallCaps{font-variant:small-caps}#sbo-rt-content .EmphasisTypeBoldItalic{font-weight:bold;font-style:italic}#sbo-rt-content .EmphasisTypeBoldUnderline{font-weight:bold;text-decoration:underline}#sbo-rt-content .EmphasisTypeBoldDoubleUnderline{font-weight:bold;border-bottom-style:double}#sbo-rt-content .EmphasisTypeBoldSmallCaps{font-weight:bold;font-variant:small-caps}#sbo-rt-content .EmphasisTypeItalicUnderline{font-style:italic;text-decoration:underline}#sbo-rt-content .EmphasisTypeItalicDoubleUnderline{font-style:italic;border-bottom-style:double}#sbo-rt-content .EmphasisTypeItalicSmallCaps{font-style:italic;font-variant:small-caps}#sbo-rt-content .EmphasisTypeBoldItalicUnderline{font-weight:bold;font-style:italic;text-decoration:underline}#sbo-rt-content .EmphasisTypeBoldItalicDoubleUnderline{font-weight:bold;font-style:italic;border-bottom-style:double}#sbo-rt-content .EmphasisTypeBoldItalicSmallCaps{font-weight:bold;font-style:italic;font-variant:small-caps}#sbo-rt-content .EmphasisTypeUnderlineSmallCaps{text-decoration:underline;font-variant:small-caps}#sbo-rt-content .EmphasisTypeDoubleUnderlineSmallCaps{border-bottom-style:double;font-variant:small-caps}#sbo-rt-content .EmphasisFontCategoryNonProportional{font-family:"Courier New",Courier,monospace}#sbo-rt-content :not(.ParaTypeProgramcode)>.EmphasisFontCategoryNonProportional{font-size:95%}#sbo-rt-content .EmphasisFontCategorySansSerif{font-family:"Arial","Helvetica",sans-serif;font-size:75%}#sbo-rt-content .EmphasisTypeStrikethrough{text-decoration:line-through}#sbo-rt-content .Equation{display:block;text-indent:0;vertical-align:middle}#sbo-rt-content .NumberedEquation{display:table;width:100%}#sbo-rt-content .NumberedEquation .EquationWrapper{display:table-row}#sbo-rt-content .NumberedEquation .EquationContent{display:table-cell}#sbo-rt-content .EquationContent{margin-top:.5em;margin-bottom:0;width:100%;text-align:center;text-indent:0;vertical-align:middle}#sbo-rt-content .EquationContent div{margin-top:.5em}#sbo-rt-content .EquationContent .MediaObject{margin-left:auto;margin-right:auto}#sbo-rt-content .EquationContent img{background:white;max-width:100%}#sbo-rt-content .EquationNumber{display:table-cell;margin-bottom:.4em;text-align:right;vertical-align:middle;white-space:nowrap}#sbo-rt-content .EquationSourceXml{white-space:nowrap}#sbo-rt-content .InlineEquation img{background:white;vertical-align:text-top}#sbo-rt-content .Figure{margin-top:1em;margin-bottom:1em;margin-left:0;margin-right:0;text-align:center;text-indent:0}#sbo-rt-content .Figure img{height:auto;margin:0;max-width:100%;padding:2px}#sbo-rt-content .MediaObject{display:block;text-align:center}#sbo-rt-content .MediaObject:last-child{margin-bottom:1em}#sbo-rt-content .EquationContent>.MediaObject:last-child{margin-bottom:0}#sbo-rt-content .MediaObject+.MediaObject{margin-top:1em}#sbo-rt-content .FootnoteSection{border-top:1px solid #bbb;margin-top:1em}#sbo-rt-content .FootnoteSection>.Heading{font-size:1.44rem;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .Footnote{clear:both;font-size:90%;text-align:left}#sbo-rt-content .FootnoteNumber{float:left;padding-right:.5em}#sbo-rt-content .FootnoteParas>div{margin-left:1em;margin-top:.3em}#sbo-rt-content .FormalPara{margin-top:1em;margin-bottom:1em}#sbo-rt-content .FormalPara .Heading{font-size:1em;margin:0}#sbo-rt-content .FormalParaRenderingStyle1>.Heading{display:inline;padding-right:1em}#sbo-rt-content .FormalParaRenderingStyle2>.Heading{display:inline;font-style:italic;font-weight:normal;padding-right:1em}#sbo-rt-content .FormalParaRenderingStyle3>.Heading{padding-right:1em}#sbo-rt-content .FormalParaRenderingStyle1>p:first-of-type,#sbo-rt-content .FormalParaRenderingStyle2>p:first-of-type{display:inline}#sbo-rt-content .Heading+.FormalPara{margin-top:0}#sbo-rt-content .FormalPara .AuthorNames{font-style:italic;font-weight:normal !important}#sbo-rt-content .HeadingNumber{padding-right:.3em}#sbo-rt-content .RenderAsSection1>.Heading{font-size:1.44rem;margin-top:.5em;margin-bottom:.1em}#sbo-rt-content .RenderAsSection2>.Heading{font-size:1.2rem;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .Heading+.Section2>.Heading:first-child{margin-top:0}#sbo-rt-content .RenderAsSection3>.Heading{font-size:1.2rem;font-style:italic;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .Heading+.Section3>.Heading:first-child{margin-top:0}#sbo-rt-content .RenderAsSection4>.Heading{font-size:100%;font-style:italic;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .Heading+.Section4>.Heading:first-child{margin-top:0}#sbo-rt-content .RenderAsSection5>.Heading{font-size:100%;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .Heading+.Section5>.Heading:first-child{margin-top:0}#sbo-rt-content .RenderAsSection6>.Heading{font-size:100%;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .Heading+.Section6>.Heading:first-child{margin-top:0}#sbo-rt-content .RenderAsSection7>.Heading{font-size:100%;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .Heading+.Section7>.Heading:first-child{margin-top:0}#sbo-rt-content .Literal{font-family:"Courier New",Courier,monospace}#sbo-rt-content .OrderedList{margin-top:.5em;margin-bottom:.5em;text-indent:0;display:table}#sbo-rt-content .OrderedList>ol{margin:0;padding:0}#sbo-rt-content .OrderedList .Heading{font-size:1em;font-style:italic;font-weight:normal;margin-top:0;margin-bottom:0;display:table-caption}#sbo-rt-content .OrderedList .Heading+.ListItem{margin-top:0}#sbo-rt-content .Heading+.Para>div.OrderedList:first-child,#sbo-rt-content .Heading+.Para>div.OrderedList:first-child>.Heading{margin-top:0}#sbo-rt-content .ListItem{margin-top:.5em;display:table-row}#sbo-rt-content .ItemNumber{padding-right:.5em;display:table-cell;vertical-align:top}#sbo-rt-content .ItemContent{display:table-cell}#sbo-rt-content .Fulltext>.Para:first-of-type{border-top:1px solid #bbb;margin-top:1em;padding-top:1em}#sbo-rt-content .Fulltext>.Para~.Para:first-of-type{border-top:none;margin-top:0;padding-top:0}#sbo-rt-content .Para+.Para{margin-top:0;text-indent:1.5em}#sbo-rt-content .ParaTextBreak{margin-top:1em !important;text-indent:0 !important}#sbo-rt-content .ParaTypeExample{border-left:4px solid;padding-left:.5em;margin-top:1em !important;margin-bottom:1em}#sbo-rt-content .ParaTypeEyeCatcher,#sbo-rt-content .ParaTypeTip{border-left:4px solid;padding-left:.5em;margin-top:1em !important;margin-bottom:.5em}#sbo-rt-content .ParaTypeImportant{background:#bbb;border:2px solid;padding:.5em;margin-top:.8em !important;margin-bottom:.8em}#sbo-rt-content .ParaTypeImportant img{background-color:transparent}#sbo-rt-content .ParaTypeGeneticSequence,#sbo-rt-content .ParaTypeLiteral,#sbo-rt-content .ParaTypeProgramcode{font-family:"Courier New",Courier,monospace;font-size:95%}#sbo-rt-content .ParaTypeProgramcode{text-indent:0 !important;word-wrap:break-word}#sbo-rt-content .Para:not(.ParaTypeProgramcode)+.ParaTypeProgramcode{margin-top:.5em}#sbo-rt-content .ParaTypeProgramcode+.Para:not(.ParaTypeProgramcode){margin-top:.5em}#sbo-rt-content .ParaTypeLegalText{font-weight:bold;margin-left:1em;text-align:left}#sbo-rt-content .ParaTypeOverview,#sbo-rt-content .ParaTypeAnswers,#sbo-rt-content .ParaTypeQuestions,#sbo-rt-content .ParaTypeDefinition,#sbo-rt-content .ParaTypeProcedure,#sbo-rt-content .ParaTypeRecipe{border:2px solid;margin-top:.8em !important;margin-bottom:.8em;padding:.5em}#sbo-rt-content .ParaTypeSource{font-style:italic}#sbo-rt-content .ParaTypeTrailer,#sbo-rt-content .ParaTypeLearningGoals{font-weight:bold;padding-left:.5em;padding-right:.5em}#sbo-rt-content .ParaTypeWarning{font-weight:bold}#sbo-rt-content .ParaTypeExample,#sbo-rt-content .ParaTypeEyeCatcher,#sbo-rt-content .ParaTypeImportant,#sbo-rt-content .ParaTypeLegalText,#sbo-rt-content .ParaTypeOverview,#sbo-rt-content .ParaTypeTip,#sbo-rt-content .ParaTypeAnswers,#sbo-rt-content .ParaTypeQuestions,#sbo-rt-content .ParaTypeDefinition,#sbo-rt-content .ParaTypeProcedure,#sbo-rt-content .ParaTypeRecipe{text-indent:0 !important}#sbo-rt-content .Para+.ParaOneEmphasisChild{margin-top:1em;text-indent:0 !important}#sbo-rt-content .ParaOneEmphasisChild+.Para{text-indent:0 !important}#sbo-rt-content .PartNumber{display:block;font-size:1.73rem}#sbo-rt-content .PartTitle{display:block;font-size:1.73rem}#sbo-rt-content .SubPartTitle{display:block;font-size:1.44rem}#sbo-rt-content .ProgramCode{margin-top:1em;margin-bottom:1em}#sbo-rt-content .ProgramCode .FixedLine{font-family:"Courier New",Courier,monospace;font-size:95%;word-wrap:break-word}#sbo-rt-content .LineGroup+.LineGroup{margin-top:1em}#sbo-rt-content .Heading+.Para>.Quiz>.Heading{margin-top:0;}#sbo-rt-content .Quiz .Heading{font-size:1rem;margin-top:1em;margin-bottom:0;text-indent:0}#sbo-rt-content .QuizTask{display:table;margin-top:.5em;margin-bottom:.5em;width:100%;text-indent:0}#sbo-rt-content .QuizTask+.QuizTask{margin-top:1.5em}#sbo-rt-content .QuizItem{padding:.1em}#sbo-rt-content .QuizItemTypeSolution{border:2px solid #aaa;margin-top:.5em;padding:10px}#sbo-rt-content .QuizTask>input{display:none}#sbo-rt-content .QuizItem>label{color:#0176C3}#sbo-rt-content .QuizTask>input~.QuizItem>label+div{display:none}#sbo-rt-content .QuizTask>input:checked~.QuizItem>label+div{display:table-cell}#sbo-rt-content .QuizTask>input~.QuizItem>label:after{content:"  »"}#sbo-rt-content .QuizTask>input:checked~.QuizItem>label:after{content:"  «"}#sbo-rt-content .QuizTask>input~.QuizItemTypeCorrectAnswer{background-color:transparent;transition:background .4s}#sbo-rt-content .QuizTask>input:checked~.QuizItemTypeCorrectAnswer{background-color:#EAF2DB;transition:background .4s}#sbo-rt-content .ReviewTitle{font-weight:bold;margin-top:1em;text-indent:0}#sbo-rt-content .Review .AuthorName+.AuthorName:before{content:", "}#sbo-rt-content .Review .ISBN,#sbo-rt-content .ReviewDataUnstructured{text-indent:0}#sbo-rt-content .Review .Para:first-of-type{margin-top:1em;text-indent:0}#sbo-rt-content .BookBackmatter>.Appendix:first-child>div:first-child{border-top:none !important;margin-top:0 !important;padding-top:0 !important}#sbo-rt-content .BookAcknowledgmentsBody>.RenderAsSection1:first-child,#sbo-rt-content .BookNotesBody>.RenderAsSection1:first-child,#sbo-rt-content .ForewordBody>.RenderAsSection1:first-child,#sbo-rt-content .PrefaceBody>.RenderAsSection1:first-child,#sbo-rt-content .BookBackmatter>.Appendix:first-child>.RenderAsSection1:first-child{border-top:none;margin-top:0}#sbo-rt-content .BookAcknowledgmentsBody>.RenderAsSection1:first-child>.Heading,#sbo-rt-content .ForewordBody>.RenderAsSection1:first-child>.Heading,#sbo-rt-content .PrefaceBody>.RenderAsSection1:first-child>.Heading{margin-top:0}#sbo-rt-content .Section1 .AuthorNames,#sbo-rt-content .Section2 .AuthorNames,#sbo-rt-content .Section3 .AuthorNames{font-weight:bold;margin-top:.3em;margin-bottom:.5em}#sbo-rt-content .Section1 .AuthorNames sup,#sbo-rt-content .Section2 .AuthorNames sup,#sbo-rt-content .Section3 .AuthorNames sup{font-size:70%}#sbo-rt-content .Section1 .Affiliations,#sbo-rt-content .Section2 .Affiliations,#sbo-rt-content .Section3 .Affiliations{margin-bottom:.5em}#sbo-rt-content .SectionTypeBackgroundInformation,#sbo-rt-content .SectionTypeExcurse{font-size:90%}#sbo-rt-content .SectionTypeBox,#sbo-rt-content .SectionTypeOverview,#sbo-rt-content .SectionTypeQuestionnaire{background-color:#BBB;margin-top:1em !important;padding:.5em}#sbo-rt-content .SectionTypeCaseStudy,#sbo-rt-content .SectionTypeExample,#sbo-rt-content .SectionTypeTip{border-left:4px solid;margin-top:1em !important;padding-top:0;padding-left:.5em;padding-right:.5em;padding-bottom:.5em}#sbo-rt-content .SectionTypeTrailer,#sbo-rt-content .SectionTypeLearningGoals{font-weight:bold;text-align:left}#sbo-rt-content .SectionTypeLegalText{font-weight:bold;margin-left:1em;text-align:left;text-indent:0 !important}#sbo-rt-content .SectionTypeProcedure,#sbo-rt-content .SectionTypeRecipe{border:2px solid;margin-top:.8em !important;margin-bottom:.8em;padding:.5em}#sbo-rt-content .SectionTypeWarning{font-weight:bold}#sbo-rt-content .RenderAsSection1{border-top:1px solid #bbb;margin-top:1em}#sbo-rt-content .SectionTypeBox+.RenderAsSection1,#sbo-rt-content .SectionTypeOverview+.RenderAsSection1,#sbo-rt-content .SectionTypeQuestionnaire+.RenderAsSection1{border-top:0;}#sbo-rt-content .SectionTypeBox>.Heading,#sbo-rt-content .SectionTypeOverview>.Heading,#sbo-rt-content .SectionTypeQuestionnaire>.Heading,#sbo-rt-content .SectionTypeProcedure>.Heading,#sbo-rt-content .SectionTypeRecipe>.Heading{margin-top:0}#sbo-rt-content .InternalRefSidebarLexicon{background-image:url(sidebar.gif);background-repeat:no-repeat;font-weight:bold;padding-left:20px}#sbo-rt-content .SidebarDialog{border:1px solid;margin-left:1.5em;margin-top:.4em;margin-bottom:.2em;padding:.2em;text-indent:0}#sbo-rt-content .SidebarNumber{font-weight:bold;padding-right:.5em}#sbo-rt-content .SimplePara+.SimplePara{margin-top:0;text-indent:1.5em}#sbo-rt-content .Stack{display:inline-table;vertical-align:top}#sbo-rt-content .Stack sub{display:table-row}#sbo-rt-content .Stack sup{display:table-header-group}#sbo-rt-content table{border-collapse:collapse;font-size:80%;max-width:100%;text-indent:0}#sbo-rt-content table .SimplePara+.SimplePara{text-indent:0}#sbo-rt-content table,#sbo-rt-content tr,#sbo-rt-content td{border-color:#bbb !important}#sbo-rt-content th{border-color:#999 !important}#sbo-rt-content thead{background:#bbb;color:#000 !important}#sbo-rt-content .Table{margin-bottom:1em;text-indent:0}#sbo-rt-content .Caption .Table{margin-bottom:0}#sbo-rt-content .Table img{height:auto;margin:0;max-width:100%}#sbo-rt-content th div{text-align:left}#sbo-rt-content td div,#sbo-rt-content td p,#sbo-rt-content th div,#sbo-rt-content th p{padding:.2em}#sbo-rt-content .Para+.Table,#sbo-rt-content .Para>.Table{margin-top:1em}#sbo-rt-content .SimplePara>.Table{margin-top:.5em}#sbo-rt-content thead,#sbo-rt-content tdiv{vertical-align:top}#sbo-rt-content tbody+tbody tr:first-child td{padding-top:1em}#sbo-rt-content .ExternalTable{background-color:#F8F8F8;border-top:1px solid;border-bottom:1px solid;margin-top:1em;margin-bottom:1em;padding-top:0;padding-bottom:0}#sbo-rt-content .ExternalTable .Table{padding-bottom:.3em}#sbo-rt-content .UnorderedList>.Heading{font-size:1em;font-style:italic;font-weight:normal;margin-top:0;margin-bottom:0}#sbo-rt-content .Heading+.Para>div.UnorderedList:first-child>.Heading{margin-top:0}#sbo-rt-content .UnorderedList li .Para:first-child{text-indent:0}#sbo-rt-content .Heading+ul{margin-top:0}#sbo-rt-content ul{margin-top:.5em;margin-bottom:.5em}#sbo-rt-content ul.UnorderedListMarkBullet{list-style-type:disc;padding-left:1em}#sbo-rt-content ul.UnorderedListMarkBullet div{margin-bottom:.3em}#sbo-rt-content ul.UnorderedListMarkBullet .Equation div{margin-bottom:0}#sbo-rt-content ul.UnorderedListMarkNone{list-style-type:none;padding-left:1em}#sbo-rt-content ul.UnorderedListMarkNone div{margin-bottom:.3em}#sbo-rt-content ul.UnorderedListMarkNone .Equation div{margin-bottom:0}#sbo-rt-content ul.UnorderedListMarkDash{list-style:none;padding-left:1.1em;text-indent:-.8em}#sbo-rt-content ul.UnorderedListMarkDash>li>*:first-child{display:inline}#sbo-rt-content ul.UnorderedListMarkDash div{text-indent:0;margin-top:.3em;margin-bottom:.3em}#sbo-rt-content ul.UnorderedListMarkDash>li:before{content:"– "}#sbo-rt-content .Verse{margin-top:1em;margin-bottom:1em}#sbo-rt-content .Verse .Heading{font-size:1rem;margin-top:1em;margin-bottom:1em;text-indent:0}#sbo-rt-content .Acknowledgments,#sbo-rt-content .AuthorContribution,#sbo-rt-content .Ethics{margin-top:1em}#sbo-rt-content .Acknowledgments>.Heading,#sbo-rt-content .AuthorContribution>.Heading,#sbo-rt-content .FundingInformation>.Heading,#sbo-rt-content .DataAvailability>.Heading,#sbo-rt-content .Ethics>.Heading{font-size:1.2rem;margin-bottom:0}#sbo-rt-content .License{font-size:.9rem !important;margin-top:1em;margin-bottom:1em}#sbo-rt-content .License>a:first-child img{float:left;height:1.9rem;padding-right:.5em;padding-bottom:0;padding-top:.2em}#sbo-rt-content .Glossary{border-top:1px solid #bbb;margin-top:1em;margin-bottom:1em;padding-top:.3em}#sbo-rt-content .Glossary .Headings{margin-top:.8em;margin-bottom:.8em}#sbo-rt-content .Glossary>.Headings>.Heading{font-size:1.44rem;margin:0}#sbo-rt-content .Glossary>.Headings>.SubHeading{font-size:1.2rem}#sbo-rt-content .GlossarySection .Headings{margin-top:.8em;margin-bottom:.4em}#sbo-rt-content .GlossarySection>.Headings>.Heading{font-size:1.2rem;margin:0}#sbo-rt-content .GlossarySection>.Headings>.SubHeading{font-size:100%}#sbo-rt-content .GlossaryTerm{float:left;font-style:italic;padding-right:.5em}#sbo-rt-content .GlossarySeeLabel,#sbo-rt-content .GlossarySeeAlsoLabel{font-style:italic;padding-right:.3em}#sbo-rt-content .GlossaryDef{display:inline;margin-top:.3em}#sbo-rt-content .GlossaryDef>.SimplePara,#sbo-rt-content .GlossaryDef>.GlossarySee,#sbo-rt-content .GlossaryDef>.GlossarySeeAlso{display:block}#sbo-rt-content .GlossaryDef>:first-child{display:inline;margin-top:0;margin-left:0}#sbo-rt-content .GlossaryDef .SimplePara+.GlossarySee,#sbo-rt-content .GlossaryDef .SimplePara+.GlossarySeeAlso{text-indent:0}#sbo-rt-content .GlossaryTerm{display:inline}#sbo-rt-content .GlossaryTerm+.GlossarySee,#sbo-rt-content .GlossaryTerm+.GlossarySeeAlso{display:inline}#sbo-rt-content .InternalRefGlossaryEntry{border-bottom:thin dotted;cursor:help}#sbo-rt-content .InternalRefGlossaryEntry:hover{border-bottom:none}#sbo-rt-content .InternalRefGlossaryEntry a:link,#sbo-rt-content .InternalRefGlossaryEntry a:active,#sbo-rt-content .InternalRefGlossaryEntry a:visited{color:inherit}#sbo-rt-content .InternalRefGlossaryEntry .InlineGlossaryDefinition{background:#fff;display:none;margin:0 3em 0 2em;padding:3px 3px 3px 6px;border-style:solid;border-color:#49546F;border-width:2px;border-radius:5px;box-shadow:5px 5px 5px #888}#sbo-rt-content .InternalRefGlossaryEntry:hover .InlineGlossaryDefinition{display:block;z-index:6}#sbo-rt-content .TocAppendix{border-top:1px solid #bbb;margin-top:1em;padding-top:1em}#sbo-rt-content .BookContextInformation+.Appendix>.TocAppendix:first-child{border-top:none;padding-top:0}#sbo-rt-content .TocAppendix .Headings{margin-bottom:.5em}#sbo-rt-content .TocAppendix>.Headings>.Heading{font-size:1.44rem;margin:0}#sbo-rt-content .TocAppendix>.Headings>.SubHeading{font-size:1.2rem}#sbo-rt-content .TocEntry,#sbo-rt-content .TocPart,#sbo-rt-content .TocBack{margin-top:.5em;text-align:left !important}#sbo-rt-content .TocItem{font-weight:bold}#sbo-rt-content .TocPageNumber{display:none}#sbo-rt-content .TocAuthors{padding-left:1.5em}#sbo-rt-content .TocSection1,#sbo-rt-content .TocSection2,#sbo-rt-content .TocSection3,#sbo-rt-content .TocSection4,#sbo-rt-content .TocSection5,#sbo-rt-content .TocSection6,#sbo-rt-content .TocSection7{padding-left:1.5em}#sbo-rt-content .Index{border-top:1px solid #bbb;margin-top:1em;padding-top:.3em;margin-bottom:.8em}#sbo-rt-content .BookBackmatter>.Index:first-child{border-top:none;margin-top:0}#sbo-rt-content .Index .Headings{margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .BookBackmatter>.Index:first-child>.Headings{margin-top:0}#sbo-rt-content .Index>.Headings>.Heading{font-size:1.44rem;margin:0}#sbo-rt-content .Index>.Headings>.SubHeading{font-size:1.2rem}#sbo-rt-content .IndexDiv .Headings{margin-top:.5em;margin-bottom:.1em}#sbo-rt-content .IndexDiv>.Headings>.Heading{font-size:1.2rem;margin:0}#sbo-rt-content .IndexDiv>.Headings>.SubHeading{font-size:100%;font-style:italic}#sbo-rt-content .IndexEntrySeeLabel{font-style:italic;margin-left:1em;padding-right:.3em}#sbo-rt-content .SecondaryIE{margin-left:1em}#sbo-rt-content .TertiaryIE{margin-left:2em}#sbo-rt-content .ChangeHistory{border-top:1px solid #bbb;margin-top:1em}#sbo-rt-content .ChangeHistory>.Heading{font-size:1.44rem;margin-top:.8em;margin-bottom:.3em}#sbo-rt-content .ChangeDate{font-weight:bold;padding-right:1em}#sbo-rt-content .ChangeDetails{display:inline}#sbo-rt-content .ChangeDetails>p:first-of-type{display:inline}#sbo-rt-content .Bibliography{border-top:1px solid #bbb;margin-top:1em}#sbo-rt-content .BookBackmatter>.Bibliography:first-child{border-top:none}#sbo-rt-content .Bibliography>.Heading{font-size:1.44rem;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .BibliographyWrapper{display:table;margin:0;padding:0}#sbo-rt-content .Bibliography>.BibliographyWrapper{padding-top:1em}#sbo-rt-content .Bibliography>.Heading+.BibliographyWrapper{padding-top:0}#sbo-rt-content .BibSection>.Heading{font-size:1.2rem;margin-top:.8em;margin-bottom:.2em}#sbo-rt-content .BibliographyWrapper>.BibSection:first-child>.Heading:first-child{margin-top:.3em}#sbo-rt-content .Citation{display:table-row;font-size:90%}#sbo-rt-content .CitationNumber{display:table-cell}#sbo-rt-content .CitationNumber+.CitationContent{padding-left:.5em;text-align:left}#sbo-rt-content .CitationContent{padding-top:1em;display:table-cell}#sbo-rt-content .BibliographyWrapper>.Citation:first-child>.CitationContent{padding-top:0}#sbo-rt-content .Occurrences{display:block}#sbo-rt-content .Occurrence{margin-right:0}#sbo-rt-content .Occurrence:before{content:"["}#sbo-rt-content .Occurrence:after{content:"]"}#sbo-rt-content .Citation .ArticleTitle:before,#sbo-rt-content .Citation .ChapterTitle:before{content:" “";}#sbo-rt-content .Citation .ArticleTitle,#sbo-rt-content .Citation .ChapterTitle{display:inline}#sbo-rt-content .Citation .ArticleTitle:after{content:"”\ ";}#sbo-rt-content .Citation .ChapterTitle:after{content:"”\ In: ";}#sbo-rt-content .Citation .Year:before{content:" ("}#sbo-rt-content .Citation .Year:after{content:") "}#sbo-rt-content .Citation .JournalTitle:after{content:" "}#sbo-rt-content .Citation .VolumeID:after{content:":"}#sbo-rt-content .BibChapter .FirstPage:before,#sbo-rt-content .BibBook .FirstPage:before{content:", pp "}#sbo-rt-content .Citation .FirstPage+.LastPage:before{content:"–";}#sbo-rt-content .Citation .BookTitle:after,#sbo-rt-content .Citation .BibEditorName:after,#sbo-rt-content .Citation .EditionNumber:after,#sbo-rt-content .Citation .PublisherName:after{content:", "}#sbo-rt-content .BibComments{display:block}#sbo-rt-content .CoverFigure img{margin:0 auto 6px;width:100%;max-width:480px;height:auto}#sbo-rt-content .SeriesTitlePage{padding-bottom:1.5em;padding-top:1em}#sbo-rt-content .SeriesTitlePage .VolumeNumber{font-size:1.44rem}#sbo-rt-content .SeriesTitlePage span.SeriesTitle{display:block;font-size:1.73rem;font-weight:bold;margin-top:.5em}#sbo-rt-content .SeriesTitlePage .SeriesSubTitle{display:block;font-size:1.44rem;font-weight:bold}#sbo-rt-content .SeriesTitlePage .SubSeriesTitle{display:block;font-size:1.44rem;font-weight:bold;margin-top:.5em}#sbo-rt-content .SeriesTitlePage .SubSeriesSubTitle{display:block;font-size:1.2rem;font-weight:bold}#sbo-rt-content .SeriesTitlePage .CollaboratorDesignation{display:block;font-weight:bold;padding-top:3em}#sbo-rt-content .SeriesTitlePage .Collaborators{display:block}#sbo-rt-content .SeriesTitlePage .AffiliationText{font-style:italic;margin-left:0}#sbo-rt-content .SeriesTitlePage .Affiliation+.CollaboratorName{display:inline-block;margin-top:1em}#sbo-rt-content .SeriesInformationText{padding-top:3em}#sbo-rt-content .BookTitlePage{padding-top:1em}#sbo-rt-content .BookTitlePageAfterSeriesTitlePage{border-top:1px solid #bbb;page-break-before:always}#sbo-rt-content .BookContextInformation+.BookTitlePage{border-top:none;padding-top:0}#sbo-rt-content .BookTitlePage .BookEditors,#sbo-rt-content .BookTitlePage .BookAuthors,#sbo-rt-content .BookTitlePage .BookEditorInChiefGroup,#sbo-rt-content .BookTitlePage .BookSectionEditorGroup{text-align:left !important}#sbo-rt-content .BookTitlePage .BookEditorInChiefGroup,#sbo-rt-content .BookTitlePage .BookSectionEditorGroup{margin-top:1em}#sbo-rt-content .BookTitlePage .BookEditorGroup .CollaboratorDesignation,#sbo-rt-content .BookTitlePage .BookEditorInChiefGroup .CollaboratorDesignation,#sbo-rt-content .BookTitlePage .BookSectionEditorGroup .CollaboratorDesignation{font-style:italic}#sbo-rt-content .BookTitlePage .BookTitle{display:block;font-size:1.73rem;font-weight:bold;margin-top:1em}#sbo-rt-content .BookTitlePage .BookSubTitle{display:block;font-size:1.44rem;font-weight:bold;margin-bottom:.5em}#sbo-rt-content .BookTitlePage .BookEdition{display:block;font-size:1rem;font-weight:normal;margin-top:.5em}#sbo-rt-content .BookTitlePage .CollaboratorLine{padding-top:.5em}#sbo-rt-content .BookFeatureText{margin-top:.5em}#sbo-rt-content .BookTitlePage .PublisherLogo .Figure,#sbo-rt-content .BookTitlePage .PublisherImprintName{font-size:1.2rem;margin-top:4em;margin-bottom:1.5em;text-align:left}#sbo-rt-content .CopyrightPage{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .CopyrightPage .CollaboratorDesignation{display:block;font-style:italic;padding-bottom:.5em}#sbo-rt-content .CopyrightPageOriginators{padding-bottom:4em}#sbo-rt-content .CopyrightPage div+.CollaboratorDesignation{padding-top:2em}#sbo-rt-content .CopyrightPage .EditorGroup+.AuthorGroup{padding-top:2em}#sbo-rt-content .CopyrightPage .Author+.Author,#sbo-rt-content .CopyrightPage .Author+.InstitutionalAuthor,#sbo-rt-content .CopyrightPage .InstitutionalAuthor+.Author,#sbo-rt-content .CopyrightPage .InstitutionalAuthor+.InstitutionalAuthor,#sbo-rt-content .CopyrightPage .Editor+.Editor,#sbo-rt-content .CopyrightPage .Editor+.InstitutionalEditor,#sbo-rt-content .CopyrightPage .InstitutionalEditor+.Editor,#sbo-rt-content .CopyrightPage .InstitutionalEditor+.InstitutionalEditor,#sbo-rt-content .CopyrightPage .Collaborator+.Collaborator{padding-top:1em}#sbo-rt-content .CopyrightPage .Affiliation{margin-top:0}#sbo-rt-content .CopyrightPage .AffiliationText{margin-left:0}#sbo-rt-content .CopyrightPage .CollaboratorLine{padding-top:1em}#sbo-rt-content .CopyrightPage .CollaboratorLineTranslatedBy{padding-top:2em}#sbo-rt-content .CopyrightPage .CollaboratorLine .CollaboratorDesignation{display:inline;font-style:normal}#sbo-rt-content .BookFrontmatter .CopyrightPage .ArticleNoteESMHint,#sbo-rt-content .BookFrontmatter .CopyrightPage .ArticleNoteMoreMedia{border:none;padding-bottom:0;page-break-before:auto}#sbo-rt-content .CopyrightPageISBNs,#sbo-rt-content .CopyrightPageISSNs,#sbo-rt-content .SpringerLocationsLine,#sbo-rt-content .CatalogingInformation,#sbo-rt-content .MathematicsSubjectClassification,#sbo-rt-content .CopyrightLine,#sbo-rt-content .CopyrightPage .CopyrightComment,#sbo-rt-content .BookCopublishingInformation .SimplePara,#sbo-rt-content .CopyrightStandardText,#sbo-rt-content .TrademarkQualifierText,#sbo-rt-content .ProductLiability,#sbo-rt-content .LegalNotice,#sbo-rt-content .CoverDesigner,#sbo-rt-content .BookCoverFigureText,#sbo-rt-content .PaperInfo,#sbo-rt-content .SpringerReferenceLine{margin-top:1em}#sbo-rt-content .CopyrightComment+.CopyrightLine{margin-top:.5em}#sbo-rt-content .SeriesTitle+.CopyrightPageISBNs,#sbo-rt-content .SubSeriesTitle+.CopyrightPageISBNs{margin-top:0}#sbo-rt-content .CopyrightPage .SeriesTitle{display:block;margin-top:1em}#sbo-rt-content .SeriesTitle+.CopyrightPageISSNs,#sbo-rt-content .CopyrightPageISSNs+.SeriesTitle,#sbo-rt-content .CopyrightPageISSNs+.SubSeriesTitle{margin-top:0}#sbo-rt-content .CopyrightPagePrintISSN,#sbo-rt-content .CopyrightPagePrintISBN{display:inline-block;min-width:12em}#sbo-rt-content .SpringerReferenceLine .SimplePara+.SimplePara,#sbo-rt-content .BookCoverFigureText .SimplePara+.SimplePara,#sbo-rt-content .BookCopublishingInformation .SimplePara+.SimplePara{text-indent:0}#sbo-rt-content .CopyrightPagePrintISSN+.CopyrightPageElectronicISSN{padding-left:1.5em}#sbo-rt-content .CopyrightPagePrintISBN+.CopyrightPageElectronicISBN{padding-left:1.5em}#sbo-rt-content .CopyrightComment .SimplePara+.SimplePara{padding-top:.5em;text-indent:0}#sbo-rt-content .BookCorrectionYear:before{content:", "}#sbo-rt-content .BookCorrectionYear .Year:first-of-type:before{content:" "}#sbo-rt-content .BookCorrectionYear .Year+.Year:before{content:", "}#sbo-rt-content .MathematicsSubjectClassificationCode+.MathematicsSubjectClassificationCode:before{content:", "}#sbo-rt-content .Endorsement{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .Frontispiece{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .Dedication{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .Foreword{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .PartFrontmatter h1:first-child+.Foreword{border-top:none;padding-top:0;page-break-before:auto}#sbo-rt-content .ForewordTitle{font-size:1.44rem;font-weight:bold;padding-bottom:.1em;page-break-after:avoid}#sbo-rt-content .Foreword .AuthorName{margin-top:.2em}#sbo-rt-content .Foreword .AuthorName,#sbo-rt-content .ForewordLocations,#sbo-rt-content .ForewordDate{font-weight:bold;text-align:right}#sbo-rt-content .ForewordLocation+.ForewordLocation:before{content:", "}#sbo-rt-content .Foreword .RenderAsSection1>.Heading{font-size:1.2rem}#sbo-rt-content .Foreword .RenderAsSection2>.Heading,#sbo-rt-content .Foreword .RenderAsSection3>.Heading{font-size:100%}#sbo-rt-content .Preface{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .PrefaceTitle{font-size:1.44rem;font-weight:bold;padding-bottom:.1em;page-break-after:avoid}#sbo-rt-content .Preface .AuthorName{margin-top:.2em}#sbo-rt-content .Preface .AuthorName,#sbo-rt-content .PrefaceLocations,#sbo-rt-content .PrefaceDate{font-weight:bold;text-align:right}#sbo-rt-content .PrefaceLocation+.PrefaceLocation:before{content:", "}#sbo-rt-content .Preface .RenderAsSection1>.Heading{font-size:1.2rem}#sbo-rt-content .Preface .RenderAsSection2>.Heading,#sbo-rt-content .Preface .RenderAsSection3>.Heading{font-size:100%}#sbo-rt-content .BookFrontmatterArticleNote{border-top:1px solid #bbb;margin-top:0;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .PartFrontmatter .ArticleNote{padding-bottom:1em}#sbo-rt-content .PartFrontmatter h1:first-child+.ArticleNote{border-top:none;page-break-before:auto}#sbo-rt-content .BookFrontmatter .ArticleNote .Heading,#sbo-rt-content .PartFrontmatter .ArticleNote .Heading{font-size:1.44rem;font-style:normal;padding-bottom:.1em;page-break-after:avoid}#sbo-rt-content .BookAcknowledgments{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .BookAcknowledgmentsTitle{font-size:1.44rem;font-weight:bold;padding-bottom:.1em;page-break-after:avoid}#sbo-rt-content .BookAcknowledgments .AuthorName{font-weight:bold;margin-top:1em}#sbo-rt-content .BookAcknowledgments .RenderAsSection1>.Heading{font-size:1.2rem}#sbo-rt-content .BookAcknowledgments .RenderAsSection2>.Heading,#sbo-rt-content .BookAcknowledgments .RenderAsSection3>.Heading{font-size:100%}#sbo-rt-content .BookNotes{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .BookNotesTitle{font-size:1.44rem;font-weight:bold;margin-bottom:.1em;page-break-after:avoid}#sbo-rt-content .BookNotes .AuthorName{font-weight:bold}#sbo-rt-content .BookFrontmatterAbbreviationGroup{border-top:1px solid #bbb;margin-top:0;padding-bottom:1em;page-break-before:always}#sbo-rt-content .PartFrontmatter .AbbreviationGroup{padding-bottom:1em;margin-top:1em}#sbo-rt-content .BookFrontmatter .AbbreviationGroup .Heading,#sbo-rt-content .PartFrontmatter .AbbreviationGroup .Heading{font-size:1.44rem;font-weight:bold;padding-top:1em;padding-bottom:.1em;page-break-after:avoid}#sbo-rt-content .BookFrontmatter .AbbreviationGroupSection>.Heading,#sbo-rt-content .PartFrontmatter .AbbreviationGroupSection>.Heading{font-size:1.2rem;padding-top:1em;padding-bottom:0}#sbo-rt-content .BookFrontmatter .AbbreviationGroupSection+.AbbreviationGroupSection>.Heading,#sbo-rt-content .PartFrontmatter .AbbreviationGroupSection+.AbbreviationGroupSection>.Heading{padding-top:.5em}#sbo-rt-content .Toc{border-top:1px solid #bbb;margin-top:0;padding-bottom:1em;page-break-before:always}#sbo-rt-content .Toc .Headings{margin-bottom:.5em}#sbo-rt-content .Toc>.Headings>.Heading{font-size:1.44rem;margin:0}#sbo-rt-content .Toc>.Headings>.SubHeading{font-size:1.2rem}#sbo-rt-content .Loh{border-top:1px solid #bbb;padding-bottom:1em;padding-top:1em;page-break-before:always}#sbo-rt-content .Loh .Headings{margin-bottom:.1em}#sbo-rt-content .Loh>.Headings>.Heading{font-size:1.44rem;margin:0}#sbo-rt-content .Loh>.Headings>.SubHeading{font-size:1.2rem}#sbo-rt-content .LohPageNumber{display:none}#sbo-rt-content .LocWithHeading,#sbo-rt-content .LocWithoutHeading>.LocBody>.LocDiv{border-top:1px solid #bbb;padding-bottom:1em;padding-top:1em;page-break-before:always}#sbo-rt-content .Loc .Headings{margin-bottom:.1em}#sbo-rt-content .LocWithHeading>.Headings>.Heading,#sbo-rt-content .LocWithoutHeading>.LocBody>.LocDiv>.Headings>.Heading{font-size:1.44rem;margin:0}#sbo-rt-content .LocWithHeading>.Headings>.SubHeading,#sbo-rt-content .LocWithoutHeading>.LocBody>.LocDiv>.Headings>.SubHeading{font-size:1.2rem}#sbo-rt-content .LocWithHeading .LocDiv{margin-top:1em}#sbo-rt-content .LocWithHeading .LocDiv .Heading{font-size:1.2rem;margin-bottom:.1em}#sbo-rt-content .LocWithHeading .LocDiv .SubHeading{font-size:100%;font-style:italic;font-weight:normal}#sbo-rt-content .LocDiv .FormalPara .Heading{font-size:100%}#sbo-rt-content .Loc .AuthorGroup+.AuthorGroup,#sbo-rt-content .Loc .AuthorGroup+.EditorGroup,#sbo-rt-content .Loc .EditorGroup+.AuthorGroup,#sbo-rt-content .Loc .EditorGroup+.EditorGroup{margin-top:1em}#sbo-rt-content .Loc .Author,#sbo-rt-content .Loc .Editor,#sbo-rt-content .Loc .InstitutionalAuthor,#sbo-rt-content .Loc .InstitutionalEditor{font-weight:bold}#sbo-rt-content .Loc .AffiliationText{margin-left:0}#sbo-rt-content .Loc .Email+.Email:before{content:", "}#sbo-rt-content .Loc .Emails,#sbo-rt-content .Loc .URLs{display:inline}#sbo-rt-content .Loc .Emails+.URLs:before{content:", "}#sbo-rt-content .Loc .URL+.URL:before{content:", "}#sbo-rt-content .BookFrontmatterFootnoteSection{border-top:1px solid #bbb;margin-top:0;page-break-before:always}#sbo-rt-content .PartFrontmatter .FootnoteSection{border-top:none;margin-top:0}#sbo-rt-content .Colophon{border-top:1px solid #bbb;margin-top:1em;padding-top:.8em;font-style:italic}#sbo-rt-content .ConferenceInfo{border-top:1px solid #bbb;margin-top:1em;padding-top:.8em}#sbo-rt-content .ConfEventAbbreviation,#sbo-rt-content .ConfNumber+.ConfSeriesName,#sbo-rt-content .ConfEventAbbreviation+.Year,#sbo-rt-content .ConfEventDateStart,#sbo-rt-content .ConfEventDateEnd{display:inline}#sbo-rt-content .ConfEventAbbreviation:after{content:" "}#sbo-rt-content .ConfEventLocation .City:after{content:", "}#sbo-rt-content .ConfEventDateEnd:before{content:"–"}#sbo-rt-content .ConfEventDateStart .Year:after,#sbo-rt-content .ConfEventDateStart .Month:after,#sbo-rt-content .ConfEventDateEnd .Year:after,#sbo-rt-content .ConfEventDateEnd .Month:after{content:"/"}#sbo-rt-content .ConfEventDate .Month:after{content:"/"}
    </style><script id="twitter-wjs" src="https://platform.twitter.com/widgets.js"></script><script type="text/javascript" async="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/cool-2.1.15.下载"></script><script crossorigin="anonymous" integrity="sha256-4akcsqklmUmtNjRgapND1hbNA1NRfbSO24PnriCCqNI=" type="text/javascript" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/appcues.mai.下载" async=""></script><script type="text/javascript" async="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/ec.js.下载"></script><script src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/44379297284583" async=""></script><script src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/17326874269685" async=""></script><script async="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/fbevents.js.下载"></script><script type="text/javascript" async="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/f.txt"></script><script type="text/javascript" async="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/analytics.j.下载"></script><script type="text/javascript" async="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/bat.js.下载"></script><script type="text/javascript" async="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/f.txt"></script><script type="text/javascript" async="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/insight.min.下载"></script><script type="text/javascript" async="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/f.txt"></script><script async="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/gtm.js.下载"></script><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9781484245019/chapter/html/477630_1_En_14_Chapter.xhtml",
          "book_id": "9781484245019",
          "chapter_uri": "html/477630_1_En_14_Chapter.xhtml",
          "position": 0.0,
          "user_uuid": "6d9ee17b-34b1-4bf4-bdae-19676bd84ca1",
          "next_chapter_uri": "/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_15_Chapter.xhtml"
        
      },
      title: "Practical Microservices Architectural Patterns: Event\u002DBased Java Microservices with Spring Boot and Spring Cloud",
      author_list: "Binildas Christudas",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: false
    };
    // ]]></script><script src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/modernizr.8.下载"></script><script>
    
      

      
        
          window.PUBLIC_ANNOTATIONS = true;
        
      

      window.MOBILE_PUBLIC_ANNOTATIONS = false;

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

      window.PRIVACY_CONTROL_SWITCH = true;

      window.PUBLISHER_PAGES = true;

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://learning.oreilly.com/api/v2/search/select/",
          "ENABLE_ONLINE_TRAINING": true
        }
      };
  </script><link rel="canonical" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml"><meta name="description" content="© Binildas Christudas 2019 Binildas ChristudasPractical Microservices Architectural Patternshttps://doi.org/10.1007/978-1-4842-4501-9_14 14. Transactions and Microservices Binildas Christudas1  (1)Trivandrum, Kerala, India   Chapter 13 covered distributed transactions extensively. You now ...!--end&gt;!--begin&gt; "><meta property="og:title" content="14. Transactions and Microservices"><meta itemprop="isPartOf" content="/library/view/practical-microservices-architectural/9781484245019/"><meta itemprop="name" content="14. Transactions and Microservices"><meta property="og:url" itemprop="url" content="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://learning.oreilly.com/library/cover/9781484245019/"><meta property="og:description" itemprop="description" content="© Binildas Christudas 2019 Binildas ChristudasPractical Microservices Architectural Patternshttps://doi.org/10.1007/978-1-4842-4501-9_14 14. Transactions and Microservices Binildas Christudas1  (1)Trivandrum, Kerala, India   Chapter 13 covered distributed transactions extensively. You now ...!--end&gt;!--begin&gt; "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Apress"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781484245019"><meta property="og:book:author" itemprop="author" content="Binildas Christudas"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@OReillyMedia"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: &lt;%= font_size %&gt; !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: &lt;%= font_family %&gt; !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: &lt;%= column_width %&gt;% !important; margin: 0 auto !important; }"></style><noscript><meta http-equiv="refresh" content="0; url=/library/no-js/" /></noscript><script>
    var dataLayer = window.dataLayer || [];

    
      window.medalliaVsgUserIdentifier = '6d9ee17b-34b1-4bf4-bdae-19676bd84ca1';
      dataLayer.push({userIdentifier: '6d9ee17b-34b1-4bf4-bdae-19676bd84ca1'});
      dataLayer.push({loggedIn: 'yes'});

      
        window.medalliaVsgAccountIdentifier = '20b4a98e-dfa5-4bb6-bdfb-97a15a9c3f0d';
        
        dataLayer.push({orgID: '20b4a98e-dfa5-4bb6-bdfb-97a15a9c3f0d'});
        

        window.medalliaVsgIsIndividual = false;
        
          
          dataLayer.push({learningAccountType: 'enterprise'});
          
        

        
          dataLayer.push({learningPaidAccount: 'yes'});
        
      
    

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5P4V6Z');
    (function () {
      var VERSION = 'V1.1';
      var AUTHOR = 'Awwad';
      if (!window.GtmHelper)
        window.GtmHelper = function () {
          var instance = this;
          var loc = document.location;
          this.version = VERSION;
          this.author = AUTHOR;
          this.readCookie = function (name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') c = c.substring(1, c.length);
              if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
          };
          this.createCookie = function (name, value, days, cookieDomain) {
            var domain = "";
            var expires = "";

            if (days) {
              var date = new Date();
              date.setTime(date.getTime() + Math.ceil(days * 24 * 60 * 60 * 1000));
              var expires = " expires=" + date.toGMTString() + ";";
            }

            if (typeof (cookieDomain) != 'undefined')
              domain = " domain=" + cookieDomain + "; ";

            document.cookie = name + "=" + value + ";" + expires + domain + "path=/";
          };

          this.isDuplicated = function (currentTransactionId) {
            // the previous transaction id:
            var previousTransIdValue = this.readCookie("previousTransId");

            if (currentTransactionId === previousTransIdValue) {
              return true; // Duplication
            } else {
              return false;
            }
          };
        }
    })()
  </script><script defer="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/vendor.a7a9.下载"></script><script defer="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/reader.90cf.下载"></script><script src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/f(1).txt"></script><script src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/f(2).txt"></script><script src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/f(3).txt"></script><script async="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/MathJax.js.下载"></script><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style><iframe src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/saved_res.html"></iframe><iframe src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/sav(1).html"></iframe><iframe src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/sav(2).html"></iframe><link rel="stylesheet" type="text/css" integrity="sha256-m9iQXscob5jO+vyfe0sovuV3lxwPoNxtAuVQYG3yl4o=" crossorigin="anonymous" href="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/container..css"><iframe src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/sav(3).html"></iframe><style type="text/css" id="kampyleStyle">.noOutline{outline: none !important;}.wcagOutline:focus{outline: 1px dashed #595959 !important;outline-offset: 2px !important;transition: none !important;}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library">

    
  <noscript> 
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P4V6Z"
            height="0" width="0"
            style="display:none;visibility:hidden">
    </iframe>
  </noscript>



    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        

  


<a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li><a href="https://learning.oreilly.com/home/" class="l0 nav-icn"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.738 14H9.254v-3.676a.617.617 0 0 0-.621-.613H7.39a.617.617 0 0 0-.62.613V14H4.284a.617.617 0 0 1-.622-.613V10.22c0-.327.132-.64.367-.87l3.547-3.493a.627.627 0 0 1 .875 0l3.54 3.499c.234.229.366.54.367.864v3.167a.617.617 0 0 1-.62.613zM7.57 2.181a.625.625 0 0 1 .882 0l5.77 5.692-.93.92-5.28-5.209-5.28 5.208-.932-.919 5.77-5.692z"></path></svg><span>Home</span></a></li><li class="search"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" class="l1 nav-icn "><!--?xml version="1.0" encoding="UTF-8"?--><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M8,8 C6.34321755,8 5.00013,6.65691245 5.00013,5.00013 C5.00013,3.34334755 6.34321755,2.00026001 8,2.00026001 C9.65678245,2.00026001 10.99987,3.34334755 10.99987,5.00013 C10.99987,6.65691245 9.65678245,8 8,8 Z M2.33024571,11.3523547 L2.33774538,11.3523547 C3.7622187,9.70968996 5.82947484,8.76608166 8.00374984,8.76608166 C10.1780248,8.76608166 12.245281,9.70968996 13.6697543,11.3523547 C13.8892083,11.6177474 14.0062813,11.9530021 13.99974,12.2973138 L13.99974,13.99974 L2.00026001,13.99974 L2.00026001,12.2973138 C1.99371867,11.9530021 2.11079172,11.6177474 2.33024571,11.3523547 Z" id="path-1"></path></svg><span>Your O'Reilly</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/profile/" class="l2 nav-icn"><span>Profile</span></a></li><li><a href="https://learning.oreilly.com/history/" class="l2 nav-icn"><span>History</span></a></li><li><a href="https://learning.oreilly.com/playlists/" class="l2 nav-icn"><span>Playlists</span></a></li><li><a href="https://learning.oreilly.com/u/6d9ee17b-34b1-4bf4-bdae-19676bd84ca1/" class="l2 nav-icn"><span>Highlights</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Featured</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/featured/navigating-21st-century/" class="l2 nav-icn"><span>Navigating Change</span></a></li><li><a href="https://learning.oreilly.com/recommendations/" class="l2 nav-icn"><span>Recommended</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"></path></g></svg><span>Explore</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/topics/" class="l2 nav-icn"><span>All Topics</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;sort=publication_date&amp;facet_json=true&amp;page=0" class="l2 nav-icn"><span>Early Releases</span></a></li><li><a href="https://learning.oreilly.com/playlists/discover/" class="l2 nav-icn"><span>Shared Playlists</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;formats=case%20study&amp;formats=learning%20path&amp;formats=live%20online%20training&amp;formats=notebook&amp;formats=oriole&amp;formats=video&amp;sort=popularity&amp;facet_json=true&amp;page=0&amp;collection_type=expert" class="l2 nav-icn"><span>Most Popular Titles</span></a></li><li><a href="https://learning.oreilly.com/resource-centers/" class="l2 nav-icn"><span>Resource Centers</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M12.8 3.2A1.2 1.2 0 0 1 14 4.4v8.4a1.2 1.2 0 0 1-1.2 1.2H3.2A1.2 1.2 0 0 1 2 12.8V4.4a1.2 1.2 0 0 1 1.2-1.2h1.2V2h1.2v1.2h4.8V2h1.2v1.2h1.2zm-9.6 9.6h9.6V6.2H3.2v6.6zM8 9.5a1.35 1.35 0 1 1 0-2.7 1.35 1.35 0 0 1 0 2.7zm2.7 2.148v.552H5.3v-.552c0-.321.124-.634.355-.858a3.358 3.358 0 0 1 4.69 0c.23.224.355.537.355.858z"></path></svg><span>Live Events</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/featured/strata/" class="l2 nav-icn"><span>Strata</span></a></li><li><a href="https://learning.oreilly.com/featured/oscon/" class="l2 nav-icn"><span>Open Source</span></a></li><li><a href="https://learning.oreilly.com/featured/infrastructure-ops/" class="l2 nav-icn"><span>Infra &amp; Ops</span></a></li><li><a href="https://learning.oreilly.com/featured/software-architecture/" class="l2 nav-icn"><span>Software Arch</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" class="l1 nav-icn "><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.6467109,4.35328907 L14.7964612,7.51003884 C15.0678463,7.78304342 15.0678463,8.22395603 14.7964612,8.49696061 L11.6467109,11.6467109 L10.6597892,10.6597892 L13.3055794,8 L10.6597892,5.34021084 L11.6467109,4.35328907 Z M4.35328907,11.6467109 L1.20353875,8.48996116 C0.932153749,8.21695658 0.932153749,7.77604397 1.20353875,7.50303939 L4.35328907,4.35328907 L5.34021084,5.34021084 L2.69442057,8 L5.34021084,10.6597892 L4.35328907,11.6467109 Z M5.84417089,11.4997226 L8.67194674,4.50027742 L10.1838269,4.50027742 L7.35605105,11.4997226 L5.84417089,11.4997226 Z" id="Mask"></path></svg><span>Practice</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/scenarios/" class="l2 nav-icn"><span>Katacoda Scenarios</span></a></li><li><a href="https://learning.oreilly.com/interactive/#notebooks" class="l2 nav-icn"><span>Jupyter Notebooks</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" class="l1 nav-icn "><!--?xml version="1.0" encoding="UTF-8"?--><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M10.0440191,12.1582649 C10.177209,12.3351976 10.2476998,12.552011 10.2434767,12.7742985 L10.2434767,13.9482829 L1.96869684,13.9482829 L1.96869684,12.7742985 C1.96418597,12.536863 2.04491894,12.3056731 2.19625329,12.1226596 L2.20142503,12.1226596 C3.18373453,10.9898864 4.60930376,10.339179 6.10867266,10.339179 C7.30793519,10.339179 8.45998426,10.7554703 9.37576632,11.5017585 L14.3434936,11.5017585 L14.3434936,3.65650645 L1.65650645,3.65650645 L1.65650645,11.5017585 L2.06682298,11.5017585 L1.82063306,12.1582649 L1.32825322,12.1582649 C1.14771395,12.1582649 1,12.010551 1,11.8300117 L1,3.32825322 C1,3.14771395 1.14771395,3 1.32825322,3 L14.6717468,3 C14.852286,3 15,3.14771395 15,3.32825322 L15,11.8300117 C15,12.010551 14.852286,12.1582649 14.6717468,12.1582649 L10.0440191,12.1582649 Z M12.5483683,7.16419284 C12.6159362,7.20929881 12.6563112,7.2853432 12.6558247,7.36658194 C12.6553382,7.44782068 12.6140555,7.5233761 12.5459522,7.56766966 L10.4270949,8.91581376 C10.3903366,8.94010203 10.3431312,8.9419685 10.3045699,8.9206583 C10.2660086,8.89934811 10.2424712,8.85838696 10.2434767,8.81434055 L10.2434767,5.91510593 C10.2420711,5.86982855 10.2666257,5.82771857 10.3067229,5.80664182 C10.3468202,5.78556507 10.3954292,5.7892172 10.431927,5.81604875 L12.5483683,7.16419284 Z M6.10608679,9.81089299 C4.9635781,9.81089299 4.03739181,8.8847067 4.03739181,7.74219802 C4.03739181,6.59968933 4.9635781,5.67350304 6.10608679,5.67350304 C7.24859547,5.67350304 8.17478176,6.59968933 8.17478176,7.74219802 C8.17478176,8.8847067 7.24859547,9.81089299 6.10608679,9.81089299 Z"></path></svg><span>Sandboxes</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/scenarios/kubernetes-sandbox/9781492062820/" class="l2 nav-icn"><span>Kubernetes</span></a></li><li><a href="https://learning.oreilly.com/scenarios/python-sandbox/9781492062844/" class="l2 nav-icn"><span>Python</span></a></li><li><a href="https://learning.oreilly.com/scenarios/tensorflow-sandbox/9781492062851/" class="l2 nav-icn"><span>TensorFlow</span></a></li><li><a href="https://learning.oreilly.com/scenarios/ubuntu-sandbox/9781492062837/" class="l2 nav-icn"><span>Ubuntu</span></a></li></ul></li><li><a href="https://learning.oreilly.com/live-training/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M13.4 9.8a.6.6 0 0 1 .6.6v1.2h-1.2l-.6 2.4H3.8l-.6-2.4H2v-1.2a.6.6 0 0 1 .6-.6h10.8zM8 5.6a1.8 1.8 0 1 1-.001-3.599A1.8 1.8 0 0 1 8 5.6zm3.6 2.35v.95H4.4v-.95c0-.167.066-.33.19-.443A5.08 5.08 0 0 1 8 6.2a5.08 5.08 0 0 1 3.41 1.307c.124.113.19.276.19.444z"></path></svg><span>Attend</span></a></li><li><a href="https://learning.oreilly.com/certifications/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M12.912 9.18L14 8.014l-1.088-1.18a.304.304 0 01-.075-.268L13.195 5l-1.535-.463a.313.313 0 01-.194-.194l-.462-1.537-1.565.358c-.09.03-.194 0-.269-.074L8.007 2 6.845 3.09a.303.303 0 01-.269.074l-1.565-.358-.462 1.537a.313.313 0 01-.194.194L2.82 5l.358 1.567a.26.26 0 01-.075.269L2 8.015l1.088 1.164c.075.075.09.18.075.269l-.358 1.567 1.535.463c.09.03.164.104.194.194l.462 1.537 1.565-.358c.015 0 .045-.015.075-.015.075 0 .15.03.209.074L8.007 14l1.163-1.09a.303.303 0 01.269-.074l1.565.358.462-1.537a.313.313 0 01.194-.194L13.195 11l-.358-1.567a.338.338 0 01.075-.254zm-6.046 1.37L4.41 8.26l1.16-1.244 1.767 1.649L10.4 5.6l1.202 1.202-4.242 4.243-.495-.495z"></path></svg><span>Certifications</span></a></li><li><a href="https://get.oreilly.com/email-signup.html" class="l1 nav-icn " target="&quot;_blank&quot;"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Newsletters</span></a></li><li><a href="https://learning.oreilly.com/u/preferences/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a></li><li><a href="https://learning.oreilly.com/public/support/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M7.363 6.656a2.692 2.692 0 0 1-2.681-2.703c0-1.493 1.2-2.703 2.681-2.703a2.692 2.692 0 0 1 2.682 2.703c0 1.493-1.2 2.703-2.682 2.703zm4.023 2.027c-1.852 0-3.352 1.513-3.352 3.379H2v-1.534c-.006-.31.099-.612.295-.852a6.666 6.666 0 0 1 9.09-.993zm-.543.676h1.12v.304c.003.284.16.543.408.676a.766.766 0 0 0 .77 0l.303-.176.556.966-.302.176a.772.772 0 0 0-.362.676v.08a.772.772 0 0 0 .362.677l.302.21-.556.965-.302-.175a.766.766 0 0 0-.771 0 .778.778 0 0 0-.409.675v.352h-1.106v-.372a.778.778 0 0 0-.409-.676.766.766 0 0 0-.77 0l-.303.176-.556-.912.302-.176a.772.772 0 0 0 .362-.676v-.04-.04a.772.772 0 0 0-.362-.676l-.302-.176.556-.966.289.155a.766.766 0 0 0 .77 0 .778.778 0 0 0 .41-.676V9.36zm1.562 2.703c0-.271-.108-.531-.3-.722a1.001 1.001 0 0 0-.72-.292 1.01 1.01 0 0 0-.992 1.023 1.01 1.01 0 0 0 1.01 1.004 1.01 1.01 0 0 0 1.002-1.013z"></path></svg><span>Support</span></a></li><li><a href="https://learning.oreilly.com/accounts/logout/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.613 12.63A.607.607 0 0 1 2 12.03V3.602C2 3.269 2.274 3 2.613 3h5.515v1.204H3.226v7.223h4.902v1.203H2.613zM5.677 9.02V6.611h4.903V4.926a.301.301 0 0 1 .19-.274.31.31 0 0 1 .33.063l2.722 2.673a.594.594 0 0 1 0 .849L11.1 10.909a.31.31 0 0 1-.331.063.301.301 0 0 1-.19-.274V9.02H5.677z"></path></svg><span>Sign Out</span></a></li></ul></div></li></ul></nav></header>



      </div><script type="text/javascript" id="">!function(b,e,f,g,a,c,d){b.fbq||(a=b.fbq=function(){a.callMethod?a.callMethod.apply(a,arguments):a.queue.push(arguments)},b._fbq||(b._fbq=a),a.push=a,a.loaded=!0,a.version="2.0",a.queue=[],c=e.createElement(f),c.async=!0,c.src=g,d=e.getElementsByTagName(f)[0],d.parentNode.insertBefore(c,d))}(window,document,"script","https://connect.facebook.net/en_US/fbevents.js");fbq("init","1732687426968531");fbq("track","PageView");</script>
<noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=1732687426968531&amp;ev=PageView&amp;noscript=1"></noscript><script type="text/javascript" id="">(function(){window.medalliaUserIdentifier=document.documentElement.dataset.userUuid;window.medalliaUserName=document.documentElement.dataset.username})();</script>
<script type="text/javascript" id="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/embed.js.下载"></script>
<script type="text/javascript" id="">!function(b,e,f,g,a,c,d){b.fbq||(a=b.fbq=function(){a.callMethod?a.callMethod.apply(a,arguments):a.queue.push(arguments)},b._fbq||(b._fbq=a),a.push=a,a.loaded=!0,a.version="2.0",a.queue=[],c=e.createElement(f),c.async=!0,c.src=g,d=e.getElementsByTagName(f)[0],d.parentNode.insertBefore(c,d))}(window,document,"script","https://connect.facebook.net/en_US/fbevents.js");fbq("init","443792972845831");fbq("set","agent","tmgoogletagmanager","443792972845831");fbq("track","PageView");</script>
<noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=443792972845831&amp;ev=PageView&amp;noscript=1"></noscript>

<script type="text/javascript" id="">!function(b,e,f,g,a,c,d){b.fbq||(a=b.fbq=function(){a.callMethod?a.callMethod.apply(a,arguments):a.queue.push(arguments)},b._fbq||(b._fbq=a),a.push=a,a.loaded=!0,a.version="2.0",a.queue=[],c=e.createElement(f),c.async=!0,c.src=g,d=e.getElementsByTagName(f)[0],d.parentNode.insertBefore(c,d))}(window,document,"script","https://connect.facebook.net/en_US/fbevents.js");fbq("init","443792972845831");fbq("track","PageView");</script>
<noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=443792972845831&amp;ev=PageView&amp;noscript=1"></noscript>
<div style="width:0px; height:0px; display:none; visibility:hidden;" id="batBeacon0.7593249677173703"><img style="width:0px; height:0px; display:none; visibility:hidden;" id="batBeacon0.02189938972141503" width="0" height="0" alt="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/0"></div>
      <div id="container" class="application" style="height: auto;">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Practical Microservices Architectural Patterns: Event-Based Java Microservices with Spring Boot and Spring Cloud
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" title="Search in archive" class="js-search-controls search-controls" onclick="window.Appcues.track(&#39;SearchBook_HeronBook&#39;)"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9781484245019/chapter/html/477630_1_En_14_Chapter.xhtml"><div class="js-collections-dropdown collections-dropdown menu-bit-cards" onclick="window.Appcues.track(&#39;AddPlaylist_HeronBook&#39;)"><div data-reactroot="" class="menu-dropdown-wrapper js-menu-dropdown-wrapper align-right"><img class="hidden" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/ajax-trans.gif" alt="loading spinner"><div class="menu-control"><div class="control "><div class="js-playlists-menu"><button class="js-playlist-icon"><svg class="icon-add-to-playlist-sml" viewBox="0 0 16 14" version="1.1" xmlns="http://www.w3.org/2000/svg"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g fill-rule="nonzero" fill="#000000"><g transform="translate(-1.000000, 0.000000)"><rect x="5" y="0" width="12" height="2"></rect><title>Playlists</title><path d="M4.5,14 C6.43299662,14 8,12.4329966 8,10.5 C8,8.56700338 6.43299662,7 4.5,7 C2.56700338,7 1,8.56700338 1,10.5 C1,12.4329966 2.56700338,14 4.5,14 Z M2.5,10 L4,10 L4,8.5 L5,8.5 L5,10 L6.5,10 L6.5,11 L5,11 L5,12.5 L4,12.5 L4,11 L2.5,11 L2.5,10 Z"></path><circle cx="2" cy="5" r="1"></circle><circle cx="1.94117647" cy="1" r="1"></circle><rect x="5" y="4" width="12" height="2"></rect><rect x="9" y="8" width="8" height="2"></rect><rect x="9" y="12" width="8" height="2"></rect></g></g></g></svg><div class="js-playlist-addto-label">Add&nbsp;To</div></button></div></div></div></div></div></div></li><li class="js-font-control-panel font-control-activator"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size" onclick="window.Appcues.track(&#39;ChangeFont_HeronBook&#39;)"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" class="trigger" data-push-state="false" title="Share" aria-label="Share" onclick="window.Appcues.track(&#39;Share_HeronBook&#39;)"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml&amp;text=Practical%20Microservices%20Architectural%20Patterns%3A%20Event-Based%20Java%20Microservices%20with%20Spring%20Boot%20and%20Spring%20Cloud&amp;via=OReillyMedia"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%2014.%C2%A0Transactions%20and%20Microservices&amp;body=https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml%0D%0Afrom%20Practical%20Microservices%20Architectural%20Patterns%3A%20Event-Based%20Java%20Microservices%20with%20Spring%20Boot%20and%20Spring%20Cloud%0D%0A"><span>Email</span></a></li></ul></li><!-- endif request.user.is_authenticated -->
      </ul>
    </div>

      
          
      

    <section role="document">
        
        




  <script defer="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/djangoMessa.下载"></script>


        <script src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/48743.js.下载"></script>
<script>
  var userId = "6d9ee17b-34b1-4bf4-bdae-19676bd84ca1";

  var userObject = {
    firstName: "Feng",
    segment: "B2B",
    admin: "False",
    profileCreatedOn: "2019-03-11",
    academic: "false"
  };
  window.Appcues.identify(userId, userObject);
  window.Appcues.page();

  setTimeout(function () {
    window.Appcues.track('ViewingBook_HeronBook')
  }, 20000);
</script>


	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">13.&nbsp;Distributed Transactions</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_15_Chapter.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">15.&nbsp;Transactions Optimized for Microservices</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content" style="transform: none;"><div class="annotator-wrapper"><div class="ChapterContextInformation"><div class="ContextInformation" id="b978-1-4842-4501-9_14"><div class="ChapterCopyright">©&nbsp;Binildas Christudas&nbsp;2019</div><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">Binildas&nbsp;Christudas</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" epub:type="title" lang="en">Practical Microservices Architectural Patterns</span></span><span class="ChapterDOI"><a href="https://doi.org/10.1007/978-1-4842-4501-9_14">https://doi.org/10.1007/978-1-4842-4501-9_14</a></span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" lang="en">14.&nbsp;Transactions and Microservices</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">Binildas&nbsp;Christudas</span><sup><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Aff2" class="totri-footnote">1</a>&nbsp;<span class="ContactIcon"></span></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">Trivandrum, Kerala, India</div></div><div class="ClearBoth">&nbsp;</div></div></div><!--End Abstract--><div class="Fulltext"><p class="Para" id="Par2">Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span> covered distributed transactions extensively. You now understand distributed transactions clearly so you use them judiciously. To make it clear, you want to avoid distributed transactions as much as possible in the microservices world across partitions and domains. I do not say that distributed transactions should be deprecated completely in microservices architecture because there are areas where you want to use them by trading loose coupling for reliability; however, the essence is that you can do most of the design without actually using distributed transactions when cross-partitions and cross-domains are involved. You will look at how to do this in detail<sup><a epub:type="noteref" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fn1" id="Fn1_source" class="totri-footnote">1</a></sup> in this chapter. The examples in this chapter are a continuation of the examples from Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>, so you may want to read and understand Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span> before you attempt to run the examples in this chapter.</p><div class="Para" id="Par4">You will look into these aspects in this chapter:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par5">The effect of distributing data across microservices</p></li><li><p class="Para" id="Par6">Distinguishing between global and local transactions</p></li><li><p class="Para" id="Par7">Enhancing the example in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span> to make it fault tolerant</p></li><li><p class="Para" id="Par8">Exploring further design refactorings that you can use in your actual microservices work</p></li></ul></div></div><section class="Section1 RenderAsSection1" id="Sec1"><h2 class="Heading">Partitioning and Microservices</h2><p class="Para" id="Par9">The best method to maximize <span id="ITerm1">consistency</span> is to avoid partitions. No partitions means you have a single software process handling all of your processing. Time has revealed that software processes have limitations, and vertical scaling cannot be increased linearly if not exponentially after a certain limit; this was discussed in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_11_Chapter.xhtml"><span class="RefSource">11</span></a></span>’s “The Scale Cube” <span id="ITerm2">section</span>. It is in this context that people use horizontal scaling methodologies to improve scalability. The moment you split processing into more than one software process, you have introduced probability for partitions, and the more partitions you have, the less consistency you can achieve. Microservices are no exception. When you split a <span id="ITerm3">monolith application</span> into a microservices-based architecture, you have increased the number of nodes or software processes across which you have split your processing logic, and the coordination of this processing has to be done using a <span id="ITerm4">network</span>. Network or process boundaries bring all the associated complexities and uncertainties, and you can no longer be certain on how and when end-to-end software processing will complete. It is in this context that you have been leveraging two-phase commit protocols to decrease uncertainty.</p><p class="Para" id="Par10">Software processes that execute requests as part of a two-phase commit protocol need to be able to communicate with one another to coordinate their actions when the transaction commits. In the first phase of the two-phase commit protocol, the coordinator, which is typically the process originating the transaction, will ask all the participants if they are prepared to commit; in the second phase, the coordinator instructs them to commit (or abort) the transaction. If a participant resource manager can commit its part of a transaction, it will agree as soon as it has recorded the changes it has made (to the resources) and its status in permanent storage, and is therefore prepared to commit. Thus the two-phase commit protocol consists of a voting phase and a completion phase. All of these additional steps add to the main processing instructions and in this manner <span id="ITerm5">two-phase commit protocols</span> are comparatively expensive since they take more time to complete compared to local transactions.</p><p class="Para" id="Par11">Even two-phase commit protocols are not completely error free. There are cases where towards the end of the two-phase commit <span id="ITerm6">protocol</span>, after all of the participants have agreed to commit, some resources can go out of order where the commit will not get completed. However, the protocol by design can tolerate such failures (server crashes, network failures, or lost messages) and is guaranteed to complete eventually, with or without manual intervention, although it is not possible to specify a time limit within which it will be completed.</p><section class="Section2 RenderAsSection2" id="Sec2"><h3 class="Heading">Microservices and Distributed Data</h3><div class="Para" id="Par12">Typical monolith applications have all or most data collocated in a single database, and this offers simplicity and many control options for the application in terms of <span id="ITerm7">consistency</span>. For example, look at the two data tables introduced in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>, shown here as Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig1">14-1</a></span>.<figure class="Figure" id="Fig1"><div class="MediaObject" id="MO1"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig1_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E.jpg" style="height:7.25em" width="1498" height="290" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig1_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-1</span><p class="SimplePara">The <span id="ITerm8">User Balance table</span></p></div></figcaption></figure></div><div class="Para" id="Par13">Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig1">14-1</a></span> shows the <span class="EmphasisFontCategoryNonProportional ">User Balance</span> table, which is an aggregated view of the running balance for the users. Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig2">14-2</a></span> shows the <span class="EmphasisFontCategoryNonProportional ">Quotes</span> table, which maintains the transaction history.<figure class="Figure" id="Fig2"><div class="MediaObject" id="MO2"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig2_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(1).jpg" style="height:7.82em" width="1501" height="313" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig2_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-2</span><p class="SimplePara">The <span id="ITerm9">Quotes table</span></p></div></figcaption></figure></div><div class="Para" id="Par14">You know that when a new quote is created, its status is “New.” When a quote is processed and settled, its status gets updated to “Confirmed” and simultaneously the value of the quote gets added to the running balances of both the buyer and the seller in the <span class="EmphasisFontCategoryNonProportional ">User Balance</span> table. These two actions must be atomic, and if it’s a monolith system, you can make the operations atomic within the span of a local transaction. See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC1">14-1</a></span>.<div class="ProgramCode" id="PC1"><div class="LineGroup"><div class="FixedLine">Start Local Transaction</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Update Quote Status</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Increment or Decrement User Balance</div><div class="FixedLine">End Local Transaction</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-1</span><p class="SimplePara">Transactions in a <span id="ITerm10">Monolith application</span></p></div></div></div></div><div class="Para" id="Par15">When you split the processing into more than one microservice, as per the principle of microservices design, each microservice will manage its own data. This means, the Quote Processing microservice will own and manage the <span class="EmphasisFontCategoryNonProportional ">Quotes</span> table, whereas the Quote Settlement microservice will own and manage the <span class="EmphasisFontCategoryNonProportional ">User Balance</span> table. If you use two-phase commit global transactions, the actions will be as shown in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC2">14-2</a></span>.<div class="ProgramCode" id="PC2"><div class="LineGroup"><div class="FixedLine">Start Global Transaction</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Update Quote Status</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Increment or Decrement User Balance</div><div class="FixedLine">End Global Transaction</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-2</span><p class="SimplePara">Global Transactions in <span id="ITerm11">Microservices</span></p></div></div></div></div><div class="Para" id="Par16">If you do not use two-phase commit transaction for the operations described in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC2">14-2</a></span>, then the two actions will have to be done separate by the two microservices and this means the atomicity between these two actions has to be relaxed. See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC3">14-3</a></span>.<div class="ProgramCode" id="PC3"><div class="LineGroup"><div class="FixedLine">Start Local Transaction</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Update Quote Status</div><div class="FixedLine">End Local Transaction</div><div class="FixedLine">Start Local Transaction</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Increment or Decrement User Balance</div><div class="FixedLine">End Local Transaction</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-3</span><p class="SimplePara"><span id="ITerm12">Local Transactions</span> in Microservices</p></div></div></div></div><div class="Para" id="Par17">There is a possibility that when the quote status is changed from “New” to “Confirmed” something will go wrong just after this change in such a manner that the addition-deduction of the value of the quote to the buyer and the seller in the <span class="EmphasisFontCategoryNonProportional ">User Balance</span> table won’t happen, so the quote settlement is missed! See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC4">14-4</a></span>.<div class="ProgramCode" id="PC4"><div class="LineGroup"><div class="FixedLine">Start Local Transaction</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Update Quote Status</div><div class="FixedLine">End Local Transaction</div><div class="FixedLine">Start Local Transaction</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Increment or Decrement User Balance</div><div class="FixedLine">End Local Transaction !ERROR</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-4</span><p class="SimplePara"><span id="ITerm13">Local Transactions</span> in Microservice Error Scenario</p></div></div></div></div><p class="Para" id="Par18">Whether this state is admissible to the application depends upon the impact if the above action in the <span class="EmphasisFontCategoryNonProportional ">User Balance</span> table is missed. Even though the update of data in the <span class="EmphasisFontCategoryNonProportional ">User Balance</span> table is missed, the same is already tracked in a different form in the <span class="EmphasisFontCategoryNonProportional ">Quotes</span> table. In this example, the data in the <span class="EmphasisFontCategoryNonProportional ">User Balance</span> table is to be looked at as a summary view, which is a kind of cache of the aggregated total for each user. This is present for faster lookup of the trading balance of each user in the system. If the application assumes that these balances for users are estimates alone, whose correct value can always be verified for accuracy using data from the <span class="EmphasisFontCategoryNonProportional ">Quotes</span> table, then the error described earlier, missing the addition of the value of the quote to the buyer and the seller in the <span class="EmphasisFontCategoryNonProportional ">User Balance</span> table<span id="ITerm14">
                
                
              </span>, is acceptable. In such a scenario, the data present in the <span class="EmphasisFontCategoryNonProportional ">User Balance</span> table is not expected to be 100% accurate.</p><p class="Para" id="Par19">The “Test the Lost Message Scenario” section in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span> simulated an error scenario like this where the quote status change from “New” to “Confirmed” was successful; however, the downstream settlement was missed because the message sent from the upstream to the downstream microservice failed to reach through. It introduced the messaging middleware between the two microservices as a bridge so that the microservices were loosely coupled. Alas, when you decoupled the microservices like this, you introduced another <span id="ITerm15">headache</span>: managing consistency across one microservice and the messaging middleware. Such scenarios are common when you have many microservices in your application. You will look into the complexities involved when you get to the messaging middleware later in the “Global vs. Local Resources” section; however, let’s keep aside the queue for the time being.</p></section><section class="Section2 RenderAsSection2" id="Sec3"><h3 class="Heading">Idempotent Operations and Microservices</h3><p class="Para" id="Par20">One easy way to handle the error <span id="ITerm16">scenario</span><span id="ITerm17">
                
              </span> in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC4">14-4</a></span> is to simply reverse the order of transactions. See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC5">14-5</a></span>.</p><div class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant" id="FPar1"><h3 class="Heading">Note</h3><p class="Para" id="Par21">This reversal of order of transaction works in this specific scenario; for your case, it may require a different approach.</p></div><div class="Para" id="Par22">
              <div class="ProgramCode" id="PC5"><div class="LineGroup"><div class="FixedLine">Start Local Transaction</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Increment or Decrement User Balance</div><div class="FixedLine">End Local Transaction</div><div class="FixedLine">Start Local Transaction</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Update Quote Status</div><div class="FixedLine">End Local Transaction</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-5</span><p class="SimplePara">Local Transactions in Microservice Scenario Reversed</p></div></div></div>
            </div><p class="Para" id="Par23">By reversing the order of transactions as listed above, you can always make sure that you will attempt to change the quote status if and only if you are sure that the user balance update is successful. In this manner, you can be sure that if the quote processing is completed by changing the quote status from “New” to “Confirmed,” the quote is already settled for sure by making corresponding changes in the <span class="EmphasisFontCategoryNonProportional ">User Balance</span> table.</p><div class="Para" id="Par24">There arises a new scenario then. What if the quote <span id="ITerm18">processing</span> fails after the quote is settled in the <span class="EmphasisFontCategoryNonProportional ">User Balance</span> table? Here, the user balance is updated; however, the quote remains in the status of “New,” as shown in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC6">14-6</a></span>.<div class="ProgramCode" id="PC6"><div class="LineGroup"><div class="FixedLine">Start Local Transaction</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Increment or Decrement User Balance</div><div class="FixedLine">End Local Transaction</div><div class="FixedLine">Start Local Transaction</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Update Quote Status</div><div class="FixedLine">End Local Transaction !ERROR</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-6</span><p class="SimplePara">Local Transactions in Microservice Scenario Reversed Error</p></div></div></div></div><p class="Para" id="Par25">If so, when the Quotes Processor Task, which is a scheduled timer, times out the next time, it will attempt to process the same quote again since the quote status is still “New.” This will cause duplicate transactions in the user balance. The “Test the Duplicate Message Being Sent Scenario” and “Test the Duplicate Message Consumption Scenario” sections in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span> simulated error scenarios like this. In the first case, the quote status change from “New” to “Confirmed” was not successful in the first pass, so duplicate messages were sent to the downstream settlement microservice. In the second case, the duplicate message consumption scenario was simulated, which caused duplicate transactions in the user balance.</p><p class="Para" id="Par26">The effect of duplicate transactions can be nullified provided the transaction is idempotent. Idempotent operations are those that can be repeatedly applied without any side effects. Additions and deductions are not <span id="ITerm19">idempotent</span>, as is evident from the nature of the actions itself. Update operations that simply set a value in a <span id="ITerm20">single-threaded environment</span> are idempotent; however, in a <span id="ITerm21">multi-threaded environment</span> where you have concurrency, even such update operations are not idempotent. This is because the context that was assumed to be the precondition for such update operations could have been changed by another concurrent thread. Or the application of such updates can happen out of order from what is desired. You need to have mechanisms to handle these cases, and you will look into them in the enhanced example <span id="ITerm22">section</span> later in this chapter. In general, idempotent consumer implementations can be tricky, as illustrated in the reference.<sup><a epub:type="noteref" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fn2" id="Fn2_source" class="totri-footnote">2</a></sup></p></section><section class="Section2 RenderAsSection2" id="Sec4"><h3 class="Heading">Global vs. Local Resources</h3><p class="Para" id="Par28">Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span> discussed ACID transactions, and Figure&nbsp;<span class="ExternalRef"><a href="https://doi.org/10.1007/978-1-4842-4501-9_13Fig#2"><span class="RefSource">13-2</span></a></span> showed a typical scenario of two separate resources, one a database resource and another a message middleware resource. Queues of message middleware resources are first class citizens for storing the state of entities in motion, temporarily in a node, or in a process. When you split the <span id="ITerm23">monolith Quote application</span> into two microservices, the Quote Processing microservice and the <span id="ITerm24">Quote Settlement microservice</span>, you need a communication mechanism between them. If you prefer reactive or event-based approaches for this communication over synchronous-style REST calls, message middleware resources are good choices, and that is what is represented in Figure&nbsp;<span class="ExternalRef"><a href="https://doi.org/10.1007/978-1-4842-4501-9_13Fig#2"><span class="RefSource">13-2</span></a></span>. However, this figure depicts a completely distributed architecture where all the resource managers and even the transaction managers are distributed globally in the network, hence full global transactions are required if you must apply ACID-style, two-phase commit operations.</p><div class="Para" id="Par29">If the queues should have fault tolerance, they are to be persistent. A queue to be persistent should be backed up with a suitable persistent mechanism, usually by a database itself. So if we redraw Figure&nbsp;<span class="ExternalRef"><a href="https://doi.org/10.1007/978-1-4842-4501-9_13Fig#2"><span class="RefSource">13-2</span></a></span> to represent a persistent queue <span id="ITerm25">participating</span> in the global transaction, it will look like Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig3">14-3</a></span>.<figure class="Figure" id="Fig3"><div class="MediaObject" id="MO3"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig3_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(2).jpg" style="height:25.8em" width="1725" height="1032" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig3_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-3</span><p class="SimplePara"><span id="ITerm26">Distributed ACID transactions</span> with distributed resources</p></div></figcaption></figure></div><div class="Para" id="Par30">Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig3">14-3</a></span> retains the Resource Manager 1 and Resource Manager 2 from Figure&nbsp;<span class="ExternalRef"><a href="https://doi.org/10.1007/978-1-4842-4501-9_13Fig#2"><span class="RefSource">13-2</span></a></span> however, it shows a backing store for the JMS resource (Resource Manager 2) represented by Resource Manager 3. You then can represent your microservices architecture similar to that shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig4">14-4</a></span>.<figure class="Figure" id="Fig4"><div class="MediaObject" id="MO4"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig4_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(3).jpg" style="height:36.45em" width="1300" height="1458" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig4_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-4</span><p class="SimplePara">
                      <span id="ITerm27">Quotes microservices architecture</span>
                    </p></div></figcaption></figure></div><div class="Para" id="Par31">It’s again typical that middleware vendors provide database solutions and message middleware solutions together. If so, you can do one optimization to the architecture shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig3">14-3</a></span>, and it is shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig5">14-5</a></span>.<figure class="Figure" id="Fig5"><div class="MediaObject" id="MO5"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig5_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(4).jpg" style="height:25.8em" width="1725" height="1032" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig5_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-5</span><p class="SimplePara"><span id="ITerm28">Distributed ACID transactions</span> with partial optimization</p></div></figcaption></figure></div><p class="Para" id="Par32">Many middleware majors including but not limited to Microsoft, IBM, and Oracle provide solutions within the same stack.</p><p class="Para" id="Par33">However, there are still some issues. The issues discussed in previous subsections can be addressed only if you bring the operations in the microservice(s) and the message queue within single transaction. If you do so, since the backing persistence database of the queue and the database used by the microservices are different resources, <span id="ITerm29">global two-phase transactions</span> are required.</p><div class="Para" id="Par34">You will optimize the architecture in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig5">14-5</a></span> further to address the above issue; see Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig6">14-6</a></span>.<figure class="Figure" id="Fig6"><div class="MediaObject" id="MO6"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig6_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(5).jpg" style="height:36.1em" width="1725" height="1444" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig6_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-6</span><p class="SimplePara">Distributed transactions optimized into <span id="ITerm30">local transactions</span></p></div></figcaption></figure></div><p class="Para" id="Par35">The technique is to ensure that the backing persistence is on the same resource as the database, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig6">14-6</a></span>. Note that the label of the transaction in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig6">14-6</a></span> has changed from XA-JTA to TX-Local. Moreover, when partitioning is avoided, you can minimize or even avoid communications happening at the network level. This too is shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig6">14-6</a></span>. Compared to Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig3">14-3</a></span> or Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig5">14-5</a></span>, the transaction managers, resource managers, and backing resources all reside in the same partition or node. If they are all from the same vendor, then there are options for optimizations using tight integration choices, like bypassing published APIs and making optimized calls through published or even non-published SPIs (service provider <span id="ITerm31">interfaces</span>).</p><div class="Para" id="Par36">Let’s now look at the microservices architectures possible with such a resource sharing setup. The architecture options shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig7">14-7</a></span> are surely improvisations over that shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig4">14-4</a></span>; however, careful observation will reveal that you have not avoided the requirement to use global two-phase transactions completely. The resource for your queue can be shared with the application transaction database resource of either of the microservices, not both. Hence with the other microservice and the queue, still there is the issue of two-phase commit transactions.<figure class="Figure" id="Fig7"><div class="MediaObject" id="MO7"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig7_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(6).jpg" style="height:23.88em" width="1725" height="955" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig7_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-7</span><p class="SimplePara">Microservices <span id="ITerm32">architecture options</span></p></div></figcaption></figure></div><p class="Para" id="Par37">Here you need to do an architecture trade-off depending upon the business involved. Perhaps Option 1 is better since you want to process any number of new quotes throttled to the Quote Processing microservice. By queueing a persistent message within the same transaction as the update to the new quote by changing the status of the quote from “New” to “Confirmed,” the information needed to update the running balances on the <span class="EmphasisFontCategoryNonProportional ">User Balance</span> table in the foreign microservice has been safely captured. The transaction is contained on a single database instance and therefore maximum throughput can be achieved by limiting transactions locally. This is also desirable if you assume that there are humans interacting with the Quote Processing microservice where, once the transactions has completed, a response has to be provided to their device or <span id="ITerm33">browser</span> (even though the example in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span> doesn’t have humans waiting; instead, it uses scheduled jobs to process quotes).</p><p class="Para" id="Par38">If you chose Option 1 for the architecture, then when you dequeue messages from the queue for settlement by the Quotes Settlement microservice, you still have the two-phase transaction problem. If you consider quote settlement as a pure back-office process, one justification for you to still continue with the two-phase commit transactions there is that you maximized the throughput and hence the availability of your customer-facing microservices while trading off with comparatively lower responsiveness for your back-office microservices. Similar is the case where you want to deal with “expensive” or “high consequence” transactions like those involved in the financial <span id="ITerm34">domain</span> where you would still want to continue with two-phase commit transactions where the benefits outweigh the costs involved.</p><p class="Para" id="Par39">Again, as is shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig7">14-7</a></span>, in Option 2 the design is restructured. However, it only reveals that you haven’t completely avoided the need for two-phase commit transactions; instead, it shifted the necessity from downstream to upstream!</p></section></section><section class="Section1 RenderAsSection1" id="Sec5"><h2 class="Heading">Distributed Transactions Example: Refactoring Towards Less ACID</h2><div class="Para" id="Par40">In the “<span id="ITerm35">Idempotent Operations</span> and Microservices” section, you saw the problem arising due to partial failures in enterprise systems. When you relax ACID constraints, there should be mechanisms to take care of scenarios including but not limited to<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par41">Partial failures</p></li><li><p class="Para" id="Par42">Lost messages</p></li><li><p class="Para" id="Par43">Duplicate messages</p></li><li><p class="Para" id="Par44">Retry attempts</p></li><li><p class="Para" id="Par45">Message redelivery</p></li><li><p class="Para" id="Par46">Message received out of order</p></li></ul></div></div><p class="Para" id="Par47">As you know, all of the above scenarios were covered in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>. The end goal is to choose between distributed transactions and local transactions based on the nature and context of the use case involved. But Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig7">14-7</a></span> illustrates that you can live with <span id="ITerm36">local transactions</span> alone if your application is a monolith. The moment you split your monolith into microservices, you introduce partitions in the architecture and there you need to trade off. Option 1 in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig7">14-7</a></span> is the preferred option where you avoid distributed transactions from microservices that require high responsiveness like those that interact with human users, and retain some form of distributed transactions in other microservices where you justify using distributed transactions to pieces of your microservices architecture where you require comparatively lower responsiveness, since they are your back-office <span id="ITerm37">microservices</span>.</p><p class="Para" id="Par48">So far, so good. What if distributed transactions or two-phase transactions are simply never acceptable in your microservices? Can this problem be ever solved? Let’s relook at an example from Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>.</p><section class="Section2 RenderAsSection2" id="Sec6"><h3 class="Heading">Towards Relaxed BASE: Redesign For Dealing with Duplicates and Out-Of-Order Messages</h3><p class="Para" id="Par49">The aim here is not to deprecate distributed transactions straight away. Instead, you will bring relaxations to the design from Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>, simulate failure scenarios, and see if you are able to overcome the shortcomings seen in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>. Once you understand this enhanced design, you will have a good grip of the underlying basics in designing distributed systems that are more resilient and fault <span id="ITerm38">tolerant</span>. Once you have these basics in your toolset, then it’s a matter of architectural creativity in designing fault tolerant microservices.</p><div class="Para" id="Par50">The main design change I introduce here is to have a new table with the name <span class="EmphasisFontCategoryNonProportional ">QuotesTX</span> in the downstream system, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig8">14-8</a></span>.<figure class="Figure" id="Fig8"><div class="MediaObject" id="MO8"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig8_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(7).jpg" style="height:8.83em" width="1199" height="353" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig8_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-8</span><p class="SimplePara">Quotes Transactions table</p></div></figcaption></figure></div><div class="Para" id="Par51">You need a way to track which quotes received through the messaging middleware have been settled and which are still <span id="ITerm39">outstanding</span>. The transactions to the <span class="EmphasisFontCategoryNonProportional ">QuotesTX</span> table have been handled by a new entity in the system called <span id="ITerm40">StockTransaction</span>, and all actions on this entity are owned by a new transactional component service, QuotesTransactionService. The enhanced architecture is shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig9">14-9</a></span>.<figure class="Figure" id="Fig9"><div class="MediaObject" id="MO9"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig9_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(8).jpg" style="height:30.53em" width="1725" height="1221" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig9_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-9</span><p class="SimplePara">The architecture for the relaxed XA <span id="ITerm41">transaction</span> example</p></div></figcaption></figure></div><div class="Para" id="Par52">The business flow for the relaxed design explaining the new building blocks for your example is as follows:<div class="OrderedList"><ol><li class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><p class="Para" id="Par53">New quotes for stock transactions can be pushed to the Broker Web microservice. New quotes will get inserted into a <span class="EmphasisFontCategoryNonProportional ">Quotes</span> table, which is in a MySQL DB, with a status of “New.”</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><p class="Para" id="Par54">The Quotes Processor Task is a Quartz scheduled task, and it polls the <span class="EmphasisFontCategoryNonProportional ">Quotes</span> table in the MySQL DB for any quotes with a status of “New.”</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><p class="Para" id="Par55">When a quote with a status of “NEW” is found, it invokes the <span class="EmphasisFontCategoryNonProportional ">processNewQuote</span> method of the broker service, always with a transaction, passing the unique identifier for the new quote in the <span class="EmphasisFontCategoryNonProportional ">Quotes</span> table.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">4.</span><div class="ItemContent"><p class="Para" id="Par56">The broker service makes use of two other transactional services, the auction service and the stock order service. The execution of both must be atomic.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">5.</span><div class="ItemContent"><p class="Para" id="Par57">The auction service confirms the quote received by changing the status of the quote to “Confirmed,” in a transaction.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">6.</span><div class="ItemContent"><p class="Para" id="Par58">The stock order service creates a JMS message out of the information contained in the new quote and it is sent to an ActiveMQ queue for settlement of the quote, again in a transaction.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">7.</span><div class="ItemContent"><p class="Para" id="Par59">The settlement listener service listens on the ActiveMQ queue for any new confirmed <span id="ITerm42">quote</span>. All confirmed quotes on reaching the ActiveMQ queue are picked up by the onMessage of the settlement listener service, within a transaction.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">8.</span><div class="ItemContent"><p class="Para" id="Par60">The settlement listener service invokes the quotes transaction service for recording all quotes received by the system. To make this record happen irrespective of any other processing in peer transactions within the enclosed parent transaction, the transaction semantic for this recording action is REQUIRES_NEW. This record action will not raise any errors on finding duplicate entries received.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">9.</span><div class="ItemContent"><p class="Para" id="Par61">The quotes transaction service attempts to safely record all quote transactions the downstream microservice receives through the messaging bridge.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">10.</span><div class="ItemContent"><p class="Para" id="Par62">The settlement listener service makes use of two other transactional services, the quotes reconcile <span id="ITerm43">service</span> and the quotes transaction service (again), the execution of both of which must be atomic.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">11.</span><div class="ItemContent"><p class="Para" id="Par63">The quotes reconcile service needs to reconcile the value of the stock traded to the respective user account of the seller and the buyer, in a transaction.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">12.</span><div class="ItemContent"><p class="Para" id="Par64">At the same time, the quotes transaction service marks the quotes transaction entry as settled in the <span class="EmphasisFontCategoryNonProportional ">QuotesTX</span> table by changing its status from “New” to “Settled.”</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">13.</span><div class="ItemContent"><p class="Para" id="Par65">The Broker Web microservice and the Settlement Web microservice are just utilities that provide a dashboard view of the operational data on the <span class="EmphasisFontCategoryNonProportional ">Quotes</span> table, the <span class="EmphasisFontCategoryNonProportional ">User</span> table, and the <span class="EmphasisFontCategoryNonProportional ">QuotesTX</span> table to provide you with live views.</p></div><div class="ClearBoth">&nbsp;</div></li></ol></div></div><p class="Para" id="Par66">A little more discussion is required about the new design. In the new design, the <span id="ITerm44">StockTransaction entity</span> is nothing but a copy of the message the microservices receive as such. In a messaging and distributed system, it is a best practice to record what is coming in and going out of (sub) systems so that if you need to later track what happened during transactions, it is possible to correlate entity states with respect to temporal actions. The downside in doing this is that you eat up more storage space in terms of duplicating data. However, you need to go back to another basic principle of microservices: a microservice should have all of what is required for the service to serve without any external dependency.</p><p class="Para" id="Par67">In that way, duplicating the required data and caching it in the microservices has to be done in certain scenarios. This is also one of the after-effects of the <span id="ITerm45">CQRS architecture</span> introduced in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_12_Chapter.xhtml"><span class="RefSource">12</span></a></span> where, while one microservices will own the “write” governance for an entity, there can be many other microservices that are interested in the “read” models, and here too you will have read data duplicated and attached along with the interested microservices so that these microservices can function on their own with no external dependency.</p><p class="Para" id="Par68">The next aspect is that the <span class="EmphasisFontCategoryNonProportional ">StockTX</span> table is also a mechanism for the downstream microservice to identify duplicate messages coming through the messaging middleware. This is done using the <span id="ITerm46">transaction ID pattern</span>. Here, the <span class="EmphasisFontCategoryNonProportional ">StockTX</span> table will also record a transaction ID send by the sender microservices along with the message payload. The sender and receiver microservices have to agree on a common schema where these transaction IDs are unique in the way that any two different messages will not have the same transaction ID. If so, the receiver microservice can record this transaction ID along with the message. In this manner, whenever the receiver microservice receives a message, it can check if it’s a duplicate message, and if so, it can be silently ignored.</p><p class="Para" id="Par69"><span id="ITerm47">Boundary level actions</span> of microservices are to be done in isolation from internal processing and also with more fault tolerant design patterns. This is because microservices boundaries have a dependency of system resources like networks, I/O, and so on, which are more error-prone. Hence, when the downstream microservice receives a message from the message network, your aim should be to make the “record new message” action independent and isolated from further internal microservice processing, since internal microservice processing is in the control of that microservice alone (no external resources, like previously mentioned) and can be retried in case of errors. This is achieved in the new design by making the transaction semantic for the new message recording action as REQUIRES_NEW so that it will succeed irrespective of the outcome of the peer transactions or the parent transaction.</p></section><section class="Section2 RenderAsSection2" id="Sec7"><h3 class="Heading">Code the Relaxed Example Scenario</h3><p class="Para" id="Par70">The complete code required to demonstrate the distributed transaction example with enhanced resiliency for relaxed BASE anomalies is in folder <span class="EmphasisFontCategoryNonProportional ">ch14\ch14-01</span>. There are no major changes in the code of the upstream microservices from what you saw in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>, so I will not duplicate the code here. I have introduced new code as well as updates to existing code in the downstream microservices, so I will explain it all here. The main changes are in the Quote Settlement downstream microservice.</p><section class="Section3 RenderAsSection3" id="Sec8"><h4 class="Heading">Microservice 3: Quote Settlement (Settlement-ActiveMQ-Derby)</h4><div class="Para" id="Par71">When a new quote message reaches the ActiveMQ queue, it will be picked up instantaneously by the settlement listener. The settlement listener code has changed from what you saw in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>, so look at Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC7">14-7</a></span>.<div class="ProgramCode" id="PC7"><div class="LineGroup"><div class="FixedLine">public class SettlementListener implements MessageListener {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Qualifier("quotesTransactionServiceRequired_TX")</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;QuotesTransactionService quotesTransactionServiceRequired_TX;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Qualifier("quotesTransactionServiceRequiresNew_TX")</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;QuotesTransactionService quotesTransactionServiceRequiresNew_TX;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Qualifier("quotesReconcileServiceRequired_TX")</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;QuotesReconcileService quotesReconcileServiceRequired_TX;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Qualifier("quotesReconcileServiceRequiresNew_TX")</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;QuotesReconcileService quotesReconcileServiceRequiresNew_TX;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public void onMessage(Message message) {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QuoteDTO quoteDTO = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quoteDTO = (QuoteDTO) ((ObjectMessage) message). getObject();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch (JMSException e) {</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new RuntimeException(e);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesTransactionServiceRequiresNew_TX.insertUniqueNoErrorOnDuplicate(</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quoteDTO);</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reconcile(quoteDTO); <span id="ITerm48">
                        
                        
                      </span></div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch (QuotesBaseException e) {</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new RuntimeException(e);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-7</span><p class="SimplePara">Settlement <span id="ITerm49">Listener Orchestrator</span> (ch14\ch14-01\XA-TX-Resilient\Settlement-ActiveMQ-Derby\src\main\java\com\acme\ecom\messaging\SettlementListener.java)</p></div></div></div></div><div class="Para" id="Par72">As shown in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC7">14-7</a></span>, on consuming the message, the settlement listener will at the very next instance attempt to record the incoming quote message backed up by a persistent resource. To make this record happen irrespective of the outcome (success or failure) of any other processing in peer transactions within the enclosed parent transaction, the transaction semantic for this recording action is REQUIRES_NEW. This record action will not raise any errors on finding duplicate entries received. Next, the listener will do a check to see if a quote similar to the one received has already been settled. This happens in cases of duplicate messages. See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC8">14-8</a></span>.<div class="ProgramCode" id="PC8"><div class="LineGroup"><div class="FixedLine">public class SettlementListener implements MessageListener {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private void reconcile(QuoteDTO quoteDTO)throws QuotesBaseException{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User seller = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User buyer = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StockTransaction stockTransaction = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Integer testCase = quoteDTO.getTest();</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!quotesTransactionServiceRequired_TX.isNotSettled(</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quoteDTO.getId())){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.debug("Quote will not be attempted to be settled again");</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(testCase.equals(1) || testCase.equals(2) ||</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;testCase.equals(4) || testCase.equals(8)){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesReconcileServiceRequired_TX.reconcile(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesTransactionServiceRequired_TX.markSettled(</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quoteDTO.getId());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch(QuotesBaseException quotesBaseException){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.error(quotesBaseException.getMessage());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if(testCase.equals(5)){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{<span id="ITerm50">
                        
                        
                      </span></div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesReconcileServiceRequiresNew_TX.reconcile(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesTransactionServiceRequiresNew_TX.markSettled(</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quoteDTO.getId());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch(QuotesBaseException quotesBaseException){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.error(quotesBaseException.getMessage());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flipFlop();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if(testCase.equals(6)){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesReconcileServiceRequiresNew_TX.reconcile(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesTransactionServiceRequired_TX.markSettled(</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quoteDTO.getId());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch(QuotesBaseException quotesBaseException){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.error(quotesBaseException.getMessage());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if(testCase.equals(7)){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesReconcileServiceRequired_TX.reconcile(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesTransactionServiceRequired_TX.markSettled(</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quoteDTO.getId());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch(QuotesBaseException quotesBaseException){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.error(quotesBaseException.getMessage());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flipFlop();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.debug("Undefined Test Case");</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<span id="ITerm51">
                        
                        
                      </span></div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-8</span><p class="SimplePara">Settlement <span id="ITerm52">Listener Reconciliation</span> (ch14\ch14-01\XA-TX-Resilient\Settlement-ActiveMQ-Derby\src\main\java\com\acme\ecom\messaging\SettlementListener.java)</p></div></div></div></div><div class="Para" id="Par73">If the quote is not a duplicate, reconciliation will be attempted, as shown in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC8">14-8</a></span>. As a last step, the listener will mark the stock transaction in the <span class="EmphasisFontCategoryNonProportional ">StockTX</span> table as “Settled” so that, if further duplicate messages arrive for the same quote, the listener will not settle it again. Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC9">14-9</a></span> shows the stock transaction.<div class="ProgramCode" id="PC9"><div class="LineGroup"><div class="FixedLine">@Entity</div><div class="FixedLine">@Table(name = "stocktx")</div><div class="FixedLine">@Data</div><div class="FixedLine">@EqualsAndHashCode(exclude = { "id" })</div><div class="FixedLine">public class StockTransaction {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public static final String NEW = "New";</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public static final String SETTLED = "Settled";</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Id</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@GeneratedValue(strategy = GenerationType.AUTO)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Long id;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "stocksymbol", nullable = false, updatable = false)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private String stockSymbol;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "sellerid", nullable = false, updatable = false)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Long sellerId;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "buyerid", nullable = false, updatable = false)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Long buyerId;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "amount", nullable = false, updatable = false)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Float amount;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "quoteid", nullable = false, updatable = false, unique=true)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Long quoteId;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "status", nullable = false, updatable = true)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private String status;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "quotecreated", nullable = false, updatable = false)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Temporal(TemporalType.TIMESTAMP)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Date quoteCreated;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "test", nullable = true, updatable = true)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Integer test; <span id="ITerm53">
                        
                        
                      </span></div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "createdat", nullable = false, updatable = false)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Temporal(TemporalType.TIMESTAMP)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Date createdAt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "updatedat", nullable = true, updatable = true)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Temporal(TemporalType.TIMESTAMP)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Date updatedAt;</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-9</span><p class="SimplePara"><span id="ITerm54">Stock Transaction Entity</span> (ch14\ch14-01\XA-TX-Resilient\Settlement-ActiveMQ-Derby\src\main\java\com\acme\ecom\model\trade\StockTransaction.java)</p></div></div></div></div><div class="Para" id="Par74">The fields for the StockTransaction entity in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC9">14-9</a></span> are chosen to demonstrate the required test cases in later sections. You will now look at the QuotesTransactionService, which is responsible for managing the stock transaction entity life cycle, in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC10">14-10</a></span>.<div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine">public class QuotesTransactionServiceImpl implements QuotesTransactionService{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private StockTransactionRepository stockTransactionRepository;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Override</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public boolean insertUniqueNoErrorOnDuplicate(QuoteDTO quoteDTO){</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StockTransaction stockTransaction = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StockTransaction stockTransactionSaved = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean inserted = false;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional stockTransactionQueried =</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransactionRepository.findOptionalByQuoteId(quoteDTO.getId());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!stockTransactionQueried.isPresent()){</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransaction = convertQuoteToStockTransaction(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransaction.setStatus(StockTransaction.NEW);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Date now = new Date();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransaction.setCreatedAt(now);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransaction.setUpdatedAt(now);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransactionSaved =</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransactionRepository.save(stockTransaction);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inserted = true; <span id="ITerm55">
                        
                        
                      </span></div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.debug("Stock Transaction with quoteId : {} exist;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Cannot insert duplicate", quoteDTO.getId());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Do Nothing - we know this is a duplicate message</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return inserted;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-10</span><p class="SimplePara">Quotes <span id="ITerm56">Transaction Service</span> (ch14\ch14-01\XA-TX-Resilient\Settlement-ActiveMQ-Derby\src\main\java\com\acme\ecom\service\QuotesTransactionServiceImpl.java)</p></div></div></div></div><div class="Para" id="Par75">The notable aspect in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC10">14-10</a></span> is the silent manner in which you are ignoring duplicate messages. Further, the <span class="EmphasisFontCategoryNonProportional ">isNotSettled</span> and <span class="EmphasisFontCategoryNonProportional ">markSettled</span> utility methods are also shown in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC11">14-11</a></span>.<div class="ProgramCode" id="PC11"><div class="LineGroup"><div class="FixedLine">public class QuotesTransactionServiceImpl implements QuotesTransactionService{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private StockTransactionRepository stockTransactionRepository;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Override</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public void markSettled(Long quoteId){</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StockTransaction stockTransaction = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StockTransaction stockTransactionSaved = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional stockTransactionQueried =</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransactionRepository.findOptionalByQuoteId(quoteId);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(stockTransactionQueried.isPresent()){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransaction =</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(StockTransaction) stockTransactionQueried.get();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransaction.setStatus(StockTransaction.SETTLED);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransaction.setUpdatedAt(new Date());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransactionSaved =</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransactionRepository.save(stockTransaction);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.debug("Stock Transaction cannot be tracked");</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<span id="ITerm57">
                        
                        
                      </span></div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Override</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public boolean isNotSettled(Long quoteId){</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean isNotSettled = true;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StockTransaction stockTransaction = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional stockTransactionQueried =</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransactionRepository.findOptionalByQuoteId(quoteId);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(stockTransactionQueried.isPresent()){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockTransaction =</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(StockTransaction) stockTransactionQueried.get();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(stockTransaction.getStatus().equals(StockTransaction.SETTLED)){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;isNotSettled = false;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return isNotSettled;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public Optional&lt;StockTransaction&gt; findOptionalByQuoteId(Long quoteId){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return stockTransactionRepository.findOptionalByQuoteId(quoteId);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-11</span><p class="SimplePara">Quotes <span id="ITerm58">Transaction Service</span> (ch14\ch14-01\XA-TX-Resilient\Settlement-ActiveMQ-Derby\src\main\java\com\acme\ecom\service\QuotesTransactionServiceImpl.java)</p></div></div></div></div><div class="Para" id="Par76">The quotes reconcile service has also been updated from what you saw in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span> to take care of the messages coming out of order. Look at the code in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC12">14-12</a></span> to understand the method of handling messages coming out of order.<div class="ProgramCode" id="PC12"><div class="LineGroup"><div class="FixedLine">public class QuotesReconcileServiceImpl implements QuotesReconcileService{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private UserRepository userRepository;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Override</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public void reconcile(QuoteDTO quoteDTO)throws QuotesBaseException{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Integer testCase = quoteDTO.getTest();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional sellerQueried =</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;userRepository.findById(quoteDTO.getSellerId());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional buyerQueried&nbsp;&nbsp;=</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;userRepository.findById(quoteDTO.getBuyerId());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User seller = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User buyer = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User sellerSaved = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User buyerSaved = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Date updatedDate = null;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(sellerQueried.isPresent() &amp;&amp; buyerQueried.isPresent()){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seller = (User) sellerQueried.get();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buyer&nbsp;&nbsp;= (User) buyerQueried.get();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updatedDate = new Date();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seller.setAmountSold(seller.getAmountSold() +</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quoteDTO.getAmount());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seller.setUpdatedAt(updatedDate);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(quoteDTO.getCreatedAt().after(seller.getLastQuoteAt())){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seller.setLastQuoteAt(quoteDTO.getCreatedAt());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sellerSaved = userRepository.save(seller);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buyer.setAmountBought(buyer.getAmountBought() +</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quoteDTO.getAmount());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buyer.setUpdatedAt(updatedDate);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(quoteDTO.getCreatedAt().after(buyer.getLastQuoteAt())){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buyer.setLastQuoteAt(quoteDTO.getCreatedAt());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buyerSaved = userRepository.save(buyer);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(testCase.equals(6)){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new QuotesReconcileRollbackException("Explicitly thrown</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;by Reconcile Application to Roll Back!");</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<span id="ITerm59">
                        
                        
                      </span></div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(testCase.equals(7)){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flipFlop();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.debug("Reconciliation Not Done");</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-12</span><p class="SimplePara">Enhanced Quotes <span id="ITerm60">Reconcile Service Code</span> (ch14\ch14-01\XA-TX-Resilient\Settlement-ActiveMQ-Derby\src\main\java\com\acme\ecom\service\QuotesReconcileServiceImpl.java)</p></div></div></div></div><div class="Para" id="Par77">The quotes reconcile service has a helper method to retrieve user details, shown in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC13">14-13</a></span>.<div class="ProgramCode" id="PC13"><div class="LineGroup"><div class="FixedLine">public class QuotesReconcileServiceImpl implements QuotesReconcileService{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private UserRepository userRepository;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Override</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public Optional findUserById(Long id){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return userRepository.findById(id);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-13</span><p class="SimplePara">Enhanced Quotes <span id="ITerm61">Reconcile Service Helper Method</span></p></div></div></div></div><div class="Para" id="Par78">The way you take care of quote messages arriving out of order is by using the check in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC14">14-14</a></span>.<div class="ProgramCode" id="PC14"><div class="LineGroup"><div class="FixedLine">if(quoteDTO.getCreatedAt().after(seller.getLastQuoteAt())){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;seller.setLastQuoteAt(quoteDTO.getCreatedAt());</div><div class="FixedLine">}</div></div><div class="LineGroup"><div class="FixedLine">if(quoteDTO.getCreatedAt().after(buyer.getLastQuoteAt())){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;buyer.setLastQuoteAt(quoteDTO.getCreatedAt());</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-14</span><p class="SimplePara">Handling Messages Arriving Out of Order</p></div></div></div></div><p class="Para" id="Par79">These checks will update the timestamp of last quote for a <span id="ITerm62">buyer</span> or a seller if and only if the corresponding creation timestamp of the original quote message recorded by the upstream microservice is later than the current timestamp of last quote for the respective buyer or the seller.</p></section></section><section class="Section2 RenderAsSection2" id="Sec9"><h3 class="Heading">Build and Test the Duplicate Message Being Sent Scenario</h3><div class="Para" id="Par80">Since this example is a continuation of the example in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>, I won’t explain the scenario in detail. Instead, your aim is to understand how to manage the duplicate messages and the messages coming out of order so that you know how to better design for them in a microservices architecture. Hence you will look into three test cases in detail, shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig10">14-10</a></span>.<figure class="Figure" id="Fig10"><div class="MediaObject" id="MO10"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig10_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(9).jpg" style="height:15.58em" width="1725" height="623" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig10_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-10</span><p class="SimplePara">XA transaction <span id="ITerm63">resiliency</span> test cases</p></div></figcaption></figure></div><div class="Para" id="Par81">The test cases of interest for you are<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par82">Test Case 4 : Duplicate messages sent</p></li><li><p class="Para" id="Par83">Test Case 5 : Duplicate consumption of messages</p></li><li><p class="Para" id="Par84">Test Case 8 : Messages reached out of order</p></li></ul></div></div><p class="Para" id="Par85">You will look at Test Case 4 in this section and the other two test cases in the subsequent two sections.</p><p class="Para" id="Par86">You need to do steps similar to those explained in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>; however, there are a few extra steps. Hence the complete steps to run the examples will be explained again here. Further, as a prerequisite of running these test cases, I’ll assume that you have experience in running the test scenarios explained in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>.</p><p class="Para" id="Par87">As the first step, you need to bring up the ActiveMQ server. You may want to refer to Appendix F to get started with the ActiveMQ server.</p><div class="Para" id="Par88">You will configure a queue that will act as the bridge between the upstream and downstream processing. Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC15">14-15</a></span> gives the configuration of a queue, which can be done in <span class="EmphasisFontCategoryNonProportional ">activemq.xml</span>.<div class="ProgramCode" id="PC15"><div class="LineGroup"><div class="FixedLine">&lt;beans&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;broker&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;destinations&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;queue physicalName="notification.queue" /&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/destinations&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/broker&gt;</div><div class="FixedLine">&lt;/beans&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-15</span><p class="SimplePara">The <span id="ITerm64">ActiveMQ Queue configuration</span> (D:\Applns\apache\ActiveMQ\apache-activemq-5.13.3\conf\activemq.xml)</p></div></div></div></div><div class="Para" id="Par89">You may now bring up the ActiveMQ server:<div class="ProgramCode" id="PC16"><div class="LineGroup"><div class="FixedLine">cd D:\Applns\apache\ActiveMQ\apache-activemq-5.13.3\bin</div><div class="FixedLine">D:\Applns\apache\ActiveMQ\apache-activemq-5.13.3\bin&gt;activemq start</div></div></div></div><div class="Para" id="Par90">Next, make sure MySQL is up and <span id="ITerm65">running</span>. You may want to refer to Appendix H to get started with MySQL.<div class="ProgramCode" id="PC17"><div class="LineGroup"><div class="FixedLine">First Bring Up MySQL Server</div><div class="FixedLine">D:\Applns\MySQL\mysql-5.7.14-winx64\bin&gt;mysqld --console</div></div><div class="LineGroup"><div class="FixedLine">Now Open MySQL prompt</div><div class="FixedLine">D:\Applns\MySQL\mysql-5.7.14-winx64\bin&gt;mysql -u root –p</div></div><div class="LineGroup"><div class="FixedLine">mysql&gt; use ecom01;</div><div class="FixedLine">Database changed</div><div class="FixedLine">mysql&gt;</div></div></div></div><div class="Para" id="Par91">To start with clean tables, delete any tables with the names you want for your examples:<div class="ProgramCode" id="PC18"><div class="LineGroup"><div class="FixedLine">mysql&gt; drop table quote;</div></div></div></div><div class="Para" id="Par92">Next, create the table with the schema required for this example:<div class="ProgramCode" id="PC19"><div class="LineGroup"><div class="FixedLine">mysql&gt; create table quote (id BIGINT PRIMARY KEY AUTO_INCREMENT, symbol VARCHAR(4), sellerid BIGINT, buyerid BIGINT, amount FLOAT, status VARCHAR(9), test INTEGER, delay INTEGER, createdat DATETIME, updatedat DATETIME);</div></div></div></div><div class="Para" id="Par93">Next, make sure the Derby <span id="ITerm66">database</span> is up and running in network mode. You may want to refer to Appendix G to get started with Derby.<div class="ProgramCode" id="PC20"><div class="LineGroup"><div class="FixedLine">D:\Applns\apache\Derby\db-derby-10.14.1.0-bin\bin&gt;startNetworkServer</div></div></div></div><div class="Para" id="Par94">You can also use the Derby ij tool to create the database named <span class="EmphasisFontCategoryNonProportional ">exampledb</span> and open a connection to an already created database using the embedded driver via the following command:<div class="ProgramCode" id="PC21"><div class="LineGroup"><div class="FixedLine">D:\Applns\apache\Derby\derbydb&gt;ij</div><div class="FixedLine">ij&gt; connect 'jdbc:derby://localhost:1527/D:/Applns/apache/Derby/derbydb/exampledb;create=false';</div></div></div></div><div class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant" id="FPar2"><h3 class="Heading">Note</h3><p class="Para" id="Par95">You are using the ij tool from a base location different from your Derby installation, assuming that your database is in a location different from that of the Derby installation, which is a best practice. For further details on how to create a new database, refer to Appendix G.</p></div><div class="Para" id="Par96">Here again you will start with clean <span id="ITerm67">tables</span>. Delete any tables with the names you want for your examples:<div class="ProgramCode" id="PC22"><div class="LineGroup"><div class="FixedLine">ij&gt; drop table stockuser;</div><div class="FixedLine">ij&gt; drop table stocktx;</div></div></div></div><div class="Para" id="Par97">Next, create the table with the schema required for this example:<div class="ProgramCode" id="PC23"><div class="LineGroup"><div class="FixedLine">ij&gt; create table stockuser (id bigint not null, amountbought double, amountsold double, createdat timestamp not null, lastquoteat timestamp, name varchar(255) not null, updatedat timestamp not null, primary key (id));</div><div class="FixedLine">ij&gt; create table stocktx (id bigint generated by default as identity, amount float not null, buyerid bigint not null, createdat timestamp not null, quotecreated timestamp not null, quoteid bigint not null, sellerid bigint not null, status varchar(255) not null, stocksymbol varchar(255) not null, test integer, updatedat timestamp, primary key (id));</div><div class="FixedLine">ij&gt; alter table stocktx add constraint stocktx_001 unique (quoteid);</div><div class="FixedLine">ij&gt; CREATE SEQUENCE hibernate_sequence START WITH 1 INCREMENT BY 1;</div></div></div></div><p class="Para" id="Par98">This completes the <span id="ITerm68">infrastructure</span> required to build and run the example.</p><p class="Para" id="Par99">For this example, there are four microservices to build and get running. You will do so one by one.</p><section class="Section3 RenderAsSection3" id="Sec10"><h4 class="Heading">Microservice 1: Quote Processing Microservice</h4><div class="Para" id="Par100">Tweak the ActiveMQ-specific <span id="ITerm69">configuration</span><span id="ITerm70">
                  
                  
                </span> in <span class="EmphasisFontCategoryNonProportional ">spring-sender-mysql.xml</span>:<div class="ProgramCode" id="PC24"><div class="LineGroup"><div class="FixedLine">ch14\ch14-01\XA-TX-Resilient\Broker-MySQL-ActiveMQ\src\main\resources\spring-sender-mysql.xml</div></div><div class="LineGroup"><div class="FixedLine">&lt;property name="brokerURL" value="tcp://127.0.0.1:61616"/&gt;</div></div></div></div><div class="Para" id="Par101">Also, tweak the MySQL-specific configuration:<div class="ProgramCode" id="PC25"><div class="LineGroup"><div class="FixedLine">&lt;bean id="xaDataSourceMySQL-01" class="com.mysql.cj.jdbc.MysqlXADataSource"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="url"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value&gt;jdbc:mysql://localhost:3306/ecom01&lt;/value&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="pinGlobalTxToPhysicalConnection"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value&gt;true&lt;/value&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="user"&gt;&lt;value&gt;root&lt;/value&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="password"&gt;&lt;value&gt;rootpassword&lt;/value&gt;&lt;/property&gt;</div><div class="FixedLine">&lt;/bean&gt;</div></div></div></div><div class="Para" id="Par102">You will now build and package the executables for the Quote Processing microservice and bring up the scheduled <span id="ITerm71">processor</span><span id="ITerm72">
                  
                  
                </span>. There is a utility script in folder <span class="EmphasisFontCategoryNonProportional ">ch14\ch14-01\XA-TX-Resilient\Broker-MySQL-ActiveMQ\make.bat</span>:<div class="ProgramCode" id="PC26"><div class="LineGroup"><div class="FixedLine">cd D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Broker-MySQL-ActiveMQ</div><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Broker-MySQL-ActiveMQ&gt;make</div><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Broker-MySQL-ActiveMQ&gt;mvn -Dmaven.test.skip=true clean install</div></div></div></div><div class="Para" id="Par103">Now, the junit test can be run by using the <span id="ITerm73">script</span><span id="ITerm74">
                  
                </span> provided:<div class="ProgramCode" id="PC27"><div class="LineGroup"><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Broker-MySQL-ActiveMQ&gt;run</div><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Broker-MySQL-ActiveMQ&gt;mvn -Dtest=BrokerServiceTest#testSubmitQuote test</div></div></div></div></section><section class="Section3 RenderAsSection3" id="Sec11"><h4 class="Heading">Microservice 2: Broker Web Microservice</h4><div class="Para" id="Par104">First, update the configuration files to suit to your <span id="ITerm75">environment</span><span id="ITerm76">
                  
                </span>:<div class="ProgramCode" id="PC28"><div class="LineGroup"><div class="FixedLine">ch14\ch14-01\XA-TX-Resilient\Broker-Web\src\main\resources\application.properties</div></div><div class="LineGroup"><div class="FixedLine">server.port=8080</div><div class="FixedLine">spring.datasource.url = jdbc:mysql://localhost:3306/oauth2?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true&amp;useSSL=false</div><div class="FixedLine">spring.datasource.username = root</div><div class="FixedLine">spring.datasource.password = rootpassword</div><div class="FixedLine">spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.MySQL5Dialect</div><div class="FixedLine">spring.jpa.hibernate.ddl-auto = update</div><div class="FixedLine">spring.freemarker.cache=false</div></div></div></div><p class="Para" id="Par105">I advise you not to make any changes here.</p><div class="Para" id="Par106">Now build and package the executables for the <span id="ITerm77">Broker Web microservice</span><span id="ITerm78">
                  
                  
                </span> and bring up the server. There is a utility script in folder <span class="EmphasisFontCategoryNonProportional ">ch14\ch14-01\XA-TX-Resilient\Broker-Web\make.bat</span>:<div class="ProgramCode" id="PC29"><div class="LineGroup"><div class="FixedLine">cd D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Broker-Web</div><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Broker-Web&gt;make</div><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Broker-Web&gt;mvn -Dmaven.test.skip=true clean package</div></div></div></div><div class="Para" id="Par107">You can run the Spring Boot application in more than one way. The straightforward way is to execute the JAR file via the following commands:<div class="ProgramCode" id="PC30"><div class="LineGroup"><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Broker-Web&gt;run</div><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Broker-Web&gt;java -jar -Dserver.port=8080 .\target\quotes-web-1.0.0.jar</div></div></div></div><p class="Para" id="Par108">This will bring up the Broker Web Spring Boot Server in port 8080.</p><p class="Para" id="Par109">You can use a <span id="ITerm79">browser</span><span id="ITerm80">
                  
                  
                </span> (preferably Chrome) and point to this URL to keep monitoring the processing of all new incoming quotes: <span class="EmphasisFontCategoryNonProportional ">http://localhost:8080/</span>.</p></section><section class="Section3 RenderAsSection3" id="Sec12"><h4 class="Heading">Microservice 3: Quote Settlement Microservice</h4><div class="Para" id="Par110">Tweak the ActiveMQ-specific <span id="ITerm81">configuration</span> in<div class="ProgramCode" id="PC31"><div class="LineGroup"><div class="FixedLine">ch13\ch13-01\XA-TX-Distributed\Settlement-ActiveMQ-Derby\src\main\resources\spring-listener-derby.xml</div></div><div class="LineGroup"><div class="FixedLine">&lt;property name="brokerURL"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;value="failover:(tcp://127.0.0.1:61616)?timeout=10000"/&gt;</div></div></div></div><div class="Para" id="Par111">Also, you need to tweak the Derby-specific configuration:<div class="ProgramCode" id="PC32"><div class="LineGroup"><div class="FixedLine">&lt;property name="xaProperties"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="databaseName"&gt;D:/Applns/apache/Derby/derbydb/exampledb&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="serverName"&gt;localhost&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="portNumber"&gt;1527&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/props&gt;</div><div class="FixedLine">&lt;/property&gt;</div></div></div></div><div class="Para" id="Par112">Now build and package the executables for the Quote Settlement microservice and bring up the message <span id="ITerm82">listener</span>. There is a utility script provided the folder <span class="EmphasisFontCategoryNonProportional ">ch14\ch14-01\XA-TX-Resilient\Settlement-ActiveMQ-Derby\make.bat</span>:<div class="ProgramCode" id="PC33"><div class="LineGroup"><div class="FixedLine">cd D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Settlement-ActiveMQ-Derby</div><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Settlement-ActiveMQ-Derby&gt;make</div><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Settlement-ActiveMQ-Derby&gt;mvn -Dmaven.test.skip=true clean install</div></div></div></div><div class="Para" id="Par113">Now, the junit test can be run by using the script provided:<div class="ProgramCode" id="PC34"><div class="LineGroup"><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Settlement-ActiveMQ-Derby&gt;run</div><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Settlement-ActiveMQ-Derby&gt;mvn -Dtest=SettlementListenerServiceTest#testSettleQuote test</div></div></div></div></section><section class="Section3 RenderAsSection3" id="Sec13"><h4 class="Heading">Microservice 4: Settlement Web Microservice</h4><div class="Para" id="Par114">First, update the configuration files to suit to your <span id="ITerm83">environment</span>:<div class="ProgramCode" id="PC35"><div class="LineGroup"><div class="FixedLine">ch14\ch14-01\XA-TX-Resilient\Settlement-Web\src\main\resources\application.properties</div></div><div class="LineGroup"><div class="FixedLine">server.port=8081</div><div class="FixedLine">spring.datasource.url=jdbc:derby://localhost:1527/D:/Applns/apache/Derby/derbydb/exampledb;create=false</div><div class="FixedLine">spring.datasource.initialize=false</div><div class="FixedLine">spring.datasource.driver-class-name=org.apache.derby.jdbc.ClientDriver</div><div class="FixedLine">spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.DerbyTenSevenDialect</div><div class="FixedLine">spring.freemarker.cache=false</div></div></div></div><p class="Para" id="Par115">I advise you not to make any changes here.</p><div class="Para" id="Par116">Now build and package the executables for the Settlement Web microservice and bring up the server. There is a utility script provided in folder <span class="EmphasisFontCategoryNonProportional ">ch13\ch13-01\XA-TX-Distributed\Settlement-Web\make.bat</span>:<div class="ProgramCode" id="PC36"><div class="LineGroup"><div class="FixedLine">cd D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Settlement-Web</div><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Settlement-Web&gt;make</div><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Settlement-Web&gt;mvn -Dmaven.test.skip=true clean package</div></div></div></div><div class="Para" id="Par117">You can run the <span id="ITerm84">Spring Boot application</span> in more than one way. The straightforward way is to execute the JAR file via the following commands:<div class="ProgramCode" id="PC37"><div class="LineGroup"><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Settlement-Web&gt;run</div><div class="FixedLine">D:\binil\gold\pack03\ch14\ch14-01\XA-TX-Resilient\Settlement-Web&gt;java -jar -Dserver.port=8081 .\target\user-web-1.0.0.jar</div></div></div></div><p class="Para" id="Par118">This will bring up the Settlement Web Spring Boot Server in port 8081.</p><p class="Para" id="Par119">You can use a browser (preferably Chrome) and point to this URL to keep monitoring the running account status of the users and how the account balance changes as each new incoming quote is settled: <span class="EmphasisFontCategoryNonProportional ">http://localhost:8081/</span>.</p><p class="Para" id="Par120">Observe that this same console will also show the new table introduced, the <span class="EmphasisFontCategoryNonProportional ">Transactions</span> table.</p><div class="Para" id="Par121">Before you start executing any test case, you want to create two test users in the system. Take Postman and create the two test users shown:<div class="ProgramCode" id="PC38"><div class="LineGroup"><div class="FixedLine">http://localhost:8081/api/users</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "id" : 11, "name" : "Sam", "amountSold" : 1000.0, "amountBought" : 1000.0 }</div><div class="FixedLine">{ "id" : 21, "name" : "Joe", "amountSold" : 5000.0, "amountBought" : 5000.0 }</div></div></div></div><p class="Para" id="Par122">As mentioned, the intention is to execute Test Case 4; however, to relate easily to the execution of the test cases in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>, you will execute all test cases starting from Test Case 1.</p><div class="Para" id="Par123">To test the first test case, take Postman and create a new quote, as shown:<div class="ProgramCode" id="PC39"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "symbol" : "AAPL", "sellerId" : 11, "buyerId" : 21, "amount" : 100, "test" : 1, "delay" : 2 }</div></div></div></div><div class="Para" id="Par124">Keep watching all three consoles. Once you make sure Test Case 1 is completed, execute the second test case by again taking <span id="ITerm85">Postman</span> and creating another new quote, as shown:<div class="ProgramCode" id="PC40"><div class="LineGroup"><div class="FixedLine">{ "symbol" : "AMZN", "sellerId" : 11, "buyerId" : 21, "amount" : 200, "test" : 2, "delay" : 2 }</div></div></div></div><div class="Para" id="Par125">Once Test Case 2 has completed fully processed, execute the third test case:<div class="ProgramCode" id="PC41"><div class="LineGroup"><div class="FixedLine">{ "symbol" : "GOOG", "sellerId" : 11, "buyerId" : 21, "amount" : 300, "test" : 3, "delay" : 2 }</div></div></div></div><div class="Para" id="Par126">If you have followed along exactly, at the completion of Test Case 3, your consoles will look like Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig11">14-11</a></span> and Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig12">14-12</a></span>.<figure class="Figure" id="Fig11"><div class="MediaObject" id="MO11"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig11_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(10).jpg" style="height:28.62em" width="1725" height="1145" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig11_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-11</span><p class="SimplePara"><span id="ITerm86">Quotes and User tables</span>, pre-Test Case 4</p></div></figcaption></figure><figure class="Figure" id="Fig12"><div class="MediaObject" id="MO12"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig12_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(11).jpg" style="height:16.35em" width="999" height="654" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig12_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-12</span><p class="SimplePara"><span id="ITerm87">Stock Transaction table</span>, pre-Test Case 4</p></div></figcaption></figure></div><p class="Para" id="Par127">You may want to note in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig12">14-12</a></span> that, even though three new quotes were processed in the upstream microservice, there are only two transactions recorded in the <span class="EmphasisFontCategoryNonProportional ">Stock Transaction</span> table. This is because the quote message of Test Case 3 was lost upstream and never reached the downstream microservice. For the same reason, the quote amount of 300 in Test Case 3 was also not added to the buyer and seller, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig11">14-11</a></span>.</p><div class="Para" id="Par128">Now let’s execute the test case you intend to do and validate the effect of the design for resiliency. To test the Duplicate Message Being Sent test case, take Postman again and create another new quote, as shown:<div class="ProgramCode" id="PC42"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "symbol" : "NFLX", "sellerId" : 11, "buyerId" : 21, "amount" : 400, "test" : 4, "delay" : 2 }</div></div></div></div><div class="Para" id="Par129">Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig13">14-13</a></span> shows the new quote for Test Case 4. It has a status of “New.” When settled, the quote amount, 400, should get added to the respective running balances of the buyer and seller, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig11">14-11</a></span>.<figure class="Figure" id="Fig13"><div class="MediaObject" id="MO13"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig13_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(12).jpg" style="height:15.67em" width="1721" height="627" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig13_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-13</span><p class="SimplePara">Test Case 4 console, initially</p></div></figcaption></figure></div><p class="Para" id="Par130">The “Test the Duplicate Message Being Sent Scenario” section in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span> may be referenced for a detailed explanation of the test scenario you are executing. Here you simulate duplicate quote messages being sent by the <span id="ITerm88">upstream microservice</span>. In that section, you saw that the quote was settled twice, which is undesirable.</p><div class="Para" id="Par131">In the test case you execute in this section, you simulate duplicate quote messages being send by the upstream microservice. The simulation is effected by successfully sending the message and making the status update of the quote change from “New” to “Confirmed” fail. This is shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig14">14-14</a></span>. Here, the quote amount is already added during quote settlement by the <span id="ITerm89">downstream microservice</span>.<figure class="Figure" id="Fig14"><div class="MediaObject" id="MO14"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig14_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(13).jpg" style="height:31.55em" width="1725" height="1262" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig14_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-14</span><p class="SimplePara">Test Case 4 console, intermediate</p></div></figcaption></figure></div><p class="Para" id="Par132">You may also view the Stock Transaction console in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig15">14-15</a></span> and see that the settlement of the quote for Test Case 4 has been recorded.</p><div class="Para" id="Par133">In the next pass of the Quote Processor Task of the upstream microservice, it will pick up the same quote of Test Case 4 a second time for processing. This time you also send a quote message to the <span id="ITerm90">downstream microservice</span>; however, you do not simulate the error while you update the status of the quote from “New” to “Confirmed.” When this quote message reaches the downstream microservice as a duplicate, due to the enhanced design of the solution, the downstream microservice is now smart enough to understand by looking in the <span class="EmphasisFontCategoryNonProportional ">Stock Transaction</span> table (Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig15">14-15</a></span>) that this quote message is a duplicate and so it will not settle. All of this is shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig16">14-16</a></span>.<figure class="Figure" id="Fig15"><div class="MediaObject" id="MO15"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig15_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(14).jpg" style="height:17.18em" width="999" height="687" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig15_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-15</span><p class="SimplePara"><span id="ITerm91">Stock Transaction table</span> during Test Case 4</p></div></figcaption></figure><figure class="Figure" id="Fig16"><div class="MediaObject" id="MO16"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig16_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(15).jpg" style="height:31.78em" width="1725" height="1271" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig16_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-16</span><p class="SimplePara">Test Case 4 console at <span id="ITerm92">completion</span></p></div></figcaption></figure></div></section></section><section class="Section2 RenderAsSection2" id="Sec14"><h3 class="Heading">Test the Duplicate Message Consumption Scenario</h3><div class="Para" id="Par134">To test the <span id="ITerm93">Duplicate Message Consumption test case</span>, take Postman again and create another new quote, as shown (see Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig17">14-17</a></span>):<div class="ProgramCode" id="PC43"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "symbol" : "TSLA", "sellerId" : 11, "buyerId" : 21, "amount" : 500, "test" : 5, "delay" : 2 }</div></div></div><figure class="Figure" id="Fig17"><div class="MediaObject" id="MO17"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig17_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(16).jpg" style="height:33.68em" width="1725" height="1347" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig17_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-17</span><p class="SimplePara">Test Case 5 console, initially</p></div></figcaption></figure></div><div class="Para" id="Par135">In this test case, all works fine in the upstream <span id="ITerm94">microservices</span>. You settle the quote message at the downstream microservice and then you simulate an error in the reading of message by the downstream microservice’s message listener. The state at this point is shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig18">14-18</a></span>.<figure class="Figure" id="Fig18"><div class="MediaObject" id="MO18"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig18_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(17).jpg" style="height:34.52em" width="1725" height="1381" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig18_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-18</span><p class="SimplePara">Test Case 5 console, intermediate and complete</p></div></figcaption></figure></div><div class="Para" id="Par136">The settlement of the quote <span id="ITerm95">message</span> is also recorded in the <span class="EmphasisFontCategoryNonProportional ">Stock Transaction</span> table by the downstream microservice and is shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig19">14-19</a></span>.<figure class="Figure" id="Fig19"><div class="MediaObject" id="MO19"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig19_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(18).jpg" style="height:19.88em" width="1000" height="795" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig19_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-19</span><p class="SimplePara">Stock Transaction table during Test Case 5</p></div></figcaption></figure></div><div class="Para" id="Par137">Because you simulated an error in the reading of message by the downstream microservice’s message listener, the message broker will redeliver the message to the downstream <span id="ITerm96">microservice</span>. But when this quote message reaches the downstream microservice as a duplicate, due to the enhanced design of the solution, the downstream microservice is now smart enough to understand by looking in the <span class="EmphasisFontCategoryNonProportional ">Stock Transaction</span> table (in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig19">14-19</a></span>) that this quote message is a duplicate and will not settle again; the final state of the user balances remains as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig18">14-18</a></span>.<blockquote class="BlockQuote"><p class="Para" id="Par138">
                  <em class="EmphasisTypeItalic ">“If the consumer uses messages to simply write (and never overwrite) a value in a database, then receiving a message more than once is no different than receiving it exactly once”.</em>
                  <sup><a epub:type="noteref" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fn3" id="Fn3_source" class="totri-footnote">3</a></sup>
                </p></blockquote></div><p class="Para" id="Par140">This is true for some <span id="ITerm97">applications</span>, but not for all. At the very least, it requires the application to interpret incoming messages accordingly. There are many other aspects on messaging to the above statement with respect to microservices; however, we will park them for another textbook on this, because the linked aspects are manyfold.</p></section><section class="Section2 RenderAsSection2" id="Sec15"><h3 class="Heading">Test the Message Received Out of Order Scenario</h3><p class="Para" id="Par141">You have now executed up to Test Case 5. Before you execute Test Case 8 to simulate a message reaching out of order, you will execute Test Case 6 and Test Case 7, but I won’t explain further because I don’t want to showcase anything extra from what you already saw in the corresponding sections in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>.</p><div class="Para" id="Par142">For Test Case 6, take Postman and create a new quote, as shown:<div class="ProgramCode" id="PC44"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "symbol" : "MSFT", "sellerId" : 11, "buyerId" : 21, "amount" : 600, "test" : 6, "delay" : 2 }</div></div></div></div><div class="Para" id="Par143">Keep watching all three <span id="ITerm98">consoles</span>. Once you make sure Test Case 6 is completed, execute Test Case 7 by again taking Postman and creating another new quote, as shown:<div class="ProgramCode" id="PC45"><div class="LineGroup"><div class="FixedLine">{ "symbol" : "ORCL", "sellerId" : 11, "buyerId" : 21, "amount" : 700, "test" : 7, "delay" : 2 }</div></div></div></div><div class="Para" id="Par144">If you have followed along exactly as directed, at the completion of Test Case 7, your consoles will look like Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig20">14-20</a></span> and Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig21">14-21</a></span>.<figure class="Figure" id="Fig20"><div class="MediaObject" id="MO20"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig20_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(19).jpg" style="height:38.8em" width="1725" height="1552" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig20_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-20</span><p class="SimplePara"><span id="ITerm99">Quotes and User table</span>, pre-Test Case 8</p></div></figcaption></figure><figure class="Figure" id="Fig21"><div class="MediaObject" id="MO21"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig21_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(20).jpg" style="height:23.78em" width="1000" height="951" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig21_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-21</span><p class="SimplePara"><span id="ITerm100">Stock Transaction table</span>, pre-Test Case 8</p></div></figcaption></figure></div><p class="Para" id="Par145">The entities are now set to the state where you can execute Test Case 8, the actual test case intended to be examined in this section. Testing for this scenario is slightly tricky since you need to coordinate the timing of each action as per the test fixtures. I will explain based on the configuration for my test fixtures, which should work for you too if you have not made any changes to the example configurations.</p><p class="Para" id="Par146">You need to send a new quote for upstream processing but you want to delay the processing for a little while, and while this quote is waiting for this delay to be over, you also want to fire one more new quote for upstream processing, which will get processed nearly straight through without any delay. In this manner, the quote created later will reach the downstream system for further processing first, followed by the quote created initially. In this manner, you will simulate messages reaching out of order at the downstream system.</p><p class="Para" id="Par147">Before you start firing requests for this test case, read this section completely once to understand the preparations you need to make mentally so as to fire the new quotes as per instructions. Then come back to this point of explanation and continue the actual test.</p><div class="Para" id="Par148">Take Postman again and fire a new quote, as shown:<div class="ProgramCode" id="PC46"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div></div></div><div class="Para" id="Par149">Note that you are piggybacking a delay of 90 seconds along with the test request payload, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig22">14-22</a></span>.<div class="ProgramCode" id="PC47"><div class="LineGroup"><div class="FixedLine">{ "symbol" : "QCOM", "sellerId" : 11, "buyerId" : 21, "amount" : 800, "test" : 8, "delay" : 90}</div></div></div><figure class="Figure" id="Fig22"><div class="MediaObject" id="MO22"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig22_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(21).jpg" style="height:40.02em" width="1725" height="1601" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig22_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-22</span><p class="SimplePara">Test Case 8 console, creating the first <span id="ITerm101">quote</span></p></div></figcaption></figure></div><div class="Para" id="Par150">Keep watching the upstream microservice console (command prompt console) and when the Quote Processor Task times out, it will fetch this new quote and change the status from “New” to “Confirmed,” but before completing the end-to-end transaction, it will sleep for the 90 seconds delay you have provided. See Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig23">14-23</a></span>.<figure class="Figure" id="Fig23"><div class="MediaObject" id="MO23"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig23_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(22).jpg" style="height:39.98em" width="1725" height="1599" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig23_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-23</span><p class="SimplePara">Test Case 8 console, processing first <span id="ITerm102">quote</span></p></div></figcaption></figure></div><p class="Para" id="Par151">This 90 seconds has a significance because the next time-out of the Quote Processor Task will happen in the next 60 seconds, and during that time-out it shouldn’t fetch this quote because it is already in a processing state (the quote status is not “New”).</p><div class="Para" id="Par152">Here comes the trick: as soon as (within 10 to 20 seconds) the Quote Processor Task picks up the quote for processing and further goes to sleep for the delay of 90 seconds provided, you need to fire another new quote (ideally, you have another Postman session with the data ready), like so:<div class="ProgramCode" id="PC48"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "symbol" : "GILD", "sellerId" : 11, "buyerId" : 21, "amount" : 900, "test" : 8, "delay" : 2 }<span id="ITerm103">
                      
                      
                    </span></div></div></div></div><div class="Para" id="Par153">This second new quote is shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig24">14-24</a></span>. That’s all, and the steps for test execution are over.<figure class="Figure" id="Fig24"><div class="MediaObject" id="MO24"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig24_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(23).jpg" style="height:41.65em" width="1725" height="1666" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig24_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-24</span><p class="SimplePara">Test Case 8 console, creating a second <span id="ITerm104">quote</span></p></div></figcaption></figure></div><p class="Para" id="Par154">When the Quote Processor Task times out next, it will fetch this second new quote alone. This is because even though the first quote is still under process in the upstream system, the status of the quote has already been updated to “Confirmed,” as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig24">14-24</a></span>. This is effected by marking the transaction of Auction Service in the upstream microservice as TX_REQUIRES_NEW.</p><div class="Para" id="Par155">For the second new quote, there is a negligible process delay and it comes out of the upstream processing, gets through ActiveMQ, and reaches downstream for further processing. You expect that the first quote is still in the process stage in the upstream system. This way, the message is out of order in the downstream <span id="ITerm105">system</span>. This will be settled as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig25">14-25</a></span>.<figure class="Figure" id="Fig25"><div class="MediaObject" id="MO25"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig25_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(24).jpg" style="height:42.6em" width="1725" height="1704" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig25_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-25</span><p class="SimplePara">Test Case 8 console, second quote settled first</p></div></figcaption></figure></div><div class="Para" id="Par156">Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig26">14-26</a></span> also asserts that the quote created second <span id="ITerm106">during</span> Test Case 8 is in fact recorded in the <span class="EmphasisFontCategoryNonProportional ">Stock Transaction</span> table and that the quote is in a settled state.<figure class="Figure" id="Fig26"><div class="MediaObject" id="MO26"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig26_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(25).jpg" style="height:25.78em" width="1000" height="1031" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig26_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-26</span><p class="SimplePara">Stock Transaction table during Test Case 8</p></div></figcaption></figure></div><div class="Para" id="Par157">Keep watching the browser <span id="ITerm107">consoles</span>. Quite soon you will see the running balances of users in the downstream system change. This is the effect of the first quote whose upstream processing has been delayed so it reached the downstream system out of order and finally got settled, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig27">14-27</a></span>.<figure class="Figure" id="Fig27"><div class="MediaObject" id="MO27"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig27_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(26).jpg" style="height:38.68em" width="1724" height="1547" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig27_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-27</span><p class="SimplePara">Test Case 8 console, first quote settled as second</p></div></figcaption></figure></div><p class="Para" id="Par158">In the “Build and <span id="ITerm108">Test</span> the Example’s Happy Flow” section in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>, you read that the latest quote creation time in the upstream system was updated as the last quote time whenever the user account was updated. In the demonstration here, the last quote time of the user accounts were not changed as per the first quote created, which came last. This is correct, but you were not able to achieve in this in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>. Due to the enhanced design of the solution, the downstream microservice is now smart enough to understand by looking in detail at the arrived quote messages that for messages arriving out of order too the requirement is met. In general, regardless what transaction paradigm you use (relaxed BASE or not) you should always add code and design to address out-of-order messages when message ordering is important.</p><div class="Para" id="Par159">Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig28">14-28</a></span> shows the <span class="EmphasisFontCategoryNonProportional ">Stock Transaction</span> table, which also reflects the recording of messages out of order from the perspective of the order in which the original quote was created.<figure class="Figure" id="Fig28"><div class="MediaObject" id="MO28"><img alt="../images/477630_1_En_14_Chapter/477630_1_En_14_Fig28_HTML.jpg" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/4776(27).jpg" style="height:28.12em" width="1000" height="1125" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_14_Chapter/477630_1_En_14_Fig28_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 14-28</span><p class="SimplePara"><span id="ITerm109">Stock Transaction table</span>, post-Test Case 8</p></div></figcaption></figure></div></section></section><section class="Section1 RenderAsSection1" id="Sec16"><h2 class="Heading">Choosing Transaction Options</h2><p class="Para" id="Par160">You concluded the “Global vs. Local Resource” section by justifying that if you chose Option 1 for the <span id="ITerm110">architecture</span>, then when you dequeue messages from the queue for settlement by the Quotes Settlement microservice, you still have the two-phase transaction problem. If you consider quote settlement as a pure back-office process, one justification for you to still continue with the two-phase transactions is that you maximized the throughput and hence the availability of your customer-facing microservices while trading off comparatively lower responsiveness for your back-office microservices.</p><div class="Para" id="Par161">But what if a two-phase commit transaction is never acceptable in some parts of your microservice architecture? There are a bunch of implications associated with a two-phase commit transaction even if you justify using them for specific <span id="ITerm111">use cases</span>, as discussed earlier. Here are a few of them:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par162">Two-phase commit transaction coordinators are single points of failure. You would require distributed and replicated logs to keep state and keep the coordinator stateless to address this.<sup><a epub:type="noteref" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fn4" id="Fn4_source" class="totri-footnote">4</a></sup></p></li><li><p class="Para" id="Par164">Two-phase commit transactions are chatty in the order of two times the number of roundtrips to the resource compared to local transactions.</p></li><li><p class="Para" id="Par165">Resource locks last a bit longer, which can impede scalability in some cases.</p></li><li><p class="Para" id="Par166">Last but not least, two-phase commit transaction can’t solve every problem. You may still need manual intervention when something goes wrong, like when you want to bring back a database from a crash. To avoid this, a form of hot failover architecture is preferred.</p></li></ul></div></div><p class="Para" id="Par167">You need to judiciously select between two-phase and local transactions on a case-by-case basis, and this will be the case for many of the microservice architectures you develop in future. To make the scenario more <span id="ITerm112">specific</span>, assume that Architecture Option 1 shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig7">14-7</a></span> is more acceptable than Option 2. If so, if there is a need, how can you further avoid two-phase transactions between the Quote Settlement microservice and the ActiveMQ message broker and still take care of integrity of data? Let’s open this Pandora’s box in the next section.</p><section class="Section2 RenderAsSection2" id="Sec17"><h3 class="Heading">Message Queues, Peek, and Client Acknowledge</h3><p class="Para" id="Par168">Suppose that you want to adopt the Architecture Option 1 shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fig7">14-7</a></span> and still want to avoid two-phase commit transactions between the Quote Settlement microservice and the ActiveMQ message broker. When you avoid two-phase commit transactions, if the database operations and the <span id="ITerm113">message queue operations</span> are backed up by partitioned resources, they can’t be effected atomically. If they cannot be effected atomically, you don’t want to encapsulate the read and read-acknowledgement of messages from the queue to happen automatically; rather, the client program or the client code should control that. The JMS specification supports two types of message delivery: persistent and non-persistent. Persistent messages should be used if you want messages to always be available to a message consumer after they’ve been delivered to the broker, even if that consumer isn’t running when the message was sent. When a message is consumed and acknowledged by a message consumer, it’s typically deleted from the broker’s message store.</p><p class="Para" id="Par169">Javax.jms.Session may be specified as transacted. When transacted, session supports a single series of <span id="ITerm114">transactions</span>. Each transaction groups a set of message sends and a set of message receives into an atomic unit of work. In effect, transactions organize a session’s input message stream and output message stream into series of atomic units. When a transaction commits, its atomic unit of input is acknowledged and its associated atomic unit of output is sent. If a transaction rollback is done, the transaction’s sent messages are destroyed and the session’s input is automatically recovered.</p><div class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant" id="FPar3"><h3 class="Heading">Note</h3><p class="Para" id="Par170">Unlike XA transactions, JMS transactions concern only on the JMS messages of a single connection. A rollback or commit does not extend beyond a single connection.</p></div><div class="Para" id="Par171">In the examples in the current chapter and in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"><span class="RefSource">13</span></a></span>, you use the following configuration:<div class="ProgramCode" id="PC49"><div class="LineGroup"><div class="FixedLine">&lt;bean id="jmsTemplate" class="org.springframework.jms.core.JmsTemplate"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="sessionTransacted" value="true"/&gt;</div><div class="FixedLine">&lt;/bean&gt;</div></div></div></div><div class="Para" id="Par172">Alternatively, the SESSION_TRANSACTED <span id="ITerm115">value</span> may be passed as the argument to the method <span class="EmphasisFontCategoryNonProportional ">createSession(int sessionMode)</span> on the <span class="EmphasisFontCategoryNonProportional ">Connection</span> object to specify that the session should use a local transaction. When used, it rolls up acknowledgments with <span class="EmphasisFontCategoryNonProportional ">Session.commit()</span>.<div class="ProgramCode" id="PC50"><div class="LineGroup"><div class="FixedLine">Session session = connection.createSession(true, Session.SESSION_TRANSACTED);</div></div></div></div><div class="Para" id="Par173">By specifying <span id="ITerm116">false</span> and AUTO_ACKNOWLEDGE, you can create a nontransacted session and the session automatically acknowledges <span id="ITerm117">messages</span>. A message is automatically acknowledged when it successfully returns from the <span class="EmphasisFontCategoryNonProportional ">receive()</span> method or the <span class="EmphasisFontCategoryNonProportional ">onMessage()</span> method. If a failure occurs while executing the <span class="EmphasisFontCategoryNonProportional ">receive()</span> method or the <span class="EmphasisFontCategoryNonProportional ">onMessage()</span> method, the message is automatically redelivered. The JMS provider manages message redelivery and guarantees once-only delivery semantics. However, messages can still be lost if the application crashes right after <span class="EmphasisFontCategoryNonProportional ">receive()</span> returns and before the message can be processed.<div class="ProgramCode" id="PC51"><div class="LineGroup"><div class="FixedLine">Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);</div></div></div></div><p class="Para" id="Par174">If you create the receiver’s session and specify false as <span class="EmphasisFontCategoryNonProportional ">createSession()</span>’s first argument and Session.CLIENT_ACKNOWLEDGE as its second <span id="ITerm118">argument</span>, you create the Session in the client acknowledgement mode. This creates a nontransacted session and invoking the <span class="EmphasisFontCategoryNonProportional ">Message</span> class’s <span class="EmphasisFontCategoryNonProportional ">acknowledge()</span> method explicitly is required to acknowledge the messages. By invoking <span class="EmphasisFontCategoryNonProportional ">acknowledge()</span> on a consumed message, a client acknowledges all messages consumed by the session that the message was delivered to. A client may individually acknowledge each message as it is consumed, or it may choose to acknowledge messages as an application-defined group (which is done by calling <span class="EmphasisFontCategoryNonProportional ">acknowledge()</span> on the last received <span id="ITerm119">message</span> of the group, thereby acknowledging all messages consumed by the session). And messages that have been received but not acknowledged may be redelivered, and this is that double-edged sword: it’s a blessing as well as a curse. A blessing in the sense that, if not acknowledged, you can be sure that messages will be redelivered at some later time. At the same time, it’s a curse because if your application design doesn’t have the mechanisms to deal with duplicate messages, it will cause duplicate processing, which will have adverse effects.</p><div class="Para" id="Par175">Let’s look more into this aspect. See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC52">14-16</a></span>.<div class="ProgramCode" id="PC52"><div class="LineGroup"><div class="FixedLine">Start 2-Phase Transaction</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Start ActiveMQ Transaction-01</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Read Message from ActiveMQ</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Start Derby Transaction-01</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Record Quote Received in Derby</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End Derby Transaction-01</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Start Derby Transaction-02</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reconcile User Balances in Derby</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Change Quote Status</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End Derby Transaction-02</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;End ActiveMQ Transaction-01</div><div class="FixedLine">End 2-Phase Transaction</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-16</span><p class="SimplePara">ActiveMQ and <span id="ITerm120">Derby Within Two-Phase Tx</span></p></div></div></div></div><div class="Para" id="Par176">The message consumption from the ActiveMQ queue and the database operations in the Derby database you saw in the downstream processing in the previous example in this chapter can be pseudo coded as shown in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC52">14-16</a></span>. If you remove the two-phase transactions, the same can be rewritten as Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC53">14-17</a></span>.<div class="ProgramCode" id="PC53"><div class="LineGroup"><div class="FixedLine">Read Message from ActiveMQ</div><div class="FixedLine">Start Derby Transaction-01</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Record Quote Received in Derby</div><div class="FixedLine">End Derby Transaction-01</div><div class="FixedLine">Start Derby Transaction-02</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Reconcile User Balances in Derby</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Change Quote Status</div><div class="FixedLine">End Derby Transaction-02</div><div class="FixedLine">Acknowledge Message Read from ActiveMQ</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-17</span><p class="SimplePara">ActiveMQ and <span id="ITerm121">Derby Without Two-Phase Tx</span></p></div></div></div></div><div class="Para" id="Par177">This is equivalent to Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC54">14-18</a></span>.<div class="ProgramCode" id="PC54"><div class="LineGroup"><div class="FixedLine">Peek Message from ActiveMQ</div><div class="FixedLine">Start Derby Transaction-01</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Record Quote Received in Derby</div><div class="FixedLine">End Derby Transaction-01</div><div class="FixedLine">Start Derby Transaction-02</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Reconcile User Balances in Derby</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Change Quote Status</div><div class="FixedLine">End Derby Transaction-02</div><div class="FixedLine">Remove Message from ActiveMQ</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 14-18</span><p class="SimplePara">ActiveMQ and <span id="ITerm122">Derby with Local Tx</span></p></div></div></div></div><p class="Para" id="Par178">The pseudocode in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#PC54">14-18</a></span> depends upon the capability of peeking at a message in the queue without removing it and removing the messages from the queue once successfully processed. This can be done with two or more independent transactions if necessary, as shown in the pseudocode: one on the message queue, another one on the user database to record the quote message, and a third one to reconcile the user balances and change the quote status. User balance reconciliation and quote status change are committed atomically; however, no two-phase transactions are required since both operations happen in the same local resource. Queue operations are not committed unless database operations successfully commit. A partial failure during the database operations will keep the queue operation uncommitted so that the message is redelivered sooner or later and processing starts over again. The algorithm now supports partial failures and still provides transactional guarantees. This algorithm or method is one attempt to implement eventual consistency between distributed microservices without the use of distributed and two-phase commit transactions. The example code provided here can be enhanced to implement multiple variants of the above methodology; this is left as an exercise for you to get your hands wet with the <span id="ITerm123">code</span>. Note that this requires an implementation of the “idempotent consumer pattern,” which is hard to do correctly.<sup><a epub:type="noteref" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fn5" id="Fn5_source" class="totri-footnote">5</a></sup> Additional testing is required, beyond the basic exploratory test cases in this chapter, so that every possible failure mode is taken into account</p></section></section><section class="Section1 RenderAsSection1" id="Sec18"><h2 class="Heading">Summary</h2><p class="Para" id="Par180">Just like many of my colleagues, I too loved transactions. I have been using declarative transaction management since 1999 where we were thrilled to be among the first few to download the <em class="EmphasisTypeItalic ">Sun’s Reference Implementation of J2EE Server with EJB</em><sup><a epub:type="noteref" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fn6" id="Fn6_source" class="totri-footnote">6</a></sup> <em class="EmphasisTypeItalic ">(Enterprise Java Beans) Containers</em> in the process of implementing an expert system for optimizing operations of an airline passenger reservation system for a European airline. It’s been 20 years since then, and we still love transactions, both local and distributed. However, the point is that the choice between distributed and local transactions has to be done on a case-by-case basis based on the context, functionality, and criticality of the microservice involved. Designing systems leveraging distributed transaction managers in cases where you don’t mandatorily need them will be costly since it may increase the operations cost as well as slightly affect the performance. You saw a few techniques in this chapter that you can use to design fault-tolerant microservices that must be eventually consistent, although I did not address all possible anomalies. In the next chapter, you will extend this learning to look at few other scenarios including but not limited to long-running transactions.</p></section><aside class="FootnoteSection" epub:type="footnotes"><div class="Heading">Footnotes</div><div class="Footnote"><span class="FootnoteNumber"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fn1_source" class="totri-footnote">1</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn1"><p class="Para" id="Par3">For more details, visit the online course at <span class="ExternalRef"><a href="https://atomikos.teachable.com/p/microservice-transaction-patterns"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional ">https://atomikos.teachable.com/p/microservice-transaction-patterns</span>
                </span></a></span></p></div><div class="ClearBoth">&nbsp;</div></div><div class="Footnote"><span class="FootnoteNumber"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fn2_source" class="totri-footnote">2</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn2"><p class="Para" id="Par27">
                  <span class="ExternalRef"><a href="http://www.atomikos.com/Blog/IdempotentJmsConsumerPitfalls"><span class="RefSource">
                      <span class="EmphasisFontCategoryNonProportional ">www.atomikos.com/Blog/IdempotentJmsConsumerPitfalls</span>
                    </span></a></span>
                </p></div><div class="ClearBoth">&nbsp;</div></div><div class="Footnote"><span class="FootnoteNumber"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fn3_source" class="totri-footnote">3</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn3"><p class="Para" id="Par139">O’Reilly, <em class="EmphasisTypeItalic ">New Designs for Streaming Architecture</em></p></div><div class="ClearBoth">&nbsp;</div></div><div class="Footnote"><span class="FootnoteNumber"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fn4_source" class="totri-footnote">4</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn4"><p class="Para" id="Par163"><span class="ExternalRef"><a href="http://www.atomikos.com/Documentation/LogCloud"><span class="RefSource">
                          <span class="EmphasisFontCategoryNonProportional ">www.atomikos.com/Documentation/LogCloud</span>
                        </span></a></span> shows a new generation of coordinator.</p></div><div class="ClearBoth">&nbsp;</div></div><div class="Footnote"><span class="FootnoteNumber"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fn5_source" class="totri-footnote">5</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn5"><p class="Para" id="Par179">
                  <span class="ExternalRef"><a href="http://www.atomikos.com/Blog/IdempotentJmsConsumerPitfalls"><span class="RefSource">
                      <span class="EmphasisFontCategoryNonProportional ">www.atomikos.com/Blog/IdempotentJmsConsumerPitfalls</span>
                    </span></a></span>
                </p></div><div class="ClearBoth">&nbsp;</div></div><div class="Footnote"><span class="FootnoteNumber"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#Fn6_source" class="totri-footnote">6</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn6"><p class="Para" id="Par181">The EJB specification was originally developed in 1997 by IBM and later adopted by Sun Microsystems (EJB 1.0 and 1.1) in 1999 and enhanced under the Java Community Process as JSR 19 (EJB 2.0), JSR 153 (EJB 2.1), JSR 220 (EJB 3.0), JSR 318 (EJB 3.1) and JSR 345 (EJB 3.2).</p></div><div class="ClearBoth">&nbsp;</div></div></aside></div><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-0" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders">
		
		<li class="copy"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#">Add Highlight</a></li>
		<li class="add-note"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#">
			Add Note
		</a></li>
		
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">13.&nbsp;Distributed Transactions</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_15_Chapter.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">15.&nbsp;Transactions Optimized for Microservices</div>
        </a>
    
  
  </div>


        
    </section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    



        
      </div>
      
        

<footer class="pagefoot t-pagefoot">
  <a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" class="icon-up" onclick="window.Appcues.track(&#39;JumpTop_HeronBook&#39;)"><div class="visuallyhidden">Back to top</div></a>
  <ul class="js-footer-nav">
  
    
    <li><a href="https://learning.oreilly.com/u/preferences/">Settings</a></li>
    
    <li><a href="https://learning.oreilly.com/public/support/">Support</a></li>
    
    <li><a href="https://learning.oreilly.com/accounts/logout/">Sign Out</a></li>
    
  
  
  </ul>
  <span class="copyright">© 2020 <a href="https://learning.oreilly.com/" target="_blank">O'Reilly Media, Inc</a>.</span>
  
    
    <a href="https://www.oreilly.com/terms/">Terms of Service</a> 
     / 
    
    <a href="https://learning.oreilly.com/privacy">Privacy Policy</a> 
    
    
  
</footer>

      
    
    <script src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/saved_resource" charset="utf-8"></script>
    <script src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/saved_re(1)" charset="utf-8"></script>
  

<div class="annotator-notice"></div><div class="font-flyout" style="top: 151.016px; left: 1280px;"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml#">Reset</a>
</div>
</div><div></div><div></div><iframe src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/pixel.html" style="display: none;"></iframe><script type="text/javascript" async="" src="./14. Transactions and Microservices - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/generic1595.下载" charset="UTF-8"></script><span></span><div style="display: none; visibility: hidden;"><script>(function(){if(null!==document.querySelector('iframe[title\x3d"fb:share_button Facebook Social Plugin"]')&&void 0!==document.querySelector('iframe[title\x3d"fb:share_button Facebook Social Plugin"]')){var a=!1;window.addEventListener("blur",function(){a&&dataLayer.push({event:"eventTracker",eventCat:"social",eventAct:"share",eventLbl:"facebook",eventVal:0,nonInteraction:0})});document.querySelector('iframe[title\x3d"fb:share_button Facebook Social Plugin"]').addEventListener("mouseover",function(){window.focus();
a=!0});document.querySelector('iframe[title\x3d"fb:share_button Facebook Social Plugin"]').addEventListener("mouseout",function(){a=!1})}if(null!==document.querySelector("iframe.twitter-share-button")&&void 0!==document.querySelector("iframe.twitter-share-button")){var b=!1;window.addEventListener("blur",function(){b&&dataLayer.push({event:"eventTracker",eventCat:"social",eventAct:"share",eventLbl:"twitter",eventVal:0,nonInteraction:0})});document.querySelector("iframe.twitter-share-button").addEventListener("mouseover",
function(){window.focus();b=!0});document.querySelector("iframe.twitter-share-button").addEventListener("mouseout",function(){b=!1})}try{window.twttr=function(a,b,d){var c,e=a.getElementsByTagName(b)[0];if(!a.getElementById(d))return a=a.createElement(b),a.id=d,a.src="//platform.twitter.com/widgets.js",e.parentNode.insertBefore(a,e),window.twttr||(c={_e:[],ready:function(a){c._e.push(a)}})}(document,"script","twitter-wjs"),twttr.ready(function(a){a.events.bind("tweet",trackTwitter)})}catch(c){}})();
null!==document.querySelector(".IN-widget")&&void 0!==document.querySelector(".IN-widget")&&document.querySelector(".IN-widget").addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"social",eventAct:"share",eventLbl:"linkedin",eventVal:0,nonInteraction:0})});
function trackTwitter(a){a&&(a.target&&"IFRAME"==a.target.nodeName&&(opt_target=extractParamFromUri(a.target.src,"url")),dataLayer.push({event:"eventTracker",eventCat:"social",eventAct:"share",eventLbl:"twitter",eventVal:0,nonInteraction:0}))}function extractParamFromUri(a,b){if(a&&(b=new RegExp("[\\?\x26#]"+b+"\x3d([^\x26#]*)"),a=b.exec(a),null!=a))return unescape(a[1])};</script></div><script type="text/javascript" id="">function forceInputUppercase(a){var b=a.target.selectionStart,c=a.target.selectionEnd;a.target.value=a.target.value.toUpperCase();a.target.setSelectionRange(b,c)}void 0!=document.getElementById("id_promotion")&&null!=document.getElementById("id_promotion")&&document.getElementById("id_promotion").addEventListener("keyup",forceInputUppercase,!1);
void 0!=document.getElementsByName("promotionCode")[0]&&null!=document.getElementsByName("promotionCode")[0]&&document.getElementsByName("promotionCode")[0].addEventListener("keyup",forceInputUppercase,!1);</script><script type="text/javascript" id="">var nonwExpandable=document.querySelectorAll(".orm-ff-NavigationSubnav-headerListItem a, .orm-ff-NavigationView-headerListItem a");nonwExpandable.forEach(function(a,b){b+1!=nonwExpandable.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):b+1==nonwExpandable.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var nonwExpandableFo=document.querySelectorAll(".drop-content li:not(.flyout-parent) a");
nonwExpandableFo.forEach(function(a,b){"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1!=nonwExpandableFo.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1==nonwExpandableFo.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var expandable=document.querySelectorAll(".orm-ff-NavigationSubnav-toggleControls a, .orm-ff-NavigationView-toggleControls a");expandable.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.parentNode.parentNode.parentNode.querySelectorAll(".orm-Button-btnContentWrap span")[0].childNodes[1].textContent+" | "+a.textContent})})});var flyoutLinks=document.querySelectorAll(".flyout a");
flyoutLinks.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.closest("li.flyout-parent").getElementsByTagName("a")[0].textContent+" | "+a.textContent})})});</script></body></html>