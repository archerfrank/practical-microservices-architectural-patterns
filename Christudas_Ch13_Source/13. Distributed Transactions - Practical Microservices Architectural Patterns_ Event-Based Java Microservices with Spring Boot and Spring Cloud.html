<!DOCTYPE html>
<!-- saved from url=(0127)https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml -->
<html class=" js flexbox flexboxlegacy no-touch websqldatabase indexeddb history csscolumns csstransforms localstorage sessionstorage applicationcache svg inlinesvg zoom" lang="en" prefix="og: http://ogp.me/ns/# og:book: http://ogp.me/ns/book# og:video: http://ogp.me/ns/video#" itemscope="" itemtype="http://schema.org/Book http://schema.org/ItemPage" data-login-url="/accounts/login/" data-offline-url="/" data-url="/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_12_Chapter.xhtml" data-csrf-cookie="csrfsafari" data-highlight-privacy="private" data-user-id="4423847" data-user-uuid="6d9ee17b-34b1-4bf4-bdae-19676bd84ca1" data-username="fwang3" data-account-type="B2B" data-activated-trial-date="" data-archive="9781484245019" data-publishers="Apress" data-htmlfile-name="477630_1_En_12_Chapter.xhtml" data-epub-title="Practical Microservices Architectural Patterns: Event-Based Java Microservices with Spring Boot and Spring Cloud" data-debug="0" data-testing="0" style=""><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="author" content="O&#39;Reilly Media"><meta name="format-detection" content="telephone=no"><meta http-equiv="cleartype" content="on"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="apple-itunes-app" content="app-id=881697395, app-argument=safaridetail://9781484245019"><link rel="shortcut icon" href="https://www.oreilly.com/favicon.ico"><meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0"><meta property="twitter:account_id" content="4503599627559754"><link rel="shortcut icon" href="https://learning.oreilly.com/favicon.ico" type="image/x-icon"><link href="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/css" rel="stylesheet" type="text/css"><title>13.&nbsp;Distributed Transactions - Practical Microservices Architectural Patterns: Event-Based Java Microservices with Spring Boot and Spring Cloud</title><link rel="stylesheet" href="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/output.731fc84c4.css" type="text/css"><link rel="stylesheet" type="text/css" href="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/annotator.e3b0c4.css"><link rel="stylesheet" href="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/font-awesome.min.css"><style type="text/css" title="ibis-book">#sbo-rt-content a{text-decoration:none}#sbo-rt-content a:link,#sbo-rt-content a:active{color:#0176C3}#sbo-rt-content a:visited{color:#5f5f5f}#sbo-rt-content div{font-family:"Cambria","Minion Pro","Times New Roman","Times",serif;}#sbo-rt-content img{border:0;vertical-align:middle}#sbo-rt-content video{display:block;margin-top:1em;max-width:100%;text-indent:0;width:100%}#sbo-rt-content p{margin:0}#sbo-rt-content .Heading,#sbo-rt-content .SubHeading,#sbo-rt-content .ContextInformation,#sbo-rt-content .MainTitleSection,#sbo-rt-content .PartTitle,#sbo-rt-content .SeriesTitle,#sbo-rt-content .SeriesSubTitle,#sbo-rt-content .SubSeriesTitle,#sbo-rt-content .SubSeriesSubTitle,#sbo-rt-content .BookTitle,#sbo-rt-content .BookSubTitle,#sbo-rt-content .ForewordTitle,#sbo-rt-content .PrefaceTitle,#sbo-rt-content .BookAcknowledgmentsTitle,#sbo-rt-content .BookNotesTitle{text-align:left !important}#sbo-rt-content .Heading,#sbo-rt-content .SubHeading{display:block;font-weight:bold}#sbo-rt-content .ArticleContextInformation{border-bottom:1px solid;margin-bottom:.8em;padding-bottom:.3em}#sbo-rt-content .ArticleContextInformation .ContextInformation{display:block;font-size:80%}#sbo-rt-content .ArticleContextInformation .JournalTitle:after,#sbo-rt-content .ArticleContextInformation .JournalSubTitle:after{content:", "}#sbo-rt-content .ArticleCopyright{display:inline}#sbo-rt-content .ArticleCopyright .CopyrightComment,#sbo-rt-content .ArticleContextInformation .ArticleDOI{display:block}#sbo-rt-content .ChapterContextInformation{border-bottom:1px solid;margin-bottom:.8em;padding-bottom:.3em}#sbo-rt-content .ChapterContextInformation .ContextInformation{display:block;font-size:80%}#sbo-rt-content .ChapterCopyright .CopyrightComment{display:block}#sbo-rt-content .ChapterContextInformation .BookEdition:before{content:", "}#sbo-rt-content .ChapterContextInformation .ContextInformationAuthorEditorNames:after{content:", "}#sbo-rt-content .ChapterContextInformation .BookTitle{font-style:italic}#sbo-rt-content .ChapterContextInformation .SeriesTitle:before{content:", "}#sbo-rt-content .ChapterContextInformation .SeriesSubTitle:before{content:": "}#sbo-rt-content .ChapterContextInformation .ContextInformationVolumeNumber:before{content:" "}#sbo-rt-content .ChapterContextInformation .ChapterDOI{display:block}#sbo-rt-content .Categories{color:#666;margin-bottom:1em;margin-top:1em}#sbo-rt-content .ArticleCategory,#sbo-rt-content .ChapterCategory{font-size:1.2rem}#sbo-rt-content .ArticleSubCategory,#sbo-rt-content .ChapterSubCategory{font-size:1rem}#sbo-rt-content .MainTitleSection{font-weight:bold;margin-bottom:1.2em;margin-top:1.2em}#sbo-rt-content .ArticleSuperTitle{font-size:1.2rem}#sbo-rt-content .MainTitleSection .ArticleTitle,#sbo-rt-content .ForeignLanguageHeader .ArticleTitle,#sbo-rt-content .MainTitleSection .ChapterTitle,#sbo-rt-content .ForeignLanguageHeader .ChapterTitle{font-size:1.73rem;margin:0}#sbo-rt-content .ArticleSubTitle,#sbo-rt-content .ChapterSubTitle{font-size:1.2rem;padding-top:.2em}#sbo-rt-content div>.AuthorGroup .AuthorNames,#sbo-rt-content .BookBackmatter>.AuthorGroup .AuthorNames{font-size:100%;margin-bottom:1em;margin-top:1em;text-align:left !important}#sbo-rt-content .BookBackmatter>.AuthorGroup .AuthorNames{font-weight:bold}#sbo-rt-content .AuthorNames sup{font-size:70%}#sbo-rt-content .Prefix:after{content:" "}#sbo-rt-content .Suffix:before{content:" "}#sbo-rt-content .Degrees:before{content:", "}#sbo-rt-content .NativeName:before,#sbo-rt-content .Role:before{content:" ("}#sbo-rt-content .NativeName:after,#sbo-rt-content .Role:after{content:")"}#sbo-rt-content .AffiliationNumber{float:left;padding-right:.5em}#sbo-rt-content .AffiliationText{margin-left:2em}#sbo-rt-content .AffiliationHint{font-style:italic}#sbo-rt-content .AuthorNames .DeceasedSymbol:before{content:"†";padding-left:3px}#sbo-rt-content .AuthorNames .EqualContributionSymbol:before{content:"*";padding-left:3px}#sbo-rt-content .InstitutionMembers:before{content:" ("}#sbo-rt-content .InstitutionMembers:after{content:")"}#sbo-rt-content .AffiliationLegend .DeceasedSymbol:before{content:"†";display:inline-block;width:14px}#sbo-rt-content .AffiliationLegend .EqualContributionSymbol:before{content:"*";display:inline-block;width:14px}#sbo-rt-content .ClearBoth{clear:both;font-size:0;line-height:0 !important}#sbo-rt-content .Contact,#sbo-rt-content .AffiliationLegend{margin-bottom:1em;margin-top:1em}#sbo-rt-content .ContactIcon{background-image:url(envelope.png);background-repeat:no-repeat;background-size:contain;width:.8rem}#sbo-rt-content .AuthorNames .ContactIcon{display:inline-block}#sbo-rt-content .Contact .ContactIcon{float:left;margin-top:4px;margin-right:4px}#sbo-rt-content .ContactAuthorLine{padding-left:20px;font-weight:bold}#sbo-rt-content .ContactAdditionalLine{padding-left:20px}#sbo-rt-content .ContactType{font-weight:bold}#sbo-rt-content .ArticleHistory{margin-bottom:1em;margin-top:1em}#sbo-rt-content .HistoryLabel{font-weight:bold}#sbo-rt-content .History+.History{padding-left:.5em}#sbo-rt-content .ArticleOrChapterToc{border-top:1px solid #bbb;margin-top:1em;padding-top:1em}#sbo-rt-content .ArticleOrChapterToc .HeadingNumber{font-weight:bold;padding-right:.3em}#sbo-rt-content .Abstract{margin-top:1em}#sbo-rt-content .Abstract>.Heading{font-size:1em;margin:0}#sbo-rt-content .AbstractSection{margin-top:.3em}#sbo-rt-content .Heading+.AbstractSection{margin-top:0}#sbo-rt-content .AbstractSection>.Heading{font-size:1em;font-style:italic;font-weight:normal;margin:0}#sbo-rt-content .KeywordGroup{margin-top:1em}#sbo-rt-content .KeywordGroup .Heading{display:inline;font-size:1em;margin:0;padding-right:.5em}#sbo-rt-content .Keyword+.Keyword:before{content:" – "}#sbo-rt-content .ArticleExternalID{margin-top:1em}#sbo-rt-content .ArticleExternalIDLabel{font-weight:bold}#sbo-rt-content .ForeignLanguageHeader{border-top:1px solid #bbb;margin-top:1em}#sbo-rt-content .ForeignLanguageTitleSection{font-weight:bold;margin-bottom:1.2em;margin-top:1rem}#sbo-rt-content .AbbreviationGroup{margin-top:1em}#sbo-rt-content .ForeignLanguageHeader+.AbbreviationGroup{border-top:1px solid #bbb;margin-top:1em;padding-top:1em}#sbo-rt-content .AbbreviationGroup>.Heading{font-size:1em;margin:0}#sbo-rt-content .AbbreviationGroup .DefinitionList{margin-top:0;margin-bottom:0;padding-right:.1em;padding-top:.1em;padding-bottom:.1em}#sbo-rt-content .AbbreviationGroupSection>.Heading{font-size:1em;margin:0;padding-top:.2em}#sbo-rt-content .ArticleNote{margin-top:1em}#sbo-rt-content .ArticleNote>.Heading{font-size:1em;margin:0}#sbo-rt-content .ArticleNoteMotto{font-style:italic;margin-left:1.5em;margin-right:1.5em;text-align:right}#sbo-rt-content .Biography{display:block;margin-top:.8em;padding-bottom:0;width:100%}#sbo-rt-content .Loc .AuthorGroup .Biography{margin-top:0}#sbo-rt-content .Biography .FormalPara,#sbo-rt-content .Biography .BiographyFigure{display:block;margin-top:0;margin-bottom:0}#sbo-rt-content .Biography .BiographyFigure{float:right;margin-left:6px}#sbo-rt-content .Biography .Figure{border-bottom:none;margin-top:.5em;margin-bottom:0}#sbo-rt-content .Fulltext>.Para:first-of-type>.BlockQuote:first-child{margin-top:0}#sbo-rt-content .BlockQuote{margin:1em 1.5em}#sbo-rt-content .BlockQuote>.Heading{font-size:1em;margin-top:1em;margin-bottom:0;text-indent:0}#sbo-rt-content .BlockQuote>.Para{text-indent:0}#sbo-rt-content .Heading+.Para>.BlockQuote:first-child{margin-top:0}#sbo-rt-content .Caption,#sbo-rt-content .TableFooter{display:block;text-align:left}#sbo-rt-content .TableFooter .SimplePara+.SimplePara{text-indent:0}#sbo-rt-content .Caption{margin-top:.5em}#sbo-rt-content .CaptionContent{font-size:90%}#sbo-rt-content .TableFooter{margin-top:1em}#sbo-rt-content .Table .Caption{margin-top:.5em}#sbo-rt-content .Figure .Caption,#sbo-rt-content video+.Caption{margin-bottom:1em}#sbo-rt-content .Table .Caption{margin-bottom:.5em}#sbo-rt-content .CaptionNumber{font-style:italic;font-weight:bold;padding-right:.6em}#sbo-rt-content .CaptionContent>span.Heading{display:inline}#sbo-rt-content .CaptionContent>span.SimplePara{display:block}#sbo-rt-content .CaptionContent>.SimplePara:first-child,#sbo-rt-content .CaptionContent>.CaptionNumber+.SimplePara,#sbo-rt-content .CaptionContent>a+.SimplePara{display:inline;margin-top:0}#sbo-rt-content .Credit>.SimplePara{text-indent:1.5em}#sbo-rt-content .DefinitionList{margin-top:1em;margin-bottom:1em;padding:.1em}#sbo-rt-content .DefinitionList>.Heading{font-size:1rem;margin:0;text-indent:0}#sbo-rt-content dl{margin:0}#sbo-rt-content .DefinitionList:after{content:"";clear:both;display:table}#sbo-rt-content .Term{clear:both;float:left;font-style:italic;padding-right:1em;text-indent:0;vertical-align:top}#sbo-rt-content .Description{padding-bottom:.3em;margin-left:0}#sbo-rt-content .Description .Para:first-child{text-indent:0}#sbo-rt-content .Heading+.Para>div.DefinitionList:first-child{margin-top:0}#sbo-rt-content .EmphasisTypeBold{font-weight:bold}#sbo-rt-content .EmphasisTypeItalic{font-style:italic}#sbo-rt-content .EmphasisTypeUnderline{text-decoration:underline}#sbo-rt-content .EmphasisTypeDoubleUnderline{border-bottom-style:double}#sbo-rt-content .EmphasisTypeSmallCaps{font-variant:small-caps}#sbo-rt-content .EmphasisTypeBoldItalic{font-weight:bold;font-style:italic}#sbo-rt-content .EmphasisTypeBoldUnderline{font-weight:bold;text-decoration:underline}#sbo-rt-content .EmphasisTypeBoldDoubleUnderline{font-weight:bold;border-bottom-style:double}#sbo-rt-content .EmphasisTypeBoldSmallCaps{font-weight:bold;font-variant:small-caps}#sbo-rt-content .EmphasisTypeItalicUnderline{font-style:italic;text-decoration:underline}#sbo-rt-content .EmphasisTypeItalicDoubleUnderline{font-style:italic;border-bottom-style:double}#sbo-rt-content .EmphasisTypeItalicSmallCaps{font-style:italic;font-variant:small-caps}#sbo-rt-content .EmphasisTypeBoldItalicUnderline{font-weight:bold;font-style:italic;text-decoration:underline}#sbo-rt-content .EmphasisTypeBoldItalicDoubleUnderline{font-weight:bold;font-style:italic;border-bottom-style:double}#sbo-rt-content .EmphasisTypeBoldItalicSmallCaps{font-weight:bold;font-style:italic;font-variant:small-caps}#sbo-rt-content .EmphasisTypeUnderlineSmallCaps{text-decoration:underline;font-variant:small-caps}#sbo-rt-content .EmphasisTypeDoubleUnderlineSmallCaps{border-bottom-style:double;font-variant:small-caps}#sbo-rt-content .EmphasisFontCategoryNonProportional{font-family:"Courier New",Courier,monospace}#sbo-rt-content :not(.ParaTypeProgramcode)>.EmphasisFontCategoryNonProportional{font-size:95%}#sbo-rt-content .EmphasisFontCategorySansSerif{font-family:"Arial","Helvetica",sans-serif;font-size:75%}#sbo-rt-content .EmphasisTypeStrikethrough{text-decoration:line-through}#sbo-rt-content .Equation{display:block;text-indent:0;vertical-align:middle}#sbo-rt-content .NumberedEquation{display:table;width:100%}#sbo-rt-content .NumberedEquation .EquationWrapper{display:table-row}#sbo-rt-content .NumberedEquation .EquationContent{display:table-cell}#sbo-rt-content .EquationContent{margin-top:.5em;margin-bottom:0;width:100%;text-align:center;text-indent:0;vertical-align:middle}#sbo-rt-content .EquationContent div{margin-top:.5em}#sbo-rt-content .EquationContent .MediaObject{margin-left:auto;margin-right:auto}#sbo-rt-content .EquationContent img{background:white;max-width:100%}#sbo-rt-content .EquationNumber{display:table-cell;margin-bottom:.4em;text-align:right;vertical-align:middle;white-space:nowrap}#sbo-rt-content .EquationSourceXml{white-space:nowrap}#sbo-rt-content .InlineEquation img{background:white;vertical-align:text-top}#sbo-rt-content .Figure{margin-top:1em;margin-bottom:1em;margin-left:0;margin-right:0;text-align:center;text-indent:0}#sbo-rt-content .Figure img{height:auto;margin:0;max-width:100%;padding:2px}#sbo-rt-content .MediaObject{display:block;text-align:center}#sbo-rt-content .MediaObject:last-child{margin-bottom:1em}#sbo-rt-content .EquationContent>.MediaObject:last-child{margin-bottom:0}#sbo-rt-content .MediaObject+.MediaObject{margin-top:1em}#sbo-rt-content .FootnoteSection{border-top:1px solid #bbb;margin-top:1em}#sbo-rt-content .FootnoteSection>.Heading{font-size:1.44rem;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .Footnote{clear:both;font-size:90%;text-align:left}#sbo-rt-content .FootnoteNumber{float:left;padding-right:.5em}#sbo-rt-content .FootnoteParas>div{margin-left:1em;margin-top:.3em}#sbo-rt-content .FormalPara{margin-top:1em;margin-bottom:1em}#sbo-rt-content .FormalPara .Heading{font-size:1em;margin:0}#sbo-rt-content .FormalParaRenderingStyle1>.Heading{display:inline;padding-right:1em}#sbo-rt-content .FormalParaRenderingStyle2>.Heading{display:inline;font-style:italic;font-weight:normal;padding-right:1em}#sbo-rt-content .FormalParaRenderingStyle3>.Heading{padding-right:1em}#sbo-rt-content .FormalParaRenderingStyle1>p:first-of-type,#sbo-rt-content .FormalParaRenderingStyle2>p:first-of-type{display:inline}#sbo-rt-content .Heading+.FormalPara{margin-top:0}#sbo-rt-content .FormalPara .AuthorNames{font-style:italic;font-weight:normal !important}#sbo-rt-content .HeadingNumber{padding-right:.3em}#sbo-rt-content .RenderAsSection1>.Heading{font-size:1.44rem;margin-top:.5em;margin-bottom:.1em}#sbo-rt-content .RenderAsSection2>.Heading{font-size:1.2rem;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .Heading+.Section2>.Heading:first-child{margin-top:0}#sbo-rt-content .RenderAsSection3>.Heading{font-size:1.2rem;font-style:italic;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .Heading+.Section3>.Heading:first-child{margin-top:0}#sbo-rt-content .RenderAsSection4>.Heading{font-size:100%;font-style:italic;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .Heading+.Section4>.Heading:first-child{margin-top:0}#sbo-rt-content .RenderAsSection5>.Heading{font-size:100%;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .Heading+.Section5>.Heading:first-child{margin-top:0}#sbo-rt-content .RenderAsSection6>.Heading{font-size:100%;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .Heading+.Section6>.Heading:first-child{margin-top:0}#sbo-rt-content .RenderAsSection7>.Heading{font-size:100%;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .Heading+.Section7>.Heading:first-child{margin-top:0}#sbo-rt-content .Literal{font-family:"Courier New",Courier,monospace}#sbo-rt-content .OrderedList{margin-top:.5em;margin-bottom:.5em;text-indent:0;display:table}#sbo-rt-content .OrderedList>ol{margin:0;padding:0}#sbo-rt-content .OrderedList .Heading{font-size:1em;font-style:italic;font-weight:normal;margin-top:0;margin-bottom:0;display:table-caption}#sbo-rt-content .OrderedList .Heading+.ListItem{margin-top:0}#sbo-rt-content .Heading+.Para>div.OrderedList:first-child,#sbo-rt-content .Heading+.Para>div.OrderedList:first-child>.Heading{margin-top:0}#sbo-rt-content .ListItem{margin-top:.5em;display:table-row}#sbo-rt-content .ItemNumber{padding-right:.5em;display:table-cell;vertical-align:top}#sbo-rt-content .ItemContent{display:table-cell}#sbo-rt-content .Fulltext>.Para:first-of-type{border-top:1px solid #bbb;margin-top:1em;padding-top:1em}#sbo-rt-content .Fulltext>.Para~.Para:first-of-type{border-top:none;margin-top:0;padding-top:0}#sbo-rt-content .Para+.Para{margin-top:0;text-indent:1.5em}#sbo-rt-content .ParaTextBreak{margin-top:1em !important;text-indent:0 !important}#sbo-rt-content .ParaTypeExample{border-left:4px solid;padding-left:.5em;margin-top:1em !important;margin-bottom:1em}#sbo-rt-content .ParaTypeEyeCatcher,#sbo-rt-content .ParaTypeTip{border-left:4px solid;padding-left:.5em;margin-top:1em !important;margin-bottom:.5em}#sbo-rt-content .ParaTypeImportant{background:#bbb;border:2px solid;padding:.5em;margin-top:.8em !important;margin-bottom:.8em}#sbo-rt-content .ParaTypeImportant img{background-color:transparent}#sbo-rt-content .ParaTypeGeneticSequence,#sbo-rt-content .ParaTypeLiteral,#sbo-rt-content .ParaTypeProgramcode{font-family:"Courier New",Courier,monospace;font-size:95%}#sbo-rt-content .ParaTypeProgramcode{text-indent:0 !important;word-wrap:break-word}#sbo-rt-content .Para:not(.ParaTypeProgramcode)+.ParaTypeProgramcode{margin-top:.5em}#sbo-rt-content .ParaTypeProgramcode+.Para:not(.ParaTypeProgramcode){margin-top:.5em}#sbo-rt-content .ParaTypeLegalText{font-weight:bold;margin-left:1em;text-align:left}#sbo-rt-content .ParaTypeOverview,#sbo-rt-content .ParaTypeAnswers,#sbo-rt-content .ParaTypeQuestions,#sbo-rt-content .ParaTypeDefinition,#sbo-rt-content .ParaTypeProcedure,#sbo-rt-content .ParaTypeRecipe{border:2px solid;margin-top:.8em !important;margin-bottom:.8em;padding:.5em}#sbo-rt-content .ParaTypeSource{font-style:italic}#sbo-rt-content .ParaTypeTrailer,#sbo-rt-content .ParaTypeLearningGoals{font-weight:bold;padding-left:.5em;padding-right:.5em}#sbo-rt-content .ParaTypeWarning{font-weight:bold}#sbo-rt-content .ParaTypeExample,#sbo-rt-content .ParaTypeEyeCatcher,#sbo-rt-content .ParaTypeImportant,#sbo-rt-content .ParaTypeLegalText,#sbo-rt-content .ParaTypeOverview,#sbo-rt-content .ParaTypeTip,#sbo-rt-content .ParaTypeAnswers,#sbo-rt-content .ParaTypeQuestions,#sbo-rt-content .ParaTypeDefinition,#sbo-rt-content .ParaTypeProcedure,#sbo-rt-content .ParaTypeRecipe{text-indent:0 !important}#sbo-rt-content .Para+.ParaOneEmphasisChild{margin-top:1em;text-indent:0 !important}#sbo-rt-content .ParaOneEmphasisChild+.Para{text-indent:0 !important}#sbo-rt-content .PartNumber{display:block;font-size:1.73rem}#sbo-rt-content .PartTitle{display:block;font-size:1.73rem}#sbo-rt-content .SubPartTitle{display:block;font-size:1.44rem}#sbo-rt-content .ProgramCode{margin-top:1em;margin-bottom:1em}#sbo-rt-content .ProgramCode .FixedLine{font-family:"Courier New",Courier,monospace;font-size:95%;word-wrap:break-word}#sbo-rt-content .LineGroup+.LineGroup{margin-top:1em}#sbo-rt-content .Heading+.Para>.Quiz>.Heading{margin-top:0;}#sbo-rt-content .Quiz .Heading{font-size:1rem;margin-top:1em;margin-bottom:0;text-indent:0}#sbo-rt-content .QuizTask{display:table;margin-top:.5em;margin-bottom:.5em;width:100%;text-indent:0}#sbo-rt-content .QuizTask+.QuizTask{margin-top:1.5em}#sbo-rt-content .QuizItem{padding:.1em}#sbo-rt-content .QuizItemTypeSolution{border:2px solid #aaa;margin-top:.5em;padding:10px}#sbo-rt-content .QuizTask>input{display:none}#sbo-rt-content .QuizItem>label{color:#0176C3}#sbo-rt-content .QuizTask>input~.QuizItem>label+div{display:none}#sbo-rt-content .QuizTask>input:checked~.QuizItem>label+div{display:table-cell}#sbo-rt-content .QuizTask>input~.QuizItem>label:after{content:"  »"}#sbo-rt-content .QuizTask>input:checked~.QuizItem>label:after{content:"  «"}#sbo-rt-content .QuizTask>input~.QuizItemTypeCorrectAnswer{background-color:transparent;transition:background .4s}#sbo-rt-content .QuizTask>input:checked~.QuizItemTypeCorrectAnswer{background-color:#EAF2DB;transition:background .4s}#sbo-rt-content .ReviewTitle{font-weight:bold;margin-top:1em;text-indent:0}#sbo-rt-content .Review .AuthorName+.AuthorName:before{content:", "}#sbo-rt-content .Review .ISBN,#sbo-rt-content .ReviewDataUnstructured{text-indent:0}#sbo-rt-content .Review .Para:first-of-type{margin-top:1em;text-indent:0}#sbo-rt-content .BookBackmatter>.Appendix:first-child>div:first-child{border-top:none !important;margin-top:0 !important;padding-top:0 !important}#sbo-rt-content .BookAcknowledgmentsBody>.RenderAsSection1:first-child,#sbo-rt-content .BookNotesBody>.RenderAsSection1:first-child,#sbo-rt-content .ForewordBody>.RenderAsSection1:first-child,#sbo-rt-content .PrefaceBody>.RenderAsSection1:first-child,#sbo-rt-content .BookBackmatter>.Appendix:first-child>.RenderAsSection1:first-child{border-top:none;margin-top:0}#sbo-rt-content .BookAcknowledgmentsBody>.RenderAsSection1:first-child>.Heading,#sbo-rt-content .ForewordBody>.RenderAsSection1:first-child>.Heading,#sbo-rt-content .PrefaceBody>.RenderAsSection1:first-child>.Heading{margin-top:0}#sbo-rt-content .Section1 .AuthorNames,#sbo-rt-content .Section2 .AuthorNames,#sbo-rt-content .Section3 .AuthorNames{font-weight:bold;margin-top:.3em;margin-bottom:.5em}#sbo-rt-content .Section1 .AuthorNames sup,#sbo-rt-content .Section2 .AuthorNames sup,#sbo-rt-content .Section3 .AuthorNames sup{font-size:70%}#sbo-rt-content .Section1 .Affiliations,#sbo-rt-content .Section2 .Affiliations,#sbo-rt-content .Section3 .Affiliations{margin-bottom:.5em}#sbo-rt-content .SectionTypeBackgroundInformation,#sbo-rt-content .SectionTypeExcurse{font-size:90%}#sbo-rt-content .SectionTypeBox,#sbo-rt-content .SectionTypeOverview,#sbo-rt-content .SectionTypeQuestionnaire{background-color:#BBB;margin-top:1em !important;padding:.5em}#sbo-rt-content .SectionTypeCaseStudy,#sbo-rt-content .SectionTypeExample,#sbo-rt-content .SectionTypeTip{border-left:4px solid;margin-top:1em !important;padding-top:0;padding-left:.5em;padding-right:.5em;padding-bottom:.5em}#sbo-rt-content .SectionTypeTrailer,#sbo-rt-content .SectionTypeLearningGoals{font-weight:bold;text-align:left}#sbo-rt-content .SectionTypeLegalText{font-weight:bold;margin-left:1em;text-align:left;text-indent:0 !important}#sbo-rt-content .SectionTypeProcedure,#sbo-rt-content .SectionTypeRecipe{border:2px solid;margin-top:.8em !important;margin-bottom:.8em;padding:.5em}#sbo-rt-content .SectionTypeWarning{font-weight:bold}#sbo-rt-content .RenderAsSection1{border-top:1px solid #bbb;margin-top:1em}#sbo-rt-content .SectionTypeBox+.RenderAsSection1,#sbo-rt-content .SectionTypeOverview+.RenderAsSection1,#sbo-rt-content .SectionTypeQuestionnaire+.RenderAsSection1{border-top:0;}#sbo-rt-content .SectionTypeBox>.Heading,#sbo-rt-content .SectionTypeOverview>.Heading,#sbo-rt-content .SectionTypeQuestionnaire>.Heading,#sbo-rt-content .SectionTypeProcedure>.Heading,#sbo-rt-content .SectionTypeRecipe>.Heading{margin-top:0}#sbo-rt-content .InternalRefSidebarLexicon{background-image:url(sidebar.gif);background-repeat:no-repeat;font-weight:bold;padding-left:20px}#sbo-rt-content .SidebarDialog{border:1px solid;margin-left:1.5em;margin-top:.4em;margin-bottom:.2em;padding:.2em;text-indent:0}#sbo-rt-content .SidebarNumber{font-weight:bold;padding-right:.5em}#sbo-rt-content .SimplePara+.SimplePara{margin-top:0;text-indent:1.5em}#sbo-rt-content .Stack{display:inline-table;vertical-align:top}#sbo-rt-content .Stack sub{display:table-row}#sbo-rt-content .Stack sup{display:table-header-group}#sbo-rt-content table{border-collapse:collapse;font-size:80%;max-width:100%;text-indent:0}#sbo-rt-content table .SimplePara+.SimplePara{text-indent:0}#sbo-rt-content table,#sbo-rt-content tr,#sbo-rt-content td{border-color:#bbb !important}#sbo-rt-content th{border-color:#999 !important}#sbo-rt-content thead{background:#bbb;color:#000 !important}#sbo-rt-content .Table{margin-bottom:1em;text-indent:0}#sbo-rt-content .Caption .Table{margin-bottom:0}#sbo-rt-content .Table img{height:auto;margin:0;max-width:100%}#sbo-rt-content th div{text-align:left}#sbo-rt-content td div,#sbo-rt-content td p,#sbo-rt-content th div,#sbo-rt-content th p{padding:.2em}#sbo-rt-content .Para+.Table,#sbo-rt-content .Para>.Table{margin-top:1em}#sbo-rt-content .SimplePara>.Table{margin-top:.5em}#sbo-rt-content thead,#sbo-rt-content tdiv{vertical-align:top}#sbo-rt-content tbody+tbody tr:first-child td{padding-top:1em}#sbo-rt-content .ExternalTable{background-color:#F8F8F8;border-top:1px solid;border-bottom:1px solid;margin-top:1em;margin-bottom:1em;padding-top:0;padding-bottom:0}#sbo-rt-content .ExternalTable .Table{padding-bottom:.3em}#sbo-rt-content .UnorderedList>.Heading{font-size:1em;font-style:italic;font-weight:normal;margin-top:0;margin-bottom:0}#sbo-rt-content .Heading+.Para>div.UnorderedList:first-child>.Heading{margin-top:0}#sbo-rt-content .UnorderedList li .Para:first-child{text-indent:0}#sbo-rt-content .Heading+ul{margin-top:0}#sbo-rt-content ul{margin-top:.5em;margin-bottom:.5em}#sbo-rt-content ul.UnorderedListMarkBullet{list-style-type:disc;padding-left:1em}#sbo-rt-content ul.UnorderedListMarkBullet div{margin-bottom:.3em}#sbo-rt-content ul.UnorderedListMarkBullet .Equation div{margin-bottom:0}#sbo-rt-content ul.UnorderedListMarkNone{list-style-type:none;padding-left:1em}#sbo-rt-content ul.UnorderedListMarkNone div{margin-bottom:.3em}#sbo-rt-content ul.UnorderedListMarkNone .Equation div{margin-bottom:0}#sbo-rt-content ul.UnorderedListMarkDash{list-style:none;padding-left:1.1em;text-indent:-.8em}#sbo-rt-content ul.UnorderedListMarkDash>li>*:first-child{display:inline}#sbo-rt-content ul.UnorderedListMarkDash div{text-indent:0;margin-top:.3em;margin-bottom:.3em}#sbo-rt-content ul.UnorderedListMarkDash>li:before{content:"– "}#sbo-rt-content .Verse{margin-top:1em;margin-bottom:1em}#sbo-rt-content .Verse .Heading{font-size:1rem;margin-top:1em;margin-bottom:1em;text-indent:0}#sbo-rt-content .Acknowledgments,#sbo-rt-content .AuthorContribution,#sbo-rt-content .Ethics{margin-top:1em}#sbo-rt-content .Acknowledgments>.Heading,#sbo-rt-content .AuthorContribution>.Heading,#sbo-rt-content .FundingInformation>.Heading,#sbo-rt-content .DataAvailability>.Heading,#sbo-rt-content .Ethics>.Heading{font-size:1.2rem;margin-bottom:0}#sbo-rt-content .License{font-size:.9rem !important;margin-top:1em;margin-bottom:1em}#sbo-rt-content .License>a:first-child img{float:left;height:1.9rem;padding-right:.5em;padding-bottom:0;padding-top:.2em}#sbo-rt-content .Glossary{border-top:1px solid #bbb;margin-top:1em;margin-bottom:1em;padding-top:.3em}#sbo-rt-content .Glossary .Headings{margin-top:.8em;margin-bottom:.8em}#sbo-rt-content .Glossary>.Headings>.Heading{font-size:1.44rem;margin:0}#sbo-rt-content .Glossary>.Headings>.SubHeading{font-size:1.2rem}#sbo-rt-content .GlossarySection .Headings{margin-top:.8em;margin-bottom:.4em}#sbo-rt-content .GlossarySection>.Headings>.Heading{font-size:1.2rem;margin:0}#sbo-rt-content .GlossarySection>.Headings>.SubHeading{font-size:100%}#sbo-rt-content .GlossaryTerm{float:left;font-style:italic;padding-right:.5em}#sbo-rt-content .GlossarySeeLabel,#sbo-rt-content .GlossarySeeAlsoLabel{font-style:italic;padding-right:.3em}#sbo-rt-content .GlossaryDef{display:inline;margin-top:.3em}#sbo-rt-content .GlossaryDef>.SimplePara,#sbo-rt-content .GlossaryDef>.GlossarySee,#sbo-rt-content .GlossaryDef>.GlossarySeeAlso{display:block}#sbo-rt-content .GlossaryDef>:first-child{display:inline;margin-top:0;margin-left:0}#sbo-rt-content .GlossaryDef .SimplePara+.GlossarySee,#sbo-rt-content .GlossaryDef .SimplePara+.GlossarySeeAlso{text-indent:0}#sbo-rt-content .GlossaryTerm{display:inline}#sbo-rt-content .GlossaryTerm+.GlossarySee,#sbo-rt-content .GlossaryTerm+.GlossarySeeAlso{display:inline}#sbo-rt-content .InternalRefGlossaryEntry{border-bottom:thin dotted;cursor:help}#sbo-rt-content .InternalRefGlossaryEntry:hover{border-bottom:none}#sbo-rt-content .InternalRefGlossaryEntry a:link,#sbo-rt-content .InternalRefGlossaryEntry a:active,#sbo-rt-content .InternalRefGlossaryEntry a:visited{color:inherit}#sbo-rt-content .InternalRefGlossaryEntry .InlineGlossaryDefinition{background:#fff;display:none;margin:0 3em 0 2em;padding:3px 3px 3px 6px;border-style:solid;border-color:#49546F;border-width:2px;border-radius:5px;box-shadow:5px 5px 5px #888}#sbo-rt-content .InternalRefGlossaryEntry:hover .InlineGlossaryDefinition{display:block;z-index:6}#sbo-rt-content .TocAppendix{border-top:1px solid #bbb;margin-top:1em;padding-top:1em}#sbo-rt-content .BookContextInformation+.Appendix>.TocAppendix:first-child{border-top:none;padding-top:0}#sbo-rt-content .TocAppendix .Headings{margin-bottom:.5em}#sbo-rt-content .TocAppendix>.Headings>.Heading{font-size:1.44rem;margin:0}#sbo-rt-content .TocAppendix>.Headings>.SubHeading{font-size:1.2rem}#sbo-rt-content .TocEntry,#sbo-rt-content .TocPart,#sbo-rt-content .TocBack{margin-top:.5em;text-align:left !important}#sbo-rt-content .TocItem{font-weight:bold}#sbo-rt-content .TocPageNumber{display:none}#sbo-rt-content .TocAuthors{padding-left:1.5em}#sbo-rt-content .TocSection1,#sbo-rt-content .TocSection2,#sbo-rt-content .TocSection3,#sbo-rt-content .TocSection4,#sbo-rt-content .TocSection5,#sbo-rt-content .TocSection6,#sbo-rt-content .TocSection7{padding-left:1.5em}#sbo-rt-content .Index{border-top:1px solid #bbb;margin-top:1em;padding-top:.3em;margin-bottom:.8em}#sbo-rt-content .BookBackmatter>.Index:first-child{border-top:none;margin-top:0}#sbo-rt-content .Index .Headings{margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .BookBackmatter>.Index:first-child>.Headings{margin-top:0}#sbo-rt-content .Index>.Headings>.Heading{font-size:1.44rem;margin:0}#sbo-rt-content .Index>.Headings>.SubHeading{font-size:1.2rem}#sbo-rt-content .IndexDiv .Headings{margin-top:.5em;margin-bottom:.1em}#sbo-rt-content .IndexDiv>.Headings>.Heading{font-size:1.2rem;margin:0}#sbo-rt-content .IndexDiv>.Headings>.SubHeading{font-size:100%;font-style:italic}#sbo-rt-content .IndexEntrySeeLabel{font-style:italic;margin-left:1em;padding-right:.3em}#sbo-rt-content .SecondaryIE{margin-left:1em}#sbo-rt-content .TertiaryIE{margin-left:2em}#sbo-rt-content .ChangeHistory{border-top:1px solid #bbb;margin-top:1em}#sbo-rt-content .ChangeHistory>.Heading{font-size:1.44rem;margin-top:.8em;margin-bottom:.3em}#sbo-rt-content .ChangeDate{font-weight:bold;padding-right:1em}#sbo-rt-content .ChangeDetails{display:inline}#sbo-rt-content .ChangeDetails>p:first-of-type{display:inline}#sbo-rt-content .Bibliography{border-top:1px solid #bbb;margin-top:1em}#sbo-rt-content .BookBackmatter>.Bibliography:first-child{border-top:none}#sbo-rt-content .Bibliography>.Heading{font-size:1.44rem;margin-top:.8em;margin-bottom:.1em}#sbo-rt-content .BibliographyWrapper{display:table;margin:0;padding:0}#sbo-rt-content .Bibliography>.BibliographyWrapper{padding-top:1em}#sbo-rt-content .Bibliography>.Heading+.BibliographyWrapper{padding-top:0}#sbo-rt-content .BibSection>.Heading{font-size:1.2rem;margin-top:.8em;margin-bottom:.2em}#sbo-rt-content .BibliographyWrapper>.BibSection:first-child>.Heading:first-child{margin-top:.3em}#sbo-rt-content .Citation{display:table-row;font-size:90%}#sbo-rt-content .CitationNumber{display:table-cell}#sbo-rt-content .CitationNumber+.CitationContent{padding-left:.5em;text-align:left}#sbo-rt-content .CitationContent{padding-top:1em;display:table-cell}#sbo-rt-content .BibliographyWrapper>.Citation:first-child>.CitationContent{padding-top:0}#sbo-rt-content .Occurrences{display:block}#sbo-rt-content .Occurrence{margin-right:0}#sbo-rt-content .Occurrence:before{content:"["}#sbo-rt-content .Occurrence:after{content:"]"}#sbo-rt-content .Citation .ArticleTitle:before,#sbo-rt-content .Citation .ChapterTitle:before{content:" “";}#sbo-rt-content .Citation .ArticleTitle,#sbo-rt-content .Citation .ChapterTitle{display:inline}#sbo-rt-content .Citation .ArticleTitle:after{content:"”\ ";}#sbo-rt-content .Citation .ChapterTitle:after{content:"”\ In: ";}#sbo-rt-content .Citation .Year:before{content:" ("}#sbo-rt-content .Citation .Year:after{content:") "}#sbo-rt-content .Citation .JournalTitle:after{content:" "}#sbo-rt-content .Citation .VolumeID:after{content:":"}#sbo-rt-content .BibChapter .FirstPage:before,#sbo-rt-content .BibBook .FirstPage:before{content:", pp "}#sbo-rt-content .Citation .FirstPage+.LastPage:before{content:"–";}#sbo-rt-content .Citation .BookTitle:after,#sbo-rt-content .Citation .BibEditorName:after,#sbo-rt-content .Citation .EditionNumber:after,#sbo-rt-content .Citation .PublisherName:after{content:", "}#sbo-rt-content .BibComments{display:block}#sbo-rt-content .CoverFigure img{margin:0 auto 6px;width:100%;max-width:480px;height:auto}#sbo-rt-content .SeriesTitlePage{padding-bottom:1.5em;padding-top:1em}#sbo-rt-content .SeriesTitlePage .VolumeNumber{font-size:1.44rem}#sbo-rt-content .SeriesTitlePage span.SeriesTitle{display:block;font-size:1.73rem;font-weight:bold;margin-top:.5em}#sbo-rt-content .SeriesTitlePage .SeriesSubTitle{display:block;font-size:1.44rem;font-weight:bold}#sbo-rt-content .SeriesTitlePage .SubSeriesTitle{display:block;font-size:1.44rem;font-weight:bold;margin-top:.5em}#sbo-rt-content .SeriesTitlePage .SubSeriesSubTitle{display:block;font-size:1.2rem;font-weight:bold}#sbo-rt-content .SeriesTitlePage .CollaboratorDesignation{display:block;font-weight:bold;padding-top:3em}#sbo-rt-content .SeriesTitlePage .Collaborators{display:block}#sbo-rt-content .SeriesTitlePage .AffiliationText{font-style:italic;margin-left:0}#sbo-rt-content .SeriesTitlePage .Affiliation+.CollaboratorName{display:inline-block;margin-top:1em}#sbo-rt-content .SeriesInformationText{padding-top:3em}#sbo-rt-content .BookTitlePage{padding-top:1em}#sbo-rt-content .BookTitlePageAfterSeriesTitlePage{border-top:1px solid #bbb;page-break-before:always}#sbo-rt-content .BookContextInformation+.BookTitlePage{border-top:none;padding-top:0}#sbo-rt-content .BookTitlePage .BookEditors,#sbo-rt-content .BookTitlePage .BookAuthors,#sbo-rt-content .BookTitlePage .BookEditorInChiefGroup,#sbo-rt-content .BookTitlePage .BookSectionEditorGroup{text-align:left !important}#sbo-rt-content .BookTitlePage .BookEditorInChiefGroup,#sbo-rt-content .BookTitlePage .BookSectionEditorGroup{margin-top:1em}#sbo-rt-content .BookTitlePage .BookEditorGroup .CollaboratorDesignation,#sbo-rt-content .BookTitlePage .BookEditorInChiefGroup .CollaboratorDesignation,#sbo-rt-content .BookTitlePage .BookSectionEditorGroup .CollaboratorDesignation{font-style:italic}#sbo-rt-content .BookTitlePage .BookTitle{display:block;font-size:1.73rem;font-weight:bold;margin-top:1em}#sbo-rt-content .BookTitlePage .BookSubTitle{display:block;font-size:1.44rem;font-weight:bold;margin-bottom:.5em}#sbo-rt-content .BookTitlePage .BookEdition{display:block;font-size:1rem;font-weight:normal;margin-top:.5em}#sbo-rt-content .BookTitlePage .CollaboratorLine{padding-top:.5em}#sbo-rt-content .BookFeatureText{margin-top:.5em}#sbo-rt-content .BookTitlePage .PublisherLogo .Figure,#sbo-rt-content .BookTitlePage .PublisherImprintName{font-size:1.2rem;margin-top:4em;margin-bottom:1.5em;text-align:left}#sbo-rt-content .CopyrightPage{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .CopyrightPage .CollaboratorDesignation{display:block;font-style:italic;padding-bottom:.5em}#sbo-rt-content .CopyrightPageOriginators{padding-bottom:4em}#sbo-rt-content .CopyrightPage div+.CollaboratorDesignation{padding-top:2em}#sbo-rt-content .CopyrightPage .EditorGroup+.AuthorGroup{padding-top:2em}#sbo-rt-content .CopyrightPage .Author+.Author,#sbo-rt-content .CopyrightPage .Author+.InstitutionalAuthor,#sbo-rt-content .CopyrightPage .InstitutionalAuthor+.Author,#sbo-rt-content .CopyrightPage .InstitutionalAuthor+.InstitutionalAuthor,#sbo-rt-content .CopyrightPage .Editor+.Editor,#sbo-rt-content .CopyrightPage .Editor+.InstitutionalEditor,#sbo-rt-content .CopyrightPage .InstitutionalEditor+.Editor,#sbo-rt-content .CopyrightPage .InstitutionalEditor+.InstitutionalEditor,#sbo-rt-content .CopyrightPage .Collaborator+.Collaborator{padding-top:1em}#sbo-rt-content .CopyrightPage .Affiliation{margin-top:0}#sbo-rt-content .CopyrightPage .AffiliationText{margin-left:0}#sbo-rt-content .CopyrightPage .CollaboratorLine{padding-top:1em}#sbo-rt-content .CopyrightPage .CollaboratorLineTranslatedBy{padding-top:2em}#sbo-rt-content .CopyrightPage .CollaboratorLine .CollaboratorDesignation{display:inline;font-style:normal}#sbo-rt-content .BookFrontmatter .CopyrightPage .ArticleNoteESMHint,#sbo-rt-content .BookFrontmatter .CopyrightPage .ArticleNoteMoreMedia{border:none;padding-bottom:0;page-break-before:auto}#sbo-rt-content .CopyrightPageISBNs,#sbo-rt-content .CopyrightPageISSNs,#sbo-rt-content .SpringerLocationsLine,#sbo-rt-content .CatalogingInformation,#sbo-rt-content .MathematicsSubjectClassification,#sbo-rt-content .CopyrightLine,#sbo-rt-content .CopyrightPage .CopyrightComment,#sbo-rt-content .BookCopublishingInformation .SimplePara,#sbo-rt-content .CopyrightStandardText,#sbo-rt-content .TrademarkQualifierText,#sbo-rt-content .ProductLiability,#sbo-rt-content .LegalNotice,#sbo-rt-content .CoverDesigner,#sbo-rt-content .BookCoverFigureText,#sbo-rt-content .PaperInfo,#sbo-rt-content .SpringerReferenceLine{margin-top:1em}#sbo-rt-content .CopyrightComment+.CopyrightLine{margin-top:.5em}#sbo-rt-content .SeriesTitle+.CopyrightPageISBNs,#sbo-rt-content .SubSeriesTitle+.CopyrightPageISBNs{margin-top:0}#sbo-rt-content .CopyrightPage .SeriesTitle{display:block;margin-top:1em}#sbo-rt-content .SeriesTitle+.CopyrightPageISSNs,#sbo-rt-content .CopyrightPageISSNs+.SeriesTitle,#sbo-rt-content .CopyrightPageISSNs+.SubSeriesTitle{margin-top:0}#sbo-rt-content .CopyrightPagePrintISSN,#sbo-rt-content .CopyrightPagePrintISBN{display:inline-block;min-width:12em}#sbo-rt-content .SpringerReferenceLine .SimplePara+.SimplePara,#sbo-rt-content .BookCoverFigureText .SimplePara+.SimplePara,#sbo-rt-content .BookCopublishingInformation .SimplePara+.SimplePara{text-indent:0}#sbo-rt-content .CopyrightPagePrintISSN+.CopyrightPageElectronicISSN{padding-left:1.5em}#sbo-rt-content .CopyrightPagePrintISBN+.CopyrightPageElectronicISBN{padding-left:1.5em}#sbo-rt-content .CopyrightComment .SimplePara+.SimplePara{padding-top:.5em;text-indent:0}#sbo-rt-content .BookCorrectionYear:before{content:", "}#sbo-rt-content .BookCorrectionYear .Year:first-of-type:before{content:" "}#sbo-rt-content .BookCorrectionYear .Year+.Year:before{content:", "}#sbo-rt-content .MathematicsSubjectClassificationCode+.MathematicsSubjectClassificationCode:before{content:", "}#sbo-rt-content .Endorsement{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .Frontispiece{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .Dedication{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .Foreword{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .PartFrontmatter h1:first-child+.Foreword{border-top:none;padding-top:0;page-break-before:auto}#sbo-rt-content .ForewordTitle{font-size:1.44rem;font-weight:bold;padding-bottom:.1em;page-break-after:avoid}#sbo-rt-content .Foreword .AuthorName{margin-top:.2em}#sbo-rt-content .Foreword .AuthorName,#sbo-rt-content .ForewordLocations,#sbo-rt-content .ForewordDate{font-weight:bold;text-align:right}#sbo-rt-content .ForewordLocation+.ForewordLocation:before{content:", "}#sbo-rt-content .Foreword .RenderAsSection1>.Heading{font-size:1.2rem}#sbo-rt-content .Foreword .RenderAsSection2>.Heading,#sbo-rt-content .Foreword .RenderAsSection3>.Heading{font-size:100%}#sbo-rt-content .Preface{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .PrefaceTitle{font-size:1.44rem;font-weight:bold;padding-bottom:.1em;page-break-after:avoid}#sbo-rt-content .Preface .AuthorName{margin-top:.2em}#sbo-rt-content .Preface .AuthorName,#sbo-rt-content .PrefaceLocations,#sbo-rt-content .PrefaceDate{font-weight:bold;text-align:right}#sbo-rt-content .PrefaceLocation+.PrefaceLocation:before{content:", "}#sbo-rt-content .Preface .RenderAsSection1>.Heading{font-size:1.2rem}#sbo-rt-content .Preface .RenderAsSection2>.Heading,#sbo-rt-content .Preface .RenderAsSection3>.Heading{font-size:100%}#sbo-rt-content .BookFrontmatterArticleNote{border-top:1px solid #bbb;margin-top:0;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .PartFrontmatter .ArticleNote{padding-bottom:1em}#sbo-rt-content .PartFrontmatter h1:first-child+.ArticleNote{border-top:none;page-break-before:auto}#sbo-rt-content .BookFrontmatter .ArticleNote .Heading,#sbo-rt-content .PartFrontmatter .ArticleNote .Heading{font-size:1.44rem;font-style:normal;padding-bottom:.1em;page-break-after:avoid}#sbo-rt-content .BookAcknowledgments{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .BookAcknowledgmentsTitle{font-size:1.44rem;font-weight:bold;padding-bottom:.1em;page-break-after:avoid}#sbo-rt-content .BookAcknowledgments .AuthorName{font-weight:bold;margin-top:1em}#sbo-rt-content .BookAcknowledgments .RenderAsSection1>.Heading{font-size:1.2rem}#sbo-rt-content .BookAcknowledgments .RenderAsSection2>.Heading,#sbo-rt-content .BookAcknowledgments .RenderAsSection3>.Heading{font-size:100%}#sbo-rt-content .BookNotes{border-top:1px solid #bbb;padding-top:1em;padding-bottom:1em;page-break-before:always}#sbo-rt-content .BookNotesTitle{font-size:1.44rem;font-weight:bold;margin-bottom:.1em;page-break-after:avoid}#sbo-rt-content .BookNotes .AuthorName{font-weight:bold}#sbo-rt-content .BookFrontmatterAbbreviationGroup{border-top:1px solid #bbb;margin-top:0;padding-bottom:1em;page-break-before:always}#sbo-rt-content .PartFrontmatter .AbbreviationGroup{padding-bottom:1em;margin-top:1em}#sbo-rt-content .BookFrontmatter .AbbreviationGroup .Heading,#sbo-rt-content .PartFrontmatter .AbbreviationGroup .Heading{font-size:1.44rem;font-weight:bold;padding-top:1em;padding-bottom:.1em;page-break-after:avoid}#sbo-rt-content .BookFrontmatter .AbbreviationGroupSection>.Heading,#sbo-rt-content .PartFrontmatter .AbbreviationGroupSection>.Heading{font-size:1.2rem;padding-top:1em;padding-bottom:0}#sbo-rt-content .BookFrontmatter .AbbreviationGroupSection+.AbbreviationGroupSection>.Heading,#sbo-rt-content .PartFrontmatter .AbbreviationGroupSection+.AbbreviationGroupSection>.Heading{padding-top:.5em}#sbo-rt-content .Toc{border-top:1px solid #bbb;margin-top:0;padding-bottom:1em;page-break-before:always}#sbo-rt-content .Toc .Headings{margin-bottom:.5em}#sbo-rt-content .Toc>.Headings>.Heading{font-size:1.44rem;margin:0}#sbo-rt-content .Toc>.Headings>.SubHeading{font-size:1.2rem}#sbo-rt-content .Loh{border-top:1px solid #bbb;padding-bottom:1em;padding-top:1em;page-break-before:always}#sbo-rt-content .Loh .Headings{margin-bottom:.1em}#sbo-rt-content .Loh>.Headings>.Heading{font-size:1.44rem;margin:0}#sbo-rt-content .Loh>.Headings>.SubHeading{font-size:1.2rem}#sbo-rt-content .LohPageNumber{display:none}#sbo-rt-content .LocWithHeading,#sbo-rt-content .LocWithoutHeading>.LocBody>.LocDiv{border-top:1px solid #bbb;padding-bottom:1em;padding-top:1em;page-break-before:always}#sbo-rt-content .Loc .Headings{margin-bottom:.1em}#sbo-rt-content .LocWithHeading>.Headings>.Heading,#sbo-rt-content .LocWithoutHeading>.LocBody>.LocDiv>.Headings>.Heading{font-size:1.44rem;margin:0}#sbo-rt-content .LocWithHeading>.Headings>.SubHeading,#sbo-rt-content .LocWithoutHeading>.LocBody>.LocDiv>.Headings>.SubHeading{font-size:1.2rem}#sbo-rt-content .LocWithHeading .LocDiv{margin-top:1em}#sbo-rt-content .LocWithHeading .LocDiv .Heading{font-size:1.2rem;margin-bottom:.1em}#sbo-rt-content .LocWithHeading .LocDiv .SubHeading{font-size:100%;font-style:italic;font-weight:normal}#sbo-rt-content .LocDiv .FormalPara .Heading{font-size:100%}#sbo-rt-content .Loc .AuthorGroup+.AuthorGroup,#sbo-rt-content .Loc .AuthorGroup+.EditorGroup,#sbo-rt-content .Loc .EditorGroup+.AuthorGroup,#sbo-rt-content .Loc .EditorGroup+.EditorGroup{margin-top:1em}#sbo-rt-content .Loc .Author,#sbo-rt-content .Loc .Editor,#sbo-rt-content .Loc .InstitutionalAuthor,#sbo-rt-content .Loc .InstitutionalEditor{font-weight:bold}#sbo-rt-content .Loc .AffiliationText{margin-left:0}#sbo-rt-content .Loc .Email+.Email:before{content:", "}#sbo-rt-content .Loc .Emails,#sbo-rt-content .Loc .URLs{display:inline}#sbo-rt-content .Loc .Emails+.URLs:before{content:", "}#sbo-rt-content .Loc .URL+.URL:before{content:", "}#sbo-rt-content .BookFrontmatterFootnoteSection{border-top:1px solid #bbb;margin-top:0;page-break-before:always}#sbo-rt-content .PartFrontmatter .FootnoteSection{border-top:none;margin-top:0}#sbo-rt-content .Colophon{border-top:1px solid #bbb;margin-top:1em;padding-top:.8em;font-style:italic}#sbo-rt-content .ConferenceInfo{border-top:1px solid #bbb;margin-top:1em;padding-top:.8em}#sbo-rt-content .ConfEventAbbreviation,#sbo-rt-content .ConfNumber+.ConfSeriesName,#sbo-rt-content .ConfEventAbbreviation+.Year,#sbo-rt-content .ConfEventDateStart,#sbo-rt-content .ConfEventDateEnd{display:inline}#sbo-rt-content .ConfEventAbbreviation:after{content:" "}#sbo-rt-content .ConfEventLocation .City:after{content:", "}#sbo-rt-content .ConfEventDateEnd:before{content:"–"}#sbo-rt-content .ConfEventDateStart .Year:after,#sbo-rt-content .ConfEventDateStart .Month:after,#sbo-rt-content .ConfEventDateEnd .Year:after,#sbo-rt-content .ConfEventDateEnd .Month:after{content:"/"}#sbo-rt-content .ConfEventDate .Month:after{content:"/"}</style><script id="twitter-wjs" src="https://platform.twitter.com/widgets.js"></script><script type="text/javascript" async="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/cool-2.1.15.min.j.下载"></script><script crossorigin="anonymous" integrity="sha256-4akcsqklmUmtNjRgapND1hbNA1NRfbSO24PnriCCqNI=" type="text/javascript" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/appcues.main.37d7.下载" async=""></script><script type="text/javascript" async="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/ec.js.下载"></script><script src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/443792972845831" async=""></script><script src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/1732687426968531" async=""></script><script async="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/fbevents.js.下载"></script><script type="text/javascript" async="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/f.txt"></script><script type="text/javascript" async="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/analytics.js.下载"></script><script type="text/javascript" async="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/bat.js.下载"></script><script type="text/javascript" async="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/f.txt"></script><script type="text/javascript" async="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/insight.min.js.下载"></script><script type="text/javascript" async="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/f.txt"></script><script async="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/gtm.js.下载"></script><script> // <![CDATA[
    var g = {
      position_cache: {
        
          "chapter": "/api/v1/book/9781484245019/chapter/html/477630_1_En_12_Chapter.xhtml",
          "book_id": "9781484245019",
          "chapter_uri": "html/477630_1_En_12_Chapter.xhtml",
          "position": 95.5336561845751,
          "user_uuid": "6d9ee17b-34b1-4bf4-bdae-19676bd84ca1",
          "next_chapter_uri": "/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml"
        
      },
      title: "Practical Microservices Architectural Patterns: Event\u002DBased Java Microservices with Spring Boot and Spring Cloud",
      author_list: "Binildas Christudas",
      format: "book",
      source: "application/epub+zip",
      is_system_book: true,
      is_public: false,
      loaded_from_server: true,
      allow_scripts: false,
      has_mathml: false
    };
    // ]]></script><script src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/modernizr.8e35451.下载"></script><script>
    
      

      
        
          window.PUBLIC_ANNOTATIONS = true;
        
      

      window.MOBILE_PUBLIC_ANNOTATIONS = false;

    

    
      window.PRIVACY_CONTROL_OVERRIDE = false;
    

      window.PRIVACY_CONTROL_SWITCH = true;

      window.PUBLISHER_PAGES = true;

      window.SBO = {
        "constants": {
          "SITB_ENDPOINT": "/api/v2/sitb/",
          "SEARCH_SELECT_ENDPOINT": "https://learning.oreilly.com/api/v2/search/select/",
          "ENABLE_ONLINE_TRAINING": true
        }
      };
  </script><link rel="canonical" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_12_Chapter.xhtml"><meta name="description" content="© Binildas Christudas 2019 Binildas ChristudasPractical Microservices Architectural Patternshttps://doi.org/10.1007/978-1-4842-4501-9_12 12. Axon for CQRS Architecture Binildas Christudas1  (1)Trivandrum, Kerala, India   In Chapter 11, you learned about ...!--end&gt;!--begin&gt; "><meta property="og:title" content="12. Axon for CQRS Architecture"><meta itemprop="isPartOf" content="/library/view/practical-microservices-architectural/9781484245019/"><meta itemprop="name" content="12. Axon for CQRS Architecture"><meta property="og:url" itemprop="url" content="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_12_Chapter.xhtml"><meta property="og:site_name" content="Safari"><meta property="og:image" itemprop="thumbnailUrl" content="https://learning.oreilly.com/library/cover/9781484245019/"><meta property="og:description" itemprop="description" content="© Binildas Christudas 2019 Binildas ChristudasPractical Microservices Architectural Patternshttps://doi.org/10.1007/978-1-4842-4501-9_12 12. Axon for CQRS Architecture Binildas Christudas1  (1)Trivandrum, Kerala, India   In Chapter 11, you learned about ...!--end&gt;!--begin&gt; "><meta itemprop="inLanguage" content="en"><meta itemprop="publisher" content="Apress"><meta property="og:type" content="book"><meta property="og:book:isbn" itemprop="isbn" content="9781484245019"><meta property="og:book:author" itemprop="author" content="Binildas Christudas"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@OReillyMedia"><style type="text/css" id="font-styles" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-size: &lt;%= font_size %&gt; !important; }"></style><style type="text/css" id="font-family" data-template="#sbo-rt-content, #sbo-rt-content p, #sbo-rt-content div { font-family: &lt;%= font_family %&gt; !important; }"></style><style type="text/css" id="column-width" data-template="#sbo-rt-content { max-width: &lt;%= column_width %&gt;% !important; margin: 0 auto !important; }"></style><noscript><meta http-equiv="refresh" content="0; url=/library/no-js/" /></noscript><script>
    var dataLayer = window.dataLayer || [];

    
      window.medalliaVsgUserIdentifier = '6d9ee17b-34b1-4bf4-bdae-19676bd84ca1';
      dataLayer.push({userIdentifier: '6d9ee17b-34b1-4bf4-bdae-19676bd84ca1'});
      dataLayer.push({loggedIn: 'yes'});

      
        window.medalliaVsgAccountIdentifier = '20b4a98e-dfa5-4bb6-bdfb-97a15a9c3f0d';
        
        dataLayer.push({orgID: '20b4a98e-dfa5-4bb6-bdfb-97a15a9c3f0d'});
        

        window.medalliaVsgIsIndividual = false;
        
          
          dataLayer.push({learningAccountType: 'enterprise'});
          
        

        
          dataLayer.push({learningPaidAccount: 'yes'});
        
      
    

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5P4V6Z');
    (function () {
      var VERSION = 'V1.1';
      var AUTHOR = 'Awwad';
      if (!window.GtmHelper)
        window.GtmHelper = function () {
          var instance = this;
          var loc = document.location;
          this.version = VERSION;
          this.author = AUTHOR;
          this.readCookie = function (name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0) == ' ') c = c.substring(1, c.length);
              if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
          };
          this.createCookie = function (name, value, days, cookieDomain) {
            var domain = "";
            var expires = "";

            if (days) {
              var date = new Date();
              date.setTime(date.getTime() + Math.ceil(days * 24 * 60 * 60 * 1000));
              var expires = " expires=" + date.toGMTString() + ";";
            }

            if (typeof (cookieDomain) != 'undefined')
              domain = " domain=" + cookieDomain + "; ";

            document.cookie = name + "=" + value + ";" + expires + domain + "path=/";
          };

          this.isDuplicated = function (currentTransactionId) {
            // the previous transaction id:
            var previousTransIdValue = this.readCookie("previousTransId");

            if (currentTransactionId === previousTransIdValue) {
              return true; // Duplication
            } else {
              return false;
            }
          };
        }
    })()
  </script><script defer="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/vendor.a7a9eda718.下载"></script><script defer="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/reader.90cfcafc75.下载"></script><script src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/f(1).txt"></script><script src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/f(2).txt"></script><script src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/f(3).txt"></script><iframe src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/saved_resource.html"></iframe><iframe src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/saved_res(1).html"></iframe><iframe src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/saved_res(2).html"></iframe><link rel="stylesheet" type="text/css" integrity="sha256-m9iQXscob5jO+vyfe0sovuV3lxwPoNxtAuVQYG3yl4o=" crossorigin="anonymous" href="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/container.37d725.css"><iframe src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/saved_res(3).html"></iframe><script async="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/MathJax.js.下载"></script><style id="annotator-dynamic-style">.annotator-adder, .annotator-outer, .annotator-notice {
  z-index: 100019;
}
.annotator-filter {
  z-index: 100009;
}</style><style type="text/css" id="kampyleStyle">.noOutline{outline: none !important;}.wcagOutline:focus{outline: 1px dashed #595959 !important;outline-offset: 2px !important;transition: none !important;}</style></head>


<body class="reading sidenav nav-collapsed  scalefonts library">

    
  <noscript> 
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P4V6Z"
            height="0" width="0"
            style="display:none;visibility:hidden">
    </iframe>
  </noscript>



    
      <div class="hide working" role="status">
        <div class="working-image"></div>
      </div>
      <div class="sbo-site-nav">
        

  


<a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#container" class="skip">Skip to content</a><header class="topbar t-topbar"><nav role="navigation" class="js-site-nav"><ul class="topnav"><li><a href="https://learning.oreilly.com/home/" class="l0 nav-icn"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.738 14H9.254v-3.676a.617.617 0 0 0-.621-.613H7.39a.617.617 0 0 0-.62.613V14H4.284a.617.617 0 0 1-.622-.613V10.22c0-.327.132-.64.367-.87l3.547-3.493a.627.627 0 0 1 .875 0l3.54 3.499c.234.229.366.54.367.864v3.167a.617.617 0 0 1-.62.613zM7.57 2.181a.625.625 0 0 1 .882 0l5.77 5.692-.93.92-5.28-5.209-5.28 5.208-.932-.919 5.77-5.692z"></path></svg><span>Home</span></a></li><li class="search"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" class="t-search-nav trigger nav-icn l0" data-dropdown-selector=".searchbox"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>search icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M31.3 0C20.9 0 12.5 8.4 12.5 18.8 12.5 22.5 13.6 25.9 15.4 28.8L1.2 42.9C-0.4 44.5-0.4 47.2 1.2 48.8 2 49.6 3.1 50 4.2 50 5.2 50 6.3 49.6 7.1 48.8L21.2 34.6C24.1 36.5 27.5 37.5 31.3 37.5 41.6 37.5 50 29.1 50 18.8 50 8.4 41.6 0 31.3 0ZM31.3 31.3C24.4 31.3 18.8 25.6 18.8 18.8 18.8 11.9 24.4 6.3 31.3 6.3 38.1 6.3 43.8 11.9 43.8 18.8 43.8 25.6 38.1 31.3 31.3 31.3Z"></path></g></svg><span>Search</span></a></li><li class="usermenu dropdown"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" class="trigger l0 nav-icn nav-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" version="1.1" fill="#4A3C31"><desc>navigation arrow</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M0.1 12.5L9.7 3.1C9.8 3 9.9 3 10 3 10.1 3 10.2 3 10.3 3.1L19.9 12.5C20 12.5 20 12.6 20 12.8 20 12.9 20 13 19.9 13L17 15.9C16.9 16 16.8 16 16.7 16 16.5 16 16.4 16 16.4 15.9L10 9.7 3.6 15.9C3.6 16 3.5 16 3.3 16 3.2 16 3.1 16 3 15.9L0.1 13C0 12.9 0 12.8 0 12.7 0 12.7 0 12.6 0.1 12.5Z"></path></g></svg><span>Expand Nav</span></a><div class="drop-content"><ul><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" class="l1 nav-icn "><!--?xml version="1.0" encoding="UTF-8"?--><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M8,8 C6.34321755,8 5.00013,6.65691245 5.00013,5.00013 C5.00013,3.34334755 6.34321755,2.00026001 8,2.00026001 C9.65678245,2.00026001 10.99987,3.34334755 10.99987,5.00013 C10.99987,6.65691245 9.65678245,8 8,8 Z M2.33024571,11.3523547 L2.33774538,11.3523547 C3.7622187,9.70968996 5.82947484,8.76608166 8.00374984,8.76608166 C10.1780248,8.76608166 12.245281,9.70968996 13.6697543,11.3523547 C13.8892083,11.6177474 14.0062813,11.9530021 13.99974,12.2973138 L13.99974,13.99974 L2.00026001,13.99974 L2.00026001,12.2973138 C1.99371867,11.9530021 2.11079172,11.6177474 2.33024571,11.3523547 Z" id="path-1"></path></svg><span>Your O'Reilly</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/profile/" class="l2 nav-icn"><span>Profile</span></a></li><li><a href="https://learning.oreilly.com/history/" class="l2 nav-icn"><span>History</span></a></li><li><a href="https://learning.oreilly.com/playlists/" class="l2 nav-icn"><span>Playlists</span></a></li><li><a href="https://learning.oreilly.com/u/6d9ee17b-34b1-4bf4-bdae-19676bd84ca1/" class="l2 nav-icn"><span>Highlights</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Featured</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/featured/navigating-21st-century/" class="l2 nav-icn"><span>Navigating Change</span></a></li><li><a href="https://learning.oreilly.com/recommendations/" class="l2 nav-icn"><span>Recommended</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="20" height="20" version="1.1" fill="#4A3C31"><desc>queue icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M25 29.2C25.4 29.2 25.8 29.1 26.1 28.9L48.7 16.8C49.5 16.4 50 15.5 50 14.6 50 13.7 49.5 12.8 48.7 12.4L26.1 0.3C25.4-0.1 24.6-0.1 23.9 0.3L1.3 12.4C0.5 12.8 0 13.7 0 14.6 0 15.5 0.5 16.4 1.3 16.8L23.9 28.9C24.2 29.1 24.6 29.2 25 29.2ZM7.3 14.6L25 5.2 42.7 14.6 25 24 7.3 14.6ZM48.7 22.4L47.7 21.9 25 34.2 2.3 21.9 1.3 22.4C0.5 22.9 0 23.7 0 24.7 0 25.6 0.5 26.5 1.3 26.9L23.9 39.3C24.2 39.5 24.6 39.6 25 39.6 25.4 39.6 25.8 39.5 26.1 39.3L48.7 26.9C49.5 26.5 50 25.6 50 24.7 50 23.7 49.5 22.9 48.7 22.4ZM48.7 32.8L47.7 32.3 25 44.6 2.3 32.3 1.3 32.8C0.5 33.3 0 34.1 0 35.1 0 36 0.5 36.9 1.3 37.3L23.9 49.7C24.2 49.9 24.6 50 25 50 25.4 50 25.8 49.9 26.1 49.7L48.7 37.3C49.5 36.9 50 36 50 35.1 50 34.1 49.5 33.3 48.7 32.8Z"></path></g></svg><span>Explore</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/topics/" class="l2 nav-icn"><span>All Topics</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;sort=publication_date&amp;facet_json=true&amp;page=0" class="l2 nav-icn"><span>Early Releases</span></a></li><li><a href="https://learning.oreilly.com/playlists/discover/" class="l2 nav-icn"><span>Shared Playlists</span></a></li><li><a href="https://learning.oreilly.com/search/?query=&amp;extended_publisher_data=true&amp;highlight=true&amp;include_assessments=false&amp;include_case_studies=true&amp;include_courses=true&amp;include_orioles=true&amp;include_playlists=true&amp;include_collections=true&amp;include_notebooks=true&amp;is_academic_institution_account=false&amp;source=user&amp;formats=book&amp;formats=case%20study&amp;formats=learning%20path&amp;formats=live%20online%20training&amp;formats=notebook&amp;formats=oriole&amp;formats=video&amp;sort=popularity&amp;facet_json=true&amp;page=0&amp;collection_type=expert" class="l2 nav-icn"><span>Most Popular Titles</span></a></li><li><a href="https://learning.oreilly.com/resource-centers/" class="l2 nav-icn"><span>Resource Centers</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M12.8 3.2A1.2 1.2 0 0 1 14 4.4v8.4a1.2 1.2 0 0 1-1.2 1.2H3.2A1.2 1.2 0 0 1 2 12.8V4.4a1.2 1.2 0 0 1 1.2-1.2h1.2V2h1.2v1.2h4.8V2h1.2v1.2h1.2zm-9.6 9.6h9.6V6.2H3.2v6.6zM8 9.5a1.35 1.35 0 1 1 0-2.7 1.35 1.35 0 0 1 0 2.7zm2.7 2.148v.552H5.3v-.552c0-.321.124-.634.355-.858a3.358 3.358 0 0 1 4.69 0c.23.224.355.537.355.858z"></path></svg><span>Live Events</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/featured/strata/" class="l2 nav-icn"><span>Strata</span></a></li><li><a href="https://learning.oreilly.com/featured/oscon/" class="l2 nav-icn"><span>Open Source</span></a></li><li><a href="https://learning.oreilly.com/featured/infrastructure-ops/" class="l2 nav-icn"><span>Infra &amp; Ops</span></a></li><li><a href="https://learning.oreilly.com/featured/software-architecture/" class="l2 nav-icn"><span>Software Arch</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" class="l1 nav-icn "><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.6467109,4.35328907 L14.7964612,7.51003884 C15.0678463,7.78304342 15.0678463,8.22395603 14.7964612,8.49696061 L11.6467109,11.6467109 L10.6597892,10.6597892 L13.3055794,8 L10.6597892,5.34021084 L11.6467109,4.35328907 Z M4.35328907,11.6467109 L1.20353875,8.48996116 C0.932153749,8.21695658 0.932153749,7.77604397 1.20353875,7.50303939 L4.35328907,4.35328907 L5.34021084,5.34021084 L2.69442057,8 L5.34021084,10.6597892 L4.35328907,11.6467109 Z M5.84417089,11.4997226 L8.67194674,4.50027742 L10.1838269,4.50027742 L7.35605105,11.4997226 L5.84417089,11.4997226 Z" id="Mask"></path></svg><span>Practice</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/scenarios/" class="l2 nav-icn"><span>Katacoda Scenarios</span></a></li><li><a href="https://learning.oreilly.com/interactive/#notebooks" class="l2 nav-icn"><span>Jupyter Notebooks</span></a></li></ul></li><li class="flyout-parent"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" class="l1 nav-icn "><!--?xml version="1.0" encoding="UTF-8"?--><svg width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M10.0440191,12.1582649 C10.177209,12.3351976 10.2476998,12.552011 10.2434767,12.7742985 L10.2434767,13.9482829 L1.96869684,13.9482829 L1.96869684,12.7742985 C1.96418597,12.536863 2.04491894,12.3056731 2.19625329,12.1226596 L2.20142503,12.1226596 C3.18373453,10.9898864 4.60930376,10.339179 6.10867266,10.339179 C7.30793519,10.339179 8.45998426,10.7554703 9.37576632,11.5017585 L14.3434936,11.5017585 L14.3434936,3.65650645 L1.65650645,3.65650645 L1.65650645,11.5017585 L2.06682298,11.5017585 L1.82063306,12.1582649 L1.32825322,12.1582649 C1.14771395,12.1582649 1,12.010551 1,11.8300117 L1,3.32825322 C1,3.14771395 1.14771395,3 1.32825322,3 L14.6717468,3 C14.852286,3 15,3.14771395 15,3.32825322 L15,11.8300117 C15,12.010551 14.852286,12.1582649 14.6717468,12.1582649 L10.0440191,12.1582649 Z M12.5483683,7.16419284 C12.6159362,7.20929881 12.6563112,7.2853432 12.6558247,7.36658194 C12.6553382,7.44782068 12.6140555,7.5233761 12.5459522,7.56766966 L10.4270949,8.91581376 C10.3903366,8.94010203 10.3431312,8.9419685 10.3045699,8.9206583 C10.2660086,8.89934811 10.2424712,8.85838696 10.2434767,8.81434055 L10.2434767,5.91510593 C10.2420711,5.86982855 10.2666257,5.82771857 10.3067229,5.80664182 C10.3468202,5.78556507 10.3954292,5.7892172 10.431927,5.81604875 L12.5483683,7.16419284 Z M6.10608679,9.81089299 C4.9635781,9.81089299 4.03739181,8.8847067 4.03739181,7.74219802 C4.03739181,6.59968933 4.9635781,5.67350304 6.10608679,5.67350304 C7.24859547,5.67350304 8.17478176,6.59968933 8.17478176,7.74219802 C8.17478176,8.8847067 7.24859547,9.81089299 6.10608679,9.81089299 Z"></path></svg><span>Sandboxes</span></a><ul class="flyout"><li><a href="https://learning.oreilly.com/scenarios/kubernetes-sandbox/9781492062820/" class="l2 nav-icn"><span>Kubernetes</span></a></li><li><a href="https://learning.oreilly.com/scenarios/python-sandbox/9781492062844/" class="l2 nav-icn"><span>Python</span></a></li><li><a href="https://learning.oreilly.com/scenarios/tensorflow-sandbox/9781492062851/" class="l2 nav-icn"><span>TensorFlow</span></a></li><li><a href="https://learning.oreilly.com/scenarios/ubuntu-sandbox/9781492062837/" class="l2 nav-icn"><span>Ubuntu</span></a></li></ul></li><li><a href="https://learning.oreilly.com/live-training/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M13.4 9.8a.6.6 0 0 1 .6.6v1.2h-1.2l-.6 2.4H3.8l-.6-2.4H2v-1.2a.6.6 0 0 1 .6-.6h10.8zM8 5.6a1.8 1.8 0 1 1-.001-3.599A1.8 1.8 0 0 1 8 5.6zm3.6 2.35v.95H4.4v-.95c0-.167.066-.33.19-.443A5.08 5.08 0 0 1 8 6.2a5.08 5.08 0 0 1 3.41 1.307c.124.113.19.276.19.444z"></path></svg><span>Attend</span></a></li><li><a href="https://learning.oreilly.com/certifications/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path d="M12.912 9.18L14 8.014l-1.088-1.18a.304.304 0 01-.075-.268L13.195 5l-1.535-.463a.313.313 0 01-.194-.194l-.462-1.537-1.565.358c-.09.03-.194 0-.269-.074L8.007 2 6.845 3.09a.303.303 0 01-.269.074l-1.565-.358-.462 1.537a.313.313 0 01-.194.194L2.82 5l.358 1.567a.26.26 0 01-.075.269L2 8.015l1.088 1.164c.075.075.09.18.075.269l-.358 1.567 1.535.463c.09.03.164.104.194.194l.462 1.537 1.565-.358c.015 0 .045-.015.075-.015.075 0 .15.03.209.074L8.007 14l1.163-1.09a.303.303 0 01.269-.074l1.565.358.462-1.537a.313.313 0 01.194-.194L13.195 11l-.358-1.567a.338.338 0 01.075-.254zm-6.046 1.37L4.41 8.26l1.16-1.244 1.767 1.649L10.4 5.6l1.202 1.202-4.242 4.243-.495-.495z"></path></svg><span>Certifications</span></a></li><li><a href="https://get.oreilly.com/email-signup.html" class="l1 nav-icn " target="&quot;_blank&quot;"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M11.564 2.263l2.172 2.174c.17.168.264.397.264.636V11a.6.6 0 0 1-.6.6h-.6V6.2h-6V2.6a.6.6 0 0 1 .6-.6h3.527c.239 0 .468.095.637.263zM2.6 14a.6.6 0 0 1-.6-.6V6.8a.6.6 0 0 1 .6-.6h1.903a1.2 1.2 0 0 1 .849.352L6.2 7.4H11a.6.6 0 0 1 .6.6v5.4a.6.6 0 0 1-.6.6H2.6zM11 5h1.8L11 3.2V5z"></path></svg><span>Newsletters</span></a></li><li><a href="https://learning.oreilly.com/u/preferences/" class="l1 nav-icn "><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 53" width="20" height="20" version="1.1" fill="#4A3C31"><desc>settings icon</desc><g stroke="none" stroke-width="1" fill-rule="evenodd"><path d="M44.6 29.6C44.7 28.6 44.8 27.5 44.8 26.5 44.8 25.5 44.7 24.4 44.6 23.4L49.6 19C50 18.8 50.1 18.3 49.9 17.9 48.9 14.7 47.1 11.7 44.9 9.1 44.6 8.8 44.2 8.7 43.8 8.8L37.4 11.1C35.8 9.8 34 8.7 32.1 8L30.9 1.4C30.8 0.9 30.4 0.6 30 0.5 26.7-0.2 23.3-0.2 20 0.5 19.6 0.6 19.2 0.9 19.1 1.4L17.9 8C16 8.7 14.1 9.8 12.6 11.1L6.2 8.8C5.8 8.7 5.4 8.8 5.1 9.1 2.9 11.7 1.1 14.7 0.1 17.9 -0.1 18.3 0 18.8 0.4 19L5.4 23.4C5.3 24.4 5.2 25.5 5.2 26.5 5.2 27.5 5.3 28.6 5.4 29.6L0.4 34C0 34.2-0.1 34.7 0.1 35.1 1.1 38.3 2.9 41.4 5.1 43.9 5.4 44.2 5.8 44.4 6.2 44.2L12.6 42C14.1 43.2 16 44.3 17.9 45L19.1 51.7C19.2 52.1 19.6 52.5 20 52.5 21.6 52.8 23.3 53 25 53 26.7 53 28.4 52.8 30 52.5 30.4 52.5 30.8 52.1 30.9 51.7L32.1 45C34 44.3 35.8 43.2 37.4 42L43.8 44.2C44.2 44.4 44.6 44.2 44.9 43.9 47.1 41.4 48.9 38.3 49.9 35.1 50.1 34.7 50 34.2 49.6 34L44.6 29.6ZM25 36.4C19.6 36.4 15.2 32 15.2 26.5 15.2 21 19.6 16.6 25 16.6 30.4 16.6 34.8 21 34.8 26.5 34.8 32 30.4 36.4 25 36.4Z"></path></g></svg><span>Settings</span></a></li><li><a href="https://learning.oreilly.com/public/support/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M7.363 6.656a2.692 2.692 0 0 1-2.681-2.703c0-1.493 1.2-2.703 2.681-2.703a2.692 2.692 0 0 1 2.682 2.703c0 1.493-1.2 2.703-2.682 2.703zm4.023 2.027c-1.852 0-3.352 1.513-3.352 3.379H2v-1.534c-.006-.31.099-.612.295-.852a6.666 6.666 0 0 1 9.09-.993zm-.543.676h1.12v.304c.003.284.16.543.408.676a.766.766 0 0 0 .77 0l.303-.176.556.966-.302.176a.772.772 0 0 0-.362.676v.08a.772.772 0 0 0 .362.677l.302.21-.556.965-.302-.175a.766.766 0 0 0-.771 0 .778.778 0 0 0-.409.675v.352h-1.106v-.372a.778.778 0 0 0-.409-.676.766.766 0 0 0-.77 0l-.303.176-.556-.912.302-.176a.772.772 0 0 0 .362-.676v-.04-.04a.772.772 0 0 0-.362-.676l-.302-.176.556-.966.289.155a.766.766 0 0 0 .77 0 .778.778 0 0 0 .41-.676V9.36zm1.562 2.703c0-.271-.108-.531-.3-.722a1.001 1.001 0 0 0-.72-.292 1.01 1.01 0 0 0-.992 1.023 1.01 1.01 0 0 0 1.01 1.004 1.01 1.01 0 0 0 1.002-1.013z"></path></svg><span>Support</span></a></li><li><a href="https://learning.oreilly.com/accounts/logout/" class="l1 nav-icn "><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.613 12.63A.607.607 0 0 1 2 12.03V3.602C2 3.269 2.274 3 2.613 3h5.515v1.204H3.226v7.223h4.902v1.203H2.613zM5.677 9.02V6.611h4.903V4.926a.301.301 0 0 1 .19-.274.31.31 0 0 1 .33.063l2.722 2.673a.594.594 0 0 1 0 .849L11.1 10.909a.31.31 0 0 1-.331.063.301.301 0 0 1-.19-.274V9.02H5.677z"></path></svg><span>Sign Out</span></a></li></ul></div></li></ul></nav></header>



      </div><script type="text/javascript" id="">!function(b,e,f,g,a,c,d){b.fbq||(a=b.fbq=function(){a.callMethod?a.callMethod.apply(a,arguments):a.queue.push(arguments)},b._fbq||(b._fbq=a),a.push=a,a.loaded=!0,a.version="2.0",a.queue=[],c=e.createElement(f),c.async=!0,c.src=g,d=e.getElementsByTagName(f)[0],d.parentNode.insertBefore(c,d))}(window,document,"script","https://connect.facebook.net/en_US/fbevents.js");fbq("init","1732687426968531");fbq("track","PageView");</script>
<noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=1732687426968531&amp;ev=PageView&amp;noscript=1"></noscript><script type="text/javascript" id="">(function(){window.medalliaUserIdentifier=document.documentElement.dataset.userUuid;window.medalliaUserName=document.documentElement.dataset.username})();</script>
<script type="text/javascript" id="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/embed.js.下载"></script>
<script type="text/javascript" id="">!function(b,e,f,g,a,c,d){b.fbq||(a=b.fbq=function(){a.callMethod?a.callMethod.apply(a,arguments):a.queue.push(arguments)},b._fbq||(b._fbq=a),a.push=a,a.loaded=!0,a.version="2.0",a.queue=[],c=e.createElement(f),c.async=!0,c.src=g,d=e.getElementsByTagName(f)[0],d.parentNode.insertBefore(c,d))}(window,document,"script","https://connect.facebook.net/en_US/fbevents.js");fbq("init","443792972845831");fbq("set","agent","tmgoogletagmanager","443792972845831");fbq("track","PageView");</script>
<noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=443792972845831&amp;ev=PageView&amp;noscript=1"></noscript>

<script type="text/javascript" id="">!function(b,e,f,g,a,c,d){b.fbq||(a=b.fbq=function(){a.callMethod?a.callMethod.apply(a,arguments):a.queue.push(arguments)},b._fbq||(b._fbq=a),a.push=a,a.loaded=!0,a.version="2.0",a.queue=[],c=e.createElement(f),c.async=!0,c.src=g,d=e.getElementsByTagName(f)[0],d.parentNode.insertBefore(c,d))}(window,document,"script","https://connect.facebook.net/en_US/fbevents.js");fbq("init","443792972845831");fbq("track","PageView");</script>
<noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=443792972845831&amp;ev=PageView&amp;noscript=1"></noscript>

      <div id="container" class="application" style="height: auto;">
        
          <div class="nav-container clearfix">
            


            
            
          </div>

          

  <div class="js-toc">
    
      <div class="sbo-reading-menu sbo-menu-top"><section class="sbo-toc-container toc-menu"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" class="sbo-toc-thumb"><span class="sbo-title ss-list"><h1><div class="visuallyhidden">Table of Contents for </div>
      
      Practical Microservices Architectural Patterns: Event-Based Java Microservices with Spring Boot and Spring Cloud
      
    </h1></span></a><div class="toc-contents"></div></section></div>

    

    <div class="interface-controls interface-controls-top">
      <ul class="interface-control-btns js-bitlist js-reader">
        <li class="js-search-in-archive search-in-archive t-search-in-archive"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" title="Search in archive" class="js-search-controls search-controls" onclick="window.Appcues.track(&#39;SearchBook_HeronBook&#39;)"><span class="icon">Search in book...</span></a><form class="search-archive-bar js-search-form"><input type="search" name="query" placeholder="Search inside this book..." autocomplete="off"></form><div class="search-archive-results"><div class="js-sitb-results-region"></div></div></li><li class="queue-control"><div class="js-content-uri" data-content-uri="/api/v1/book/9781484245019/chapter/html/477630_1_En_12_Chapter.xhtml"><div class="js-collections-dropdown collections-dropdown menu-bit-cards" onclick="window.Appcues.track(&#39;AddPlaylist_HeronBook&#39;)"><div data-reactroot="" class="menu-dropdown-wrapper js-menu-dropdown-wrapper align-right"><img class="hidden" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/ajax-transp.gif" alt="loading spinner"><div class="menu-control"><div class="control "><div class="js-playlists-menu"><button class="js-playlist-icon"><svg class="icon-add-to-playlist-sml" viewBox="0 0 16 14" version="1.1" xmlns="http://www.w3.org/2000/svg"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g fill-rule="nonzero" fill="#000000"><g transform="translate(-1.000000, 0.000000)"><rect x="5" y="0" width="12" height="2"></rect><title>Playlists</title><path d="M4.5,14 C6.43299662,14 8,12.4329966 8,10.5 C8,8.56700338 6.43299662,7 4.5,7 C2.56700338,7 1,8.56700338 1,10.5 C1,12.4329966 2.56700338,14 4.5,14 Z M2.5,10 L4,10 L4,8.5 L5,8.5 L5,10 L6.5,10 L6.5,11 L5,11 L5,12.5 L4,12.5 L4,11 L2.5,11 L2.5,10 Z"></path><circle cx="2" cy="5" r="1"></circle><circle cx="1.94117647" cy="1" r="1"></circle><rect x="5" y="4" width="12" height="2"></rect><rect x="9" y="8" width="8" height="2"></rect><rect x="9" y="12" width="8" height="2"></rect></g></g></g></svg><div class="js-playlist-addto-label">Add&nbsp;To</div></button></div></div></div></div></div></div></li><li class="js-font-control-panel font-control-activator"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" data-push-state="false" id="font-controls" title="Change font size" aria-label="Change font size" onclick="window.Appcues.track(&#39;ChangeFont_HeronBook&#39;)"><span class="icon">Toggle Font Controls</span></a></li><li class="dropdown sharing-controls"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" class="trigger" data-push-state="false" title="Share" aria-label="Share" onclick="window.Appcues.track(&#39;Share_HeronBook&#39;)"><i class="fa fa-share"></i></a><ul class="social-sharing dropdown-menu"><li><a class="twitter share-button t-twitter" target="_blank" aria-label="Share this section on Twitter" title="Share this section on Twitter" href="https://twitter.com/share?url=https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_12_Chapter.xhtml&amp;text=Practical%20Microservices%20Architectural%20Patterns%3A%20Event-Based%20Java%20Microservices%20with%20Spring%20Boot%20and%20Spring%20Cloud&amp;via=OReillyMedia"><span>Twitter</span></a></li><li><a class="facebook share-button t-facebook" target="_blank" aria-label="Share this section on Facebook" title="Share this section on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_12_Chapter.xhtml"><span>Facebook</span></a></li><li><a class="googleplus share-button t-googleplus" target="_blank" aria-label="Share this secton on Google Plus" title="Share this secton on Google Plus" href="https://plus.google.com/share?url=https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_12_Chapter.xhtml"><span>Google Plus</span></a></li><li><a class="email share-button t-email" aria-label="Share this section via email" title="Share this section via email" href="mailto:?subject=Safari:%2012.%C2%A0Axon%20for%20CQRS%20Architecture&amp;body=https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_12_Chapter.xhtml%0D%0Afrom%20Practical%20Microservices%20Architectural%20Patterns%3A%20Event-Based%20Java%20Microservices%20with%20Spring%20Boot%20and%20Spring%20Cloud%0D%0A"><span>Email</span></a></li></ul></li><!-- endif request.user.is_authenticated -->
      </ul>
    </div>

      
          
      

    <section role="document"><script src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/48743.js.下载"></script>
<script>
  var userId = "6d9ee17b-34b1-4bf4-bdae-19676bd84ca1";

  var userObject = {
    firstName: "Feng",
    segment: "B2B",
    admin: "False",
    profileCreatedOn: "2019-03-11",
    academic: "false"
  };
  window.Appcues.identify(userId, userObject);
  window.Appcues.page();

  setTimeout(function () {
    window.Appcues.track('ViewingBook_HeronBook')
  }, 20000);
</script>


	  <div class="t-sbo-prev sbo-prev sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_12_Chapter.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">12.&nbsp;Axon for CQRS Architecture</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-top">
  
    
      
        <a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">14.&nbsp;Transactions and Microservices</div>
        </a>
    
  
  </div>



<div id="sbo-rt-content"><div class="annotator-wrapper"><div class="ChapterContextInformation"><div class="ContextInformation" id="b978-1-4842-4501-9_13"><div class="ChapterCopyright">©&nbsp;Binildas Christudas&nbsp;2019</div><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">Binildas&nbsp;Christudas</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" epub:type="title" lang="en">Practical Microservices Architectural Patterns</span></span><span class="ChapterDOI"><a href="https://doi.org/10.1007/978-1-4842-4501-9_13">https://doi.org/10.1007/978-1-4842-4501-9_13</a></span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" lang="en">13.&nbsp;Distributed Transactions</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">Binildas&nbsp;Christudas</span><sup><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Aff2" class="totri-footnote">1</a>&nbsp;<span class="ContactIcon"></span></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">Trivandrum, Kerala, India</div></div><div class="ClearBoth">&nbsp;</div></div></div><!--End Abstract--><div class="Fulltext"><p class="Para" id="Par2">You looked at using the Axon framework to implement different scenarios of the CQRS pattern in the previous chapter. In this chapter, you will be revisiting Axon for more scenarios in the microservices context, including executing long-running computational processing. To do that effectively, let’s start the discussion with a few basics, including transactions. A transaction in its simple form is a change or exchange of values between entities. The parties involved can be a single entity or more than one entity. When the party involved is a single entity, typically the transaction is a local transaction. If more than one party is involved, the transaction can be classified as either a local transaction or a distributed transaction, depending on the nature and location of the entities involved.</p><p class="Para" id="Par3">A transaction may involve a single step or multiple steps. Whether a single step or multiple steps, a transaction is a single unit of work that embodies these individual steps. For the successful completion of a transaction, each of the involved individual steps should succeed. If any of the individual steps fail, the transaction should undo any of the effects of the other steps it has already done within that transaction.</p><p class="Para" id="Par4">With this preface, you will look into the details of transactions, especially distributed transactions. I will only touch base on the essentials of transactions; I’ll spend more time on the practical implication aspects, especially in the context of microservices. Detailing out transactions to any more depth would require its own complete book, so this coverage will be limited to discussions around microservices and few practical tools you can use to build reliable microservices.</p><div class="Para" id="Par5">In this chapter you will learn about<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par6">The indeterministic characteristics of computer networks</p></li><li><p class="Para" id="Par7">Transaction aspects in general</p></li><li><p class="Para" id="Par8">Distributed transactions vs. local transactions</p></li><li><p class="Para" id="Par9">ACID vs. BASE transactions</p></li><li><p class="Para" id="Par10">A complete example demonstrating distributed transactions using multiple resource managers</p></li></ul></div></div><section class="Section1 RenderAsSection1" id="Sec1"><h2 class="Heading">The Two Generals Paradox</h2><p class="Para" id="Par11">In computer networking (particularly with regard to the Transmission Control <span id="ITerm1">Protocol</span>), literature shows that <span id="ITerm2">TCP</span> can’t guarantee (complete) state consistency between endpoints. This is illustrated by the Two Generals Paradox (also known as the <span id="ITerm3">Two Generals Problem</span> or the <span id="ITerm4">Two Armies Problem</span> or the <span id="ITerm5">Coordinated Attack Problem</span>), which is a thought experiment illustrating the pitfalls and connected design challenges while attempting to coordinate an action by communicating over an unreliable link.</p><p class="Para" id="Par12">The Two Generals Paradox is unsolvable in the face of <span id="ITerm6">arbitrary communication failures</span>; however, the same problem provides a base for realistic expectations for any distributed consistency protocols. So to understand the problem, you need to understand the associated indeterminism involved, which will provide a perfect analogy to learn more about transactions.</p><section class="Section2 RenderAsSection2" id="Sec2"><h3 class="Heading">Illustrating the Two Generals Paradox</h3><div class="Para" id="Par13">This section will <span id="ITerm7">illustrate</span> the Two Generals Paradox with the classical example scenario. Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig1">13-1</a></span> shows two armies, each led by a different general who are jointly preparing to attack a fortified city, shown in the center. Both armies are encamped near the city, but in their own valleys. A third valley separates the two hills of the valleys occupied by the two generals, and the only way for the two generals to communicate is by sending messengers across the third valley. The third valley is occupied by the city’s defenders, so there’s a chance that any messenger sent through the valley may be captured.<figure class="Figure" id="Fig1"><div class="MediaObject" id="MO1"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig1_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_En_13_F.jpg" style="height:12.45em" width="1725" height="498" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig1_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-1</span><p class="SimplePara">Illustrating the Two Generals Paradox</p></div></figcaption></figure></div><p class="Para" id="Par14">The two generals have agreed that they will <span id="ITerm8">attack</span>; however, they have yet to agree upon a time for attack. The attack will only succeed if both armies attack the city at the same time; the lone attacker army will die trying. So the generals must communicate with each other to decide on a time to attack and agree to jointly attack at that time; each general must also know that the other general knows that they have jointly agreed to the attack plan. An acknowledgement of message receipt can be lost as easily as the original message itself, thus a potentially infinite series of messages are required to come to (near) consensus. Both generals will always be left wondering whether their last messenger got through.</p></section><section class="Section2 RenderAsSection2" id="Sec3"><h3 class="Heading">Solution Approaches</h3><p class="Para" id="Par15">Computer networks are the spine of distributed <span id="ITerm9">systems</span>; however, the reliability of any network has to be examined. <span id="ITerm10">Distributed systems</span> are required to address scalability and flexibility of software systems, so a network is a necessary evil. Schemes should accept the uncertainty of the networks and not attempt to eliminate it; rather, they should mitigate it to an acceptable degree.</p><div class="Para" id="Par16">In the Two Generals Paradox, you can think of many acceptable mechanisms, such as<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par17">The first general can send 50 messengers, anticipating that the probability of all 50 being captured is low. This general will have fixed the time of attack to include enough time for all or a few or many of those 50 messengers to reach the other general. He will then attack at the communicated time no matter what, and the second general will also attack if any of the messages are received.</p></li><li><p class="Para" id="Par18">A second approach is where the first general sends a stream of messages and the second general sends acknowledgments to each received message, with each general’s comfort increasing with the number of messages received.</p></li><li><p class="Para" id="Par19">In a third approach, the first general can put a marking on each message saying it is message 1 of n, 2 of n, 3 of n, etc. Here the second general can estimate how reliable the channel is and send an appropriate number of messages back to ensure a high probability of at least one message being received. If the network is highly reliable, then one message will suffice and additional messages won’t help; if not, the last message is as likely to get lost as the first <span id="ITerm11">one</span>.</p></li></ul></div></div></section><section class="Section2 RenderAsSection2" id="Sec4"><h3 class="Heading">Microservices as Generals</h3><p class="Para" id="Par20">When you have split the state of a <span id="ITerm12">monolith</span> that has been “living happily thereafter, together” to the state of “living happily ever after, separated,” you have split the army from one general into multiple generals. Each microservice has their own general or is a general by itself, and more than one general may be required to coordinate any useful functionality. By adopting <span id="ITerm13">polyglot</span>, each microservice will have its own resource, whether it’s a database or file storage. The network is the only way these microservices can coordinate and communicate. The effect of changes made to resources cross-microservices has to be made consistent. This consistency depends on which schema or protocol you choose to coordinate and communicate the commands to make changes and the acknowledgements, which act as the agreement to effect that change between microservices.</p></section><section class="Section2 RenderAsSection2" id="Sec5"><h3 class="Heading">TCP/IP, the Valley Between the Generals</h3><p class="Para" id="Par21">The Internet Protocol (<span id="ITerm14">IP</span>)<span id="ITerm15">
                
              </span> is not reliable. It may be delayed or dropped or duplicate data can come or data can come in order not as per the original <span id="ITerm16">intention</span>. The Transmission Control <span id="ITerm17">Protocol</span> adds a more reliable layer over IP. <span id="ITerm18">TCP</span> can retransmit missing packets, eliminate duplicates, and assemble packets in the order in which the sender intended to transmit. However, while TCP can hide packet loss, duplication, or reordering, it may not be able to remove delays in the network, since they are packet switched. Traditional fixed-line telephone networks are extremely reliable, and delayed audio frames and dropped calls are very rare. This is because a fixed, guaranteed amount of bandwidth is allocated for your call in the network, along the entire route between the two callers; this is referred to as circuit switched. However, data center networks and the Internet are not circuit switched. Their backbone, the Ethernet and IP, are packet switched protocols, which suffer from queueing, which can cause unbounded delays in the network.</p><p class="Para" id="Par22">Each microservice has its own memory space for computation and resources for persistence and storage, and one microservice cannot access another microservice’s memory or resource (except by making requests to the other microservice over the network, through an exposed API). The Internet and most internal networks in data centers (often Ethernet) have the characteristics explained above, and these networks become the only way microservices can coordinate and communicate. In this kind of network, one microservice can send a message to another microservice, but the network gives no guarantees as to when it will arrive or whether it will arrive at all. If you send a request and expect a response, many things could go wrong in between.</p><p class="Para" id="Par23">The sending microservice can’t even tell whether the request or message was delivered. The next best option is for the recipient microservice to send a response message, which may also in turn be lost or delayed. These issues are indistinguishable in an <span id="ITerm19">asynchronous network</span>. When one microservice sends a request to another microservice and doesn’t receive a response, it is impossible to tell why. The typical way of handling such issues is by using timeouts: after some time you give up waiting and assume that the response is never going to arrive. However, if and when a timeout occurs, you still don’t know whether the remote microservice got your request or not, and if the request is still queued somewhere, there is a chance that it may still be delivered to the recipient microservice, even if the sender microservice has given up on the previous request and might have resent the request, in which case a duplicate request will get fired. Advanced <span id="ITerm20">solutions</span> to this problem are addressed in the reference.<sup><a epub:type="noteref" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fn1" id="Fn1_source" class="totri-footnote">1</a></sup></p></section></section><section class="Section1 RenderAsSection1" id="Sec6"><h2 class="Heading">Transactions</h2><p class="Para" id="Par25">Transactions help you control how access is given to the same data set, whether it is for read or write purposes. Data in a changing state might be inconsistent, hence other reads and writes should have to wait while the state transitions from “changing” to either “committed” or “rolled back.” You will look at the details related to transactions now.</p><section class="Section2 RenderAsSection2" id="Sec7"><h3 class="Heading">Hardware Instruction Sets at the Core of Transactions</h3><p class="Para" id="Par26">For transactions at a single database node, atomicity is implemented at the storage level. When a transaction commits, the database makes the transaction’s writes durable (typically in a <span id="ITerm21">write-ahead log</span><sup><a epub:type="noteref" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fn2" id="Fn2_source" class="totri-footnote">2</a></sup>) and subsequently appends a commit record to the log on disk. So, the controller of the disk drive handling that write takes a crucial role in asserting that the write has happened.</p><p class="Para" id="Par28">A transaction once committed cannot be undone. You cannot change your mind and retroactively undo a transaction after it has been committed. This is because, once data has been committed, it may become visible to other transactions and thus other transactions may have already started relying on that data.</p></section><section class="Section2 RenderAsSection2" id="Sec8"><h3 class="Heading">The ACID in the&nbsp;Transaction</h3><div class="Para" id="Par29">For a transaction to comply with the specification, it should exhibit the <span id="ITerm22">ACID</span> (Atomicity, Consistency, Isolation, and <span id="ITerm23">Durability</span>) properties. Let’s look into them one by one.<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par30"><span id="ITerm24">
                      <strong class="EmphasisTypeBold ">Atomicity</strong>
                      
                    </span><strong class="EmphasisTypeBold ">:</strong> The outcome of a transaction, if it’s a commit, is that all of the transaction’s writes are made durable as a single unit of work. If it’s an abort, then all of the transaction’s writes are rolled back (i.e., undone or discarded) as a single unit of work. If you go back to the previous section where I described that it’s the single controller of one particular disk drive that sits in the core and takes the commit or rollback decision, you need to appreciate that whether it’s the write of a single word<sup><a epub:type="noteref" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fn3" id="Fn3_source" class="totri-footnote">3</a></sup> or multiple words (depending on 32-bit or 64-bit), it’s the support available from the hardware level that helps you club them together as the write of a single unit of work.</p></li><li><p class="Para" id="Par32"><span id="ITerm25">
                      <strong class="EmphasisTypeBold ">Consistency</strong>
                      
                    </span><strong class="EmphasisTypeBold ">:</strong> This property guarantees that a transaction will leave the data in a consistent state, irrespective of whether the transaction is committed or rolled back. To understand what this “consistent state” means, it refers to the adherence of the constraints or rules of the database. It is common to model business rule constraints in terms of database integrity constraints. So, maintaining consistency is a dual effort by both a resource manager and the application. While the application ensures consistency in terms of keys, referential integrity, and so on, the transaction manager ensures that the transaction is atomic, isolated, and durable. For example, if your transaction is to assign the last seat on the flight to one of two travelers who are concurrently booking for that same flight, the transaction will be consistent if one seat is removed from the inventory of free seats and assigned to one and only one of the travelers and at the same time show that the same seat is not assigned or assignable any more to the other traveler trying booking concurrently.</p></li><li><p class="Para" id="Par33"><span id="ITerm26">
                      <strong class="EmphasisTypeBold ">Isolation</strong>
                      
                    </span><strong class="EmphasisTypeBold ">:</strong> The isolation property guarantees that the changes ongoing in a transaction will not affect the data accessed by another transaction. This isolation can be controlled to finer levels, and “Transaction Isolation Mechanisms" section describes them.</p></li><li><p class="Para" id="Par34"><span id="ITerm27">
                      <strong class="EmphasisTypeBold ">Durability</strong>
                      
                    </span><strong class="EmphasisTypeBold ">:</strong> This property requires that when a transaction is committed, any changes the transaction makes to the data must be recorded permanently. When a transaction commits, the database makes the transaction’s writes durable (typically in a write-ahead log) and subsequently appends a commit record to the log on disk. If the database crashes in the middle of this process, the transaction can be recovered from the log when the database restarts. In cases where the commit record is already written to disk before the crash, the transaction is considered committed. If not, any writes from that transaction are rolled back. So the moment at which the disk finishes writing the commit record is the single deciding point to commit; before that moment, it is still possible to abort (due to a crash), but after that moment, the transaction is committed (even if the database crashes just afterwards). So, it is the controller of the disk drive handling the write that makes the commit atomic. Having said that, if an error or crash happens during the process, the above logs can be used to rebuild or recreate the data <span id="ITerm28">changes</span><span id="ITerm29">
                      
                    </span>.</p></li></ul></div></div></section><section class="Section2 RenderAsSection2" id="Sec9"><h3 class="Heading">Transaction Models</h3><div class="Para" id="Par35">Transaction models refer to how the coordination of individual transactions under the context of an enclosing transaction are structured. You will look at the major <span id="ITerm30">transaction models</span> here:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par36"><strong class="EmphasisTypeBold ">Flat transactions:</strong> In a <span id="ITerm31">flat transaction</span>, when one of the steps fails, the entire transaction is rolled back. In a flat transaction, the transaction completes each of its steps before going on to the next one. Each step accesses corresponding resources sequentially. When the transaction uses locks, it can only wait for one object at a time.</p></li><li><p class="Para" id="Par37"><strong class="EmphasisTypeBold ">Nested transactions:</strong> In a <span id="ITerm32">nested transaction</span>, atomic transactions are embedded in other transactions. The top-level transaction can open subtransactions, and each subtransaction can open further subtransactions, and this nesting can continue. The effect of an individual embedded transaction will not affect the parent transaction. When a parent aborts, all of its subtransactions are aborted. However, when a subtransaction aborts, the parent can decide whether to abort or not. In a nested transaction, a subtransaction can be another nested transaction or a flat transaction.</p></li><li><p class="Para" id="Par38"><strong class="EmphasisTypeBold ">Chained transactions:</strong> In a <span id="ITerm33">chained transaction</span>, each transaction relies on the result and resources of the previous transaction. A chained transaction is also called a serial transaction. Here the distinguishing feature is that when a transaction commits, its resources, like cursors, are retained and are available for the next transaction in the chain. So, transactions inside the chain can see the result of the previous commit within the chain; however, transactions outside of the chain cannot see or alter the data being affected by transactions within the chain. If one of the transactions should fail, only that one will be rolled back and the previously committed transactions will not.</p></li><li><p class="Para" id="Par39"><strong class="EmphasisTypeBold ">Saga:</strong> <span class="annotator-hl">Sagas are similar to nested transactions; however, each of the transactions has a corresponding compensating transaction. If any of the transactions in a </span><span id="ITerm34"><span class="annotator-hl">saga</span></span><span class="annotator-hl"> fail, the compensating transactions for each transaction that was successfully run previously will be </span><span id="ITerm35"><span class="annotator-hl">invoked</span></span><span class="annotator-hl">.</span></p></li></ul></div></div></section><section class="Section2 RenderAsSection2" id="Sec10"><h3 class="Heading">Transaction Attributes in EJB vs. Spring</h3><div class="Para" id="Par40">Both <span id="ITerm36">Spring</span> and EJB give the user the freedom to choose from programmatic and declarative transaction management. For programmatic transaction management, you need to code against the JDBC and JTA APIs. With the declarative approach, you externalize transaction control to configuration files. Also, you need to choose from the available transaction attributes to get the required behavior. The EJB specification defines six basic transaction attributes. Subsequently, Spring has counterparts for all six transaction attributes. In fact, Spring has more:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par41"><strong class="EmphasisTypeBold ">PROPAGATION_REQUIRED (REQUIRED in EJB):</strong> Supports a current <span id="ITerm37">transaction</span>; creates a new one if none exist.</p></li><li><p class="Para" id="Par42"><strong class="EmphasisTypeBold ">PROPAGATION_REQUIRES_NEW (REQUIRES_NEW in EJB):</strong> Creates a new transaction; suspends the current <span id="ITerm38">transaction</span> if one exists.</p></li><li><p class="Para" id="Par43"><strong class="EmphasisTypeBold ">PROPAGATION_NOT_SUPPORTED (NOT_SUPPORTED in EJB):</strong><span id="ITerm39">
                      
                    </span> Executes non-transactionally; suspends the current transaction if one exists.</p></li><li><p class="Para" id="Par44"><strong class="EmphasisTypeBold ">PROPAGATION_SUPPORTS (SUPPORTS in EJB):</strong> Supports a current <span id="ITerm40">transaction</span>; executes non-transactionally if none exist.</p></li><li><p class="Para" id="Par45"><strong class="EmphasisTypeBold ">PROPAGATION_MANDATORY (MANDATORY in EJB):</strong> Supports a current <span id="ITerm41">transaction</span>; throws an exception if none exist.</p></li><li><p class="Para" id="Par46"><strong class="EmphasisTypeBold ">PROPAGATION_NEVER (NEVER in EJB):</strong> Executes non-transactionally; throws an <span id="ITerm42">exception</span> if a transaction exists.</p></li><li><p class="Para" id="Par47"><strong class="EmphasisTypeBold ">PROPAGATION_NESTED (No equivalent in EJB):</strong> Executes within a nested transaction if a current <span id="ITerm43">transaction</span> exists, or else behave like <span id="ITerm44">PROPAGATION_REQUIRED</span>. There is no analogous feature in EJB. Actual creation of a nested transaction will only work on specific transaction managers. Out of the box, this only applies to the JDBC DataSourceTransactionManager when working on a JDBC 3.0 driver. Some JTA providers might support nested transactions as well.</p></li></ul></div></div></section><section class="Section2 RenderAsSection2" id="Sec11"><h3 class="Heading">Transaction Isolation Mechanisms</h3><div class="Para" id="Par48"><span id="ITerm45">Transaction isolation</span> refers to the protection of one transaction from the effects of the other, when multiple concurrent transactions happen, often on the same data set. Transaction managers rely on two mechanisms to achieve transaction isolation:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par49"><strong class="EmphasisTypeBold ">Locking:</strong> <span id="ITerm46">Locking</span> controls access to a transaction to a particular data set. <span id="ITerm47">Read locks</span> are non-exclusive and allow multiple transactions to read data concurrently. However, <span id="ITerm48">write locks</span> are exclusive locks and only a single transaction is allowed to update data.</p></li><li><p class="Para" id="Par50"><strong class="EmphasisTypeBold ">Serialization:</strong> When multiple transactions happen concurrently, <span id="ITerm49">serialization</span> is a mechanism to guarantee that the effects are as if they are executing sequentially, not concurrently. Locking is a means of enforcing serialization.</p></li></ul></div></div></section><section class="Section2 RenderAsSection2" id="Sec12"><h3 class="Heading">Transaction Isolation Levels</h3><div class="Para" id="Par51">The types of serialization and locks used as well as the extent to which they are affected determine the level of isolation that a transaction will execute under. Java Enterprise Edition specifies the following types of isolation levels, as defined in the java.sql.Connection interface:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par52"><span id="ITerm50">
                      <strong class="EmphasisTypeBold ">TRANSACTION_NONE:</strong>
                      
                      
                      
                    </span> Indicates that transactions are not supported.</p></li><li><p class="Para" id="Par53"><span id="ITerm51">
                      <strong class="EmphasisTypeBold ">TRANSACTION_READ_COMMITTED:</strong>
                      
                      
                      
                    </span> Indicates that dirty reads are prevented; non-repeatable reads and phantom<sup><a epub:type="noteref" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fn4" id="Fn4_source" class="totri-footnote">4</a></sup> reads can occur.</p></li><li><p class="Para" id="Par55"><span id="ITerm52">
                      <strong class="EmphasisTypeBold ">TRANSACTION_READ_UNCOMMITTED:</strong>
                      
                      
                      
                    </span> Indicates that dirty reads, non-repeatable reads, and phantom reads can occur. This level allows a row changed by one transaction to be read by another transaction before any changes in that row have been committed (a dirty read). If any of the changes are rolled back, the second transaction will have retrieved an invalid row.</p></li><li><p class="Para" id="Par56"><span id="ITerm53">
                      <strong class="EmphasisTypeBold ">TRANSACTION_REPEATABLE_READ:</strong>
                      
                      
                      
                    </span> Indicates that dirty reads and non-repeatable reads are prevented; phantom reads can occur.</p></li><li><p class="Para" id="Par57"><span id="ITerm54">
                      <strong class="EmphasisTypeBold ">TRANSACTION_SERIALIZABLE:</strong>
                      
                      
                      
                    </span> Indicates that dirty reads, non-repeatable reads, and phantom reads are prevented. This level prohibits the situation where one transaction reads all rows that satisfy a WHERE condition, a second transaction inserts a row that satisfies that WHERE condition, and the first transaction rereads for the same condition, retrieving the additional phantom row in the second read.</p></li></ul></div></div><p class="Para" id="Par58">The level of relaxation or the strictness of enforcement of the serialization and locks are determined by the type of concurrency the application is willing to tolerate with respect to staleness of data. The next section will explain this concept.</p></section><section class="Section2 RenderAsSection2" id="Sec13"><h3 class="Heading">Transaction Concurrency</h3><div class="Para" id="Par59">When multiple concurrent transactions <span id="ITerm55">happen</span>, often on the same data set, the effect of one transaction from the effects of the other can be controlled via the level of concurrency the application is willing to tolerate. The levels are the following:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par60"><strong class="EmphasisTypeBold "><span class="annotator-hl">Dirty read:</span></strong> <span id="ITerm56"><span class="annotator-hl">Dirty read</span></span><span class="annotator-hl">s happen when a transaction reads data that has been written by another transaction but has not yet been committed by the other transaction.</span></p></li><li><p class="Para" id="Par61"><span id="ITerm57">
                      <strong class="EmphasisTypeBold "><span class="annotator-hl">Non-repeatable read:</span></strong>
                      
                    </span><span class="annotator-hl"> If a transaction reads data, and if it gets a different result if it rereads the same data within the same transaction, it is a non-repeatable read.</span></p></li><li><p class="Para" id="Par62"><strong class="EmphasisTypeBold "><span class="annotator-hl">Phantom read:</span></strong><span class="annotator-hl"> When a single transaction reads against the same data set more than once, a phantom read happens when another transaction slips in and inserts additional data.</span></p></li></ul></div></div></section><section class="Section2 RenderAsSection2" id="Sec14"><h3 class="Heading">Transaction Isolation Control Methods</h3><div class="Para" id="Par63">Strict levels of transaction isolation may cause negative performance scenarios, and in such cases there are two general approaches to <span id="ITerm58">locking</span>:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par64"><strong class="EmphasisTypeBold ">Optimistic locking:</strong> <span id="ITerm59">Optimistic locking</span> takes a pragmatic approach and encourages clients to be “optimistic” that data will not change while they are using it and allows them to access same data concurrently. If for any reason the transaction on behalf of any particular client wants to update, the update is committed if and only if the data that was originally provided to the client is the same as the current data in the database. This approach is less ideal for hot-spot data because the comparison will fail often.</p></li><li><p class="Para" id="Par65"><strong class="EmphasisTypeBold ">Pessimistic locking:</strong> <span id="ITerm60">Pessimistic locking</span> may use <span id="ITerm61">semaphore</span><sup><a epub:type="noteref" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fn5" id="Fn5_source" class="totri-footnote">5</a></sup> or any of the transaction mechanisms previously discussed. For every read, you need a <span id="ITerm62">read lock</span>, and for every write, you need a <span id="ITerm63">write lock</span>. Read locks are not exclusive whereas write locks are. A typical read lock may be obtained when you query similar to</p><div class="Para" id="Par67">
                    <div class="ProgramCode" id="PC1"><div class="LineGroup"><div class="FixedLine">SELECT ∗ FROM QUOTES_TABLE WHERE QUOTES_ID=5 FOR UPDATE;</div></div></div>
                  </div></li></ul></div></div><p class="Para" id="Par68"><span class="annotator-hl">Both locks will be released only when the usage of data is completed. A read lock can be given to a transaction on request, provided no other transaction holds the write lock. For a transaction to update, it requires a write lock, and during the duration that transaction holds the write lock, other transactions are allowed to read the data if and only if they don’t require a read lock. Moreover, if a transaction holds a write, it will not allow another transaction to read its changing data until those changes have been committed.</span></p></section></section><section class="Section1 RenderAsSection1" id="Sec15"><h2 class="Heading">Enterprise Transaction Categories</h2><p class="Para" id="Par69">Transactions have different connotations depending on the context in which we use them. It can be in the context of multiple operations within a monolith system, or in the context of multiple monoliths or multiple microservices, or in the context of multiple enterprises with common (or conflicting) interests. You will briefly look at the different transaction categories in this context.</p><section class="Section2 RenderAsSection2" id="Sec16"><h3 class="Heading">ACID Transactions</h3><div class="Para" id="Par70"><span id="ITerm64">ACID transactions</span> are related to <span id="ITerm65">atomic</span> transactions where multiple steps or operations are executed with the intent that either all of them succeed together or all of them return back to the previous state due to the failure of one or more of the steps. A major portion of the discussion in previous sections of this chapter concerned ACID transactions, so enough explanation has already been done. You will now look at the architecture of an ACID transaction processing (TP) system. Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig2">13-2</a></span> depicts a typical architecture consisting of multiple resource managers.<figure class="Figure" id="Fig2"><div class="MediaObject" id="MO2"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig2_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(1).jpg" style="height:25.8em" width="1725" height="1032" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig2_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-2</span><p class="SimplePara"><span id="ITerm66">Distributed ACID transactions</span> with multiple resources</p></div></figcaption></figure></div></section><section class="Section2 RenderAsSection2" id="Sec17"><h3 class="Heading">BASE = ACID in Slices</h3><p class="Para" id="Par71">ACID is the only style that can guarantee data consistency. However, if a distributed system uses ACID transactions, everything has to happen in lockstep mode, everywhere. This requires all components to be available and it also increases the lock times on the data. BASE is an architectural style that relaxes these requirements, simply by cutting the (overall, ideal) ACID transaction into smaller pieces, each of them still ACID in themselves.</p><p class="Para" id="Par72">Messaging is used to make changes ripple through the system, where each change is ideally processed by an ACID transaction. The messages are asynchronous rather than synchronous, meaning that there is a delay between the first and last ACID transaction in a BASE system.</p><p class="Para" id="Par73">This is why this style exhibits “eventual consistency:” one has to wait for all messages to ripple through the system and be applied where appropriate. The “Eventual Consistency of Microservices” section in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_11_Chapter.xhtml"><span class="RefSource">11</span></a></span> discussed this in detail.</p><p class="Para" id="Par74">I’ll now introduce BASE in various incremental steps, by cutting more and more into the ACID transaction scope.</p></section><section class="Section2 RenderAsSection2" id="Sec18"><h3 class="Heading">BASE Transactions</h3><div class="Para" id="Par75">Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig3">13-3</a></span> shows a BASE <span id="ITerm67">architecture</span> with four different microservices. Each microservice still has ACID properties (independent of the other microservices of the system).<figure class="Figure" id="Fig3"><div class="MediaObject" id="MO3"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig3_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(2).jpg" style="height:27.03em" width="1725" height="1081" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig3_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-3</span><p class="SimplePara"><span id="ITerm68">BASE architecture</span> where each microservice still has ACID guarantees by means of XA <span id="ITerm69">transactions</span></p></div></figcaption></figure></div><p class="Para" id="Par76">This is the architecture of a microservice <span id="ITerm70">ecosystem</span> in BASE style that sends or receives messages in ACID style. You will look at the functionality of each microservice in a later section (the “Design the Example Scenario” subsection under the “Distributed Transaction Example” section); however, pay attention to the technical components depicted here for the time being. It is BASE because via ActiveMQ you don’t know or care where the messages go to or come from; all that the quote processing and quote settlement see between them is the queues (whereas a classical ACID architecture would create one big <span id="ITerm71">ACID transaction</span> for quote settlement and quote processing). You use JTA/XA to ensure that messages are processed exactly once, since you don’t want to lose messages (or get duplicates). Messages that are received from the queue are guaranteed to make it to the database, even with intermediate crashes. Messages that are sent are guaranteed to have their domain object status updated in the database, even with intermediate crashes.</p><p class="Para" id="Par77">For systems that require strong guarantees on data consistency, this is a good solution. In other systems, strong data consistency is not that vital and you can relax things even more–by using an even finer scope of ACID transactions in your <span id="ITerm72">BASE architecture</span>.</p><p class="Para" id="Par78">When you transition to microservices, you want to avoid system-wide distributed transactions. However, your actual data is distributed more compared to the scenario of the monolith, so the need for distributed transactions is very real. And it is in this context we are talking about eventual consistency in place of instantaneous <span id="ITerm73">consistency</span>. The “Eventual Consistency of Microservices” section in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_11_Chapter.xhtml"><span class="RefSource">11</span></a></span> covered this in detail.</p></section><section class="Section2 RenderAsSection2" id="Sec19"><h3 class="Heading">Relaxed BASE Transactions</h3><p class="Para" id="Par79">In some cases, you don’t care a lot about message loss or duplicates, and the scope of your ACID transactions can be limited to single resource managers, like purely local transactions only. This offers more performance but it has a cost: whereas so far the BASE system had eventual consistency, this architecture no longer guarantees that by default.</p><p class="Para" id="Par80">As will be shown in the next chapter, to get some level of consistency, a lot more work has to be done by the application developers; in some cases, eventual consistency may even be impossible, notably in the case of message loss.</p><div class="Para" id="Par81">Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig4">13-4</a></span> shows a typical architecture consisting of multiple resource managers in a <span id="ITerm74">relaxed</span> BASE transaction.<figure class="Figure" id="Fig4"><div class="MediaObject" id="MO4"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig4_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(3).jpg" style="height:27.25em" width="1725" height="1090" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig4_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-4</span><p class="SimplePara">Distributed, relaxed BASE transactions with multiple <span id="ITerm75">resources</span></p></div></figcaption></figure></div><p class="Para" id="Par82">Microservice resources are distributed across nodes. You want to avoid distributed transactions since locking of resources across nodes will impede system scalability. Further, you are OK for eventual consistency but you don’t mind if you can’t achieve it perfectly. If so, Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig4">13-4</a></span> illustrates how to follow the relaxed BASE model. Applications interact either directly with one or more of the involved resource managers, or, more typically, through some load balancer or gateway that distributes incoming requests to a pool of resource managers with symmetrical responsibilities and capabilities. Requests are served by one or more resource managers, and changes are propagated to one or more other resource managers subsequently. The number of resource managers involved depends on the sharding model (covered in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_11_Chapter.xhtml"><span class="RefSource">11</span></a></span>’s “The Scale Cube” section) and the system configuration chosen, ranging from a single node (single replica) to a quorum of nodes to, theoretically, all replicas of a given data record.</p><div class="Para" id="Par83"><span id="ITerm76">Axon</span> provides many features with which you can span BASE transactions across resource managers without using a distributed transaction manager or transaction coordinator. To rephrase, there is no distributed transaction manager or transaction coordinator in a BASE transaction; still, transactions can be propagated across multiple resource managers to have some level of eventual consistency. Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig5">13-5</a></span> depicts this scenario where you show the key components in Axon that make this happen.<figure class="Figure" id="Fig5"><div class="MediaObject" id="MO5"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig5_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(4).jpg" style="height:31.6em" width="1725" height="1264" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig5_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-5</span><p class="SimplePara"><span id="ITerm77">Axon components</span> to support BASE transactions</p></div></figcaption></figure></div><div class="Para" id="Par84">You will look at typical relaxed BASE transactional steps, referring to Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig5">13-5</a></span>. A write request from a browser will come as a <span id="ITerm78">HTTP PUT</span> at the HTTP server or the load balancer.<div class="OrderedList"><ol><li class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><p class="Para" id="Par85">The request is routed to the API gateway.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><p class="Para" id="Par86">The API gateway routes this request to the first point of contact of the request to the Axon application, which is the (front) REST Controller.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><p class="Para" id="Par87">The REST Controller, after unpacking the request, interprets it as a request for an entity change and creates a command, following the CQRS pattern. This command is send to the distributed command bus, starting a local transaction.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">4.</span><div class="ItemContent"><p class="Para" id="Par88">The distributed command bus transports this command to the node containing the respective command handler (Resource Manager 3).</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">5.</span><div class="ItemContent"><p class="Para" id="Par89">The command handler effects the write to the entity with the help of the repository in the Write DB.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">6.</span><div class="ItemContent"><p class="Para" id="Par90">The above repository change also triggers an event (the “Design the Example Scenario” section under the “Command and Event Handling in Same JVM” section in Chapter <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_12_Chapter.xhtml"><span class="RefSource">12</span></a></span> provides detailed narration) and this event is sent to the clustered event bus.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">7.</span><div class="ItemContent"><p class="Para" id="Par91">In Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig5">13-5</a></span>, you can see that the two different event handlers (Resource Manager 1 and Resource Manager 2) are interested in the previous event, and they may also do whatever state changes they dictate.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">8.</span><div class="ItemContent"><p class="Para" id="Par92">You can see that Resource Manager 2 is in effect synchronizing itself (the Read DB)<span id="ITerm79">
                        
                        
                      </span> of any interesting changes in the system.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">9.</span><div class="ItemContent"><p class="Para" id="Par93">Any subsequent query (HTTP GET) also sees these changes. Eventually, everyone see the changes.</p></div><div class="ClearBoth">&nbsp;</div></li></ol></div></div></section></section><section class="Section1 RenderAsSection1" id="Sec20"><h2 class="Heading">ACID vs. BASE</h2><p class="Para" id="Par94">Such a comparison is like comparing apples and oranges: they are not intended to replace each <span id="ITerm80">other</span>, and both are equally good (or bad) at serving their own purpose. This is an easily said statement; however, no CTO-level discussion can end with that straight explanation. Having said that, understanding this distinction is key in “mastering microservices.” If you understand this difference, the main intention of this book is met!</p><p class="Para" id="Par95">BASE transactions are the base for <span id="ITerm81">microservices architecture</span> where we want to stay away from <span id="ITerm82">ACID transactions</span>. However, they serve different purposes. There is not much point in debating one over the other, since both solve orthogonal concerns–the reason why the CAP theorem is significant. But then, do you want to completely put aside ACID transactions? It’s like asking whether you as the captain of your fighter jet should have direct control of the seat ejection button or are you comfortable even if you don’t have direct reach to it but you are (almost) sure that your co-pilot will activate it for you at your command? In the former case, you are very sure that you can escape instantaneously, at your own will, when a sudden need arises. In the latter case, you are almost sure that you will still be able to escape; however, there is a percentage of skepticism as to whether the escape will be instantaneous or delayed either due to your co-pilot taking time to execute your command or in the unfortunate event that your co-pilot is not in a position to move his own muscles to act! To restate, the former is synonymous to an ACID transaction, which is relatively more deterministic, whereas the latter is synonymous to a BASE transaction, which (may) eventually happen.</p><p class="Para" id="Par96">We still need ACID, if not all the time.</p><p class="Para" id="Par97">Let’s now come to BASE. If you still use ACID at the right level (as in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig3">13-3</a></span>), then things are easy. On the other hand, an even more relaxed BASE approach is not going to ease your life; in fact, relaxed BASE is going to give you far more complexities than ACID.</p><p class="Para" id="Par98">Having said that, one way to understand and appreciate the complexities involved in BASE transactions is to understand ACID <span id="ITerm83">transactions</span> themselves, so you will do that in the following sections.</p></section><section class="Section1 RenderAsSection1" id="Sec21"><h2 class="Heading">Distributed Transactions Revisited</h2><p class="Para" id="Par99">Before you look into concrete examples, you need to understand a few concepts that will set the context for the examples you will explore.</p><section class="Section2 RenderAsSection2" id="Sec22"><h3 class="Heading">Local Transactions</h3><p class="Para" id="Par100">If you take a typical resource <span id="ITerm84">manager</span>, typically that single resource will be confined to a single host or node (even though that may not be the case mandatorily). Operations confined to such a single resource are local transactions and they affect only one transactional resource. Within a single node, there are less (or for practical considerations, nil) nondeterministic operations, hence a command sent to a single node must be considered deterministic, and in case of any catastrophes, there are local recovery mechanisms. These resources have their own transactional APIs, and the notion of a transaction is often exhibited as the concept of a <span id="ITerm85">session</span>, which can encapsulate a <span id="ITerm86">unit of work</span> with demarcating APIs to tell the resource when the buffered work should be committed to the underlying resource. Thus, from a developer perspective, you do not manage with transactions in a local transaction, but with just “connections.”</p><div class="Para" id="Par101">The <span id="ITerm87">java.sql.Connection interface</span> is a transactional resource that can wrap a database. By default, a Connection object is in <span id="ITerm88">auto-commit</span> mode, which means that it automatically commits changes after executing each statement. If auto-commit mode is disabled, the method commit must be called explicitly in order to commit changes; otherwise, database changes will not be saved. It is preferable to collect several related statements into a batch and then commit all, or none, when you have more than one statement. You do this by first setting the Connection’s <span class="EmphasisFontCategoryNonProportional ">setAutoCommit()</span> method<span id="ITerm89">
                
              </span> to false and later explicitly calling <span id="ITerm90">
                <span class="EmphasisFontCategoryNonProportional ">Connection.commit()</span>
                
                
              </span> or <span id="ITerm91">
                <span class="EmphasisFontCategoryNonProportional ">Connection.rollback()</span>
                
              </span> at the end of the batch. See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC2">13-1</a></span>.<div class="ProgramCode" id="PC2"><div class="LineGroup"><div class="FixedLine">try{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;connection.setAutoCommit(false);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;Statement statement = conn.createStatement();</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;String insertString = "insert into " +&nbsp;&nbsp;dbName + ".SHIPPING VALUES ("</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ orderId + ", 'NEW')";</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;statement.executeUpdate(insertString);</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;String updateString = "update " + dbName + ".ORDERS set STATUS =</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'PROCESSED' where ORDER_ID = " + orderId;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;statement.executeUpdate(updateString);</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;connection.commit();</div><div class="FixedLine">}catch(SQLException se){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;connection.rollback();</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-1</span><p class="SimplePara">A Local Transaction Sample</p></div></div></div></div><p class="Para" id="Par102">In Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC2">13-1</a></span>, both the statements will be committed together or rolled back together. However, it is a local transaction, not a distributed transaction.</p></section><section class="Section2 RenderAsSection2" id="Sec23"><h3 class="Heading">Distributed Transactions</h3><p class="Para" id="Par103">Typically for the scenario of a distributed transaction to exist, it must span at least two resource managers. Databases, message queues, <span id="ITerm92">transaction processing (TP)</span> monitors like IBM’s CICS, BEA’s Tuxedo, SAP Java Connector, and Siebel Systems are common transactional resources, and often, if the transactions has to be distributed, it has to span a couple of such resources. A distributed transaction can be seen as an atomic operation that must be synchronized (or provide ACID properties) among multiple participating resources that are distributed among different physical locations.</p><div class="Para" id="Par104">Java EE application servers like Oracle Weblogic and IBM Websphere support JTA out of the box, and there are third-party, standalone implementations of JTA like<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par105"><strong class="EmphasisTypeBold ">JOTM:</strong> <span id="ITerm93">JOTM</span><span id="ITerm94">
                      
                    </span> is an open source transaction manager implemented in Java. It supports several transaction models and specifications providing transaction support for clients using a wide range of middleware platforms (J2EE, CORBA, Web Services, OSGi).</p></li><li><p class="Para" id="Par106"><strong class="EmphasisTypeBold ">Narayana:</strong> <span id="ITerm95">Narayana</span>, formerly known as JBossTS and Arjuna Transaction Service, comes with a very robust implementation that supports both the JTA and JTS APIs. It supports three extended transaction models: nested top-level transactions, nested transactions, and a compensation-based model based on sagas. Further, it also supports web service and RESTful transactions. There is a need for manual integration with the Spring framework, but it provides out-of-the-box integration with Spring Boot.</p></li><li><p class="Para" id="Par107"><span id="ITerm96">
                      <strong class="EmphasisTypeBold ">Atomikos</strong>
                      
                    </span> <strong class="EmphasisTypeBold ">TransactionsEssentials:</strong> Atomikos TransactionsEssentials is a production quality implementation that also supports recovery and some exotic features beyond the JTA API. It provides out-of-the-box Spring integration and support for pooled connections for both database and JMS resources.</p></li><li><p class="Para" id="Par108"><strong class="EmphasisTypeBold ">Bitronix JTA:</strong> <span id="ITerm97">Bitronix</span><span id="ITerm98">
                      
                      
                    </span> claims to support transaction recovery as well as or even better than some of the commercial products. Bitronix also provides connection pooling and session pooling out of the box.</p></li></ul></div></div></section><section class="Section2 RenderAsSection2" id="Sec24"><h3 class="Heading">Distributed Transactions in Java</h3><p class="Para" id="Par109">Coordination of transactions spanning multiple <span id="ITerm99">resources</span> are specified by the X/Open standards by opengroup. Java supports X/Open standards by providing two interfaces: JTA (Java Transaction API)<span id="ITerm100">
                
              </span> and JTS (Java Transaction Service)<span id="ITerm101">
                
              </span>. As shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig2">13-2</a></span>, JTA is used by application developers to communicate to transaction managers. Since resources can be provided by multiple vendors following different platforms and programming languages, if all of these resources must be coordinated, they have to agree again to the X/Open standards. Here, JTS, which follows <span id="ITerm102">CORBA</span> OTS (Object Transaction Service)<span id="ITerm103">
                
              </span>, provides the required interoperability between different transaction managers sitting with distributed resources.</p><p class="Para" id="Par110">I have discussed the “distributed nature” in distributed transactions. The two-phase commit protocol is used for coordination of transactions across multiple resource managers.</p></section></section><section class="Section1 RenderAsSection1" id="Sec25"><h2 class="Heading">Distributed Transaction Example Using MySQL, ActiveMQ, Derby, and Atomikos</h2><p class="Para" id="Par111">The easiest way to do away with many data consistency problems, especially when multiple resource managers are involved, is to use XA or distributed transactions even in BASE, as in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig3">13-3</a></span>. However, if you want to transition to even more relaxed BASE microservices, the design mechanisms have to be more fault tolerant since your XA transaction managers are absent, and they would have done all the hard work. You will walk through the major consistency concern scenarios with the help of an example. Again, I could have demonstrated the concern scenarios straight without using distributed transactions in the example; however, I will take the reverse route and use XA transactions to illustrate the perfect scenario and simulate the various fault conditions by cutting down the ACID scope even more since it is rather easy for you, the reader, to comprehend aspects in this manner. XA transactions allow us to do that by “abusing” the transaction attributes to make the transaction scope smaller than it would normally be. This means that I can reuse the same code to illustrate the anomalies of relaxed BASE incrementally.</p><section class="Section2 RenderAsSection2" id="Sec26"><h3 class="Heading">The Example Scenario</h3><div class="Para" id="Par112">The example is not trivial, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig3">13-3</a></span>, so the scenario requires a little explanation. The example scenario is a simple <span id="ITerm104">stock trade processing system</span>. Here are the building blocks:<div class="OrderedList"><ol><li class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><p class="Para" id="Par113">New quotes for stock transactions can be pushed to the Broker Web microservice. New quotes get inserted into a <span class="EmphasisFontCategoryNonProportional ">Quotes</span> table, which is in a MySQL DB, with a status of “New.”</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><p class="Para" id="Par114">The Quotes processor task is a quartz scheduled task and it polls the <span class="EmphasisFontCategoryNonProportional ">Quotes</span> table in the MySQL DB for any new quotes with a status of “New.”</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><p class="Para" id="Par115">When a new quote with a status of “New” is found, it invokes the <span class="EmphasisFontCategoryNonProportional ">processNewQuote</span> method of the broker service, always with a transaction, passing the unique identifier for the new quote into the <span class="EmphasisFontCategoryNonProportional ">Quotes</span> table.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">4.</span><div class="ItemContent"><p class="Para" id="Par116">The broker service makes use of the other transactional services, the auction service and the stock order service, and the execution of both has to be atomic.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">5.</span><div class="ItemContent"><p class="Para" id="Par117">The auction service confirms the quote received by changing the status of the quote to “Confirmed” within a transaction.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">6.</span><div class="ItemContent"><p class="Para" id="Par118">The stock order service creates a JMS message out of the information contained in the new quote and is sent to an ActiveMQ queue for settlement of the quote, again within the above (5) transaction.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">7.</span><div class="ItemContent"><p class="Para" id="Par119">The settlement listener service is listening on the ActiveMQ queue for any new confirmed quote. All confirmed quotes on reaching the ActiveMQ queue are picked up by <span class="EmphasisFontCategoryNonProportional ">onMessage</span> of the settlement listener service, within a transaction.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">8.</span><div class="ItemContent"><p class="Para" id="Par120">The settlement listener service invokes the quotes reconcile service for reconciliation of the quote, again within the above (7) transaction.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">9.</span><div class="ItemContent"><p class="Para" id="Par121">The quotes reconcile service needs to reconcile the value of the stock traded to the respective user account of the seller and the buyer, within the above (7) transaction.</p></div><div class="ClearBoth">&nbsp;</div></li><li class="ListItem"><span class="ItemNumber">10.</span><div class="ItemContent"><p class="Para" id="Par122">The Broker Web microservice and the Settlement Web microservice are just utilities that provide a dashboard view of the operational data on both the <span class="EmphasisFontCategoryNonProportional ">Quotes</span> table as well as the <span class="EmphasisFontCategoryNonProportional ">User</span> table to provide live views.</p></div><div class="ClearBoth">&nbsp;</div></li></ol></div></div><p class="Para" id="Par123">Having seen the high-level <span id="ITerm105">business</span> of the example scenario, let’s now pay attention to other infrastructural aspects in the architecture. The Quote Processing microservice has to do atomic operations across two resources, MySQL and ActiveMQ. You need a distributed transaction manager here. Similarly, the Quote Settlement microservice must also do atomic operations across two resources, Derby and ActiveMQ. You need a distributed transaction manager here also.</p></section><section class="Section2 RenderAsSection2" id="Sec27"><h3 class="Heading">Code the Example Scenario</h3><p class="Para" id="Par124">The complete code required to demonstrate the distributed transaction example is in folder <span class="EmphasisFontCategoryNonProportional ">ch13\ch13-01</span>. There are four microservices to be coded. You will look into them one by one.</p><section class="Section3 RenderAsSection3" id="Sec28"><h4 class="Heading">Microservice 1: Quote Processing (Broker-MySQL-ActiveMQ)</h4><div class="Para" id="Par125">Visit <span class="EmphasisFontCategoryNonProportional ">pom.xml</span> to see the <span id="ITerm106">Atomikos</span> distributed transaction manager dependency. See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC3">13-2</a></span>.<div class="ProgramCode" id="PC3"><div class="LineGroup"><div class="FixedLine">&lt;dependencies&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;dependency&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;javax.transaction&lt;/groupId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;jta&lt;/artifactId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;1.1&lt;/version&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;dependency&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;com.atomikos&lt;/groupId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;transactions&lt;/artifactId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;3.9.3&lt;/version&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;dependency&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;com.atomikos&lt;/groupId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;transactions-hibernate3&lt;/artifactId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;3.9.3&lt;/version&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;dependency&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;com.atomikos&lt;/groupId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;transactions-api&lt;/artifactId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;3.9.3&lt;/version&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;dependency&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;com.atomikos&lt;/groupId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;transactions-jms&lt;/artifactId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;3.9.3&lt;/version&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;dependency&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;com.atomikos&lt;/groupId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;transactions-jdbc&lt;/artifactId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;3.9.3&lt;/version&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;dependency&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;com.atomikos&lt;/groupId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;transactions-jta&lt;/artifactId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;3.9.3&lt;/version&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;dependency&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;activemq-core&lt;/artifactId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;5.7.0&lt;/version&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;dependency&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;mysql&lt;/groupId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;8.0.14&lt;/version&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</div></div><div class="LineGroup"><div class="FixedLine">&lt;/dependencies&gt;<span id="ITerm107">
                        
                        
                        
                      </span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-2</span><p class="SimplePara"><span id="ITerm108">Maven Dependencies</span> for the Distributed Transactions Example Using MySQL and ActiveMQ (ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ\pom.xml)</p></div></div></div></div><p class="Para" id="Par126">These library dependencies will be clearer when you look at the configuration in detail. Before you do that, let’s inspect the main components in the architecture.</p><div class="Para" id="Par127">You will first look at the Quotes Processor Task, which is a <span id="ITerm109">Quartz scheduler</span> that will timeout at configured intervals so the <span id="ITerm110">
                  <span class="EmphasisFontCategoryNonProportional ">processNewQuotes()</span>
                  
                </span> will get triggered at definite intervals. See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC4">13-3</a></span>.<div class="ProgramCode" id="PC4"><div class="LineGroup"><div class="FixedLine">public class QuotesProcessorTask {</div></div><div class="LineGroup"><div class="FixedLine">@Autowired</div><div class="FixedLine">@Qualifier("brokerServiceRequired_TX")</div><div class="FixedLine">BrokerService brokerServiceRequired_TX;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public void processNewQuotes() {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&lt;QuoteDTO&gt; newQuotes = brokerServiceRequired_TX.findNewQuotes();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newQuotes.forEach(item-&gt;{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(((QuoteDTO) item).getStatus().equals(Quote.NEW)){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;brokerServiceRequired_TX.processNewQuote(</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((QuoteDTO) item).getId());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-3</span><p class="SimplePara"><span id="ITerm111">Scheduled Task</span> for Processing New Quotes (ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ\src\main\java\com\acme\ecom\schedule\QuotesProcessorTask.java)</p></div></div></div></div><div class="Para" id="Par128">If “New” quotes are found, the scheduler invokes the <span class="EmphasisFontCategoryNonProportional ">processNewQuote()</span> method<span id="ITerm112">
                  
                  
                  
                </span> of the broker service, once for each new quote, passing the ID of the new quote found. Note that this method invocation happens within a transaction, the configuration of which you will see soon. You will look at the broker service next in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC5">13-4</a></span>.<div class="ProgramCode" id="PC5"><div class="LineGroup"><div class="FixedLine">public class BrokerServiceImpl implements BrokerService{</div></div><div class="LineGroup"><div class="FixedLine">private static volatile boolean flipFlop = false;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Qualifier("auctionServiceRequired_TX")</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;AuctionService auctionServiceRequired_TX;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Qualifier("stockOrderServiceRequired_TX")</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;StockOrderService stockOrderServiceRequired_TX;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Qualifier("auctionServiceRequiresNew_TX")</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;AuctionService auctionServiceRequiresNew_TX;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Qualifier("stockOrderServiceRequiresNew_TX")</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;StockOrderService stockOrderServiceRequiresNew_TX;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private static synchronized void flipFlop() throws QuotesBaseException{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(flipFlop){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flipFlop = false;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flipFlop = true;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(flipFlop){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new QuotesBaseException("Explicitly thrown by Broker</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Application to Roll Back!");</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Override</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public List&lt;QuoteDTO&gt; findNewQuotes(){<span id="ITerm113">
                        
                        
                        
                      </span></div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&lt;QuoteDTO&gt; newQuotes = auctionServiceRequired_TX.findNewQuotes();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return newQuotes;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Override</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public void processNewQuote(Long id)throws QuotesBaseException{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional&lt;QuoteDTO&gt; quoteQueried =</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auctionServiceRequired_TX.findQuoteById(id);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QuoteDTO quoteDTO = (QuoteDTO) quoteQueried.get();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Integer testCase = quoteDTO.getTest();</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If((testCase == 1)&nbsp;&nbsp;|| (testCase == 5) || (testCase == 6)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| (testCase == 7)){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auctionServiceRequired_TX.confirmQuote(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockOrderServiceRequired_TX.sendOrderMessage(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if(testCase == 2){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auctionServiceRequired_TX.confirmQuote(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockOrderServiceRequired_TX.sendOrderMessage(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flipFlop();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if(testCase == 3){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auctionServiceRequired_TX.confirmQuote(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockOrderServiceRequiresNew_TX.sendOrderMessage(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch(QuotesMessageRollbackException</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesMessageRollbackException){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.error(quotesMessageRollbackException.getMessage());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if(testCase == 4){<span id="ITerm114">
                        
                        
                        
                      </span></div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auctionServiceRequiresNew_TX.confirmQuote(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch(QuotesConfirmRollbackException</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesConfirmRollbackException){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.error(quotesConfirmRollbackException.getMessage());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockOrderServiceRequired_TX.sendOrderMessage(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if(testCase == 8){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auctionServiceRequiresNew_TX.confirmQuote(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// PROPAGATION_REQUIRES_NEW Because, during next time out</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// of QuotesProcessorTask we shouldn't fetch this quote</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch(QuotesConfirmRollbackException</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesConfirmRollbackException){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.error(quotesConfirmRollbackException.getMessage());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stockOrderServiceRequired_TX.sendOrderMessage(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.debug("Undefined Test Case");</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}<span id="ITerm115">
                        
                        
                        
                      </span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-4</span><p class="SimplePara"><span id="ITerm116">Broker Service</span> Coordinating New Quote Processing (ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ\src\main\java\com\acme\ecom\service\BrokerServiceImpl.java)</p></div></div></div></div><p class="Para" id="Par129">You auto-configure the references to the auction service and the stock order service within the broker service. You have two references of each of these services; this is just a hack to arrange the fixtures for the various test scenarios you are going to validate. To make it clear, you have two references of auction service with the names auctionServiceRequired_TX and auctionServiceRequiresNew_TX. As the name implies, the write methods in auctionServiceRequired_TX get executed in a <span id="ITerm117">PROPAGATION_REQUIRED</span> context whereas those in auctionServiceRequiresNew_TX get executed in a <span id="ITerm118">PROPAGATION_REQUIRES_NEW</span> context. The rest of the code checks the incoming parameter where you have piggy-backed an indicator (an integer value) to identify which test scenario (test case) you are executing. The general strategy is to use PROPAGATION_REQUIRED if you want to propagate transactions between parent and child services and to use PROPAGATION_REQUIRES_NEW wherever you explicitly generate error conditions so that the error is confined to the context of that respective service method alone, that too in a controlled manner (by using try-catch) and the rest of the execution flow can happen; again, this is to facilitate the fixture for the demonstration purposes.</p><p class="Para" id="Par130">You need to be aware that, in a real production scenario, you do not want the arrangement of the test scenarios; so if you want atomic operations across services, you just configure everything using PROPAGATION_REQUIRED, the (testCase == 1) scenario alone.</p><p class="Para" id="Par131">There is another utility method called <span id="ITerm119">flipFlop</span>()<span id="ITerm120">
                  
                  
                  
                </span><sup><a epub:type="noteref" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fn6" id="Fn6_source" class="totri-footnote">6</a></sup> defined in the broker service. This method flip-flops the simulation of error creation during an operation between two consecutive executions, so if you have simulated an error in one execution of the method, the next execution of the same method will not simulate the error. In this way, if you have executed a test case to validate for an error scenario in one pass, you will also be able to see how the invariants will be if the same flow is executed without that error scenario. This is useful if you want to see if the message consumptions fails between the first pass so that when an attempt to reconsume happens, it will happen without failure in the next pass; in that manner, it is easy for you to test and visualize the results. Leave this here for the time being; it will be clearer when you execute the tests.</p><div class="Para" id="Par133">Next, look at the auction service shown in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC6">13-5</a></span>.<div class="ProgramCode" id="PC6"><div class="LineGroup"><div class="FixedLine">@Service</div><div class="FixedLine">public class AuctionServiceImpl implements AuctionService{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private QuoteRepository quoteRepository;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Override</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public QuoteDTO confirmQuote(QuoteDTO quoteDTO)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws QuotesConfirmRollbackException{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Integer testCase = quoteDTO.getTest();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional quoteQueried = quoteRepository.findById(quoteDTO.getId());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Quote quote = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Quote quoteSaved = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(quoteQueried.isPresent()){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quote = (Quote) quoteQueried.get();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quote.setStatus(Quote.CONFIRMED);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quote.setUpdatedAt(new Date());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quoteSaved = quoteRepository.save(quote);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(testCase == 4){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flipFlop();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return getQuoteDTOFromQuote((Quote) quoteQueriedAgain.get());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}<span id="ITerm121">
                        
                        
                        
                      </span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-5</span><p class="SimplePara"><span id="ITerm122">Auction Service</span> Confirming New Quotes into MySQL DB (ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ\src\main\java\com\acme\ecom\service\AuctionServiceImpl.java)</p></div></div></div></div><p class="Para" id="Par134">The auction service changes the status of a new quote to “Confirmed.”</p><div class="Para" id="Par135">The broker service, after invoking the auction service, will call the stock order service. The stock order service is a JMS message sender and is shown in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC7">13-6</a></span>.<div class="ProgramCode" id="PC7"><div class="LineGroup"><div class="FixedLine">public class StockOrderServiceImpl implements StockOrderService{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private JmsTemplate jmsTemplate;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public void setJmsTemplate(JmsTemplate jmsTemplate) {</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.jmsTemplate = jmsTemplate;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public void sendOrderMessage(final QuoteDTO quoteDTO)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws QuotesMessageRollbackException{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Integer testCase = quoteDTO.getTest();</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmsTemplate.send(new MessageCreator() {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public Message createMessage(Session session) throws JMSException {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return session.createObjectMessage(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(testCase == 3){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new QuotesMessageRollbackException(</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Explicitly thrown by Message Sender to Roll Back!");</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-6</span><p class="SimplePara"><span id="ITerm123">Stock Order Service</span> Sending Messages to ActiveMQ Against Confirmed Quotes (ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ\src\main\java\com\acme\ecom\messaging\StockOrderServiceImpl.java)</p></div></div></div></div><div class="Para" id="Par136">For the sake of completeness of the code, Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC8">13-7</a></span> shows the <span class="EmphasisFontCategoryNonProportional ">Quote</span> model class.<div class="ProgramCode" id="PC8"><div class="LineGroup"><div class="FixedLine">@Entity</div><div class="FixedLine">@Table(name = "quote")</div><div class="FixedLine">@Data</div><div class="FixedLine">@EqualsAndHashCode(exclude = { "id" })</div><div class="FixedLine">public class Quote{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public static final String NEW = "New";</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public static final String CONFIRMED = "Confirmed";</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Id</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@GeneratedValue(strategy = GenerationType.AUTO)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Long id;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@NotBlank</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "symbol", nullable = false, updatable = false)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private String symbol;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "sellerid", nullable = false, updatable = false)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Long sellerId;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "buyerid", nullable = false, updatable = false)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Long buyerId;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "amount", nullable = false, updatable = false)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Float amount;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "status", nullable = false, updatable = true)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private String status;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "test", nullable = true, updatable = true)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Integer test;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "delay", nullable = true, updatable = true)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Integer delay = 0;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "createdat", nullable = true, updatable = false)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Temporal(TemporalType.TIMESTAMP)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Date createdAt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "updatedat", nullable = true, updatable = true)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Temporal(TemporalType.TIMESTAMP)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Date updatedAt;</div><div class="FixedLine">}<span id="ITerm124">
                        
                        
                        
                      </span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-7</span><p class="SimplePara">A <span id="ITerm125">Quote Entity</span> (ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ\src\main\java\com\acme\ecom\model\quote\Quote.java)</p></div></div></div></div><div class="Para" id="Par137">That’s all of the main Java files for the example. The main configuration of wiring the above classes with the Atomikos XA transaction manager is done in the file <span class="EmphasisFontCategoryNonProportional ">spring-sender-mysql.xml</span>, shown in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC9">13-8</a></span>.<div class="ProgramCode" id="PC9"><div class="LineGroup"><div class="FixedLine">&lt;beans&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="stockOrderTarget"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="com.acme.ecom.messaging.StockOrderServiceImpl"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="jmsTemplate" ref="jmsTemplate"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="stockOrderServiceRequired_TX"class="org.springframework.</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction.interceptor.TransactionProxyFactoryBean"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionManager"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="transactionManager" /&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="target"&gt;&lt;ref bean="stockOrderTarget"&nbsp;&nbsp;/&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionAttributes"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="sendOrderMessage∗"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROPAGATION_REQUIRED,</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-QuotesMessageRollbackException, +QuotesNoRollbackException</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="stockOrderServiceRequiresNew_TX" class="org.springframework.</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction.interceptor.TransactionProxyFactoryBean"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionManager"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="transactionManager" /&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="target"&gt;&lt;ref bean="stockOrderTarget"&nbsp;&nbsp;/&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionAttributes"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="sendOrderMessage∗"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROPAGATION_REQUIRES_NEW,</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-QuotesMessageRollbackException, +QuotesNoRollbackException</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;<span id="ITerm126">
                        
                        
                        
                      </span></div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="auctionTarget" class= "com.acme.ecom.service.AuctionServiceImpl"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="auctionServiceRequired_TX" class="org.springframework.</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction.interceptor.TransactionProxyFactoryBean"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionManager"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="transactionManager" /&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="target"&gt;&lt;ref bean="auctionTarget"&nbsp;&nbsp;/&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionAttributes"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="confirm∗"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROPAGATION_REQUIRED,</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-QuotesConfirmRollbackException, +QuotesNoRollbackException</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="find∗"&gt;PROPAGATION_SUPPORTS, readOnly&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="auctionServiceRequiresNew_TX" class="org.springframework.</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction.interceptor.TransactionProxyFactoryBean"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionManager"&gt;&lt;ref bean="transactionManager" /&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="target"&gt;&lt;ref bean="auctionTarget"&nbsp;&nbsp;/&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionAttributes"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="confirm∗"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROPAGATION_REQUIRES_NEW,</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-QuotesConfirmRollbackException,</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+QuotesNoRollbackException&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="find∗"&gt;PROPAGATION_SUPPORTS, readOnly&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;<span id="ITerm127">
                        
                        
                        
                      </span></div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="brokerTarget" class= "com.acme.ecom.service.BrokerServiceImpl"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="brokerServiceRequired_TX" class="org.springframework.</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction.interceptor.TransactionProxyFactoryBean"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionManager"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="transactionManager" /&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="target"&gt;&lt;ref bean="brokerTarget"&nbsp;&nbsp;/&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionAttributes"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="process∗"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROPAGATION_REQUIRED,</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-QuotesBaseException, +QuotesNoRollbackException</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="find∗"&gt;PROPAGATION_SUPPORTS, readOnly&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&lt;/beans&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-8</span><p class="SimplePara"><span id="ITerm128">Spring Wiring</span> for Distributed Transactions Example Using MySQL, ActiveMQ, and Atomikos (ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ\src\main\resources\spring-sender-mysql.xml)</p></div></div></div></div><p class="Para" id="Par138">You touched on local transactions in the “Distributed Transactions Revisited” section earlier and Spring’s <span id="ITerm129">PlatformTransactionManager</span> supports local transactions in JDBC, JMS, AMQP, Hibernate, JPA, JDO, and many others usage scenarios. When you want to use XA transactions, <span class="EmphasisFontCategoryNonProportional ">org.springframework.transaction.jta.JtaTransactionManager</span> can be used. JtaTransactionManager is a PlatformTransactionManager implementation for JTA, delegating to a back-end JTA provider. This is typically used to delegate to a Java EE server’s transaction coordinator like Oracle <span id="ITerm130">WebLogicJtaTransactionManager</span> or IBM <span id="ITerm131">WebSphereUowTransactionManager</span><span id="ITerm132">
                  
                </span>, but may also be configured with a local JTA provider that is embedded within the application like <span id="ITerm133">Atomikos</span>. Embedded transaction managers give you the freedom of not using a full-fledged app server; you still get much of the XA transaction support similar to what you get from an app server in your standalone JVM applications.</p><div class="Para" id="Par139">In the current example, there are operations in two resource managers, which are to be transactional:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par140">
                      <span class="EmphasisFontCategoryNonProportional ">AuctionService.confirmQuote()</span>
                    </p></li><li><p class="Para" id="Par141">
                      <span class="EmphasisFontCategoryNonProportional ">StockOrderService.sendOrderMessage()</span>
                    </p></li></ul></div></div><div class="Para" id="Par142">The first one uses a JPA repository to merge an entity’s changed state to the underlying repository and subsequently to the backing persistent store. The second one uses JMS to send messages to an ActiveMQ queue. You want to make both above operations atomic, so either both of them should succeed or both of them should roll back. To ease the control, you enclose both above transactional methods within a third method:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par143">
                      <span class="EmphasisFontCategoryNonProportional ">BrokerService.processNewQuote()</span>
                    </p></li></ul></div></div><div class="Para" id="Par144">You now leverage <span class="EmphasisFontCategoryNonProportional ">org.springframework.transaction.interceptor.</span><span id="ITerm134">
                  <span class="EmphasisFontCategoryNonProportional ">TransactionProxyFactoryBean</span>
                  
                </span>, designed to cover the typical use case of declarative transaction demarcation, by wrapping a singleton target object with a transactional proxy, proxying all the interfaces that the target implements. This is done in the XML configuration. You then also configure the transaction type required for all three methods:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div class="Para" id="Par145">
                      <span class="EmphasisFontCategoryNonProportional ">AuctionService.confirmQuote()</span>
                      <div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par146">
                            <span class="EmphasisFontCategoryNonProportional ">&lt;prop key="confirm*"&gt;PROPAGATION_REQUIRED&lt;/prop&gt;</span>
                          </p></li></ul></div>
                    </div></li><li><div class="Para" id="Par147">
                      <span class="EmphasisFontCategoryNonProportional ">StockOrderService.sendOrderMessage()</span>
                      <div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par148">
                            <span class="EmphasisFontCategoryNonProportional ">&lt;prop key="sendOrderMessage*"&gt;PROPAGATION_REQUIRED&lt;/prop&gt;</span>
                          </p></li></ul></div>
                    </div></li><li><div class="Para" id="Par149">
                      <span class="EmphasisFontCategoryNonProportional ">BrokerService.processNewQuote()</span>
                      <div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par150">
                            <span class="EmphasisFontCategoryNonProportional ">&lt;prop key="process*"&gt;PROPAGATION_REQUIRED&lt;/prop&gt;</span>
                          </p></li></ul></div>
                    </div></li></ul></div></div><p class="Para" id="Par151">Further, the recommended way to indicate to the Spring Framework’s transaction infrastructure that a transaction’s work is to be rolled back is to throw an exception from code that is currently executing in the context of a transaction. The Spring Framework’s transaction infrastructure code will catch any unhandled exception as it bubbles up the call stack and will mark the transaction for rollback.</p><p class="Para" id="Par152">That’s all you want to do to wire the business components. Now, if there is an error within any of the above three methods, it will roll back the state changes affected by all three business methods in the underlying resource managers taking part in the XA transaction.</p><div class="Para" id="Par153">You can now concentrate on the infrastructure plumbing. There are two resources you need to configure, the JMS resource and the JDBC resource. See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC10">13-9</a></span> for the XA JMS resource.<div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine">&lt;beans&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="XaFactory"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="org.apache.activemq.ActiveMQXAConnectionFactory"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="brokerURL" value="tcp://127.0.0.1:61616"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="connectionFactory"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="com.atomikos.jms.AtomikosConnectionFactoryBean”&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="uniqueResourceName" value="JMS-Producer"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="xaConnectionFactory" ref="XaFactory"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="localTransactionMode" value="false"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="jmsTemplate"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="org.springframework.jms.core.JmsTemplate"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="connectionFactory" ref="connectionFactory"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="defaultDestinationName"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value="notification.queue"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="deliveryPersistent" value="true"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="sessionTransacted" value="true"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="sessionAcknowledgeMode" value="0"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&lt;/beans&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-9</span><p class="SimplePara">Spring Wiring for XA JMS <span id="ITerm135">Resources</span> for the Distributed Transactions Example ActiveMQ Atomikos (ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ\src\main\resources\spring-sender-mysql.xml)</p></div></div></div></div><p class="Para" id="Par154">The JmsTemplate used by StockOrderService uses <span class="EmphasisFontCategoryNonProportional ">com.atomikos.jms.AtomikosConnectionFactoryBean</span>, which is the Atomikos’s JMS 1.1 connection factory for JTA-enabled JMS operations. You can use an instance of this class to make JMS participate in JTA transactions without having to issue the low-level XA calls yourself. You set whether local <span id="ITerm136">transactions</span> are desired by using the <span class="EmphasisFontCategoryNonProportional ">localTransactionMode</span> property<span id="ITerm137">
                  
                </span>, which defaults to false. With local transactions, no XA enlist will be done; rather, the application should perform session-level JMS commits or rollbacks instead. Note that this feature also requires support from your JMS provider, ActiveMQ in your case. The <span class="EmphasisFontCategoryNonProportional ">xaConnectionFactory</span> property is the basic connection factory that encapsulates the plumbing for connecting to the ActiveMQ broker. In your case, the bean is an instance of <span id="ITerm138">
                  <span class="EmphasisFontCategoryNonProportional ">ActiveMQXAConnectionFactory</span>
                  
                  
                  
                </span><span id="ITerm139">
                  
                </span> type, which is a special connection factory class that you must use when you want to connect to the ActiveMQ broker with support for XA transactions.</p><div class="Para" id="Par155">See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC11">13-10</a></span> for the XA JDBC resource.<div class="ProgramCode" id="PC11"><div class="LineGroup"><div class="FixedLine">&lt;beans&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="datasourceAtomikos-01"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="com.atomikos.jdbc.AtomikosDataSourceBean"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="uniqueResourceName"&gt;&lt;value&gt;JDBC-1&lt;/value&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="xaDataSource"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="xaDataSourceMySQL-01"&nbsp;&nbsp;/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="xaProperties"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="maxPoolSize"&gt;4&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="uniqueResourceName"&gt;xads1&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="poolSize"&gt;&lt;value&gt;4&lt;/value&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="xaDataSourceMySQL-01"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="com.mysql.cj.jdbc.MysqlXADataSource"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="url"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value&gt;jdbc:mysql://localhost:3306/ecom01&lt;/value&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="pinGlobalTxToPhysicalConnection"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value&gt;true&lt;/value&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="user"&gt;&lt;value&gt;root&lt;/value&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="password"&gt;&lt;value&gt;rootpassword&lt;/value&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="atomikosTransactionManager"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="com.atomikos.icatch.jta.UserTransactionManager"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="forceShutdown"&gt;&lt;value&gt;true&lt;/value&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="atomikosUserTransaction"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="com.atomikos.icatch.jta.UserTransactionImp"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionTimeout"&gt;&lt;value&gt;300&lt;/value&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;<span id="ITerm140">
                        
                        
                        
                      </span></div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="transactionManager"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="org.springframework.transaction.jta.JtaTransactionManager"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionManager"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="atomikosTransactionManager"&nbsp;&nbsp;/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="userTransaction"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="atomikosUserTransaction"&nbsp;&nbsp;/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="springJtaPlatformAdapter"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="com.acme.ecom.AtomikosJtaPlatform"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="jtaTransactionManager" ref="transactionManager" /&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="hibernateJpaVendorAdapter" class=</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"/&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="quoteEntityManager"class="org.springframework.</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orm.jpa.LocalContainerEntityManagerFactoryBean"&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="dataSource" ref="datasourceAtomikos-01"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="jpaVendorAdapter" ref="hibernateJpaVendorAdapter"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="jpaProperties"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="hibernate.transaction.jta.platform"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;com.acme.ecom.AtomikosJtaPlatform</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="javax.persistence.transactionType"&gt;JTA&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="packagesToScan" value="com.acme.ecom.model.quote"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="persistenceUnitName" value="quotePersistenceUnit" /&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;<span id="ITerm141">
                        
                        
                        
                      </span></div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;jpa:repositories base-package="com.acme.ecom.repository.quote"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entity-manager-factory-ref="quoteEntityManager"/&gt;</div></div><div class="LineGroup"><div class="FixedLine">&lt;/beans&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-10</span><p class="SimplePara">Spring Wiring for XA JDBC <span id="ITerm142">Resources</span> for the Distributed Transactions Example Using MySQL and Atomikos (ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ\src\main\resources\spring-sender-mysql.xml)</p></div></div></div></div><p class="Para" id="Par156">You can use an instance of the <span class="EmphasisFontCategoryNonProportional ">com.atomikos.jdbc.</span><span id="ITerm143">
                  <span class="EmphasisFontCategoryNonProportional ">AtomikosDataSourceBean</span>
                  
                  
                  
                </span> class if you want to use Atomikos JTA-enabled connection pooling. You need to construct an instance and set the required properties, and the resulting bean will automatically register with the transaction service and take part in active transactions. All SQL done over connections received from this class will participate in JTA transactions. Starting with Connector/J 5.0.0, the javax.sql.<span id="ITerm144">XADataSource interface</span> is implemented using the <span class="EmphasisFontCategoryNonProportional ">com.mysql.jdbc.jdbc2.optional.MysqlXADataSource</span> class<span id="ITerm145">
                  
                </span>, which supports XA distributed transactions when used in combination with MySQL server version 5.0 and later. You set an instance of <span class="EmphasisFontCategoryNonProportional ">MysqlXADataSource</span> as the <span class="EmphasisFontCategoryNonProportional ">xaDataSource</span> property for the <span class="EmphasisFontCategoryNonProportional ">AtomikosDataSourceBean</span> class.</p><p class="Para" id="Par157">Next, the LocalContainerEntityManagerFactoryBean is Spring’s FactoryBean that creates a JPA EntityManagerFactory, which can then be passed to JPA-based DAOs via dependency injection. Starting with Spring 3.1, the <span class="EmphasisFontCategoryNonProportional ">persistence.xml</span> is no longer necessary and LocalContainerEntityManagerFactoryBean supports a <span class="EmphasisFontCategoryNonProportional ">packagesToScan</span> property where the packages to scan for <span class="EmphasisFontCategoryNonProportional ">@Entity</span> classes can be specified.</p><div class="Para" id="Par158">To teach Hibernate how to participate in the Atomikos transaction, earlier you must set a property, the <span id="ITerm146">
                  <span class="EmphasisFontCategoryNonProportional ">hibernate.transaction.manager_lookup_class</span>
                  
                </span>. However, Hibernate 4.3 removed the long-deprecated <span id="ITerm147">TransactionManagerLookup</span>. Hibernate4 doesn’t know to work with Atomikos out of the box. The JTA provider must implement <span class="EmphasisFontCategoryNonProportional ">org.hibernate.engine.transaction.jta.platform.spi.JtaPlatform</span> to resolve the JTA UserTransaction and TransactionManager from the Spring-configured <span id="ITerm148">JtaTransactionManager</span> implementation. An abstract implementation of JTA Platform is already available within Hibernate, namely <span class="EmphasisFontCategoryNonProportional ">org.hibernate.engine.transaction.jta.platform.internal.AbstractJtaPlatform</span>. Using it makes writing a JTA Platform for <span id="ITerm149">Atomikos</span> a breeze. You need to implement this class and set the <span id="ITerm150">
                  <span class="EmphasisFontCategoryNonProportional ">hibernate.transaction.jta.platform</span>
                  
                </span> property explicitly. See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC12">13-11</a></span>.<div class="ProgramCode" id="PC12"><div class="LineGroup"><div class="FixedLine">import javax.transaction.TransactionManager;</div><div class="FixedLine">import javax.transaction.UserTransaction;</div></div><div class="LineGroup"><div class="FixedLine">import org.hibernate.engine.transaction.jta.platform.internal.AbstractJtaPlatform;</div><div class="FixedLine">import org.springframework.transaction.jta.JtaTransactionManager;</div></div><div class="LineGroup"><div class="FixedLine">@SuppressWarnings("serial")</div><div class="FixedLine">public class AtomikosJtaPlatform extends AbstractJtaPlatform {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;static TransactionManager transactionManager;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;static UserTransaction userTransaction;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Override</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;protected TransactionManager locateTransactionManager() {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assert.notNull(transactionManager,</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"TransactionManager has not been setted");</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return transactionManager;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Override</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;protected UserTransaction locateUserTransaction() {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assert.notNull(userTransaction, "UserTransaction has not been setted");</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return userTransaction;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public void setJtaTransactionManager(JtaTransactionManager</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jtaTransactionManager) {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transactionManager = jtaTransactionManager.getTransactionManager();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;userTransaction = jtaTransactionManager.getUserTransaction();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public void setTransactionManager(TransactionManager transactionManager) {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.transactionManager = transactionManager;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public void setUserTransaction(UserTransaction userTransaction) {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.userTransaction = userTransaction;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}<span id="ITerm151">
                        
                        
                        
                      </span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-11</span><p class="SimplePara">Resolving <span id="ITerm152">JTA UserTransaction and TransactionManager</span> (ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ\src\main\java\com\acme\ecom\AtomikosJtaPlatform.java)</p></div></div></div></div><p class="Para" id="Par159">Having looked at the overall configurations, let’s also look into more details of the infrastructure configurations with reference to Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC10">13-9</a></span> and Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC11">13-10</a></span>.</p><p class="Para" id="Par160">You need to set the <span class="EmphasisFontCategoryNonProportional ">dataSource</span> property of LocalContainerEntityManagerFactoryBean to a JDBC DataSource that the JPA persistence provider is supposed to use for accessing the database. The DataSource passed in here will be used as a <span class="EmphasisFontCategoryNonProportional ">nonJtaDataSource</span> on the PersistenceUnitInfo passed to the PersistenceProvider. Note that this variant typically works for JTA transaction management as well; if it does not, consider using the explicit property <span class="EmphasisFontCategoryNonProportional ">jtaDataSource</span> instead. You use the <span id="ITerm153">AtomikosDataSourceBean</span> explained previously to set this property.</p><p class="Para" id="Par161">Next, you need a service provider interface implementation that allows you to plug in vendor-specific behavior into Spring’s EntityManagerFactory creators. <span id="ITerm154">HibernateJpaVendorAdapter</span> is an implementation for Hibernate EntityManager. It supports the detection of annotated packages along with other things. The JPA module of Spring Data contains a custom namespace, &lt;jpa:repositories, that allows the defining of repository beans. It also contains certain features and element attributes that are special to JPA. Generally, the JPA repositories can be set up using the repositories element. In this example, Spring is instructed to scan <span class="EmphasisFontCategoryNonProportional ">com.acme.ecom.repository.quote</span> and all its subpackages for interfaces extending <span class="EmphasisFontCategoryNonProportional ">Repository</span> or one of its subinterfaces. For each interface found, the infrastructure registers the persistence technology-specific FactoryBean to create the appropriate proxies to handle invocations of the query methods. Each bean is registered under a bean name that is derived from the interface name, so your interface of QuoteRepository would be registered under quoteRepository. The entity-manager-factory-ref will help to explicitly wire the EntityManagerFactory to be used with the repositories being detected by the repositories element. This property is usually used if multiple EntityManagerFactory beans are used within the application. If not explicitly configured, Spring will automatically look up the single EntityManagerFactory configured in the ApplicationContext.</p><p class="Para" id="Par162">This completes the configuration of both XA resources. Next, you must configure the XA transaction manager.</p><p class="Para" id="Par163">You need <span class="EmphasisFontCategoryNonProportional ">org.springframework.transaction.jta.</span><span id="ITerm155">
                  <span class="EmphasisFontCategoryNonProportional ">JtaTransactionManager</span>
                  
                </span>, which is an implementation of <span id="ITerm156">PlatformTransactionManager</span>. You need to provide implementations of <span class="EmphasisFontCategoryNonProportional ">javax.transaction.</span><span id="ITerm157">
                  <span class="EmphasisFontCategoryNonProportional ">TransactionManager</span>
                  
                </span> and <span class="EmphasisFontCategoryNonProportional ">javax.transaction.UserTransaction</span> to create a <span class="EmphasisFontCategoryNonProportional ">JtaTransactionManager</span>.</p><p class="Para" id="Par164">The <span class="EmphasisFontCategoryNonProportional ">javax.transaction.UserTransaction</span> interface<span id="ITerm158">
                  
                </span> provides the application the ability to control transaction boundaries programmatically. This interface may be used by Java client programs or Enterprise Java Beans. The <span class="EmphasisFontCategoryNonProportional ">UserTransaction.begin()</span> method starts a global transaction and associates the transaction with the calling thread. The transaction-to-thread association is managed transparently by the transaction manager. Thus the <span class="EmphasisFontCategoryNonProportional ">UserTransaction</span> is the user-facing API.</p><p class="Para" id="Par165"><span class="EmphasisFontCategoryNonProportional ">com.atomikos.icatch.jta.</span><span id="ITerm159">
                  <span class="EmphasisFontCategoryNonProportional ">UserTransactionManager</span>
                  
                </span> is a straightforward, zero-setup implementation of <span class="EmphasisFontCategoryNonProportional ">javax.transaction.TransactionManager</span>. Standalone Java applications can use an instance of this class to get a handle to the transaction manager and automatically start up or recover the transaction service on first use. <span class="EmphasisFontCategoryNonProportional ">com.atomikos.icatch.jta.</span><span id="ITerm160">
                  <span class="EmphasisFontCategoryNonProportional ">UserTransactionImp</span>
                  
                </span> is the <span class="EmphasisFontCategoryNonProportional ">javax.transaction.UserTransaction</span> implementation from <span id="ITerm161">Atomikos</span> which you can use for standalone Java applications. This class again automatically starts up and recovers the transaction service on first use.</p><p class="Para" id="Par166"><span class="EmphasisFontCategoryNonProportional ">org.springframework.transaction.jta.JtaTransactionManager</span> is a PlatformTransactionManager implementation for JTA, delegating to back-end JTA providers. It is typically used to delegate to a Java EE server’s transaction coordinator, but in your case, you have configured with Atomikos JTA provider, which is embedded within the application.</p></section><section class="Section3 RenderAsSection3" id="Sec29"><h4 class="Heading">Microservice 2: Broker-Web</h4><div class="Para" id="Par167">This microservice is straightforward, with REST controllers. You can invoke the test cases by sending HTTP requests to this microservice. You can also keep watching the dashboard, which will provide you with view for the <span class="EmphasisFontCategoryNonProportional ">Quotes</span> table so that you can visualize the effect of your test. Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig6">13-6</a></span> shows how various interactions can be done with the <span id="ITerm162">Broker Web microservice</span><span id="ITerm163">
                  
                  
                </span>.<figure class="Figure" id="Fig6"><div class="MediaObject" id="MO6"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig6_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(5).jpg" style="height:15.92em" width="1299" height="637" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig6_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-6</span><p class="SimplePara">The Broker Web console</p></div></figcaption></figure></div></section><section class="Section3 RenderAsSection3" id="Sec30"><h4 class="Heading">Microservice 3: Quote Settlement (Settlement-ActiveMQ-Derby)</h4><div class="Para" id="Par168">Visit <span class="EmphasisFontCategoryNonProportional ">pom.xml</span> to see the <span id="ITerm164">Atomikos</span><span id="ITerm165">
                  
                </span> distributed transaction manager dependency. You have all of the dependencies described already in Microservice 2, the Broker-MySQL-ActiveMQ microservice. However, as depicted in the architecture diagram, you are using a Derby database in place of MySQL for the downstream settlement of quotes. I will not repeat the dependencies you have already seen; Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC13">13-12</a></span> shows the dependency for the Derby client alone.<div class="ProgramCode" id="PC13"><div class="LineGroup"><div class="FixedLine">&lt;dependencies&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;dependency&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;org.apache.derby&lt;/groupId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;derbyclient&lt;/artifactId&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;10.14.1.0&lt;/version&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</div><div class="FixedLine">&lt;/dependencies&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-12</span><p class="SimplePara">Maven Dependency for the Derby <span id="ITerm166">Client</span> (ch13\ch13-01\XA-TX-Distributed\Settlement-ActiveMQ-Derby\pom.xml)</p></div></div></div></div><p class="Para" id="Par169">My intention with using a <span id="ITerm167">Derby database</span> in place of MySQL is just to make you, the reader, comfortable using XA transactions with an additional XA-compliant resource, a Derby database, so that as a subsequent exercise you have all the tools to try for yourself XA transactions across two XA-compliant databases within a single XA transactions. But you will not attempt that exercise in this text, since it is outside the scope of our discussion.</p><div class="Para" id="Par170">When a new quote message reaches the <span id="ITerm168">ActiveMQ queue</span>, it will be picked up instantaneously by the settlement listener. The settlement listener is a JMS listener and it consumes messages from the queue in a transaction. See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC14">13-13</a></span>.<div class="ProgramCode" id="PC14"><div class="LineGroup"><div class="FixedLine">public class SettlementListener implements MessageListener {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Qualifier("quotesReconcileServiceRequired_TX")</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;QuotesReconcileService quotesReconcileServiceRequired_TX;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Qualifier("quotesReconcileServiceRequiresNew_TX")</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;QuotesReconcileService quotesReconcileServiceRequiresNew_TX;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public void onMessage(Message message) {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reconcile((QuoteDTO) objectMessage.getObject());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch (JMSException e) {</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new RuntimeException(e);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch (QuotesBaseException e) {</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new RuntimeException(e);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private void reconcile(QuoteDTO quoteDTO)throws QuotesBaseException{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Integer testCase = quoteDTO.getTest();</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(testCase.equals(1) || testCase.equals(2) || testCase.equals(4) ||</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;testCase.equals(8)){</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesReconcileServiceRequired_TX.reconcile(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if(testCase.equals(5)){<span id="ITerm169">
                        
                        
                        
                      </span></div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesReconcileServiceRequiresNew_TX.reconcile(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch(QuotesBaseException quotesBaseException){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.error(quotesBaseException.getMessage());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flipFlop();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if(testCase.equals(6)){</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesReconcileServiceRequiresNew_TX.reconcile(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch(QuotesBaseException quotesBaseException){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.error(quotesBaseException.getMessage());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if(testCase.equals(7)){</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotesReconcileServiceRequired_TX.reconcile(quoteDTO);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch(QuotesBaseException quotesBaseException){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.error(quotesBaseException.getMessage());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flipFlop();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOGGER.debug("Undefined Test Case");</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}<span id="ITerm170">
                        
                        
                        
                      </span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-13</span><p class="SimplePara"><span id="ITerm171">Transacted Message Listener Orchestrating Message Consumtion</span> and Quotes Settlement (ch13\ch13-01\XA-TX-Distributed\Settlement-ActiveMQ-Derby\src\main\java\com\acme\ecom\messaging\SettlementListener.java)</p></div></div></div></div><div class="Para" id="Par171">On consuming the message, the settlement listener will invoke the <span class="EmphasisFontCategoryNonProportional ">QuotesReconcileService.reconcile(QuoteDTO)</span> method to reconcile and settle the quote, again in a transaction. See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC15">13-14</a></span>.<div class="ProgramCode" id="PC15"><div class="LineGroup"><div class="FixedLine">public class QuotesReconcileServiceImpl implements QuotesReconcileService{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private UserRepository userRepository;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Override</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public void reconcile(QuoteDTO quoteDTO)throws QuotesBaseException{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Integer testCase = quoteDTO.getTest();</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional sellerQueried =</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;userRepository.findById(quoteDTO.getSellerId());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional buyerQueried&nbsp;&nbsp;=</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;userRepository.findById(quoteDTO.getBuyerId());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User seller = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User buyer = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User sellerSaved = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User buyerSaved = null;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Date updatedDate = null;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seller = (User) sellerQueried.get();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buyer&nbsp;&nbsp;= (User) buyerQueried.get();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;updatedDate = new Date();</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seller.setAmountSold(seller.getAmountSold() + quoteDTO.getAmount());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seller.setUpdatedAt(updatedDate);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seller.setLastQuoteAt(quoteDTO.getCreatedAt());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sellerSaved = userRepository.save(seller);</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buyer.setAmountBought(buyer.getAmountBought() + quoteDTO.getAmount());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buyer.setUpdatedAt(updatedDate);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buyer.setLastQuoteAt(quoteDTO.getCreatedAt());</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buyerSaved = userRepository.save(buyer);<span id="ITerm172">
                        
                        
                        
                      </span></div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(testCase.equals(6)){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new QuotesReconcileRollbackException(</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Explicitly thrown by Reconcile Application to Roll Back!");</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(testCase.equals(7)){</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flipFlop();</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-14</span><p class="SimplePara"><span id="ITerm173">Quotes Reconcile Service</span> Doing Settlement Reconciliation (ch13\ch13-01\XA-TX-Distributed\Settlement-ActiveMQ-Derby\src\main\java\com\acme\ecom\service\QuotesReconcileServiceImpl.java)</p></div></div></div></div><div class="Para" id="Par172">During reconciliation, you update the <span class="EmphasisFontCategoryNonProportional ">amountSold</span> and the <span class="EmphasisFontCategoryNonProportional ">amountBought</span> attributes of the Seller and the Buyer respectively, thus these two attributes represent the running totals as shown in code Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC15">13-14</a></span>. For the completeness of the discussion, Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC16">13-15</a></span> shows the User entity.<div class="ProgramCode" id="PC16"><div class="LineGroup"><div class="FixedLine">@Entity</div><div class="FixedLine">@Table(name = "stockuser")</div><div class="FixedLine">@Data</div><div class="FixedLine">@EqualsAndHashCode(exclude = { "id" })</div><div class="FixedLine">public class User {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Id</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "id", nullable = false, updatable = false)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Long id;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "name", nullable = false, updatable = false)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private String name;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "amountsold", nullable = true, updatable = true)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Double amountSold;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "amountbought", nullable = true, updatable = true)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Double amountBought;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "lastquoteat", nullable = true, updatable = true)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Temporal(TemporalType.TIMESTAMP)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Date lastQuoteAt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "createdat", nullable = false, updatable = false)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Temporal(TemporalType.TIMESTAMP)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Date createdAt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Column(name = "updatedat", nullable = false, updatable = true)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Temporal(TemporalType.TIMESTAMP)</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;private Date updatedAt;</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-15</span><p class="SimplePara"><span id="ITerm174">User Entity</span> (ch13\ch13-01\XA-TX-Distributed\Settlement-ActiveMQ-Derby\src\main\java\com\acme\ecom\model\user\User.java)</p></div></div></div></div><div class="Para" id="Par173">That’s all the main Java files for the microservice. The main configuration of wiring the above classes with the Atomikos XA transaction <span id="ITerm175">manager</span> is done in the file <span class="EmphasisFontCategoryNonProportional ">spring-listener-derbyl.xml</span>, shown in Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC17">13-16</a></span>.<div class="ProgramCode" id="PC17"><div class="LineGroup"><div class="FixedLine">&lt;beans&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="datasourceAtomikos-02"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="com.atomikos.jdbc.AtomikosDataSourceBean&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="uniqueResourceName"&gt;&lt;value&gt;JDBC-2&lt;/value&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="xaDataSourceClassName"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value="org.apache.derby.jdbc.ClientXADataSource" /&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="xaProperties"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="databaseName"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D:/Applns/apache/Derby/derbydb/exampledb</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="serverName"&gt;localhost&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="portNumber"&gt;1527&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="atomikosTransactionManager"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="com.atomikos.icatch.jta.UserTransactionManager"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="forceShutdown"&gt;&lt;value&gt;true&lt;/value&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="atomikosUserTransaction"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="com.atomikos.icatch.jta.UserTransactionImp"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionTimeout"&gt;&lt;value&gt;300&lt;/value&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="transactionManager"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="org.springframework.transaction.jta.JtaTransactionManager"&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionManager"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="atomikosTransactionManager"&nbsp;&nbsp;/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="userTransaction"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="atomikosUserTransaction"&nbsp;&nbsp;/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="springJtaPlatformAdapter"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="com.acme.ecom.AtomikosJtaPlatform"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="jtaTransactionManager" ref="transactionManager" /&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="hibernateJpaVendorAdapter" class="org.springframework.</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orm.jpa.vendor.HibernateJpaVendorAdapter"/&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="userEntityManager" class="org.springframework.</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orm.jpa.LocalContainerEntityManagerFactoryBean"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="dataSource" ref="datasourceAtomikos-02"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="jpaVendorAdapter" ref="hibernateJpaVendorAdapter"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="jpaProperties"&gt;<span id="ITerm176">
                        
                        
                        
                      </span></div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="hibernate.transaction.jta.platform"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;com.acme.ecom.AtomikosJtaPlatform</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="javax.persistence.transactionType"&gt;JTA&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="packagesToScan" value="com.acme.ecom.model.user"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="persistenceUnitName" value="userPersistenceUnit" /&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;jpa:repositories base-package="com.acme.ecom.repository.user"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entity-manager-factory-ref="userEntityManager"/&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="XaFactory"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="org.apache.activemq.ActiveMQXAConnectionFactory"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="brokerURL"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value="failover:(tcp://127.0.0.1:61616)?timeout=10000"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="connectionFactory"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="com.atomikos.jms.AtomikosConnectionFactoryBean”&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="uniqueResourceName" value="JMS-Consumer"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="xaConnectionFactory" ref="XaFactory"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="localTransactionMode" value="false"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="notificationListenerContainer" class="org.springframework.</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jms.listener.DefaultMessageListenerContainer"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="messageListener" ref="notificationListener"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="receiveTimeout" value="10000"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="connectionFactory" ref="connectionFactory"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="destinationName" value="notification.queue"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionManager" ref="transactionManager"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="sessionTransacted" value="true"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="sessionAcknowledgeMode" value="0"/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="notificationListener"<span id="ITerm177">
                        
                        
                        
                      </span></div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="com.acme.ecom.messaging.SettlementListener"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="quotesReconcileServiceRequired_TX"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="quotesReconcileServiceRequired_TX"&nbsp;&nbsp;/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="quotesReconcileServiceRequiresNew_TX"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="quotesReconcileServiceRequiresNew_TX"&nbsp;&nbsp;/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="quotesReconcileServiceTarget"</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class="com.acme.ecom.service.QuotesReconcileServiceImpl"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="quotesReconcileServiceRequired_TX" class="org.springframework.</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction.interceptor.TransactionProxyFactoryBean"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionManager"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="transactionManager" /&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="target"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="quotesReconcileServiceTarget"&nbsp;&nbsp;/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionAttributes"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="reconcile∗"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROPAGATION_REQUIRED,</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-QuotesReconcileRollbackException,+QuotesNoRollbackException</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="find∗"&gt;PROPAGATION_SUPPORTS, readOnly&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;bean id="quotesReconcileServiceRequiresNew_TX" class="org.springframework.</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction.interceptor.TransactionProxyFactoryBean"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionManager"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="transactionManager" /&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="target"&gt;<span id="ITerm178">
                        
                        
                        
                      </span></div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;ref bean="quotesReconcileServiceTarget"&nbsp;&nbsp;/&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="transactionAttributes"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="reconcile∗"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PROPAGATION_REQUIRES_NEW,</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-QuotesReconcileRollbackException,</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+QuotesNoRollbackException</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="find∗"&gt;PROPAGATION_SUPPORTS, readOnly&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/bean&gt;</div><div class="FixedLine">&lt;/beans&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-16</span><p class="SimplePara"><span id="ITerm179">Spring Wiring</span> for the Distributed Transactions Example Using Derby, ActiveMQ, and Atomikos (ch13\ch13-01\XA-TX-Distributed\Settlement-ActiveMQ-Derby\src\main\resources\spring-listener-derbyl.xml)</p></div></div></div></div><p class="Para" id="Par174">I have already explained all of the configurations above except that of <span class="EmphasisFontCategoryNonProportional ">DefaultMessageListenerContainer</span>. <span class="EmphasisFontCategoryNonProportional ">DefaultMessageListenerContainer</span> is a message listener container variant that uses plain JMS client APIs, specifically a loop of <span class="EmphasisFontCategoryNonProportional ">MessageConsumer.receive()</span> calls that also allow for transactional reception of messages when registered with an XA transaction manager. This is designed to work in a native JMS environment as well as in a Java EE environment. You first set your standard JMS message listener, which is the settlement listener, so that messages can be picked up by the <span class="EmphasisFontCategoryNonProportional ">SettlementListener.onMessage()</span>.</p></section><section class="Section3 RenderAsSection3" id="Sec31"><h4 class="Heading">Microservice 4: Settlement-Web</h4><div class="Para" id="Par175">This microservice is again straightforward, with REST controllers. You can also keep watching the dashboard, which will provide you with view for the <span class="EmphasisFontCategoryNonProportional ">User</span> table so that you can visualize the effect of your test. You will also use this microservice to create a few initial users in the system for test purposes. Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig7">13-7</a></span> shows how various interactions can be done with the <span id="ITerm180">Settlement Web microservice</span><span id="ITerm181">
                  
                </span>.<figure class="Figure" id="Fig7"><div class="MediaObject" id="MO7"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig7_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(6).jpg" style="height:18.28em" width="1299" height="731" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig7_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-7</span><p class="SimplePara">The Settlement Web console</p></div></figcaption></figure></div><div class="Para" id="Par176">There is a junit <span class="EmphasisFontCategoryNonProportional ">Test</span> class that simply loads the bean definitions into <span class="EmphasisFontCategoryNonProportional ">spring-sender-mysql.xml</span> and puts the main test application in sleep mode so that the scheduler can time out to check for any new quotes received at predefined <span id="ITerm182">intervals</span><span id="ITerm183">
                  
                </span>. See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC18">13-17</a></span>.<div class="ProgramCode" id="PC18"><div class="LineGroup"><div class="FixedLine">@RunWith(SpringJUnit4ClassRunner.class)</div><div class="FixedLine">@ContextConfiguration(locations="classpath:spring-sender-mysql.xml")</div><div class="FixedLine">public class BrokerServiceTest {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Autowired</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Qualifier("brokerServiceRequired_TX")</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;BrokerService brokerService;</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Test</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public void testSubmitQuote() throws Exception{</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread.sleep(1000 ∗ 60 ∗ 60);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-17</span><p class="SimplePara">Main Test Class at the Quote Processor End (ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ\src\test\java\com\acme\ecom\test\BrokerServiceTest.java)</p></div></div></div></div><div class="Para" id="Par177">Similarly, there is another junit <span class="EmphasisFontCategoryNonProportional ">Test</span> class that simply loads the bean definitions into <span class="EmphasisFontCategoryNonProportional ">spring-listener-derby.xml</span> and puts the main test application in sleep mode so that the JMS listener can keep listening to any incoming messages in the ActiveMQ. See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC19">13-18</a></span>.<div class="ProgramCode" id="PC19"><div class="LineGroup"><div class="FixedLine">@RunWith(SpringJUnit4ClassRunner.class)</div><div class="FixedLine">@ContextConfiguration(locations="classpath:spring-listener-derby.xml")</div><div class="FixedLine">public class SettlementListenerServiceTest {</div></div><div class="LineGroup"><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;@Test</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;public void testSettleQuote() throws Exception{</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread.sleep(1000 ∗ 60 ∗ 60);</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="FixedLine">}<span id="ITerm184">
                        
                        
                      </span><span id="ITerm185">
                        
                      </span></div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-18</span><p class="SimplePara">Another Test Class at the Quote Settlement End (ch13\ch13-01\XA-TX-Distributed\Settlement-ActiveMQ-Derby\src\test\java\com\acme\ecom\test\SettlementListenerServiceTest.java)</p></div></div></div></div></section></section><section class="Section2 RenderAsSection2" id="Sec32"><h3 class="Heading">Build and Test the Example’s Happy Flow</h3><p class="Para" id="Par178">As the first step, you need to bring up the ActiveMQ server. You may want to refer to Appendix F to get started with ActiveMQ.</p><div class="Para" id="Par179">You configure a queue that will act as the bridge between the upstream and downstream processing. Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC20">13-19</a></span> gives the configuration of a queue that can be done in <span class="EmphasisFontCategoryNonProportional ">activemq.xml</span>.<div class="ProgramCode" id="PC20"><div class="LineGroup"><div class="FixedLine">&lt;beans&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;broker&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;destinations&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;queue physicalName="notification.queue" /&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/destinations&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/broker&gt;</div><div class="FixedLine">&lt;/beans&gt;</div></div><div class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 13-19</span><p class="SimplePara">The ActiveMQ <span id="ITerm186">Queue Configuration</span> (D:\Applns\apache\ActiveMQ\apache-activemq-5.13.3\conf\activemq.xml)</p></div></div></div></div><div class="Para" id="Par180">You may now bring up the ActiveMQ Server:<div class="ProgramCode" id="PC21"><div class="LineGroup"><div class="FixedLine">cd D:\Applns\apache\ActiveMQ\apache-activemq-5.13.3\bin</div><div class="FixedLine">D:\Applns\apache\ActiveMQ\apache-activemq-5.13.3\bin&gt;activemq start</div></div></div></div><div class="Para" id="Par181">Next, make sure MySQL is up and running. You may want to refer to Appendix H to get started with MySQL.<div class="ProgramCode" id="PC22"><div class="LineGroup"><div class="FixedLine">D:\Applns\MySQL\mysql-5.7.14-winx64\bin&gt;mysqld --console</div></div></div></div><div class="Para" id="Par182">Now open a MySQL prompt:<div class="ProgramCode" id="PC23"><div class="LineGroup"><div class="FixedLine">D:\Applns\MySQL\mysql-5.7.14-winx64\bin&gt;mysql -u root –p</div></div><div class="LineGroup"><div class="FixedLine">mysql&gt; use ecom01;</div><div class="FixedLine">Database changed</div><div class="FixedLine">mysql&gt;</div></div></div></div><div class="Para" id="Par183">To start with clean tables, delete any tables with the names you want for your examples:<div class="ProgramCode" id="PC24"><div class="LineGroup"><div class="FixedLine">mysql&gt; drop table quote;</div></div></div></div><div class="Para" id="Par184">Next, create the table with the schema required for this example:<div class="ProgramCode" id="PC25"><div class="LineGroup"><div class="FixedLine">mysql&gt; create table quote (id BIGINT PRIMARY KEY AUTO_INCREMENT, symbol VARCHAR(4), sellerid BIGINT, buyerid BIGINT, amount FLOAT, status VARCHAR(9), test INTEGER, delay INTEGER, createdat DATETIME, updatedat DATETIME);</div></div></div></div><div class="Para" id="Par185">Next, make sure the Derby database is up and running in network mode. You may want to refer to Appendix <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_26_Chapter.xhtml" class="totri-footnote"><span class="RefSource">G</span></a></span> to get started with Derby.<div class="ProgramCode" id="PC26"><div class="LineGroup"><div class="FixedLine">D:\Applns\apache\Derby\db-derby-10.14.1.0-bin\bin&gt;startNetworkServer</div></div></div></div><div class="Para" id="Par186">You can also use the Derby ij tool to create the database <span class="EmphasisFontCategoryNonProportional ">exampledb</span> and open a connection to an already created database using the embedded driver using the following command:<div class="ProgramCode" id="PC27"><div class="LineGroup"><div class="FixedLine">D:\Applns\apache\Derby\derbydb&gt;ij</div><div class="FixedLine">ij&gt; connect 'jdbc:derby://localhost:1527/D:/Applns/apache/Derby/derbydb/exampledb;create=false';</div></div></div></div><div class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant" id="FPar1"><h3 class="Heading">Note</h3><p class="Para" id="Par187">You are using the ij tool from a base location different from your Derby installation, assuming that your database is in a location different from that of the Derby installation, which is a best practice. For further details on how to create a new database, refer to Appendix <span class="ExternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_26_Chapter.xhtml" class="totri-footnote"><span class="RefSource">G</span></a></span>.</p></div><div class="Para" id="Par188">Here again you will start with clean tables. Delete any tables with the names you want for your examples:<div class="ProgramCode" id="PC28"><div class="LineGroup"><div class="FixedLine">ij&gt; drop table stockuser;</div></div></div></div><div class="Para" id="Par189">Next, create the table with the schema required for this example:<div class="ProgramCode" id="PC29"><div class="LineGroup"><div class="FixedLine">ij&gt; create table stockuser (id bigint not null, amountbought double, amountsold double, createdat timestamp not null, lastquoteat timestamp, name varchar(10) not null, updatedat timestamp not null, primary key (id));</div><div class="FixedLine">ij&gt; CREATE SEQUENCE hibernate_sequence START WITH 1 INCREMENT BY 1;</div></div></div></div><p class="Para" id="Par190">This completes the infrastructure required to build and run the example.</p><p class="Para" id="Par191">Next, there are four microservices to build and get running. You will do this one by one.</p><section class="Section3 RenderAsSection3" id="Sec33"><h4 class="Heading">Microservice 1: <span id="ITerm187">Quote Processing Microservice</span></h4><div class="Para" id="Par192">See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC10">13-9</a></span> to tweak the ActiveMQ-specific configuration in<div class="ProgramCode" id="PC30"><div class="LineGroup"><div class="FixedLine">ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ\src\main\resources\spring-sender-mysql.xml</div></div><div class="LineGroup"><div class="FixedLine">&lt;property name="brokerURL" value="tcp://127.0.0.1:61616"/&gt;</div></div></div></div><div class="Para" id="Par193">Also, you need to tweak the MySQL-specific configuration:<div class="ProgramCode" id="PC31"><div class="LineGroup"><div class="FixedLine">&lt;bean id="xaDataSourceMySQL-01" class="com.mysql.cj.jdbc.MysqlXADataSource"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="url"&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;value&gt;jdbc:mysql://localhost:3306/ecom01&lt;/value&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="user"&gt;&lt;value&gt;root&lt;/value&gt;&lt;/property&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;property name="password"&gt;&lt;value&gt;rootpassword&lt;/value&gt;&lt;/property&gt;</div><div class="FixedLine">&lt;/bean&gt;</div></div></div></div><div class="Para" id="Par194">Now build and package the executables for the Quote Processing microservice and bring up the scheduled processor. There is a utility script provided that you can easily execute in folder <span class="EmphasisFontCategoryNonProportional ">ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ\make.bat</span>:<div class="ProgramCode" id="PC32"><div class="LineGroup"><div class="FixedLine">cd D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ</div><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ&gt;make</div><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ&gt;mvn -Dmaven.test.skip=true clean install</div></div></div></div><div class="Para" id="Par195">Now, the junit test can be run by using the script provided:<div class="ProgramCode" id="PC33"><div class="LineGroup"><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ&gt;run</div><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Broker-MySQL-ActiveMQ&gt;mvn -Dtest=BrokerServiceTest#testSubmitQuote test</div></div></div></div></section><section class="Section3 RenderAsSection3" id="Sec34"><h4 class="Heading">Microservice 2: <span id="ITerm188">Broker Web Microservice</span></h4><div class="Para" id="Par196">First, you want to update the configuration files to suit to your environment:<div class="ProgramCode" id="PC34"><div class="LineGroup"><div class="FixedLine">ch13\ch13-01\XA-TX-Distributed\Broker-Web\src\main\resources\application.properties</div></div><div class="LineGroup"><div class="FixedLine">server.port=8080</div><div class="FixedLine">spring.datasource.url = jdbc:mysql://localhost:3306/ecom01?autoReconnect=true&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;allowMultiQueries=true&amp;useSSL=false</div><div class="FixedLine">spring.datasource.username = root</div><div class="FixedLine">spring.datasource.password = rootpassword</div><div class="FixedLine">spring.jpa.properties.hibernate.dialect = org.hibernate.dialect.MySQL5Dialect</div><div class="FixedLine">spring.jpa.hibernate.ddl-auto = update</div><div class="FixedLine">spring.freemarker.cache=false</div></div></div></div><div class="Para" id="Par197">You can now build and package the executables for the Broker Web microservice and bring up the server. There is a utility script provided in folder <span class="EmphasisFontCategoryNonProportional ">ch13\ch13-01\XA-TX-Distributed\Broker-Web\make.bat</span>:<div class="ProgramCode" id="PC35"><div class="LineGroup"><div class="FixedLine">cd D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Broker-Web</div><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Broker-Web&gt;make</div><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Broker-Web&gt;mvn -Dmaven.test.skip=true clean package</div></div></div></div><div class="Para" id="Par198">You can run the Spring Boot application, again in more than one way. The straightforward way is to execute the JAR file via the following commands:<div class="ProgramCode" id="PC36"><div class="LineGroup"><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Broker-Web&gt;run</div><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Broker-Web&gt;java -jar -Dserver.port=8080 .\target\quotes-web-1.0.0.jar</div></div></div></div><p class="Para" id="Par199">This will bring up the Broker Web Spring Boot <span id="ITerm189">Server</span> in port 8080.</p><p class="Para" id="Par200">You can use a browser (preferably Chrome) and point to the following URL to keep monitoring the processing of all new incoming quotes: <span class="EmphasisFontCategoryNonProportional ">http://localhost:8080/</span>.</p></section><section class="Section3 RenderAsSection3" id="Sec35"><h4 class="Heading">Microservice 3: <span id="ITerm190">Quote Settlement Microservice</span></h4><div class="Para" id="Par201">See Listing <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#PC17">13-16</a></span> to tweak the ActiveMQ-specific configuration in<div class="ProgramCode" id="PC37"><div class="LineGroup"><div class="FixedLine">ch13\ch13-01\XA-TX-Distributed\Settlement-ActiveMQ-Derby\src\main\resources\spring-listener-derby.xml</div></div><div class="LineGroup"><div class="FixedLine">&lt;property name="brokerURL" value="failover:(tcp://127.0.0.1:61616)?timeout=10000"/&gt;</div></div></div></div><div class="Para" id="Par202">Also, you need to tweak the Derby-specific configuration:<div class="ProgramCode" id="PC38"><div class="LineGroup"><div class="FixedLine">&lt;property name="xaProperties"&gt;</div><div class="FixedLine">&lt;props&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="databaseName"&gt;D:/Applns/apache/Derby/derbydb/exampledb&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="serverName"&gt;localhost&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;prop key="portNumber"&gt;1527&lt;/prop&gt;</div><div class="FixedLine">&nbsp;&nbsp;&nbsp;&nbsp;&lt;/props&gt;</div><div class="FixedLine">&lt;/property&gt;</div></div></div></div><div class="Para" id="Par203">Now build and package the executables for the Quote Settlement microservice and bring up the message <span id="ITerm191">listener</span>. There is a utility script provided in folder <span class="EmphasisFontCategoryNonProportional ">ch13\ch13-01\XA-TX-Distributed\Settlement-ActiveMQ-Derby\make.bat</span>:<div class="ProgramCode" id="PC39"><div class="LineGroup"><div class="FixedLine">cd D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Settlement-ActiveMQ-Derby</div><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Settlement-ActiveMQ-Derby&gt;make</div><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Settlement-ActiveMQ-Derby&gt;mvn -Dmaven.test.skip=true clean install</div></div></div></div><div class="Para" id="Par204">Now, the junit test can be run by using the script provided:<div class="ProgramCode" id="PC40"><div class="LineGroup"><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Settlement-ActiveMQ-Derby&gt;run</div><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Settlement-ActiveMQ-Derby&gt;mvn -Dtest=SettlementListenerServiceTest#testSettleQuote test</div></div></div></div></section><section class="Section3 RenderAsSection3" id="Sec36"><h4 class="Heading">Microservice 4: <span id="ITerm192">Settlement Web Microservice</span></h4><div class="Para" id="Par205">First, you want to update the configuration files to suit to your environment:<div class="ProgramCode" id="PC41"><div class="LineGroup"><div class="FixedLine">ch13\ch13-01\XA-TX-Distributed\Settlement-Web\src\main\resources\application.properties</div></div><div class="LineGroup"><div class="FixedLine">server.port=8081</div><div class="FixedLine">spring.datasource.url=jdbc:derby://localhost:1527/D:/Applns/apache/Derby/derbydb/exampledb;create=false</div><div class="FixedLine">spring.datasource.initialize=false</div><div class="FixedLine">spring.datasource.driver-class-name=org.apache.derby.jdbc.ClientDriver</div><div class="FixedLine">spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.DerbyTenSevenDialect</div><div class="FixedLine">spring.freemarker.cache=false</div></div></div></div><div class="Para" id="Par206">Now build and package the executables for the Settlement Web microservice and bring up the server. There is a utility script provided in folder <span class="EmphasisFontCategoryNonProportional ">ch13\ch13-01\XA-TX-Distributed\Settlement-Web\make.bat</span>:<div class="ProgramCode" id="PC42"><div class="LineGroup"><div class="FixedLine">cd D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Settlement-Web</div><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Settlement-Web&gt;make</div><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Settlement-Web&gt;mvn -Dmaven.test.skip=true clean package</div></div></div></div><div class="Para" id="Par207">You can run the Spring Boot application in more than one way. The straightforward way is to execute the JAR file via the following commands:<div class="ProgramCode" id="PC43"><div class="LineGroup"><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Settlement-Web&gt;run</div><div class="FixedLine">D:\binil\gold\pack03\ch13\ch13-01\XA-TX-Distributed\Settlement-Web&gt;java -jar -Dserver.port=8081 .\target\user-web-1.0.0.jar</div></div></div></div><p class="Para" id="Par208">This will bring up the Settlement Web Spring Boot <span id="ITerm193">Server</span> in port 8080.</p><p class="Para" id="Par209">You can use a browser (preferably Chrome) and point to the following URL to keep monitoring the running account status of the users and how the account balance changes as each new incoming quote is settled: <span class="EmphasisFontCategoryNonProportional ">http://localhost:8081/</span>.</p><div class="Para" id="Par210">There are altogether eight test cases that you will execute one by one to validate the example. See Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig8">13-8</a></span>.<figure class="Figure" id="Fig8"><div class="MediaObject" id="MO8"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig8_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(7).jpg" style="height:15.63em" width="1725" height="625" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig8_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-8</span><p class="SimplePara">Test cases</p></div></figcaption></figure></div><p class="Para" id="Par211">In the truest sense, there are only three test cases that validate the example and they are the first, second, and the seventh test cases. All other test cases invalidate the example either by simulating various failure conditions or by adjusting the transaction semantics applied to service methods. I do that to make you understand possible error scenarios that can occur in a distributed transactions environment.</p><p class="Para" id="Par212">In this section, you will look at the first test case, which demonstrates strict ACID compliant transaction in the end-to-end flow. This means either all of the state changes in the resources will be approved or all of them will be rolled back. The rest of the test cases will be executed in the subsequent sections one by one.</p><div class="Para" id="Par213">As a first step, you will create two test users in the system. Take Postman and create two test users as shown (see Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig9">13-9</a></span>):<div class="ProgramCode" id="PC44"><div class="LineGroup"><div class="FixedLine">http://localhost:8081/api/users</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "id" : 11, "name" : "Sam", "amountSold" : 1000.0, "amountBought" : 1000.0 }</div><div class="FixedLine">{ "id" : 21, "name" : "Joe", "amountSold" : 5000.0, "amountBought" : 5000.0 }</div></div></div><figure class="Figure" id="Fig9"><div class="MediaObject" id="MO9"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig9_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(8).jpg" style="height:21.32em" width="1725" height="853" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig9_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-9</span><p class="SimplePara">Create test users<span id="ITerm194">
                          
                        </span></p></div></figcaption></figure></div><div class="Para" id="Par214">The moment the test users are created, they will be visible in the settlement console, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig10">13-10</a></span>.<figure class="Figure" id="Fig10"><div class="MediaObject" id="MO10"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig10_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(9).jpg" style="height:14.22em" width="1725" height="569" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig10_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-10</span><p class="SimplePara">Test user console</p></div></figcaption></figure></div><div class="Para" id="Par215">To start the first test case, take Postman and create a new quote, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig11">13-11</a></span>:<div class="ProgramCode" id="PC45"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "symbol" : "AAPL", "sellerId" : 11, "buyerId" : 21, "amount" : 100, "test" : 1, "delay" : 2 }</div></div></div><figure class="Figure" id="Fig11"><div class="MediaObject" id="MO11"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig11_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(10).jpg" style="height:21.5em" width="1725" height="860" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig11_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-11</span><p class="SimplePara">Create a new <span id="ITerm195">quote</span></p></div></figcaption></figure></div><div class="Para" id="Par216">Keep watching the consoles of the broker web service and the settlement web service together. When a new quote is created, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig11">13-11</a></span>, it instantaneously gets reflected in the broker web console, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig12">13-12</a></span>.<figure class="Figure" id="Fig12"><div class="MediaObject" id="MO12"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig12_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(11).jpg" style="height:25.17em" width="1725" height="1007" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig12_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-12</span><p class="SimplePara">A new quote arrived for Test Case <span id="ITerm196">1</span></p></div></figcaption></figure></div><div class="Para" id="Par217">Within minutes, the quotes will get processed in the upstream microservices and will subsequently get settled in the downstream microservices. Close observation shows that the status of the quote changes from “New” to “Confirmed” in the broker web console and the running balances of the users will get changed by the amount of quotes also in the Settlement Web console, both shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig13">13-13</a></span>.<figure class="Figure" id="Fig13"><div class="MediaObject" id="MO13"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig13_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(12).jpg" style="height:25.32em" width="1725" height="1013" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig13_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-13</span><p class="SimplePara">Test Case 1 <span id="ITerm197">console</span></p></div></figcaption></figure></div><p class="Para" id="Par218">You should also note another aspect in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig13">13-13</a></span>, which will be relevant in Test Case 8, in the “Test the Message Received Out of Order Scenario” section later. The latest quote creation time in the upstream system gets updated as the Last Quote Time for users whenever the respective user account gets updated.</p><div class="Para" id="Par219">Since you already looked at every detail of the code in the earlier sections, you will not look at what is happening under the hood again in detail. Instead, you will now concentrate on the transaction semantics.<figure class="Figure" id="Fig14"><div class="MediaObject" id="MO14"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig14_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(13).jpg" style="height:30.4em" width="1299" height="1216" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig14_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-14</span><p class="SimplePara">Test Case 1 transaction <span id="ITerm198">semantics</span></p></div></figcaption></figure></div><p class="Para" id="Par220">As shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig14">13-14</a></span>, you applied TX_REQUIRED transaction semantics to all service methods. This means either all of the state changes in the resources will be made or all of them will be rolled back. In the current test case, you have not simulated any errors or failure conditions, hence all of the transactions succeeded.</p><p class="Para" id="Par221">In subsequent test cases you are going to simulate error conditions to better understand possible failure conditions in enterprise scenarios. A thorough understanding of all of these possible failure conditions will arm you with better insight, which is very much required when you design for “true microservices,” where you want to stay away from distributed transactions!</p></section></section><section class="Section2 RenderAsSection2" id="Sec37"><h3 class="Heading">Test the Transaction Rollback Scenario</h3><div class="Para" id="Par222">To test the <span id="ITerm199">Transaction Rollback test case</span>, take Postman again and create another new quote, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig11">13-11</a></span>:<div class="ProgramCode" id="PC46"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "symbol" : "AMZN", "sellerId" : 11, "buyerId" : 21, "amount" : 200, "test" : 2, "delay" : 2 }</div></div></div></div><div class="Para" id="Par223">In Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig3">13-3</a></span>, the upstream processing and the downstream processing are separate. There is no strict “super transaction coordinator” across these two domains. If transaction semantics are applied to Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig3">13-3</a></span>, you get Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig15">13-15</a></span>. So within a domain (upstream alone or downstream alone) you may decide to have coordinated transactions across multiple resources, and when it comes to coordination across those domains you may need to think of the BASE approach.<figure class="Figure" id="Fig15"><div class="MediaObject" id="MO15"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig15_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(14).jpg" style="height:30.4em" width="1299" height="1216" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig15_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-15</span><p class="SimplePara">Test Case 2 transaction <span id="ITerm200">semantics</span></p></div></figcaption></figure></div><p class="Para" id="Par224">As shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig15">13-15</a></span>, TX_REQUIRED transaction semantics have been applied to all service methods. This means either all of the state changes in the resources will be made or all of them will be rolled back.</p><p class="Para" id="Par225">In the first pass of execution when the Quotes Processor Task picks up the new quote for processing, you simulate an error within the broker service. This is marked by an X sign in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig15">13-15</a></span>. So, even though the corresponding transactions in the auction service and stock order service were ready to commit, as shown by the ✓ sign, they will be rolled back since both of them were called within the context of the parent transaction of the broker service where you simulate the error. This is shown in the Quote Processing microservice’s console in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig16">13-16</a></span>.</p><div class="Para" id="Par226">Moreover, since in the first pass the transactions were rolled out, the New Quote message delivery to ActiveMQ is not committed, so no action takes place in the Quote Settlement microservice (see Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig16">13-16</a></span>). This is depicted by a blank circle in the first pass in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig15">13-15</a></span> for brevity.<figure class="Figure" id="Fig16"><div class="MediaObject" id="MO16"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig16_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(15).jpg" style="height:33.35em" width="1725" height="1334" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig16_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-16</span><p class="SimplePara">Test Case 2 processing first <span id="ITerm201">pass</span></p></div></figcaption></figure></div><div class="Para" id="Par227">Wait until the Quotes Processor Task picks up the previous quote again (since the status is still New) in the next scheduled trigger, which is shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig17">13-17</a></span>.<figure class="Figure" id="Fig17"><div class="MediaObject" id="MO17"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig17_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(16).jpg" style="height:27.28em" width="1725" height="1091" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig17_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-17</span><p class="SimplePara">New quote arrived for Test Case <span id="ITerm202">2</span></p></div></figcaption></figure></div><div class="Para" id="Par228">In the second pass of executing the Quotes Processor Task, it again picks up the new quote corresponding to Test Case 2 for processing. In the second pass, you do not simulate any error conditions, as shown by the ✓ sign in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig15">13-15</a></span>. So, the transactions in the auction service and stock order service that are ready to commit as shown by the ✓ sign are committed, since both of them were called within the context of the parent transaction of the broker service, which is also committed. Since the new quote message delivery to ActiveMQ is committed, the Quote Settlement microservice will receive the quote message for settlement. As shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig15">13-15</a></span> by the ✓ sign in this second pass for the settlement listener service and the record user transaction service, the complete transactions within the Quote Settlement microservice will be committed. This is reflected in the console in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig18">13-18</a></span>.<figure class="Figure" id="Fig18"><div class="MediaObject" id="MO18"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig18_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(17).jpg" style="height:27.08em" width="1725" height="1083" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig18_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-18</span><p class="SimplePara">Test Case 2 <span id="ITerm203">console</span></p></div></figcaption></figure></div><div class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant"><h3 class="Heading">Caution</h3><p class="Para">As a reader, if you follow the execution of tests mentioned in this chapter exactly, it is easy for you to visualize the effects and understand based on the explanation and screenshots provided here. So you are strongly advised to follow exactly as directed. Further, this setup automatically makes the first pass fail and the second pass succeed for few of the test cases. This mechanism is designed in that manner to make intervention from the reader at a minimum during the test execution. However, the test fixtures will work only if you execute tests cases with a single test client (Postman Browser client). So do not (monkey) test the example with concurrent test clients. Later, when you are comfortable executing the tests as described and can follow the explanations provided, then you may start tweaking the code and test fixtures to test further scenarios of your own.</p></div></section><section class="Section2 RenderAsSection2" id="Sec38"><h3 class="Heading">Simulating Relaxed Base Anomalies</h3><p class="Para" id="Par230">So far you implemented a BASE system with a reasonable degree of ACID transactions so you are sure that eventual consistency is preserved. Now, let’s abuse the transaction attributes to artificially “cut down” the scope of ACID transactions even more, which brings you into the following relaxed BASE situations.</p><section class="Section3 RenderAsSection3" id="Sec39"><h4 class="Heading">Test the Lost Message Scenario</h4><div class="Para" id="Par231">To test the <span id="ITerm204">Lost Message test case</span>, take Postman again and create another new quote:<div class="ProgramCode" id="PC47"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "symbol" : "GOOG", "sellerId" : 11, "buyerId" : 21, "amount" : 300, "test" : 3, "delay" : 2 }</div></div></div></div><div class="Para" id="Par232">Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig19">13-19</a></span> shows the new quote for Test Case 3. It has a status of “New.” When settled, the quote amount, 300, should get added to the respective running balances of the buyer and seller shown in the figure.<figure class="Figure" id="Fig19"><div class="MediaObject" id="MO19"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig19_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(18).jpg" style="height:29.05em" width="1725" height="1162" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig19_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-19</span><p class="SimplePara">Test Case 3 console at first</p></div></figcaption></figure></div><div class="Para" id="Par233">Let’s now look at the transaction semantics. See Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig20">13-20</a></span>.<figure class="Figure" id="Fig20"><div class="MediaObject" id="MO20"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig20_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(19).jpg" style="height:29.2em" width="1299" height="1168" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig20_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-20</span><p class="SimplePara">Test Case 3 transaction <span id="ITerm205">semantics</span></p></div></figcaption></figure></div><div class="Para" id="Par234">Here, the Quotes Processor Task picks up the new quote for processing. You simulate an error within the stock order service. This is marked by an X sign in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig19">13-19</a></span>. The peer transaction in the auction service has to succeed, so it’s marked with the ✓ sign. The parent transaction in the broker service also needs to succeed. This means the error in the stock order service shouldn’t affect the parent transaction in the broker service or the peer transaction in auction service, so you put TX_REQUIRES_NEW semantics for the stock order service. The net effect is that the quote will be marked as “Confirmed;” however, the new quote message to ActiveMQ will fail. Since the quote is already marked as “Confirmed,” the Quotes Processor Task will not pick up this quote for processing again in the next scheduled trigger. The net effect is this quote will never get settled in the downstream Quote Settlement microservice, which is shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig21">13-21</a></span>! The message is lost.<figure class="Figure" id="Fig21"><div class="MediaObject" id="MO21"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig21_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(20).jpg" style="height:29.15em" width="1725" height="1166" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig21_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-21</span><p class="SimplePara">Test Case 3 console at <span id="ITerm206">completion</span></p></div></figcaption></figure></div></section><section class="Section3 RenderAsSection3" id="Sec40"><h4 class="Heading">Test the Duplicate Message Sent Scenario</h4><div class="Para" id="Par235">To validate the <span id="ITerm207">Duplicate Message Sent test case</span>, take Postman again and create another new quote:<div class="ProgramCode" id="PC48"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "symbol" : "NFLX", "sellerId" : 11, "buyerId" : 21, "amount" : 400, "test" : 4, "delay" : 2 }</div></div></div></div><div class="Para" id="Par236">Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig22">13-22</a></span> shows the new quote for Test Case 4. It has a status of “New.” When settled, the quote amount, 400, should get added to the respective running balances of the buyer and seller, as shown in the figure.<figure class="Figure" id="Fig22"><div class="MediaObject" id="MO22"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig22_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(21).jpg" style="height:30.8em" width="1725" height="1232" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig22_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-22</span><p class="SimplePara">Test Case 4 console, <span id="ITerm208">initially</span></p></div></figcaption></figure></div><div class="Para" id="Par237">Let’s now look at the transaction semantics in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig23">13-23</a></span>.<figure class="Figure" id="Fig23"><div class="MediaObject" id="MO23"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig23_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(22).jpg" style="height:30.4em" width="1299" height="1216" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig23_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-23</span><p class="SimplePara">Test Case 4 transaction <span id="ITerm209">semantics</span></p></div></figcaption></figure></div><p class="Para" id="Par238">Here, the Quotes Processor Task picks up the new quote for processing. You simulate an error within the auction service. This is marked by an X sign in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig23">13-23</a></span>. The peer transaction in the stock order service has to succeed, so it’s marked with a ✓ sign. The parent transaction in the broker service also needs to succeed. This means the error in the auction service shouldn’t affect the parent transaction in the broker service or the peer transaction in the stock order service, so you put TX_REQUIRES_NEW semantics for the auction service. The net effect is that the status of the quote marked as “Confirmed” will be rolled back; however, the new quote message to ActiveMQ will succeed.</p><div class="Para" id="Par239">Since the new quote message delivery to ActiveMQ is committed, the Quote Settlement microservice will receive the quote message for settlement. As shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig23">13-23</a></span> by the ✓ sign in the first pass for the settlement listener service and the record user transaction service, the complete transactions within the Quote Settlement microservice will be committed. This is reflected in the console in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig24">13-24</a></span>.<figure class="Figure" id="Fig24"><div class="MediaObject" id="MO24"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig24_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(23).jpg" style="height:30.85em" width="1725" height="1234" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig24_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-24</span><p class="SimplePara">Test Case 4 console, intermediate <span id="ITerm210">view</span></p></div></figcaption></figure></div><p class="Para" id="Par240">Alarmingly enough, you can see that the quote settlement happened and the quote amount of 400 gets added to the respective running balances of the buyer and seller, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig24">13-24</a></span>; however, in the upstream systems, the quote is yet not marked as “Confirmed.” This is because the auction service, which marked the quote as “Confirmed,” got rolled back!</p><div class="Para" id="Par241">The effect is the next time out the Quotes Processor Task picks up the new quote for processing a second time. In your test execution, you won’t simulate the error within the auction service this time. Thus, for a second time, the end-to-end processing of this quote is repeated and Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig25">13-25</a></span> reflects the result!<figure class="Figure" id="Fig25"><div class="MediaObject" id="MO25"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig25_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(24).jpg" style="height:30.75em" width="1725" height="1230" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig25_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-25</span><p class="SimplePara">Test Case 4 console at <span id="ITerm211">completion</span></p></div></figcaption></figure></div><p class="Para" id="Par242">This is not intended. The duplicate message caused the duplicate settlement of the quote!</p></section><section class="Section3 RenderAsSection3" id="Sec41"><h4 class="Heading">Test the Duplicate Message Consumption Scenario</h4><div class="Para" id="Par243">To test the <span id="ITerm212">Duplicate Message Consumption test case</span>, take Postman again and create another new quote:<div class="ProgramCode" id="PC49"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "symbol" : "TSLA", "sellerId" : 11, "buyerId" : 21, "amount" : 500, "test" : 5, "delay" : 2 }</div></div></div></div><div class="Para" id="Par244">Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig26">13-26</a></span> shows the new quote for Test Case 5. It has a status of “New.” When settled, the quote amount, 500, should get added to the respective running balances of the buyer and seller, shown in the figure.<figure class="Figure" id="Fig26"><div class="MediaObject" id="MO26"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig26_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(25).jpg" style="height:32.5em" width="1725" height="1300" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig26_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-26</span><p class="SimplePara">Test Case 5 console, <span id="ITerm213">initially</span></p></div></figcaption></figure></div><div class="Para" id="Par245">Let’s now look at the transaction semantics in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig27">13-27</a></span>.<figure class="Figure" id="Fig27"><div class="MediaObject" id="MO27"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig27_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(26).jpg" style="height:30.4em" width="1299" height="1216" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig27_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-27</span><p class="SimplePara">Test Case 5 transaction <span id="ITerm214">semantics</span></p></div></figcaption></figure></div><p class="Para" id="Par246">Here, there are no errors simulated in any upstream processing, so the quote status will change from “New” to “Confirmed,” and since the new quote message delivery to ActiveMQ is also successful, the Quote Settlement microservice will receive the quote message for settlement. The settlement listener service will receive the message and subsequently invoke the quote reconcile service for settlement. Settlement happens during which the running balances of the buyer and seller are updated. However, once the control comes back from the quote reconcile service, an error is simulated, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig27">13-27</a></span> by the X sign in the first pass for the settlement listener service.</p><div class="Para" id="Par247">A few things to be noted here:<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><p class="Para" id="Par248">The settlement done by the quote reconcile service is done within a TX_REQUIRES_NEW transaction context, so the error happens at the enclosing or the parent transaction (the transaction of the settlement listener service) will not have any effect on the transaction of the quote reconcile service, so the effect of the settlement is committed.</p></li><li><p class="Para" id="Par249">Even though the settlement listener service has read the message from ActiveMQ, the message listener method, which is in a TX_REQUIRED transaction context, will not commit the message read from ActiveMQ. Hence for ActiveMQ, the message delivery didn’t succeed, so it will try to deliver the message again.</p></li></ul></div></div><div class="Para" id="Par250">During retry of message delivery (i.e., during the second pass of the message listener processing), you do not simulate any error, and this is indicated by the sign (✓) in both services in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig27">13-27</a></span>. Hence the transactions by the settlement listener service and the quote reconcile service will both be successful and committed. However, there is a bigger problem: the quote will get settled once again, which will cause double addition and double deduction in the buyer’s and seller’s accounts, <span id="ITerm215">respectively</span>. See Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig28">13-28</a></span>.<figure class="Figure" id="Fig28"><div class="MediaObject" id="MO28"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig28_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(27).jpg" style="height:32.65em" width="1725" height="1306" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig28_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-28</span><p class="SimplePara">Test Case 5 transaction <span id="ITerm216">semantics</span></p></div></figcaption></figure></div></section><section class="Section3 RenderAsSection3" id="Sec42"><h4 class="Heading">Test the Message Consumed, Processing Failure Scenario</h4><div class="Para" id="Par251">To test the <span id="ITerm217">Message Consumed, Processing Failure test case</span>, take Postman again and create another new quote:<div class="ProgramCode" id="PC50"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "symbol" : "MSFT", "sellerId" : 11, "buyerId" : 21, "amount" : 600, "test" : 6, "delay" : 2 }</div></div></div></div><div class="Para" id="Par252">Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig29">13-29</a></span> shows the new quote for Test Case 6. It has a status of “New.” When settled, the quote amount, 600, should get added to the respective running balances of the buyer and seller, as shown in the figure.<figure class="Figure" id="Fig29"><div class="MediaObject" id="MO29"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig29_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(28).jpg" style="height:34.15em" width="1725" height="1366" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig29_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-29</span><p class="SimplePara">Test Case 6 console, <span id="ITerm218">initially</span></p></div></figcaption></figure></div><div class="Para" id="Par253">Let’s now look at the transaction semantics shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig30">13-30</a></span>.<figure class="Figure" id="Fig30"><div class="MediaObject" id="MO30"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig30_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(29).jpg" style="height:30.4em" width="1299" height="1216" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig30_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-30</span><p class="SimplePara">Test Case 6 transaction <span id="ITerm219">semantics</span></p></div></figcaption></figure></div><div class="Para" id="Par254">Here again there are no errors simulated in any upstream processing, so the quote status will change from “New” to “Confirmed,” and since the new quote message delivery to ActiveMQ is also successful, the Quote Settlement microservice will receive the quote message for settlement. The settlement listener service will receive the message and subsequently invoke the quote reconcile service for settlement. Settlement happens during which it attempts to update the running balances of the buyer and seller. However, an error is simulated within the quote reconcile service transaction, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig30">13-30</a></span> by the X sign. Since the quote reconcile service transaction is configured with TX_REQUIRES_NEW semantics, the settlement will be rolled back. Since the message consumption succeeded, the net effect is that the quote remains unsettled forever in the downstream system! See Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig31">13-31</a></span>.<figure class="Figure" id="Fig31"><div class="MediaObject" id="MO31"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig31_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(30).jpg" style="height:34.15em" width="1725" height="1366" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig31_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-31</span><p class="SimplePara">Test Case 6 console, <span id="ITerm220">complete</span></p></div></figcaption></figure></div></section><section class="Section3 RenderAsSection3" id="Sec43"><h4 class="Heading">Test the Message Redelivery Scenario</h4><p class="Para" id="Par255">JMS offers no ordering guarantees regarding message delivery, so messages sent first can arrive after messages sent at a later time. This holds regardless of whether you use XA transactions or not.</p><div class="Para" id="Par256">To test the <span id="ITerm221">Message Redelivery test case</span>, take Postman again and create another new quote:<div class="ProgramCode" id="PC51"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "symbol" : "ORCL", "sellerId" : 11, "buyerId" : 21, "amount" : 700, "test" : 7, "delay" : 2 }</div></div></div></div><div class="Para" id="Par257">Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig32">13-32</a></span> shows the new quote for Test Case 7. It has a status of “New.” When settled, the quote amount, 700, should get added to the respective running balances of the buyer and seller, as shown in the figure.<figure class="Figure" id="Fig32"><div class="MediaObject" id="MO32"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig32_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(31).jpg" style="height:35.8em" width="1725" height="1432" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig32_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-32</span><p class="SimplePara">Test Case 7 console, <span id="ITerm222">initially</span></p></div></figcaption></figure></div><div class="Para" id="Par258">Let’s now look at the transaction semantics shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig33">13-33</a></span>.<figure class="Figure" id="Fig33"><div class="MediaObject" id="MO33"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig33_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(32).jpg" style="height:30.4em" width="1299" height="1216" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig33_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-33</span><p class="SimplePara">Test Case 7 transaction <span id="ITerm223">semantics</span></p></div></figcaption></figure></div><p class="Para" id="Par259">In this case too there are no errors simulated in any upstream processing, hence the quote status will change from “New” to “Confirmed” and since the new quote message delivery to ActiveMQ is also successful, the Quote Settlement microservice will receive the quote message for settlement. The settlement listener service will receive the message and subsequently invoke the quote reconcile service for settlement. Settlement happens, during which it attempts to update the running balances of the buyer and seller. However, during the first pass, an error is simulated within the quote reconcile service transaction, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig33">13-33</a></span> by the X sign. Further, once the control comes back from the quote reconcile service, another error is simulated within the settlement listener service, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig33">13-33</a></span> by the X sign in the first pass by the settlement listener service.</p><div class="Para" id="Par260">Even though the settlement listener service has read the message from ActiveMQ, the message listener method, which is in a TX_REQUIRED transaction context, will not commit the message read from ActiveMQ. Hence for ActiveMQ, the message delivery didn’t succeed, so it will try to deliver the message again. During the retry (i.e., during the second pass of the message listener processing), you do not simulate any error, and this is indicated by the ✓ sign in both the services. Hence the transactions by the settlement listener service and the quote reconcile service will both be successful and committed. And the effect is that the quote will get settled correctly in the second pass. See Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig34">13-34</a></span>.<figure class="Figure" id="Fig34"><div class="MediaObject" id="MO34"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig34_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(33).jpg" style="height:35.68em" width="1725" height="1427" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig34_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-34</span><p class="SimplePara">Test Case 7 console, <span id="ITerm224">complete</span></p></div></figcaption></figure></div></section></section><section class="Section2 RenderAsSection2" id="Sec44"><h3 class="Heading">Common Messaging Pitfalls</h3><p class="Para" id="Par261">In this section, I will demonstrate few common messaging pitfalls which can occur in distributed scenarios if you have not designed the system carefully.</p><section class="Section3 RenderAsSection3" id="Sec45"><h4 class="Heading">Test the Message Received Out of Order Scenario</h4><p class="Para" id="Par262">Testing for this scenario is slightly <span id="ITerm225">tricky</span><span id="ITerm226">
                  
                </span> since you need to coordinate the timing of each action as per the test fixtures. I will explain based on the configuration for my test fixtures, and they should work for you too if you have not done any changes to the example configurations.</p><p class="Para" id="Par263">You need to send a new quote for upstream processing but you want to delay the processing for a little. While this quote is waiting for the delay to be over, you also want to fire one more new quote for upstream processing, which will get processed nearly straight through without any delay. As a result, the quote created later has to reach the downstream system for further processing first, followed by the quote created initially. In this manner, you need to simulate messages arriving out of order at the downstream system.</p><p class="Para" id="Par264">Before you start firing requests for this test case, read the rest of this section completely once to understand the preparations you need to make mentally so as to fire new quotes as per instructions. Then come back to this point of the explanation again, read it again, and continue the actual test.</p><div class="Para" id="Par265">Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig35">13-35</a></span> shows the transaction semantics for this test case.<figure class="Figure" id="Fig35"><div class="MediaObject" id="MO35"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig35_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(34).jpg" style="height:40.4em" width="1725" height="1616" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig35_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-35</span><p class="SimplePara">Test Case 8 transaction semantics</p></div></figcaption></figure></div><p class="Para" id="Par266">As shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig35">13-35</a></span>, you don’t simulate any error scenarios; instead, you simulate only messages reaching out of order.</p><div class="Para" id="Par267">To test this test case, take Postman again and fire a new quote:<div class="ProgramCode" id="PC52"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "symbol" : "QCOM", "sellerId" : 11, "buyerId" : 21, "amount" : 800, "test" : 8, "delay" : 90}</div></div></div></div><div class="Para" id="Par268">You should note that you are piggybacking a delay of 90 seconds along with the test request payload, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig36">13-36</a></span>.<figure class="Figure" id="Fig36"><div class="MediaObject" id="MO36"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig36_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(35).jpg" style="height:37.48em" width="1725" height="1499" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig36_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-36</span><p class="SimplePara">Test Case 8 console, creating the first quote</p></div></figcaption></figure></div><div class="Para" id="Par269">Keep watching upstream microservice console (command screen). When the Quote Processor Task times out, it will fetch this new quote, changing the status from “New” to “Confirmed,” but before completing the end-to-end transaction, it will sleep for the 90 seconds delay you have provided; this is shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig37">13-37</a></span>.<figure class="Figure" id="Fig37"><div class="MediaObject" id="MO37"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig37_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(36).jpg" style="height:34.98em" width="1607" height="1399" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig37_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-37</span><p class="SimplePara">Test Case 8 console, showing the delay</p></div></figcaption></figure></div><p class="Para" id="Par270">This 90 seconds has a significance because the next time-out of the Quote Processor Task will happen in the next 60 seconds, and during that time-out it shouldn’t fetch this quote because it is already in a processing state (the quote status is not “New”).</p><div class="Para" id="Par271">Here comes the trick. As soon as (within 10 to 20 seconds) the Quote Processor Task picks up the quote for processing and further goes to sleep for the delay of 90 seconds provided, you need to fire another new quote (ideally, you have another Postman session with the data ready), like so:<div class="ProgramCode" id="PC53"><div class="LineGroup"><div class="FixedLine">http://localhost:8080/api/quotes</div><div class="FixedLine">METHOD: POST; BODY: Raw JSON</div></div><div class="LineGroup"><div class="FixedLine">{ "symbol" : "GILD", "sellerId" : 11, "buyerId" : 21, "amount" : 900, "test" : 8, "delay" : 2 }</div></div></div></div><div class="Para" id="Par272">This second new quote is shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig38">13-38</a></span>. That’s all, and the steps for test execution from your part are over.<figure class="Figure" id="Fig38"><div class="MediaObject" id="MO38"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig38_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(37).jpg" style="height:37.62em" width="1725" height="1505" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig38_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-38</span><p class="SimplePara">Test Case 8 console, creating a second quote</p></div></figcaption></figure></div><p class="Para" id="Par273">When the Quote Processor Task times out next, it will fetch this second new quote alone. This is because even though the first quote is still under process in the upstream system, the status of the quote has already been updated to “Confirmed,” as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig38">13-38</a></span>. This is shown by marking the transaction of the Auction Service as TX_REQUIRES_NEW, as is evident in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig35">13-35</a></span> (another hack for demonstration purposes).</p><div class="Para" id="Par274">For the second new quote, there is negligible process delay and it comes out of upstream processing, gets through ActiveMQ, and reaches downstream for further processing. You expect the first quote to still be at the process stage in the upstream system. This way, the message is out of order in the downstream system. This will be settled as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig39">13-39</a></span>.<figure class="Figure" id="Fig39"><div class="MediaObject" id="MO39"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig39_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(38).jpg" style="height:37.5em" width="1725" height="1500" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig39_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-39</span><p class="SimplePara">Test Case 8 console, second quote settled first</p></div></figcaption></figure></div><div class="Para" id="Par275">Keep watching the browser consoles. Quite soon, you will see the running balances of users in the downstream system change. This is the effect of the first quote, whose upstream processing has been delayed, so it reaches the downstream system out of order and finally gets settled, as shown in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig40">13-40</a></span>.<figure class="Figure" id="Fig40"><div class="MediaObject" id="MO40"><img alt="../images/477630_1_En_13_Chapter/477630_1_En_13_Fig40_HTML.jpg" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/477630_1_E(39).jpg" style="height:37.6em" width="1725" height="1504" data-mfp-src="/library/view/practical-microservices-architectural/9781484245019/images/477630_1_En_13_Chapter/477630_1_En_13_Fig40_HTML.jpg"></div><figcaption class="Caption" lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 13-40</span><p class="SimplePara">Test Case 8 console, first quote settled in second place</p></div></figcaption></figure></div><p class="Para" id="Par276">In the “Build and Test the Example’s Happy Flow" section earlier, you read that the latest quote creation time in the upstream system gets updated as the last quote time whenever the user account gets updated. Going by this logic, Quote ID 9 in Figure <span class="InternalRef"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fig40">13-40</a></span> is the latest quote created, so the creation timestamp of that quote should be the last quote time for the users. However, since Quote ID 8 and Quote ID 9 reached the downstream systems out of order, this sanity of data attribute rule went wrong!</p></section></section></section><section class="Section1 RenderAsSection1" id="Sec46"><h2 class="Heading">Summary</h2><p class="Para" id="Par277">Transactions are the bread and butter for the dynamics of any enterprise-class application. Local transactions are good; however, distributed transactions across partitioned domains are not among the good guys. When you shift from a monolith-based architecture to a microservices-based architecture, you still need transactions; however, you are better off with BASE transactions in place of ACID transactions for domains across partitions and keep ACID or XA compliant transactions within partitions or domains. In this chapter, you saw many error scenarios possible in distributed enterprise systems, and you also saw how such error scenarios could be avoided had you been using ACID transactions. When you shift from monolith- to microservices-based architecture, there is no reduction in the above error scenarios; instead, there is a magnitude of increase in such error scenarios since the degree of distribution of microservices-based architectures are increased manyfold. In the next chapter, you will see techniques you can use in architecting distributed systems to safeguard against such error scenarios, so continue happy reading!</p></section><aside class="FootnoteSection" epub:type="footnotes"><div class="Heading">Footnotes</div><div class="Footnote"><span class="FootnoteNumber"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fn1_source" class="totri-footnote">1</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn1"><p class="Para" id="Par24">Atomikos Microservices Transaction Patterns online course: <span class="ExternalRef"><a href="https://atomikos.teachable.com/p/microservice-transaction-patterns"><span class="RefSource">
                      <span class="EmphasisFontCategoryNonProportional ">https://atomikos.teachable.com/p/microservice-transaction-patterns</span>
                    </span></a></span></p></div><div class="ClearBoth">&nbsp;</div></div><div class="Footnote"><span class="FootnoteNumber"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fn2_source" class="totri-footnote">2</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn2"><p class="Para" id="Par27">Write-ahead logging (WAL) is a family of techniques for providing atomicity and durability (two of the ACID properties) in database systems. The changes are first recorded in the log, which must be written to stable storage, before the changes are written to the database.</p></div><div class="ClearBoth">&nbsp;</div></div><div class="Footnote"><span class="FootnoteNumber"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fn3_source" class="totri-footnote">3</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn3"><p class="Para" id="Par31">64-bit computing is the use of processors that have datapath widths, integer size, and memory address widths of 64 bits (eight octets). Also, 64-bit computer architectures for central processing units (CPUs) and arithmetic logic units (ALUs) are based on processor registers, address buses, or data buses of that size.</p></div><div class="ClearBoth">&nbsp;</div></div><div class="Footnote"><span class="FootnoteNumber"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fn4_source" class="totri-footnote">4</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn4"><p class="Para" id="Par54">A phantom read occurs when, in the course of a transaction, new rows are added or removed by another transaction to the records being read.</p></div><div class="ClearBoth">&nbsp;</div></div><div class="Footnote"><span class="FootnoteNumber"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fn5_source" class="totri-footnote">5</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn5"><p class="Para" id="Par66">A semaphore is a variable or abstract data type used to control access to a common resource by multiple processes in a concurrent system such as a multitasking operating system. A trivial semaphore is a plain variable that is changed (for example, incremented, decremented, or toggled) depending on programmer-defined conditions.</p></div><div class="ClearBoth">&nbsp;</div></div><div class="Footnote"><span class="FootnoteNumber"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#Fn6_source" class="totri-footnote">6</a></span><div class="FootnoteContent" epub:type="footnote" id="Fn6"><p class="Para" id="Par132">A flip-flop is an electronic circuit with two stable states that can be used to store binary data.</p></div><div class="ClearBoth">&nbsp;</div></div></aside></div><div class="annotator-outer annotator-viewer viewer annotator-hide">
  <ul class="annotator-widget annotator-listing"></ul>
</div><div class="annotator-modal-wrapper annotator-editor-modal annotator-editor annotator-hide">
	<div class="annotator-outer editor">
		<h2 class="title">Highlight</h2>
		<form class="annotator-widget">
			<ul class="annotator-listing">
			<li class="annotator-item"><textarea id="annotator-field-1" placeholder="Add a note using markdown (optional)" class="js-editor" maxlength="750"></textarea></li></ul>
			<div class="annotator-controls">
				<a class="link-to-markdown" href="https://daringfireball.net/projects/markdown/basics" target="_blank">?</a>
				<ul>
					<li class="delete annotator-hide"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#delete" class="annotator-delete-note button positive">Delete Note</a></li>
					<li class="save"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#save" class="annotator-save annotator-focus button positive">Save Note</a></li>
					<li class="cancel"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#cancel" class="annotator-cancel button">Cancel</a></li>
				</ul>
			</div>
		</form>
	</div>
</div><div class="annotator-modal-wrapper annotator-delete-confirm-modal" style="display: none;">
  <div class="annotator-outer">
    <h2 class="title">Highlight</h2>
      <a class="js-close-delete-confirm annotator-cancel close" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#close">Close</a>
      <div class="annotator-widget">
         <div class="delete-confirm">
            Are you sure you want to permanently delete this note?
         </div>
         <div class="annotator-controls">
            <a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#cancel" class="annotator-cancel button js-cancel-delete-confirm">No, I changed my mind</a>
            <a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#delete" class="annotator-delete button positive js-delete-confirm">Yes, delete it</a>
         </div>
       </div>
   </div>
</div><div class="annotator-adder" style="display: none;">
	<ul class="adders">
		
		<li class="copy"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#">Copy</a></li>
		
		<li class="add-highlight"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#">Add Highlight</a></li>
		<li class="add-note"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#">
			Add Note
		</a></li>
		
	</ul>
</div></div></div>



  <div class="t-sbo-prev sbo-prev sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_12_Chapter.xhtml" class="prev nav-link">
      
          <span aria-hidden="true" class="pagination-label t-prev-label">Prev</span>
          <span class="visuallyhidden">Previous Chapter</span>
          <div class="pagination-title t-prev-title">12.&nbsp;Axon for CQRS Architecture</div>
        </a>
    
  
  </div>

  <div class="t-sbo-next sbo-next sbo-nav-bottom">
  
    
      
        <a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_14_Chapter.xhtml" class="next nav-link">
      
          <span aria-hidden="true" class="pagination-label t-next-label">Next</span>
          <span class="visuallyhidden">Next Chapter</span>
          <div class="pagination-title t-next-title">14.&nbsp;Transactions and Microservices</div>
        </a>
    
  
  </div>

</section>
  </div>
<section class="sbo-saved-archives"></section>



          
          
  




    
    



        
      </div><div style="width:0px; height:0px; display:none; visibility:hidden;" id="batBeacon0.0012369070667999083"><img style="width:0px; height:0px; display:none; visibility:hidden;" id="batBeacon0.8835591474266922" width="0" height="0" alt="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/0"></div>
      
        

<footer class="pagefoot t-pagefoot">
  <a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" class="icon-up" onclick="window.Appcues.track(&#39;JumpTop_HeronBook&#39;)" style="display: block;"><div class="visuallyhidden">Back to top</div></a>
  <ul class="js-footer-nav">
  
    
    <li><a href="https://learning.oreilly.com/u/preferences/">Settings</a></li>
    
    <li><a href="https://learning.oreilly.com/public/support/">Support</a></li>
    
    <li><a href="https://learning.oreilly.com/accounts/logout/">Sign Out</a></li>
    
  
  
  </ul>
  <span class="copyright">© 2020 <a href="https://learning.oreilly.com/" target="_blank">O'Reilly Media, Inc</a>.</span>
  
    
    <a href="https://www.oreilly.com/terms/">Terms of Service</a> 
     / 
    
    <a href="https://learning.oreilly.com/privacy">Privacy Policy</a> 
    
    
  
</footer>

      
    
    <script src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/saved_resource" charset="utf-8"></script>
    <script src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/saved_resource(1)" charset="utf-8"></script>
  

<div></div><div></div><div class="annotator-notice"></div><div class="font-flyout" style="top: 201.012px; left: 1280px;"><div class="font-controls-panel">
	<div class="nightmodes">
		<ul>
			<li class="day"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" id="day-mode" title="Day Mode">
				<i class="fa fa-sun-o"></i>
				<span>Day Mode</span></a></li>
			<li class="cloudy"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" id="cloudy-mode" title="Cloudy Mode">
				<i class="fa fa-cloud"></i>
				<span>Cloud Mode</span>
			</a></li>
			<li class="night"><a href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#" id="night-mode" title="Night Mode">
				<i class="fa fa-moon-o"></i>
				<span>Night Mode</span>
			</a></li>
		</ul>
	</div>

	<div class="font-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-font left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-font-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-font right"></i>
		</div>
	</div>

	<div class="column-resizer resizer">
		<div class="draggable-containment-wrapper">
			<i class="fa fa-compress left"></i>
			<span class="filler" style="width: 50%;"></span>
			<div id="js-column-size-draggable" class="draggable ui-widget-content ui-draggable ui-draggable-handle" style="position: relative; left: 80px;"></div>
			<i class="fa fa-expand right"></i>
		</div>
	</div>

	<a id="reset" class="button" href="https://learning.oreilly.com/library/view/practical-microservices-architectural/9781484245019/html/477630_1_En_13_Chapter.xhtml#">Reset</a>
</div>
</div><script type="text/javascript" async="" src="./13. Distributed Transactions - Practical Microservices Architectural Patterns_ Event-Based Java Microservices with Spring Boot and Spring Cloud_files/generic1595942691.下载" charset="UTF-8"></script><span></span><div style="display: none; visibility: hidden;"><script>(function(){if(null!==document.querySelector('iframe[title\x3d"fb:share_button Facebook Social Plugin"]')&&void 0!==document.querySelector('iframe[title\x3d"fb:share_button Facebook Social Plugin"]')){var a=!1;window.addEventListener("blur",function(){a&&dataLayer.push({event:"eventTracker",eventCat:"social",eventAct:"share",eventLbl:"facebook",eventVal:0,nonInteraction:0})});document.querySelector('iframe[title\x3d"fb:share_button Facebook Social Plugin"]').addEventListener("mouseover",function(){window.focus();
a=!0});document.querySelector('iframe[title\x3d"fb:share_button Facebook Social Plugin"]').addEventListener("mouseout",function(){a=!1})}if(null!==document.querySelector("iframe.twitter-share-button")&&void 0!==document.querySelector("iframe.twitter-share-button")){var b=!1;window.addEventListener("blur",function(){b&&dataLayer.push({event:"eventTracker",eventCat:"social",eventAct:"share",eventLbl:"twitter",eventVal:0,nonInteraction:0})});document.querySelector("iframe.twitter-share-button").addEventListener("mouseover",
function(){window.focus();b=!0});document.querySelector("iframe.twitter-share-button").addEventListener("mouseout",function(){b=!1})}try{window.twttr=function(a,b,d){var c,e=a.getElementsByTagName(b)[0];if(!a.getElementById(d))return a=a.createElement(b),a.id=d,a.src="//platform.twitter.com/widgets.js",e.parentNode.insertBefore(a,e),window.twttr||(c={_e:[],ready:function(a){c._e.push(a)}})}(document,"script","twitter-wjs"),twttr.ready(function(a){a.events.bind("tweet",trackTwitter)})}catch(c){}})();
null!==document.querySelector(".IN-widget")&&void 0!==document.querySelector(".IN-widget")&&document.querySelector(".IN-widget").addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"social",eventAct:"share",eventLbl:"linkedin",eventVal:0,nonInteraction:0})});
function trackTwitter(a){a&&(a.target&&"IFRAME"==a.target.nodeName&&(opt_target=extractParamFromUri(a.target.src,"url")),dataLayer.push({event:"eventTracker",eventCat:"social",eventAct:"share",eventLbl:"twitter",eventVal:0,nonInteraction:0}))}function extractParamFromUri(a,b){if(a&&(b=new RegExp("[\\?\x26#]"+b+"\x3d([^\x26#]*)"),a=b.exec(a),null!=a))return unescape(a[1])};</script></div><script type="text/javascript" id="">function forceInputUppercase(a){var b=a.target.selectionStart,c=a.target.selectionEnd;a.target.value=a.target.value.toUpperCase();a.target.setSelectionRange(b,c)}void 0!=document.getElementById("id_promotion")&&null!=document.getElementById("id_promotion")&&document.getElementById("id_promotion").addEventListener("keyup",forceInputUppercase,!1);
void 0!=document.getElementsByName("promotionCode")[0]&&null!=document.getElementsByName("promotionCode")[0]&&document.getElementsByName("promotionCode")[0].addEventListener("keyup",forceInputUppercase,!1);</script><script type="text/javascript" id="">var nonwExpandable=document.querySelectorAll(".orm-ff-NavigationSubnav-headerListItem a, .orm-ff-NavigationView-headerListItem a");nonwExpandable.forEach(function(a,b){b+1!=nonwExpandable.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):b+1==nonwExpandable.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var nonwExpandableFo=document.querySelectorAll(".drop-content li:not(.flyout-parent) a");
nonwExpandableFo.forEach(function(a,b){"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1!=nonwExpandableFo.length?a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.childNodes[1].textContent})}):"drop-content"==a.parentNode.parentNode.parentNode.className&&b+1==nonwExpandableFo.length&&a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"user login",eventAct:"logout",eventLbl:"global nav | unified"})})});
var expandable=document.querySelectorAll(".orm-ff-NavigationSubnav-toggleControls a, .orm-ff-NavigationView-toggleControls a");expandable.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.parentNode.parentNode.parentNode.querySelectorAll(".orm-Button-btnContentWrap span")[0].childNodes[1].textContent+" | "+a.textContent})})});var flyoutLinks=document.querySelectorAll(".flyout a");
flyoutLinks.forEach(function(a){a.addEventListener("click",function(){dataLayer.push({event:"eventTracker",eventCat:"global nav",eventAct:"navigation",eventLbl:a.closest("li.flyout-parent").getElementsByTagName("a")[0].textContent+" | "+a.textContent})})});</script></body></html>